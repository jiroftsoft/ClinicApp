# ğŸ”§ Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙ†ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ

## ğŸ—ï¸ **Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…**

### **Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controllers  â”‚  Views  â”‚  JavaScript  â”‚  CSS  â”‚  HTML     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Business Logic Layer                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services  â”‚  Interfaces  â”‚  ViewModels  â”‚  Validators    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Data Access Layer                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Repositories  â”‚  Entity Framework  â”‚  Database Context   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Infrastructure Layer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Cache  â”‚  Logging  â”‚  Monitoring  â”‚  Security  â”‚  Config  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ **Ù…Ø¯Ù„ Ø¯Ø§Ø¯Ù‡**

### **Entity: InsuranceTariff**
```csharp
public class InsuranceTariff : ISoftDelete, ITrackable
{
    // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    public int InsuranceTariffId { get; set; }
    public int InsurancePlanId { get; set; }
    public int ServiceId { get; set; }
    
    // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
    public InsuranceType InsuranceType { get; set; }
    public string SupplementarySettings { get; set; }
    public decimal? SupplementaryCoveragePercent { get; set; }
    public decimal? SupplementaryMaxPayment { get; set; }
    
    // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Audit
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public string CreatedByUserId { get; set; }
    public string UpdatedByUserId { get; set; }
    public bool IsDeleted { get; set; }
}
```

### **Entity: InsuranceType (Enum)**
```csharp
public enum InsuranceType
{
    Primary = 1,        // Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ
    Supplementary = 2   // Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
}
```

### **Entity: PatientInsurance**
```csharp
public class PatientInsurance : ISoftDelete, ITrackable
{
    public int PatientInsuranceId { get; set; }
    public int PatientId { get; set; }
    public int InsurancePlanId { get; set; }
    public bool IsActive { get; set; }
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
    
    // Navigation Properties
    public virtual Patient Patient { get; set; }
    public virtual InsurancePlan InsurancePlan { get; set; }
}
```

---

## ğŸ”§ **Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ**

### **SupplementaryInsuranceService**

#### **Dependency Injection**
```csharp
public SupplementaryInsuranceService(
    IPatientInsuranceRepository patientInsuranceRepository,
    IInsuranceTariffRepository tariffRepository,
    IInsurancePlanRepository planRepository,
    IServiceRepository serviceRepository,
    ISupplementaryInsuranceCacheService cacheService,
    ISupplementaryInsuranceMonitoringService monitoringService,
    ICurrentUserService currentUserService,
    ILogger logger)
```

#### **Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ**

##### **CalculateSupplementaryInsuranceAsync**
```csharp
public async Task<ServiceResult<SupplementaryCalculationResult>> CalculateSupplementaryInsuranceAsync(
    int patientId, 
    int serviceId, 
    decimal serviceAmount, 
    decimal primaryCoverage, 
    DateTime calculationDate)
{
    try
    {
        // 1. Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø±
        var supplementaryInsurance = await _patientInsuranceRepository
            .GetSupplementaryByPatientIdAsync(patientId);
        
        // 2. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ ÙØ¹Ø§Ù„
        var activeSupplementary = supplementaryInsurance
            .FirstOrDefault(pi => pi.IsActive && 
                (pi.EndDate == null || pi.EndDate > calculationDate));
        
        // 3. Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        var tariffs = await _tariffRepository.GetByPlanIdAsync(activeSupplementary.InsurancePlanId);
        var tariff = tariffs.FirstOrDefault(t => 
            t.ServiceId == serviceId && 
            t.InsuranceType == InsuranceType.Supplementary);
        
        // 4. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        decimal remainingAmount = serviceAmount - primaryCoverage;
        
        // 5. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        decimal supplementaryCoverage = 0;
        if (tariff.SupplementaryCoveragePercent.HasValue)
        {
            supplementaryCoverage = remainingAmount * (tariff.SupplementaryCoveragePercent.Value / 100m);
        }
        
        // 6. Ø§Ø¹Ù…Ø§Ù„ Ø³Ù‚Ù Ù¾Ø±Ø¯Ø§Ø®Øª
        if (tariff.SupplementaryMaxPayment.HasValue && 
            supplementaryCoverage > tariff.SupplementaryMaxPayment.Value)
        {
            supplementaryCoverage = tariff.SupplementaryMaxPayment.Value;
        }
        
        // 7. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù‡Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨ÛŒÙ…Ø§Ø±
        decimal finalPatientShare = remainingAmount - supplementaryCoverage;
        if (finalPatientShare < 0) finalPatientShare = 0;
        
        // 8. Ø§ÛŒØ¬Ø§Ø¯ Ù†ØªÛŒØ¬Ù‡
        var result = new SupplementaryCalculationResult
        {
            PatientId = patientId,
            ServiceId = serviceId,
            ServiceAmount = serviceAmount,
            PrimaryCoverage = primaryCoverage,
            SupplementaryCoverage = supplementaryCoverage,
            FinalPatientShare = finalPatientShare,
            TotalCoverage = primaryCoverage + supplementaryCoverage,
            CalculationDate = calculationDate,
            Notes = $"Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø±ÙÙ‡: {tariff.SupplementaryCoveragePercent}%"
        };
        
        return ServiceResult<SupplementaryCalculationResult>.Successful(result);
    }
    catch (Exception ex)
    {
        _logger.Error(ex, "Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ");
        return ServiceResult<SupplementaryCalculationResult>.Failed("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ");
    }
}
```

---

## ğŸ—ƒï¸ **Cache Management**

### **SupplementaryInsuranceCacheService**

#### **Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Cache**
```csharp
public class SupplementaryInsuranceCacheService : ISupplementaryInsuranceCacheService
{
    // Cache Ù‡Ø§ÛŒ Ø¯Ø±ÙˆÙ†â€ŒØ­Ø§ÙØ¸Ù‡â€ŒØ§ÛŒ
    private static readonly Dictionary<string, CachedTariffData> _tariffCache = new();
    private static readonly Dictionary<string, CachedSettingsData> _settingsCache = new();
    private static readonly Dictionary<string, CachedCalculationData> _calculationCache = new();
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Cache
    private static readonly TimeSpan TariffCacheExpiry = TimeSpan.FromMinutes(30);
    private static readonly TimeSpan SettingsCacheExpiry = TimeSpan.FromMinutes(60);
    private static readonly TimeSpan CalculationCacheExpiry = TimeSpan.FromMinutes(15);
}
```

#### **Ù…ØªØ¯Ù‡Ø§ÛŒ Cache**

##### **GetCachedSupplementaryTariffsAsync**
```csharp
public async Task<ServiceResult<List<SupplementaryTariffViewModel>>> GetCachedSupplementaryTariffsAsync(int planId)
{
    var cacheKey = $"tariffs_{planId}";
    
    // Ø¨Ø±Ø±Ø³ÛŒ Cache
    if (_tariffCache.ContainsKey(cacheKey) && 
        _tariffCache[cacheKey].ExpiresAt > DateTime.UtcNow)
    {
        return ServiceResult<List<SupplementaryTariffViewModel>>.Successful(
            _tariffCache[cacheKey].Data);
    }
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Database
    var tariffs = await _tariffRepository.GetByPlanIdAsync(planId);
    var supplementaryTariffs = tariffs
        .Where(t => t.InsuranceType == InsuranceType.Supplementary)
        .Select(t => new SupplementaryTariffViewModel
        {
            TariffId = t.InsuranceTariffId,
            PlanId = t.InsurancePlanId,
            ServiceId = t.ServiceId,
            ServiceName = t.Service?.Title,
            CoveragePercent = t.SupplementaryCoveragePercent ?? 0,
            MaxPayment = t.SupplementaryMaxPayment ?? 0,
            Settings = t.SupplementarySettings
        })
        .ToList();
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Cache
    _tariffCache[cacheKey] = new CachedTariffData
    {
        Data = supplementaryTariffs,
        ExpiresAt = DateTime.UtcNow.Add(TariffCacheExpiry)
    };
    
    return ServiceResult<List<SupplementaryTariffViewModel>>.Successful(supplementaryTariffs);
}
```

---

## ğŸ“Š **Monitoring Ùˆ Logging**

### **SupplementaryInsuranceMonitoringService**

#### **Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Monitoring**
```csharp
public class CalculationEvent
{
    public int PatientId { get; set; }
    public int ServiceId { get; set; }
    public decimal ServiceAmount { get; set; }
    public decimal PrimaryCoverage { get; set; }
    public decimal SupplementaryCoverage { get; set; }
    public decimal FinalPatientShare { get; set; }
    public long Duration { get; set; }
    public bool Success { get; set; }
    public string ErrorMessage { get; set; }
    public DateTime CalculationDate { get; set; }
}
```

#### **Ù…ØªØ¯Ù‡Ø§ÛŒ Monitoring**

##### **LogCalculationEvent**
```csharp
public void LogCalculationEvent(CalculationEvent calculationEvent)
{
    try
    {
        if (calculationEvent.Success)
        {
            _logger.Information("âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙÙ‚ - PatientId: {PatientId}, Duration: {Duration}ms",
                calculationEvent.PatientId, calculationEvent.Duration);
        }
        else
        {
            _logger.Error("âŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ - PatientId: {PatientId}, Error: {Error}",
                calculationEvent.PatientId, calculationEvent.ErrorMessage);
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
        _calculationEvents.Add(calculationEvent);
    }
    catch (Exception ex)
    {
        _logger.Error(ex, "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡");
    }
}
```

##### **GetPerformanceReport**
```csharp
public PerformanceReport GetPerformanceReport(DateTime? fromDate = null, DateTime? toDate = null)
{
    var from = fromDate ?? DateTime.UtcNow.AddDays(-30);
    var to = toDate ?? DateTime.UtcNow;
    
    var eventsInRange = _calculationEvents
        .Where(e => e.CalculationDate >= from && e.CalculationDate <= to)
        .ToList();
    
    var report = new PerformanceReport
    {
        FromDate = from,
        ToDate = to,
        GeneratedAt = DateTime.UtcNow,
        TotalCalculations = eventsInRange.Count,
        SuccessfulCalculations = eventsInRange.Count(e => e.Success),
        FailedCalculations = eventsInRange.Count(e => !e.Success),
        AverageDuration = eventsInRange.Any() ? 
            eventsInRange.Average(e => e.Duration) : 0,
        SuccessRate = eventsInRange.Any() ? 
            (double)eventsInRange.Count(e => e.Success) / eventsInRange.Count * 100 : 0
    };
    
    return report;
}
```

---

## ğŸ—„ï¸ **Database Schema**

### **Ø¬Ø¯ÙˆÙ„ InsuranceTariffs**
```sql
CREATE TABLE InsuranceTariffs (
    InsuranceTariffId INT IDENTITY(1,1) PRIMARY KEY,
    InsurancePlanId INT NOT NULL,
    ServiceId INT NOT NULL,
    InsuranceType INT NOT NULL, -- 1: Primary, 2: Supplementary
    SupplementarySettings NVARCHAR(2000) NULL,
    SupplementaryCoveragePercent DECIMAL(5,2) NULL,
    SupplementaryMaxPayment DECIMAL(18,2) NULL,
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2 NOT NULL,
    CreatedByUserId NVARCHAR(450) NOT NULL,
    UpdatedByUserId NVARCHAR(450) NOT NULL,
    IsDeleted BIT NOT NULL DEFAULT 0,
    
    CONSTRAINT FK_InsuranceTariffs_InsurancePlans 
        FOREIGN KEY (InsurancePlanId) REFERENCES InsurancePlans(InsurancePlanId),
    CONSTRAINT FK_InsuranceTariffs_Services 
        FOREIGN KEY (ServiceId) REFERENCES Services(ServiceId)
);

-- Indexes
CREATE INDEX IX_InsuranceTariff_InsuranceType ON InsuranceTariffs(InsuranceType);
CREATE INDEX IX_InsuranceTariff_SupplementaryCoveragePercent ON InsuranceTariffs(SupplementaryCoveragePercent);
CREATE INDEX IX_InsuranceTariff_SupplementaryMaxPayment ON InsuranceTariffs(SupplementaryMaxPayment);
```

### **Migration Script**
```csharp
public partial class AddSupplementaryInsuranceFields : DbMigration
{
    public override void Up()
    {
        AddColumn("dbo.InsuranceTariffs", "InsuranceType", c => c.Int(nullable: false, defaultValue: 1));
        AddColumn("dbo.InsuranceTariffs", "SupplementarySettings", c => c.String(maxLength: 2000));
        AddColumn("dbo.InsuranceTariffs", "SupplementaryCoveragePercent", c => c.Decimal(precision: 5, scale: 2));
        AddColumn("dbo.InsuranceTariffs", "SupplementaryMaxPayment", c => c.Decimal(precision: 18, scale: 2));
        
        CreateIndex("dbo.InsuranceTariffs", "InsuranceType", name: "IX_InsuranceTariff_InsuranceType");
        CreateIndex("dbo.InsuranceTariffs", "SupplementaryCoveragePercent", name: "IX_InsuranceTariff_SupplementaryCoveragePercent");
        CreateIndex("dbo.InsuranceTariffs", "SupplementaryMaxPayment", name: "IX_InsuranceTariff_SupplementaryMaxPayment");
    }
    
    public override void Down()
    {
        DropIndex("dbo.InsuranceTariffs", "IX_InsuranceTariff_SupplementaryMaxPayment");
        DropIndex("dbo.InsuranceTariffs", "IX_InsuranceTariff_SupplementaryCoveragePercent");
        DropIndex("dbo.InsuranceTariffs", "IX_InsuranceTariff_InsuranceType");
        
        DropColumn("dbo.InsuranceTariffs", "SupplementaryMaxPayment");
        DropColumn("dbo.InsuranceTariffs", "SupplementaryCoveragePercent");
        DropColumn("dbo.InsuranceTariffs", "SupplementarySettings");
        DropColumn("dbo.InsuranceTariffs", "InsuranceType");
    }
}
```

---

## ğŸ”’ **Ø§Ù…Ù†ÛŒØª**

### **Authentication & Authorization**
```csharp
[Authorize(Roles = "Admin,Doctor,Reception")]
public class PatientInsuranceController : BaseController
{
    [HttpPost]
    [ValidateAntiForgeryToken]
    [Authorize(Roles = "Admin,Doctor")]
    public async Task<ActionResult> CalculateSupplementaryInsurance(SupplementaryCalculationRequest request)
    {
        // Implementation
    }
}
```

### **Input Validation**
```csharp
public class SupplementaryCalculationRequestValidator : AbstractValidator<SupplementaryCalculationRequest>
{
    public SupplementaryCalculationRequestValidator()
    {
        RuleFor(x => x.PatientId)
            .GreaterThan(0)
            .WithMessage("Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
            
        RuleFor(x => x.ServiceId)
            .GreaterThan(0)
            .WithMessage("Ø´Ù†Ø§Ø³Ù‡ Ø®Ø¯Ù…Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
            
        RuleFor(x => x.ServiceAmount)
            .GreaterThan(0)
            .WithMessage("Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Øª Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯");
            
        RuleFor(x => x.PrimaryCoverage)
            .GreaterThanOrEqualTo(0)
            .WithMessage("Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯");
    }
}
```

---

## âš¡ **Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯**

### **Query Optimization**
```csharp
// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Include Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ Query Ù‡Ø§
var tariffs = await _context.InsuranceTariffs
    .Include(t => t.Service)
    .Include(t => t.InsurancePlan)
    .Where(t => t.InsurancePlanId == planId && 
                t.InsuranceType == InsuranceType.Supplementary)
    .ToListAsync();
```

### **Async/Await Pattern**
```csharp
public async Task<ServiceResult<SupplementaryCalculationResult>> CalculateAsync(
    int patientId, int serviceId, decimal serviceAmount, decimal primaryCoverage)
{
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² async/await Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª I/O
    var patientInsurance = await _patientInsuranceRepository
        .GetSupplementaryByPatientIdAsync(patientId);
        
    var tariffs = await _tariffRepository
        .GetByPlanIdAsync(patientInsurance.InsurancePlanId);
        
    // Ù…Ø­Ø§Ø³Ø¨Ø§Øª CPU-intensive
    var result = await Task.Run(() => 
        PerformCalculation(patientInsurance, tariffs, serviceAmount, primaryCoverage));
        
    return result;
}
```

### **Memory Management**
```csharp
public class SupplementaryInsuranceCacheService : IDisposable
{
    private readonly Timer _cleanupTimer;
    
    public SupplementaryInsuranceCacheService()
    {
        // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Cache Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
        _cleanupTimer = new Timer(CleanupExpiredCache, null, 
            TimeSpan.FromMinutes(5), TimeSpan.FromMinutes(5));
    }
    
    private void CleanupExpiredCache(object state)
    {
        var now = DateTime.UtcNow;
        var expiredKeys = _tariffCache
            .Where(kvp => kvp.Value.ExpiresAt <= now)
            .Select(kvp => kvp.Key)
            .ToList();
            
        foreach (var key in expiredKeys)
        {
            _tariffCache.Remove(key);
        }
    }
    
    public void Dispose()
    {
        _cleanupTimer?.Dispose();
    }
}
```

---

## ğŸ§ª **Testing Strategy**

### **Unit Tests**
```csharp
[Test]
public async Task CalculateSupplementaryInsuranceAsync_WithValidData_ShouldReturnSuccessfulResult()
{
    // Arrange
    var patientId = 1;
    var serviceId = 1;
    var serviceAmount = 1000000m;
    var primaryCoverage = 500000m;
    var calculationDate = DateTime.UtcNow;
    
    var supplementaryInsurance = new List<PatientInsurance>
    {
        new PatientInsurance { PatientId = patientId, InsurancePlanId = 1, IsActive = true }
    };
    
    var tariffs = new List<InsuranceTariff>
    {
        new InsuranceTariff 
        { 
            ServiceId = serviceId, 
            InsuranceType = InsuranceType.Supplementary,
            SupplementaryCoveragePercent = 50,
            SupplementaryMaxPayment = 200000
        }
    };
    
    _mockPatientInsuranceRepository
        .Setup(x => x.GetSupplementaryByPatientIdAsync(patientId))
        .ReturnsAsync(supplementaryInsurance);
        
    _mockTariffRepository
        .Setup(x => x.GetByPlanIdAsync(1))
        .ReturnsAsync(tariffs);
    
    // Act
    var result = await _service.CalculateSupplementaryInsuranceAsync(
        patientId, serviceId, serviceAmount, primaryCoverage, calculationDate);
    
    // Assert
    Assert.True(result.Success);
    Assert.NotNull(result.Data);
    Assert.Equal(250000m, result.Data.SupplementaryCoverage);
    Assert.Equal(250000m, result.Data.FinalPatientShare);
}
```

### **Integration Tests**
```csharp
[Test]
public async Task CompleteCalculationFlow_WithValidData_ShouldWorkEndToEnd()
{
    // Arrange
    SetupTestData();
    
    // Act
    var result = await _supplementaryService.CalculateSupplementaryInsuranceAsync(
        1, 1, 2000000m, 800000m, DateTime.UtcNow);
    
    // Assert
    Assert.True(result.Success);
    Assert.NotNull(result.Data);
    
    // Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ù…Ø­Ø§Ø³Ø¨Ø§Øª
    var remainingAmount = 2000000m - 800000m;
    var expectedSupplementaryCoverage = Math.Min(remainingAmount * 0.6m, 500000m);
    Assert.Equal(expectedSupplementaryCoverage, result.Data.SupplementaryCoverage);
}
```

---

## ğŸ“ˆ **Monitoring Ùˆ Alerting**

### **Health Checks**
```csharp
public class SupplementaryInsuranceHealthCheck : IHealthCheck
{
    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Database
            var canConnect = await _context.Database.CanConnectAsync(cancellationToken);
            if (!canConnect)
            {
                return HealthCheckResult.Unhealthy("Database connection failed");
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Cache
            var cacheStats = _cacheService.GetCacheStatistics();
            if (cacheStats.CacheErrors > 10)
            {
                return HealthCheckResult.Degraded($"Cache errors: {cacheStats.CacheErrors}");
            }
            
            return HealthCheckResult.Healthy("All systems operational");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("Health check failed", ex);
        }
    }
}
```

### **Performance Counters**
```csharp
public class PerformanceCounters
{
    private static readonly Counter _calculationCounter = 
        Metrics.CreateCounter("supplementary_calculations_total", "Total calculations");
        
    private static readonly Histogram _calculationDuration = 
        Metrics.CreateHistogram("supplementary_calculation_duration_seconds", "Calculation duration");
        
    private static readonly Gauge _activeCalculations = 
        Metrics.CreateGauge("supplementary_active_calculations", "Active calculations");
    
    public void RecordCalculation(bool success, double duration)
    {
        _calculationCounter.Inc(new[] { new KeyValuePair<string, string>("success", success.ToString()) });
        _calculationDuration.Observe(duration);
    }
}
```

---

## ğŸ”„ **Deployment Ùˆ Configuration**

### **Configuration Settings**
```json
{
  "SupplementaryInsurance": {
    "CacheSettings": {
      "TariffCacheExpiryMinutes": 30,
      "SettingsCacheExpiryMinutes": 60,
      "CalculationCacheExpiryMinutes": 15,
      "MaxCacheSize": 1000
    },
    "MonitoringSettings": {
      "EnableLogging": true,
      "LogLevel": "Information",
      "EnablePerformanceCounters": true,
      "AlertThresholds": {
        "ErrorRate": 5.0,
        "ResponseTime": 2000,
        "MemoryUsage": 80.0
      }
    },
    "CalculationSettings": {
      "MaxCalculationTime": 5000,
      "EnableAdvancedSettings": true,
      "DefaultCoveragePercent": 50,
      "DefaultMaxPayment": 100000
    }
  }
}
```

### **Dependency Injection Configuration**
```csharp
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddSupplementaryInsuranceServices(this IServiceCollection services)
    {
        services.AddScoped<ISupplementaryInsuranceService, SupplementaryInsuranceService>();
        services.AddScoped<ISupplementaryInsuranceCacheService, SupplementaryInsuranceCacheService>();
        services.AddScoped<ISupplementaryInsuranceMonitoringService, SupplementaryInsuranceMonitoringService>();
        
        services.AddSingleton<IMemoryCache, MemoryCache>();
        services.AddHealthChecks()
            .AddCheck<SupplementaryInsuranceHealthCheck>("supplementary-insurance");
            
        return services;
    }
}
```

---

**Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ**: 15 Ø¯ÛŒ 1403  
**Ù†Ø³Ø®Ù‡**: 1.0.0  
**Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡**: ØªÛŒÙ… ØªÙˆØ³Ø¹Ù‡ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ù…Ø§Ù†ÛŒ
