@model ClinicApp.ViewModels.SharedServiceCreateEditViewModel
@{
    ViewBag.Title = "Ø§ÙØ²ÙˆØ¯Ù† Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú© Ø¬Ø¯ÛŒØ¯";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus"></i>
                        Ø§ÙØ²ÙˆØ¯Ù† Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú© Ø¬Ø¯ÛŒØ¯
                    </h4>
                    <p class="mb-0">ØªØ¹Ø±ÛŒÙ Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú© Ø¨ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i>
                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                    </h5>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Create", "SharedService", FormMethod.Post, new { @class = "form-horizontal" }))
                    {
                        @Html.AntiForgeryToken()

                       if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:</h6>
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            </div>
                        }

                        <div class="row">
                            <!-- Service Selection -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.ServiceId, htmlAttributes: new { @class = "control-label required" })
                                    @Html.DropDownListFor(model => model.ServiceId, Model.Services, "Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª...", new { @class = "form-control", @required = "required" })
                                    @Html.ValidationMessageFor(model => model.ServiceId, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø®Ø¯Ù…ØªÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ Ù…Ø´ØªØ±Ú© Ø¨Ø§Ø´Ø¯</small>
                                </div>
                            </div>

                            <!-- Department Selection -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.DepartmentId, htmlAttributes: new { @class = "control-label required" })
                                    @Html.DropDownListFor(model => model.DepartmentId, Model.Departments, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†...", new { @class = "form-control", @required = "required" })
                                    @Html.ValidationMessageFor(model => model.DepartmentId, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª Ø¯Ø± Ø¢Ù† Ù…Ø´ØªØ±Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Active Status -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="form-check">
                                        @Html.CheckBoxFor(model => model.IsActive, new { @class = "form-check-input" })
                                        @Html.LabelFor(model => model.IsActive, htmlAttributes: new { @class = "form-check-label" })
                                    </div>
                                    <small class="form-text text-muted">Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú© ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŸ</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Override Technical Factor -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.OverrideTechnicalFactor, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextBoxFor(model => model.OverrideTechnicalFactor, new { @class = "form-control", @type = "number", @step = "0.01", @placeholder = "Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ Override (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" })
                                    @Html.ValidationMessageFor(model => model.OverrideTechnicalFactor, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>

                            <!-- Override Professional Factor -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.OverrideProfessionalFactor, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextBoxFor(model => model.OverrideProfessionalFactor, new { @class = "form-control", @type = "number", @step = "0.01", @placeholder = "Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Override (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" })
                                    @Html.ValidationMessageFor(model => model.OverrideProfessionalFactor, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Department Specific Notes -->
                            <div class="col-12">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.DepartmentSpecificNotes, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextAreaFor(model => model.DepartmentSpecificNotes, new { @class = "form-control", rows = 4, placeholder = "ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†..." })
                                    @Html.ValidationMessageFor(model => model.DepartmentSpecificNotes, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>
                        </div>

        <!-- Price Calculation Section -->
        <div class="row" id="price-calculation-section" style="display: none;">
            <div class="col-12">
                <div class="card border-2" id="price-calculation-card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-calculator"></i>
                            Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Ù‚ÛŒÙ…Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡:</label>
                                    <div class="input-group input-group-lg">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-success text-white">
                                                <i class="fas fa-money-bill-wave"></i> Ø±ÛŒØ§Ù„
                                            </span>
                                        </div>
                                        <input type="text" class="form-control text-success font-weight-bold" id="calculated-price" readonly style="font-size: 1.2em;">
                                    </div>
                                    <small class="form-text text-muted">Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…ÙˆÙ„ ÙˆØ²Ø§Ø±Øª Ø¨Ù‡Ø¯Ø§Ø´Øª</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡:</label>
                                    <div id="calculation-details" class="border rounded p-3 bg-light" style="min-height: 120px;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-info btn-sm" id="calculate-price-btn">
                                    <i class="fas fa-calculator"></i>
                                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ù‚ÛŒÙ…Øª
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm ml-2" onclick="clearCalculation()">
                                    <i class="fas fa-eraser"></i>
                                    Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                        <!-- Form Actions -->
                        <div class="form-group">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i>
                                        Ø°Ø®ÛŒØ±Ù‡ Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i>
                                        Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù…
                                    </button>
                                </div>
                                <div>
                                    <a href="@Url.Action("Index")" class="btn btn-light">
                                        <i class="fas fa-arrow-right"></i>
                                        Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Ù‡Ø± Ø®Ø¯Ù…Øª ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø¯Ø± Ù‡Ø± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù‚Ø§Ø¨Ù„ ØªØ¹Ø±ÛŒÙ Ø§Ø³Øª</li>
                                <li><i class="fas fa-check text-success"></i> Ø®Ø¯Ù…Ø§Øª Ù…Ø´ØªØ±Ú© Ø¯Ø± ØªÙ…Ø§Ù… Ø³ÛŒØ³ØªÙ… Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù‡Ø³ØªÙ†Ø¯</li>
                                <li><i class="fas fa-check text-success"></i> Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®Ø¯Ù…Ø§Øª Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ ÙØ¹Ø§Ù„ ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-question-circle text-info"></i> Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„:</h6>
                            <ul class="list-unstyled">
                                <li><strong>Ø³ÙˆØ§Ù„:</strong> Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ÛŒÚ© Ø®Ø¯Ù…Øª Ø±Ø§ Ø¯Ø± Ú†Ù†Ø¯ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† ØªØ¹Ø±ÛŒÙ Ú©Ù†Ù…ØŸ</li>
                                <li><strong>Ù¾Ø§Ø³Ø®:</strong> Ø¨Ù„Ù‡ØŒ Ù‡Ø± Ø®Ø¯Ù…Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± Ú†Ù†Ø¯ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ø´ØªØ±Ú© Ø¨Ø§Ø´Ø¯</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
            $('form').on('submit', function(e) {
                var isValid = true;
                var errors = [];

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª
                if (!$('#ServiceId').val()) {
                    errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
                if (!$('#DepartmentId').val()) {
                    errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                // Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù†
                if ($('#ServiceId').val() && $('#DepartmentId').val()) {
                    // Ø§ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯:\n' + errors.join('\n'));
                }
            });

            // ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª - Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª
            $('#ServiceId').change(function() {
                var serviceId = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª - ServiceId:', serviceId);
                if (serviceId) {
                    console.log('âœ… [BROWSER] Ø®Ø¯Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', serviceId);
                    checkAndShowPriceCalculation();
                } else {
                    console.log('âŒ [BROWSER] Ø®Ø¯Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
                }
            });

            // ØªØºÛŒÛŒØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† - Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
            $('#DepartmentId').change(function() {
                var departmentId = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† - DepartmentId:', departmentId);
                if (departmentId) {
                    console.log('âœ… [BROWSER] Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', departmentId);
                    checkAndShowPriceCalculation();
                } else {
                    console.log('âŒ [BROWSER] Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
                }
            });

            // ØªØºÛŒÛŒØ± Ø¶Ø±Ø§ÛŒØ¨ Override
            $('#OverrideTechnicalFactor, #OverrideProfessionalFactor').on('input', function() {
                var fieldName = $(this).attr('id');
                var fieldValue = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯ Override - Field:', fieldName, 'Value:', fieldValue);
                
                if ($('#ServiceId').val() && $('#DepartmentId').val()) {
                    console.log('âœ… [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªØºÛŒÛŒØ± Override');
                    calculatePrice();
                } else {
                    console.log('âŒ [BROWSER] Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø±Ø¯ - ServiceId ÛŒØ§ DepartmentId Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                }
            });

            // Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            $('#calculate-price-btn').click(function() {
                console.log('ğŸ”˜ [BROWSER] Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª');
                calculatePrice();
            });

            // Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            function checkAndShowPriceCalculation() {
                var serviceId = $('#ServiceId').val();
                var departmentId = $('#DepartmentId').val();
                
                console.log('ğŸ” [BROWSER] Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                console.log('ğŸ” [BROWSER] ServiceId:', serviceId, 'DepartmentId:', departmentId);
                
                if (serviceId && departmentId) {
                    console.log('âœ… [BROWSER] Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                    $('#price-calculation-section').show();
                    calculatePrice();
                } else {
                    console.log('âŒ [BROWSER] Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                    $('#price-calculation-section').hide();
                }
            }

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            function calculatePrice() {
                var serviceId = $('#ServiceId').val();
                var departmentId = $('#DepartmentId').val();
                var overrideTechnicalFactor = $('#OverrideTechnicalFactor').val();
                var overrideProfessionalFactor = $('#OverrideProfessionalFactor').val();

                console.log('ğŸš€ [BROWSER] Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª');
                console.log('ğŸš€ [BROWSER] ServiceId:', serviceId);
                console.log('ğŸš€ [BROWSER] DepartmentId:', departmentId);
                console.log('ğŸš€ [BROWSER] Override Technical Factor:', overrideTechnicalFactor);
                console.log('ğŸš€ [BROWSER] Override Professional Factor:', overrideProfessionalFactor);

                if (!serviceId || !departmentId) {
                    console.log('âŒ [BROWSER] ServiceId ÛŒØ§ DepartmentId Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                    return;
                }

                console.log('ğŸ“¡ [BROWSER] Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX...');
                $.ajax({
                    url: '@Url.Action("CalculateSharedServicePriceForCreate")',
                    type: 'POST',
                    data: {
                        serviceId: serviceId,
                        departmentId: departmentId,
                        overrideTechnicalFactor: overrideTechnicalFactor,
                        overrideProfessionalFactor: overrideProfessionalFactor
                    },
                    success: function(response) {
                        console.log('âœ… [BROWSER] Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ±');
                        console.log('ğŸ“Š [BROWSER] Raw Response:', response);
                        console.log('ğŸ“Š [BROWSER] Response Type:', typeof response);
                        
                        // Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('ğŸ”„ [BROWSER] Response parsed successfully');
                            } catch (parseError) {
                                console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† response:', parseError);
                                $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø®');
                                $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±</div>');
                                return;
                            }
                        }
                        
                        console.log('ğŸ“Š [BROWSER] Parsed Response:', parsedResponse);
                        console.log('ğŸ“Š [BROWSER] Response Success:', parsedResponse ? parsedResponse.success : 'undefined');
                        
                        try {
                            if (parsedResponse && parsedResponse.success) {
                                console.log('âœ… [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙÙ‚');
                                console.log('ğŸ’° [BROWSER] Calculated Price:', parsedResponse.calculatedPrice);
                                console.log('ğŸ”§ [BROWSER] Technical Component:', parsedResponse.technicalComponent);
                                console.log('ğŸ‘¨â€âš•ï¸ [BROWSER] Professional Component:', parsedResponse.professionalComponent);
                                console.log('ğŸ”§ [BROWSER] Technical Factor:', parsedResponse.technicalFactor);
                                console.log('ğŸ‘¨â€âš•ï¸ [BROWSER] Professional Factor:', parsedResponse.professionalFactor);
                                console.log('ğŸ“ [BROWSER] Calculation Formula:', parsedResponse.calculationFormula);
                                console.log('ğŸ”„ [BROWSER] Has Override:', parsedResponse.hasOverride);
                                console.log('ğŸ“… [BROWSER] Financial Year:', parsedResponse.financialYear);
                                // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª Ø¨Ø§ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†
                                console.log('ğŸ¨ [BROWSER] ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª...');
                                var formattedPrice = new Intl.NumberFormat('fa-IR').format(parsedResponse.calculatedPrice);
                                console.log('ğŸ¨ [BROWSER] Formatted Price:', formattedPrice);
                                $('#calculated-price').val(formattedPrice);
                                
                                // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡
                                console.log('ğŸ¨ [BROWSER] Ø§ÛŒØ¬Ø§Ø¯ HTML Ø¬Ø²Ø¦ÛŒØ§Øª...');
                                var detailsHtml = '<div class="calculation-details">' +
                                    '<strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡:</strong><br>' +
                                    '<div class="row mt-2">' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¬Ø²Ø¡ ÙÙ†ÛŒ:</small><br>' +
                                    '<strong>' + parsedResponse.technicalComponent + '</strong>' +
                                    '</div>' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¬Ø²Ø¡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:</small><br>' +
                                    '<strong>' + parsedResponse.professionalComponent + '</strong>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="row mt-2">' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ:</small><br>' +
                                    '<strong>' + new Intl.NumberFormat('fa-IR').format(parsedResponse.technicalFactor) + '</strong>' +
                                    '</div>' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:</small><br>' +
                                    '<strong>' + new Intl.NumberFormat('fa-IR').format(parsedResponse.professionalFactor) + '</strong>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="mt-2">' +
                                    '<small class="text-muted">ÙØ±Ù…ÙˆÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡:</small><br>' +
                                    '<code>' + parsedResponse.calculationFormula + '</code>' +
                                    '</div>';
                                
                                if (parsedResponse.hasOverride) {
                                    detailsHtml += '<div class="mt-2"><span class="badge badge-warning">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¶Ø±Ø§ÛŒØ¨ Override</span></div>';
                                }
                                
                                detailsHtml += '</div>';
                                console.log('ğŸ¨ [BROWSER] HTML Ø¬Ø²Ø¦ÛŒØ§Øª:', detailsHtml);
                                $('#calculation-details').html(detailsHtml);
                                
                                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª
                                console.log('âœ… [BROWSER] Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± UI');
                                $('#price-calculation-section').removeClass('border-danger').addClass('border-success');
                            } else {
                                console.log('âŒ [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚');
                                console.log('âŒ [BROWSER] Error Message:', parsedResponse ? parsedResponse.message : 'undefined');
                                $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡');
                                $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§: ' + (parsedResponse.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ') + '</div>');
                                $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                            }
                        } catch (e) {
                            console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ response:', e);
                            console.error('âŒ [BROWSER] Error Stack:', e.stack);
                            $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´');
                            $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡</div>');
                            $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± AJAX:');
                        console.error('âŒ [BROWSER] XHR:', xhr);
                        console.error('âŒ [BROWSER] Status:', status);
                        console.error('âŒ [BROWSER] Error:', error);
                        console.error('âŒ [BROWSER] Response Text:', xhr.responseText);
                        $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·');
                        $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error + '</div>');
                        $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                    }
                });
            }
        });

        function resetForm() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.')) {
                $('form')[0].reset();
                $('#ServiceId').val('').trigger('change');
                $('#DepartmentId').val('').trigger('change');
                $('#OverrideTechnicalFactor').val('');
                $('#OverrideProfessionalFactor').val('');
                clearCalculation();
            }
        }

        function clearCalculation() {
            $('#calculated-price').val('');
            $('#calculation-details').html(
                '<div class="text-center text-muted">' +
                '<i class="fas fa-info-circle"></i>' +
                ' Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' +
                '</div>'
            );
            $('#price-calculation-section').hide();
            $('#price-calculation-card').removeClass('border-success border-danger');
        }
    </script>
}
