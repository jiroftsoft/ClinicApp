@model ClinicApp.ViewModels.SharedServiceIndexPageViewModel
@{
    ViewBag.Title = "مدیریت خدمات مشترک";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-share-alt"></i>
                        مدیریت خدمات مشترک
                    </h4>
                    <p class="mb-0">مدیریت خدمات مشترک بین دپارتمان‌ها</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        آمار کلی
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TotalSharedServices</h3>
                                    <p class="card-text">کل خدمات مشترک</p>
                                    <i class="fas fa-share-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.ActiveSharedServices</h3>
                                    <p class="card-text">خدمات فعال</p>
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.InactiveSharedServices</h3>
                                    <p class="card-text">خدمات غیرفعال</p>
                                    <i class="fas fa-pause-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.AverageServicesPerDepartment.ToString("F1")</h3>
                                    <p class="card-text">میانگین خدمات/دپارتمان</p>
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- آمار اضافی -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">@Model.Statistics.TotalDepartments</h5>
                                    <p class="card-text">کل دپارتمان‌ها</p>
                                    <i class="fas fa-building fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">@Model.Statistics.TotalServices</h5>
                                    <p class="card-text">کل خدمات</p>
                                    <i class="fas fa-stethoscope fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-warning">@Model.Statistics.ServicesWithOverride</h5>
                                    <p class="card-text">خدمات با Override</p>
                                    <i class="fas fa-cog fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i>
                        فیلترها
                    </h5>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Index", "SharedService", FormMethod.Get, new { @class = "form-inline" }))
                    {
                        <div class="form-group mr-3">
                            <label for="searchTerm" class="sr-only">جستجو</label>
                            @Html.TextBox("searchTerm", Model.Filter.SearchTerm, new { @class = "form-control", placeholder = "جستجو در عنوان، کد، دپارتمان..." })
                        </div>

                        <div class="form-group mr-3">
                            <label for="departmentId" class="sr-only">دپارتمان</label>
                            @Html.DropDownList("departmentId", Model.Filter.Departments, "همه دپارتمان‌ها", new { @class = "form-control" })
                        </div>

                        <div class="form-group mr-3">
                            <label for="serviceId" class="sr-only">خدمت</label>
                            @Html.DropDownList("serviceId", Model.Filter.Services, "همه خدمات", new { @class = "form-control" })
                        </div>

                        <div class="form-group mr-3">
                            <label for="isActive" class="sr-only">وضعیت</label>
                            @Html.DropDownList("isActive", Model.Filter.StatusOptions, new { @class = "form-control" })
                        </div>

                        <div class="form-group mr-3">
                            <label for="pageSize" class="sr-only">تعداد در صفحه</label>
                            @Html.DropDownList("pageSize", Model.Filter.PageSizeOptions, new { @class = "form-control" })
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            جستجو
                        </button>

                        <a href="@Url.Action("Index")" class="btn btn-secondary mr-2">
                            <i class="fas fa-refresh"></i>
                            پاک کردن فیلترها
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        آمار کلی
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="statistics-container">
                        <div class="col-md-3">
                            <div class="info-box bg-info">
                                <span class="info-box-icon"><i class="fas fa-share-alt"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">کل خدمات مشترک</span>
                                    <span class="info-box-number" id="total-shared-services">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-success">
                                <span class="info-box-icon"><i class="fas fa-check-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">خدمات فعال</span>
                                    <span class="info-box-number" id="active-shared-services">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-warning">
                                <span class="info-box-icon"><i class="fas fa-pause-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">خدمات غیرفعال</span>
                                    <span class="info-box-number" id="inactive-shared-services">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box bg-primary">
                                <span class="info-box-icon"><i class="fas fa-building"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">میانگین خدمات/دپارتمان</span>
                                    <span class="info-box-number" id="average-services-per-department">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i>
                            لیست خدمات مشترک
                        </h5>
                        <a href="@Url.Action("Create")" class="btn btn-success">
                            <i class="fas fa-plus"></i>
                            افزودن خدمت مشترک جدید
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.SharedServices.Items.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>شناسه</th>
                                        <th>خدمت</th>
                                        <th>دپارتمان</th>
                                        <th>وضعیت</th>
                                        <th>توضیحات</th>
                                        <th>تاریخ ایجاد</th>
                                        <th>ایجادکننده</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.SharedServices.Items)
                                    {
                                        <tr>
                                            <td>@item.SharedServiceId</td>
                                            <td>
                                                <strong>@item.ServiceTitle</strong>
                                                <br>
                                                <small class="text-muted">@item.ServiceCode</small>
                                            </td>
                                            <td>
                                                <strong>@item.DepartmentName</strong>
                                            </td>
                                            <td>
                                                <span class="badge @(item.IsActive ? "badge-success" : "badge-warning")">
                                                    @item.IsActiveText
                                                </span>
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.DepartmentSpecificNotes))
                                                {
                                                    <span title="@item.DepartmentSpecificNotes">
                                                        @(item.DepartmentSpecificNotes.Length > 50 ? item.DepartmentSpecificNotes.Substring(0, 50) + "..." : item.DepartmentSpecificNotes)
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @item.CreatedAtShamsi
                                            </td>
                                            <td>
                                                @item.CreatedByUserName
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="@Url.Action("Details", new { id = item.SharedServiceId })" class="btn btn-info btn-sm" title="جزئیات">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="@Url.Action("Edit", new { id = item.SharedServiceId })" class="btn btn-warning btn-sm" title="ویرایش">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" class="btn @(item.IsActive ? "btn-secondary" : "btn-success") btn-sm toggle-active" 
                                                            data-id="@item.SharedServiceId" data-active="@item.IsActive.ToString().ToLower()" 
                                                            title="@(item.IsActive ? "غیرفعال کردن" : "فعال کردن")">
                                                        <i class="fas @(item.IsActive ? "fa-pause" : "fa-play")"></i>
                                                    </button>
                                                    <a href="@Url.Action("Delete", new { id = item.SharedServiceId })" class="btn btn-danger btn-sm" title="حذف">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        if (Model.SharedServices.TotalPages > 1)
                        {
                            <nav aria-label="صفحه‌بندی">
                                <ul class="pagination justify-content-center">
                                    @if (Model.SharedServices.HasPreviousPage)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="@Url.Action("Index", new { page = Model.SharedServices.PageNumber - 1, pageSize = Model.Filter.PageSize, searchTerm = Model.Filter.SearchTerm, departmentId = Model.Filter.DepartmentId, serviceId = Model.Filter.ServiceId, isActive = Model.Filter.IsActive })">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    }

                                    @for (int i = Math.Max(1, Model.SharedServices.PageNumber - 2); i <= Math.Min(Model.SharedServices.TotalPages, Model.SharedServices.PageNumber + 2); i++)
                                    {
                                        <li class="page-item @(i == Model.SharedServices.PageNumber ? "active" : "")">
                                            <a class="page-link" href="@Url.Action("Index", new { page = i, pageSize = Model.Filter.PageSize, searchTerm = Model.Filter.SearchTerm, departmentId = Model.Filter.DepartmentId, serviceId = Model.Filter.ServiceId, isActive = Model.Filter.IsActive })">
                                                @i
                                            </a>
                                        </li>
                                    }

                                    @if (Model.SharedServices.HasNextPage)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="@Url.Action("Index", new { page = Model.SharedServices.PageNumber + 1, pageSize = Model.Filter.PageSize, searchTerm = Model.Filter.SearchTerm, departmentId = Model.Filter.DepartmentId, serviceId = Model.Filter.ServiceId, isActive = Model.Filter.IsActive })">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        }

                        <!-- Page Info -->
                        <div class="text-center text-muted">
                            نمایش @((Model.SharedServices.PageNumber - 1) * Model.SharedServices.PageSize + 1) تا @(Math.Min(Model.SharedServices.PageNumber * Model.SharedServices.PageSize, Model.SharedServices.TotalItems)) از @Model.SharedServices.TotalItems رکورد
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-share-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">هیچ خدمت مشترکی یافت نشد</h5>
                            <p class="text-muted">برای شروع، یک خدمت مشترک جدید ایجاد کنید</p>
                            <a href="@Url.Action("Create")" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                افزودن خدمت مشترک جدید
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // بارگذاری آمار
            loadStatistics();

            // مدیریت تغییر وضعیت فعال/غیرفعال
            $('.toggle-active').click(function() {
                var id = $(this).data('id');
                var isActive = $(this).data('active') === 'true';
                var newStatus = !isActive;

                if (confirm('آیا از تغییر وضعیت این خدمت مشترک اطمینان دارید؟')) {
                    $.ajax({
                        url: '@Url.Action("ToggleActive")',
                        type: 'POST',
                        data: { id: id, isActive: newStatus },
                        success: function(response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert('خطا: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('خطا در ارتباط با سرور');
                        }
                    });
                }
            });
        });

        function loadStatistics() {
            $.ajax({
                url: '@Url.Action("GetStatistics")',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        $('#total-shared-services').text(response.data.totalSharedServices);
                        $('#active-shared-services').text(response.data.activeSharedServices);
                        $('#inactive-shared-services').text(response.data.inactiveSharedServices);
                        $('#average-services-per-department').text(response.data.averageServicesPerDepartment.toFixed(1));
                    }
                },
                error: function() {
                    console.log('خطا در بارگذاری آمار');
                }
            });
        }
    </script>
}
