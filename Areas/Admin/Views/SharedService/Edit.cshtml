@model ClinicApp.ViewModels.SharedServiceCreateEditViewModel
@{
    ViewBag.Title = "ÙˆÛŒØ±Ø§ÛŒØ´ Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i>
                        ÙˆÛŒØ±Ø§ÛŒØ´ Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                    </h4>
                    <p class="mb-0">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i>
                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                    </h5>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Edit", "SharedService", FormMethod.Post, new { @class = "form-horizontal" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(model => model.SharedServiceId)

                        if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:</h6>
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            </div>
                        }

                        <div class="row">
                            <!-- Service Selection -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.ServiceId, htmlAttributes: new { @class = "control-label required" })
                                    @Html.DropDownListFor(model => model.ServiceId, Model.Services, "Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª...", new { @class = "form-control", @required = "required" })
                                    @Html.ValidationMessageFor(model => model.ServiceId, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø®Ø¯Ù…ØªÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ Ù…Ø´ØªØ±Ú© Ø¨Ø§Ø´Ø¯</small>
                                </div>
                            </div>

                            <!-- Department Selection -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.DepartmentId, htmlAttributes: new { @class = "control-label required" })
                                    @Html.DropDownListFor(model => model.DepartmentId, Model.Departments, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†...", new { @class = "form-control", @required = "required" })
                                    @Html.ValidationMessageFor(model => model.DepartmentId, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª Ø¯Ø± Ø¢Ù† Ù…Ø´ØªØ±Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Active Status -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="form-check">
                                        @Html.CheckBoxFor(model => model.IsActive, new { @class = "form-check-input" })
                                        @Html.LabelFor(model => model.IsActive, htmlAttributes: new { @class = "form-check-label" })
                                    </div>
                                    <small class="form-text text-muted">Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú© ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŸ</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Override Technical Factor -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.OverrideTechnicalFactor, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextBoxFor(model => model.OverrideTechnicalFactor, new { @class = "form-control", @type = "number", @step = "0.01", @placeholder = "Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ Override (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" })
                                    @Html.ValidationMessageFor(model => model.OverrideTechnicalFactor, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>

                            <!-- Override Professional Factor -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.OverrideProfessionalFactor, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextBoxFor(model => model.OverrideProfessionalFactor, new { @class = "form-control", @type = "number", @step = "0.01", @placeholder = "Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Override (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" })
                                    @Html.ValidationMessageFor(model => model.OverrideProfessionalFactor, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Department Specific Notes -->
                            <div class="col-12">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.DepartmentSpecificNotes, htmlAttributes: new { @class = "control-label" })
                                    @Html.TextAreaFor(model => model.DepartmentSpecificNotes, new { @class = "form-control", rows = 4, placeholder = "ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†..." })
                                    @Html.ValidationMessageFor(model => model.DepartmentSpecificNotes, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø§Øµ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÛŒÙ† Ø®Ø¯Ù…Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</small>
                                </div>
                            </div>
                        </div>

        <!-- Price Calculation Section -->
        <div class="row" id="price-calculation-section" style="display: none;">
            <div class="col-12">
                <div class="card border-2" id="price-calculation-card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-calculator"></i>
                            Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Ù‚ÛŒÙ…Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡:</label>
                                    <div class="input-group input-group-lg">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-success text-white">
                                                <i class="fas fa-money-bill-wave"></i> Ø±ÛŒØ§Ù„
                                            </span>
                                        </div>
                                        <input type="text" class="form-control text-success font-weight-bold" id="calculated-price" readonly style="font-size: 1.2em;">
                                    </div>
                                    <small class="form-text text-muted">Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…ÙˆÙ„ ÙˆØ²Ø§Ø±Øª Ø¨Ù‡Ø¯Ø§Ø´Øª</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡:</label>
                                    <div id="calculation-details" class="border rounded p-3 bg-light" style="min-height: 120px;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-info btn-sm" id="calculate-price-btn">
                                    <i class="fas fa-calculator"></i>
                                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ù‚ÛŒÙ…Øª
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm ml-2" onclick="clearCalculation()">
                                    <i class="fas fa-eraser"></i>
                                    Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                        <!-- Form Actions -->
                        <div class="form-group">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save"></i>
                                        Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®Ø¯Ù…Øª Ù…Ø´ØªØ±Ú©
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i>
                                        Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
                                    </button>
                                </div>
                                <div>
                                    <a href="@Url.Action("Details", new { id = Model.SharedServiceId })" class="btn btn-info">
                                        <i class="fas fa-eye"></i>
                                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                                    </a>
                                    <a href="@Url.Action("Index")" class="btn btn-light">
                                        <i class="fas fa-arrow-right"></i>
                                        Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Information Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i>
                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø¯ÛŒØ§Ø¨ÛŒ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-plus-circle text-success"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØ¬Ø§Ø¯:</h6>
                            <ul class="list-unstyled">
                                <li><strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</strong> @Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")</li>
                                <li><strong>Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡:</strong> @Model.CreatedByUserName</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-edit text-warning"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒØ±Ø§ÛŒØ´:</h6>
                            <ul class="list-unstyled">
                                @if (Model.UpdatedAt.HasValue)
                                {
                                    <li><strong>ØªØ§Ø±ÛŒØ® ÙˆÛŒØ±Ø§ÛŒØ´:</strong> @Model.UpdatedAt.Value.ToString("yyyy/MM/dd HH:mm")</li>
                                    <li><strong>ÙˆÛŒØ±Ø§ÛŒØ´â€ŒÚ©Ù†Ù†Ø¯Ù‡:</strong> @Model.UpdatedByUserName</li>
                                }
                                else
                                {
                                    <li><span class="text-muted">Ù‡Ù†ÙˆØ² ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span></li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª ÛŒØ§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø± Ø³Ø§ÛŒØ± Ø¨Ø®Ø´â€ŒÙ‡Ø§ ØªØ£Ø«ÛŒØ± Ø¨Ú¯Ø°Ø§Ø±Ø¯</li>
                                <li><i class="fas fa-check text-success"></i> ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø®Ø¯Ù…ØªØŒ Ø¢Ù† Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø®Ø¯Ù…Ø§Øª Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
                                <li><i class="fas fa-check text-success"></i> ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle text-danger"></i> Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-warning text-warning"></i> ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù‚ÛŒÙ…Øª ØªØ£Ø«ÛŒØ± Ø¨Ú¯Ø°Ø§Ø±Ø¯</li>
                                <li><i class="fas fa-warning text-warning"></i> ØªØºÛŒÛŒØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
            var initialValues = {
                serviceId: $('#ServiceId').val(),
                departmentId: $('#DepartmentId').val(),
                isActive: $('#IsActive').is(':checked'),
                notes: $('#DepartmentSpecificNotes').val(),
                overrideTechnicalFactor: $('#OverrideTechnicalFactor').val(),
                overrideProfessionalFactor: $('#OverrideProfessionalFactor').val()
            };

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡ Ø§Ú¯Ø± Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
            console.log('ğŸ”„ [BROWSER] Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡');
            if (initialValues.serviceId && initialValues.departmentId) {
                console.log('âœ… [BROWSER] Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ - Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                checkAndShowPriceCalculation();
            } else {
                console.log('âŒ [BROWSER] Ø®Ø¯Ù…Øª ÛŒØ§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ - Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                $('#price-calculation-section').hide();
            }

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
            $('form').on('submit', function(e) {
                var isValid = true;
                var errors = [];

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª
                if (!$('#ServiceId').val()) {
                    errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
                if (!$('#DepartmentId').val()) {
                    errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯:\n' + errors.join('\n'));
                }
            });

            // ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª - Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª
            $('#ServiceId').change(function() {
                var serviceId = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± Ø®Ø¯Ù…Øª - ServiceId:', serviceId);
                if (serviceId) {
                    console.log('âœ… [BROWSER] Ø®Ø¯Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', serviceId);
                    checkAndShowPriceCalculation();
                } else {
                    console.log('âŒ [BROWSER] Ø®Ø¯Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
                }
            });

            // ØªØºÛŒÛŒØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† - Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
            $('#DepartmentId').change(function() {
                var departmentId = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† - DepartmentId:', departmentId);
                if (departmentId) {
                    console.log('âœ… [BROWSER] Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', departmentId);
                    checkAndShowPriceCalculation();
                } else {
                    console.log('âŒ [BROWSER] Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
                }
            });

            // ØªØºÛŒÛŒØ± Ø¶Ø±Ø§ÛŒØ¨ Override
            $('#OverrideTechnicalFactor, #OverrideProfessionalFactor').on('input', function() {
                var fieldName = $(this).attr('id');
                var fieldValue = $(this).val();
                console.log('ğŸ”„ [BROWSER] ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯ Override - Field:', fieldName, 'Value:', fieldValue);
                
                if ($('#ServiceId').val() && $('#DepartmentId').val()) {
                    console.log('âœ… [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªØºÛŒÛŒØ± Override');
                    calculatePrice();
                } else {
                    console.log('âŒ [BROWSER] Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø±Ø¯ - ServiceId ÛŒØ§ DepartmentId Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                }
            });

            // Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            $('#calculate-price-btn').click(function() {
                console.log('ğŸ”˜ [BROWSER] Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª');
                calculatePrice();
            });

            // Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            function checkAndShowPriceCalculation() {
                var serviceId = $('#ServiceId').val();
                var departmentId = $('#DepartmentId').val();
                
                console.log('ğŸ” [BROWSER] Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                console.log('ğŸ” [BROWSER] ServiceId:', serviceId, 'DepartmentId:', departmentId);
                
                if (serviceId && departmentId) {
                    console.log('âœ… [BROWSER] Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                    $('#price-calculation-section').show();
                    calculatePrice();
                } else {
                    console.log('âŒ [BROWSER] Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                    $('#price-calculation-section').hide();
                }
            }

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
            function calculatePrice() {
                var serviceId = $('#ServiceId').val();
                var departmentId = $('#DepartmentId').val();
                var overrideTechnicalFactor = $('#OverrideTechnicalFactor').val();
                var overrideProfessionalFactor = $('#OverrideProfessionalFactor').val();

                console.log('ğŸš€ [BROWSER] Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª');
                console.log('ğŸš€ [BROWSER] ServiceId:', serviceId);
                console.log('ğŸš€ [BROWSER] DepartmentId:', departmentId);
                console.log('ğŸš€ [BROWSER] Override Technical Factor:', overrideTechnicalFactor);
                console.log('ğŸš€ [BROWSER] Override Professional Factor:', overrideProfessionalFactor);

                if (!serviceId || !departmentId) {
                    console.log('âŒ [BROWSER] ServiceId ÛŒØ§ DepartmentId Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                    return;
                }

                console.log('ğŸ“¡ [BROWSER] Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX...');
                $.ajax({
                    url: '@Url.Action("CalculateSharedServicePriceForCreate")',
                    type: 'POST',
                    data: {
                        serviceId: serviceId,
                        departmentId: departmentId,
                        overrideTechnicalFactor: overrideTechnicalFactor,
                        overrideProfessionalFactor: overrideProfessionalFactor
                    },
                    success: function(response) {
                        console.log('âœ… [BROWSER] Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ±');
                        console.log('ğŸ“Š [BROWSER] Raw Response:', response);
                        console.log('ğŸ“Š [BROWSER] Response Type:', typeof response);
                        
                        // Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('ğŸ”„ [BROWSER] Response parsed successfully');
                            } catch (parseError) {
                                console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† response:', parseError);
                                $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø®');
                                $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±</div>');
                                return;
                            }
                        }
                        
                        console.log('ğŸ“Š [BROWSER] Parsed Response:', parsedResponse);
                        console.log('ğŸ“Š [BROWSER] Response Success:', parsedResponse ? parsedResponse.success : 'undefined');
                        
                        try {
                            if (parsedResponse && parsedResponse.success) {
                                console.log('âœ… [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙÙ‚');
                                console.log('ğŸ’° [BROWSER] Calculated Price:', parsedResponse.calculatedPrice);
                                console.log('ğŸ”§ [BROWSER] Technical Component:', parsedResponse.technicalComponent);
                                console.log('ğŸ‘¨â€âš•ï¸ [BROWSER] Professional Component:', parsedResponse.professionalComponent);
                                console.log('ğŸ”§ [BROWSER] Technical Factor:', parsedResponse.technicalFactor);
                                console.log('ğŸ‘¨â€âš•ï¸ [BROWSER] Professional Factor:', parsedResponse.professionalFactor);
                                console.log('ğŸ“ [BROWSER] Calculation Formula:', parsedResponse.calculationFormula);
                                console.log('ğŸ”„ [BROWSER] Has Override:', parsedResponse.hasOverride);
                                console.log('ğŸ“… [BROWSER] Financial Year:', parsedResponse.financialYear);
                                // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª Ø¨Ø§ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†
                                console.log('ğŸ¨ [BROWSER] ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª...');
                                var formattedPrice = new Intl.NumberFormat('fa-IR').format(parsedResponse.calculatedPrice);
                                console.log('ğŸ¨ [BROWSER] Formatted Price:', formattedPrice);
                                $('#calculated-price').val(formattedPrice);
                                
                                // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡
                                console.log('ğŸ¨ [BROWSER] Ø§ÛŒØ¬Ø§Ø¯ HTML Ø¬Ø²Ø¦ÛŒØ§Øª...');
                                var detailsHtml = '<div class="calculation-details">' +
                                    '<strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡:</strong><br>' +
                                    '<div class="row mt-2">' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¬Ø²Ø¡ ÙÙ†ÛŒ:</small><br>' +
                                    '<strong>' + parsedResponse.technicalComponent + '</strong>' +
                                    '</div>' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¬Ø²Ø¡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:</small><br>' +
                                    '<strong>' + parsedResponse.professionalComponent + '</strong>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="row mt-2">' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¶Ø±ÛŒØ¨ ÙÙ†ÛŒ:</small><br>' +
                                    '<strong>' + new Intl.NumberFormat('fa-IR').format(parsedResponse.technicalFactor) + '</strong>' +
                                    '</div>' +
                                    '<div class="col-6">' +
                                    '<small class="text-muted">Ø¶Ø±ÛŒØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:</small><br>' +
                                    '<strong>' + new Intl.NumberFormat('fa-IR').format(parsedResponse.professionalFactor) + '</strong>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="mt-2">' +
                                    '<small class="text-muted">ÙØ±Ù…ÙˆÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡:</small><br>' +
                                    '<code>' + parsedResponse.calculationFormula + '</code>' +
                                    '</div>';
                                
                                if (parsedResponse.hasOverride) {
                                    detailsHtml += '<div class="mt-2"><span class="badge badge-warning">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¶Ø±Ø§ÛŒØ¨ Override</span></div>';
                                }
                                
                                detailsHtml += '</div>';
                                console.log('ğŸ¨ [BROWSER] HTML Ø¬Ø²Ø¦ÛŒØ§Øª:', detailsHtml);
                                $('#calculation-details').html(detailsHtml);
                                
                                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª
                                console.log('âœ… [BROWSER] Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± UI');
                                $('#price-calculation-section').removeClass('border-danger').addClass('border-success');
                            } else {
                                console.log('âŒ [BROWSER] Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚');
                                console.log('âŒ [BROWSER] Error Message:', parsedResponse ? parsedResponse.message : 'undefined');
                                $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡');
                                $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§: ' + (parsedResponse.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ') + '</div>');
                                $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                            }
                        } catch (e) {
                            console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ response:', e);
                            console.error('âŒ [BROWSER] Error Stack:', e.stack);
                            $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´');
                            $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡</div>');
                            $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ [BROWSER] Ø®Ø·Ø§ Ø¯Ø± AJAX:');
                        console.error('âŒ [BROWSER] XHR:', xhr);
                        console.error('âŒ [BROWSER] Status:', status);
                        console.error('âŒ [BROWSER] Error:', error);
                        console.error('âŒ [BROWSER] Response Text:', xhr.responseText);
                        $('#calculated-price').val('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·');
                        $('#calculation-details').html('<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error + '</div>');
                        $('#price-calculation-section').removeClass('border-success').addClass('border-danger');
                    }
                });
            }

            // ØªØ§Ø¨Ø¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡
            window.clearCalculation = function() {
                $('#calculated-price').val('');
                $('#calculation-details').html(
                    '<div class="text-center text-muted">' +
                    '<i class="fas fa-info-circle"></i>' +
                    ' Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' +
                    '</div>'
                );
                $('#price-calculation-section').hide();
                $('#price-calculation-card').removeClass('border-success border-danger');
            };

            // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù…
            window.resetForm = function() {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.')) {
                    $('#ServiceId').val(initialValues.serviceId);
                    $('#DepartmentId').val(initialValues.departmentId);
                    $('#IsActive').prop('checked', initialValues.isActive);
                    $('#DepartmentSpecificNotes').val(initialValues.notes);
                    $('#OverrideTechnicalFactor').val(initialValues.overrideTechnicalFactor);
                    $('#OverrideProfessionalFactor').val(initialValues.overrideProfessionalFactor);
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡
                    clearCalculation();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡
                    checkAndShowPriceCalculation();
                }
            };
        });
    </script>
}
