@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ØªØ³Ø§Ø¨Ø§Øª Ù¾Ø²Ø´Ú©Ø§Ù†";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@model ClinicApp.ViewModels.DoctorManagementVM.DoctorAssignmentIndexViewModel

@Html.AntiForgeryToken()

@section Styles {
    <link href="~/Content/plugins/DataTables/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/DataTables/css/responsive.bootstrap4.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/persian-datepicker/persian-datepicker.min.css" rel="stylesheet" />
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            transition: transform 0.3s ease;
        }

            .stats-card:hover {
                transform: translateY(-5px);
            }

        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .assignment-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-assignment {
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            .btn-assignment:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

        .search-box {
            background: white;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            display: none;
        }
    </style>
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 text-primary">
                        <i class="fas fa-user-md me-2"></i>
                        Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ØªØ³Ø§Ø¨Ø§Øª Ù¾Ø²Ø´Ú©Ø§Ù†
                    </h2>
                    <p class="text-muted mb-0">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ø§Ù†ØªØ³Ø§Ø¨Ø§Øª Ù¾Ø²Ø´Ú©Ø§Ù† Ø¨Ù‡ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ Ùˆ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§ØªÛŒ</p>
                </div>
                <div>
                    <button type="button" class="btn btn-success btn-assignment" onclick="showBulkAssignmentModal()">
                        <i class="fas fa-users me-2"></i>
                        Ø§Ù†ØªØ³Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ÛŒ
                    </button>
                    <button type="button" class="btn btn-info btn-assignment" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Statistics -->
    @Html.Partial("_PartialViews/_AssignmentFilters", Model.Filters)
    @Html.Partial("_PartialViews/_AssignmentStats", Model.Stats)

    <!-- Main Content -->
    <div class="row">
        <div class="col-12">
            <div class="assignment-table p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Ù„ÛŒØ³Øª Ø§Ù†ØªØ³Ø§Ø¨Ø§Øª Ù¾Ø²Ø´Ú©Ø§Ù†
                    </h4>
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="assignmentsTable" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Ø±Ø¯ÛŒÙ</th>
                                <th>Ù†Ø§Ù… Ù¾Ø²Ø´Ú©</th>
                                <th>Ú©Ø¯ Ù…Ù„ÛŒ</th>
                                <th>Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§</th>
                                <th>Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§ØªÛŒ</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ³Ø§Ø¨</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Assignment Modal -->
<div class="modal fade" id="bulkAssignmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>
                    Ø§Ù†ØªØ³Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ÛŒ Ù¾Ø²Ø´Ú©Ø§Ù†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©Ø§Ù†</label>
                        <select id="bulkDoctors" class="form-select" multiple>
                            <!-- Doctors will be loaded here -->
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ù‚ØµØ¯</label>
                        <select id="bulkDepartment" class="form-select">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="form-label">Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§ØªÛŒ</label>
                        <select id="bulkServiceCategories" class="form-select" multiple>
                            <!-- Service categories will be loaded here -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="button" class="btn btn-success" onclick="performBulkAssignment()">
                    <i class="fas fa-save me-2"></i>
                    Ø§Ù†ØªØ³Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ÛŒ
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Scripts are loaded via bundles in _AdminLayout.cshtml -->
    <!-- Additional scripts specific to this page -->

    <script>
        let assignmentsTable;

        // Ù…Ø­Ø§ÙØ¸Øª jQuery - Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ jQuery
        (function() {
            function ensureJQuery(callback) {
                if (typeof jQuery !== 'undefined' && typeof $.fn !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function() {
                        ensureJQuery(callback);
                    }, 50);
                }
            }

            ensureJQuery(function() {
                $(document).ready(function () {
                    try {
                        initDataTable();
                        initSelect2();
                        initPersianDatePickers();
                        loadInitialData();
                        initSearchBox();
                        console.log('DoctorAssignment Index initialized successfully');
                    } catch (error) {
                        console.error('Error initializing DoctorAssignment Index:', error);
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØµÙØ­Ù‡. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
                    }
                });
            });
        })();

        /* -----------------------------
           ğŸ“Œ DataTable
        ----------------------------- */
        function initDataTable() {
            console.log('Initializing DataTable...');
            console.log('jQuery version:', $.fn.jquery);
            console.log('DataTable plugin available:', typeof $.fn.DataTable !== 'undefined');
            
            if (typeof $.fn.DataTable === 'undefined') {
                console.error('DataTable plugin not loaded');
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'DataTable plugin Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                return;
            }
            
            // Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            console.log('Testing AJAX call to GetAssignments...');
            $.ajax({
                url: '@Url.Action("GetAssignments", "DoctorAssignment")',
                type: 'POST',
                data: {
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                    draw: 1,
                    start: 0,
                    length: 10
                },
                success: function(response) {
                    console.log('AJAX test successful:', response);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX test failed:', status, error);
                    console.error('Response:', xhr.responseText);
                }
            });
            
            try {
                assignmentsTable = $('#assignmentsTable').DataTable({
                    language: { url: '@Url.Content("~/Content/plugins/DataTables/js/fa.json")' },
                    responsive: true,
                    processing: true,
                    serverSide: true,
                    pageLength: 25,
                    order: [[1, 'asc']], // sort by doctor name
                    ajax: {
                        url: '@Url.Action("GetAssignments", "DoctorAssignment")',
                        type: 'POST',
                        data: function (d) {
                            d.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
                            d.searchTerm = $('#searchInput').val();
                            d.departmentId = $('#departmentFilter').val();
                            d.status = $('#statusFilter').val();
                            d.dateFrom = $('#DateFrom').val();
                            d.dateTo = $('#DateTo').val();
                            d.serviceCategoryId = $('#ServiceCategoryId').val();
                            d.assignmentType = $('#AssignmentType').val();
                        },
                        error: function (xhr, error, thrown) {
                            console.error('DataTable AJAX Error:', error, thrown);
                            console.error('Response:', xhr.responseText);
                            if (xhr.status === 500) {
                                showError('Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                            } else if (xhr.status === 401) {
                                showError('Ø®Ø·Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ', 'Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
                            } else {
                                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
                            }
                        }
                    },
                    columns: [
                        { data: null, render: (d, t, r, m) => m.row + m.settings._iDisplayStart + 1 },
                        { data: 'DoctorName' },
                        { data: 'DoctorNationalCode' },
                        { data: 'Departments', render: renderDepartments },
                        { data: 'ServiceCategories', render: renderCategories },
                        { data: 'Status', render: renderStatus },
                        { data: 'AssignmentDate', render: formatDate },
                        { data: 'Id', render: renderActions }
                    ],
                    columnDefs: [
                        { targets: [0, 7], orderable: false },
                        { targets: [3, 4], width: '20%' },
                        { targets: [5], width: '10%' }
                    ]
                });
                
                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('Error initializing DataTable:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„', 'Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ DataTable');
            }
        }

        function renderDepartments(data) {
            if (!data?.length) return '<span class="text-muted">Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ³Ø§Ø¨</span>';
            return data.map(d => `<span class="badge bg-primary me-1">${escapeHtml(d.Name)}</span>`).join('');
        }

        function renderCategories(data) {
            if (!data?.length) return '<span class="text-muted">Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÛŒØª</span>';
            return data.map(c => `<span class="badge bg-info me-1">${escapeHtml(c.Name)}</span>`).join('');
        }

        function renderStatus(status) {
            const map = {
                active: '<span class="badge bg-success">ÙØ¹Ø§Ù„</span>',
                inactive: '<span class="badge bg-secondary">ØºÛŒØ±ÙØ¹Ø§Ù„</span>',
                pending: '<span class="badge bg-warning">Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</span>'
            };
            return map[status] || '<span class="badge bg-secondary">Ù†Ø§Ù…Ø´Ø®Øµ</span>';
        }

        function renderActions(id) {
            return `
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-sm btn-outline-success" onclick="editAssignment(${id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-warning" onclick="transferDoctor(${id})"><i class="fas fa-exchange-alt"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${id})"><i class="fas fa-trash"></i></button>
                </div>`;
        }

        /* -----------------------------
           ğŸ“Œ Select2
        ----------------------------- */
        function initSelect2() {
            if (typeof $.fn.select2 !== 'undefined') {
                $('#departmentFilter, #bulkDepartment, #bulkDoctors, #bulkServiceCategories').select2({
                    placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...',
                    allowClear: true,
                    language: 'fa'
                });
            } else {
                console.warn('Select2 plugin not loaded');
            }
        }

        /* -----------------------------
           ğŸ“Œ Persian DatePicker
        ----------------------------- */
        function initPersianDatePickers() {
            console.log('Initializing Persian DatePickers...');
            console.log('Persian DatePicker plugin available:', typeof $.fn.persianDatepicker !== 'undefined');
            
            if (typeof $.fn.persianDatepicker !== 'undefined') {
                try {
                    $('.persian-date').persianDatepicker({
                        format: 'YYYY/MM/DD',
                        initialValue: false,
                        autoClose: true
                    });
                    console.log('Persian DatePickers initialized successfully');
                } catch (error) {
                    console.error('Error initializing Persian DatePickers:', error);
                }
            } else {
                console.warn('Persian DatePicker plugin not loaded');
            }
        }

        /* -----------------------------
           ğŸ“Œ Load initial data
        ----------------------------- */
        function loadInitialData() {
            // Data is already loaded from ViewBag in the controller
            // No need for additional AJAX calls that might fail
            console.log('Initial data loaded from ViewBag');
        }

        function populateSelect(selector, data, defaultOption = null, showCode = false) {
            const select = $(selector);
            select.empty();
            if (defaultOption) select.append(`<option value="">${defaultOption}</option>`);
            data.forEach(item => {
                const text = showCode ? `${item.FullName} - ${item.NationalCode}` : item.Name;
                select.append(new Option(text, item.Id));
            });
        }

        /* -----------------------------
           ğŸ“Œ Actions
        ----------------------------- */
        function applyFilters() { assignmentsTable.ajax.reload(); }
        function refreshTable() { assignmentsTable.ajax.reload(); }
        function refreshData() { assignmentsTable.ajax.reload(); }
        
        function showBulkAssignmentModal() {
            $('#bulkAssignmentModal').modal('show');
        }

        function viewDetails(id) { window.location.href = '@Url.Action("Details", "DoctorAssignment")/' + id; }
        function editAssignment(id) { window.location.href = '@Url.Action("AssignToDepartment", "DoctorAssignment", new { doctorId = "__ID__" })'.replace('__ID__', id); }
        function transferDoctor(id) { window.location.href = '@Url.Action("TransferDoctor", "DoctorAssignment", new { doctorId = "__ID__" })'.replace('__ID__', id); }

        function removeAssignment(id) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø§Ù†ØµØ±Ø§Ù'
            }).then(r => { if (r.isConfirmed) performRemoveAssignment(id); });
        }

        function performRemoveAssignment(id) {
            showLoading();
            $.post('@Url.Action("RemoveAssignments", "DoctorAssignment")', {
                id: id,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }).done(r => {
                if (r.success) {
                    showSuccess('Ø­Ø°Ù Ù…ÙˆÙÙ‚', 'Ø§Ù†ØªØ³Ø§Ø¨ Ø­Ø°Ù Ø´Ø¯');
                    refreshTable();
                } else showError('Ø®Ø·Ø§', r.message);
            }).fail((xhr, status, error) => {
                console.error('Remove assignment error:', status, error);
                if (xhr.status === 500) {
                    showError('Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù');
                } else {
                    showError('Ø®Ø·Ø§', 'Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
                }
            }).always(hideLoading);
        }

        function performBulkAssignment() {
            const doctors = $('#bulkDoctors').val();
            const department = $('#bulkDepartment').val();
            const categories = $('#bulkServiceCategories').val() || [];

            if (!doctors?.length) return showError('Ø®Ø·Ø§', 'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø²Ø´Ú© Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
            if (!department) return showError('Ø®Ø·Ø§', 'Ù„Ø·ÙØ§Ù‹ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');

            const assignments = doctors.map(d => ({
                DoctorId: d,
                DepartmentId: department,
                ServiceCategoryIds: categories
            }));

            showLoading();
            $.ajax({
                url: '@Url.Action("BulkAssign", "DoctorAssignment")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ models: assignments }),
                headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
            }).done(r => {
                if (r.success) {
                    showSuccess('Ù…ÙˆÙÙ‚', `${r.successCount} Ù¾Ø²Ø´Ú© Ø§Ù†ØªØ³Ø§Ø¨ Ø´Ø¯Ù†Ø¯`);
                    $('#bulkAssignmentModal').modal('hide');
                    refreshTable();
                } else showError('Ø®Ø·Ø§', r.message);
            }).fail((xhr, status, error) => {
                console.error('Bulk assignment error:', status, error);
                if (xhr.status === 500) {
                    showError('Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ù†ØªØ³Ø§Ø¨ Ú¯Ø±ÙˆÙ‡ÛŒ');
                } else {
                    showError('Ø®Ø·Ø§', 'Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
                }
            }).always(hideLoading);
        }

        /* -----------------------------
           ğŸ“Œ Utils
        ----------------------------- */
        function initSearchBox() {
            $('#searchInput').on('keyup', e => { if (e.keyCode === 13) applyFilters(); });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('fa-IR');
            } catch { return '-'; }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() { $('.loading-spinner').show(); }
        function hideLoading() { $('.loading-spinner').hide(); }

        function showSuccess(title, msg) { 
            console.log('SweetAlert2 available:', typeof Swal !== 'undefined');
            if (typeof Swal !== 'undefined') {
                Swal.fire({ title, text: msg, icon: 'success' }); 
            } else {
                alert(title + ': ' + msg);
            }
        }
        function showError(title, msg) { 
            console.log('SweetAlert2 available:', typeof Swal !== 'undefined');
            if (typeof Swal !== 'undefined') {
                Swal.fire({ title, text: msg, icon: 'error' }); 
            } else {
                alert(title + ': ' + msg);
            }
        }
    </script>
}
