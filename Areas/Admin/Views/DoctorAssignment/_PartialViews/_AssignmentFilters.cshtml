@model ClinicApp.ViewModels.DoctorManagementVM.AssignmentFilterViewModel
@* Partial View برای فیلترهای جستجوی انتسابات کلی پزشکان *@

<div class="filters-card p-4 mb-4">
    <h5 class="mb-3">
        <i class="fas fa-filter me-2"></i>
        فیلترهای جستجو
    </h5>

    @using (Html.BeginForm("Index", "DoctorAssignment", FormMethod.Get, new { id = "filterForm" }))
    {
        <div class="row">
            <!-- Doctor Filter -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.SearchTerm, "نام پزشک", new { @class = "form-label fw-bold" })
                    @Html.TextBoxFor(m => m.SearchTerm, new { @class = "form-control", placeholder = "جستجو بر اساس نام..." })
                </div>
            </div>

            <!-- Department Filter -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.DepartmentId, "دپارتمان", new { @class = "form-label fw-bold" })
                    @Html.DropDownListFor(m => m.DepartmentId, 
                        new SelectList(ViewBag.Departments ?? Model.Departments, "Value", "Text"), 
                        "همه دپارتمان‌ها", 
                        new { @class = "form-select" })
                </div>
            </div>

            <!-- Service Category Filter -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.ServiceCategoryId, "صلاحیت خدماتی", new { @class = "form-label fw-bold" })
                    @Html.DropDownListFor(m => m.ServiceCategoryId, 
                        new SelectList(ViewBag.ServiceCategories ?? Model.ServiceCategories, "Value", "Text"), 
                        "همه صلاحیت‌ها", 
                        new { @class = "form-select" })
                </div>
            </div>

            <!-- Status Filter -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.Status, "وضعیت", new { @class = "form-label fw-bold" })
                    @Html.DropDownListFor(m => m.Status, 
                        new SelectList(Model.Statuses, "Value", "Text"), 
                        new { @class = "form-select" })
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Date Range Filters -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.DateFrom, "تاریخ انتساب از", new { @class = "form-label fw-bold" })
                    @Html.TextBoxFor(m => m.DateFrom, new { @class = "form-control datepicker", placeholder = "yyyy/mm/dd" })
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.DateTo, "تاریخ انتساب تا", new { @class = "form-label fw-bold" })
                    @Html.TextBoxFor(m => m.DateTo, new { @class = "form-control datepicker", placeholder = "yyyy/mm/dd" })
                </div>
            </div>

            <!-- Assignment Type Filter -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    @Html.LabelFor(m => m.AssignmentType, "نوع انتساب", new { @class = "form-label fw-bold" })
                    @Html.DropDownListFor(m => m.AssignmentType, 
                        new SelectList(Model.AssignmentTypes, "Value", "Text"), 
                        new { @class = "form-select" })
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="col-md-3 mb-3">
                <div class="form-group">
                    <label class="form-label fw-bold">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="fas fa-search me-2"></i>
                            جستجو
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-2"></i>
                            پاک کردن
                        </button>
                    </div>
                </div>
            </div>
        </div>

        if (Model.HasFilters)
        {
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>فیلترهای فعال:</strong> @Model.GetFilterSummary()
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .filters-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    .filters-card h5 {
        color: #667eea;
        font-weight: 600;
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 10px;
    }
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #ced4da;
        transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .advanced-filters {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e9ecef;
    }
    .advanced-filters h6 {
        color: #495057;
        font-weight: 600;
    }
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn:hover {
        transform: translateY(-1px);
    }
</style>

<script>
    // محافظت jQuery - اطمینان از بارگذاری کامل jQuery
    (function() {
        'use strict';
        
        function ensureJQuery(callback) {
            if (typeof jQuery !== 'undefined' && typeof $.fn !== 'undefined') {
                callback();
            } else {
                setTimeout(function() {
                    ensureJQuery(callback);
                }, 50);
            }
        }

        // تابع ریست فیلترها
        window.resetFilters = function() {
            ensureJQuery(function() {
                // Reset form fields
                $('#filterForm input[type="text"]').val('');
                $('#filterForm select').prop('selectedIndex', 0);
                
                // Submit form to refresh data
                $('#filterForm').submit();
            });
        };

        // راه‌اندازی datepicker ها
        function initializeDatepickers() {
            ensureJQuery(function() {
                if (typeof $.fn.datepicker !== 'undefined') {
                    $('.datepicker').datepicker({
                        format: 'yyyy/mm/dd',
                        autoclose: true,
                        todayHighlight: true,
                        rtl: true
                    });
                } else {
                    console.warn('DatePicker plugin not loaded');
                }
            });
        }

        // راه‌اندازی Persian DatePicker
        function initializePersianDatepickers() {
            ensureJQuery(function() {
                if (typeof $.fn.persianDatepicker !== 'undefined') {
                    $('.persian-date').each(function() {
                        var $this = $(this);
                        if (!$this.data('persian-datepicker-initialized')) {
                            $this.persianDatepicker({
                                format: 'YYYY/MM/DD',
                                initialValue: false,
                                autoClose: true,
                                observer: true,
                                calendar: {
                                    persian: {
                                        locale: 'fa',
                                        leapYearMode: 'astronomical'
                                    }
                                },
                                toolbox: {
                                    todayBtn: { enabled: true, text: { fa: 'امروز' } },
                                    clearBtn: { enabled: true, text: { fa: 'پاک کردن' } }
                                },
                                onSelect: function(unix) {
                                    var date = new Date(unix);
                                    var persianDate = date.getFullYear() + '/' +
                                        String(date.getMonth() + 1).padStart(2, '0') + '/' +
                                        String(date.getDate()).padStart(2, '0');
                                    $this.val(persianDate);
                                    
                                    // Trigger change event
                                    $this.trigger('change');
                                }
                            });
                            $this.data('persian-datepicker-initialized', true);
                        }
                    });
                }
            });
        }

        // راه‌اندازی اولیه
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeDatepickers();
                initializePersianDatepickers();
            });
        } else {
            initializeDatepickers();
            initializePersianDatepickers();
        }

        // راه‌اندازی مجدد برای محتوای AJAX
        ensureJQuery(function() {
            $(document).on('DOMNodeInserted', function(e) {
                if ($(e.target).hasClass('datepicker') || 
                    $(e.target).hasClass('persian-date') ||
                    $(e.target).find('.datepicker, .persian-date').length > 0) {
                    setTimeout(function() {
                        initializeDatepickers();
                        initializePersianDatepickers();
                    }, 100);
                }
            });
        });

    })();
</script>
