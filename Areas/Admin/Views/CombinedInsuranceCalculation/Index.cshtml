@{
    ViewBag.Title = "محاسبه بیمه ترکیبی (اصلی + تکمیلی)";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/medical-environment.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/toastr/toastr.min.css" rel="stylesheet" />

    <style>
        /* 🏥 Medical Environment Styles - بهینه شده برای محیط درمانی */
        .calculation-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: all 0.3s ease;
            position: relative;
            min-height: 500px; /* حداقل ارتفاع برای خوانایی بهتر */
        }
        
        /* 📏 بزرگ کردن فرم‌ها */
        .form-control {
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
            height: auto;
            min-height: 50px;
        }
        
        .form-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .card-header {
            padding: 1.5rem 2rem;
            font-size: 1.2rem;
        }
        
        .btn {
            font-size: 1.1rem;
            padding: 0.75rem 1.5rem;
            min-height: 50px;
        }
        
        .btn-lg {
            font-size: 1.2rem;
            padding: 1rem 2rem;
            min-height: 60px;
        }
        
        .calculation-card:hover {
            box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.25);
            transform: translateY(-2px);
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .medical-icon {
            color: #1cc88a;
            font-size: 1.2rem;
        }
        
        .calculation-step {
            border-left: 4px solid #1cc88a;
            padding-left: 1rem;
            margin-bottom: 1rem;
            background: rgba(28, 200, 138, 0.05);
            border-radius: 0.25rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .calculation-step:hover {
            background: rgba(28, 200, 138, 0.1);
            transform: translateX(5px);
        }
        
        .amount-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .percentage-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1cc88a;
        }
        
        /* 🚀 Performance Optimizations */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 1rem 3rem rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* 📱 Responsive Design */
        @@media (max-width: 768px) {
            .calculation-card {
                margin-bottom: 1rem;
            }
            
            .amount-display {
                font-size: 1.2rem;
            }
            
            .result-card .row {
                flex-direction: column;
            }
            
            .result-card .col-md-3 {
                margin-bottom: 1rem;
            }
        }
        
        /* 🎨 Medical Theme Colors */
        .medical-primary { color: #1cc88a; }
        .medical-secondary { color: #36b9cc; }
        .medical-warning { color: #f6c23e; }
        .medical-danger { color: #e74a3b; }
        .medical-success { color: #28a745; }
        
        /* 🔒 Security Indicators */
        .security-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #1cc88a;
            font-size: 1.1rem;
            animation: blink 2s infinite;
        }
        
        @@keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* 🎯 Enhanced Form Styling */
        .form-control:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #1cc88a, #17a2b8);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #17a2b8, #1cc88a);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* 📊 Enhanced Results Display */
        .result-item {
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        
        /* 🚨 Error Handling */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin: 1rem 0;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin: 1rem 0;
        }
        
        /* 🔄 Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1cc88a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 📈 Progress Indicators */
        .progress-bar {
            background: linear-gradient(45deg, #1cc88a, #17a2b8);
        }
        
        /* 🎨 Enhanced Typography */
        .medical-title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .medical-subtitle {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 400;
            color: #6c757d;
        }
        
        /* 🎯 UX/UI Enhancements */
        .is-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
        
        .form-label i {
            margin-right: 5px;
            color: #1cc88a;
        }
        
        .text-danger {
            color: #e74a3b !important;
            font-weight: bold;
        }
        
        .input-group-text {
            background-color: #1cc88a;
            color: white;
            border-color: #1cc88a;
        }
        
        .form-text {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .form-text i {
            margin-right: 3px;
        }
        
        /* 🎨 Enhanced Form Styling */
        .form-control:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        
        .form-control.is-invalid {
            border-color: #e74a3b;
            box-shadow: 0 0 0 0.2rem rgba(231, 74, 59, 0.25);
        }
        
        .form-control.is-valid {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        
        /* 🎯 Loading States */
        .loading-state {
            position: relative;
            pointer-events: none;
        }
        
        .loading-state::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1cc88a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="medical-title">
                        <i class="fas fa-calculator medical-icon"></i> محاسبه بیمه ترکیبی
                        <span class="security-indicator">
                            <i class="fas fa-shield-alt" title="محاسبات امن و رمزنگاری شده"></i>
                        </span>
                    </h2>
                    <p class="medical-subtitle mb-0">محاسبه دقیق سهم بیمه اصلی و تکمیلی با استانداردهای پزشکی ایران</p>
                </div>
                <div class="text-muted">
                    <small>
                        <i class="fas fa-clock"></i> آخرین به‌روزرسانی: @DateTime.Now.ToString("yyyy/MM/dd HH:mm")
                    </small>
                </div>
            </div>

            <!-- فرم محاسبه -->
            <div class="row">
                <div class="col-lg-9">
                    <div class="card calculation-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user-md"></i> اطلاعات محاسبه
                                <span class="badge badge-info ml-2">نسخه 2.0</span>
                            </h5>
                            <small class="text-muted">تمام فیلدها الزامی هستند</small>
                        </div>
                        <div class="card-body">
                            <form id="calculationForm">
                                @Html.AntiForgeryToken()
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="patientId" class="form-label">
                                                <i class="fas fa-user"></i> بیمار
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select id="patientId" name="patientId" class="form-control" required aria-describedby="patientIdHelp">
                                                <option value="">انتخاب بیمار...</option>
                                            </select>
                                            <small id="patientIdHelp" class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> بیمار مورد نظر را انتخاب کنید
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="departmentId" class="form-label">
                                                <i class="fas fa-building"></i> دپارتمان
                                            </label>
                                            <select id="departmentId" name="departmentId" class="form-control" aria-describedby="departmentIdHelp">
                                                <option value="">انتخاب دپارتمان...</option>
                                            </select>
                                            <small id="departmentIdHelp" class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> دپارتمان مورد نظر را انتخاب کنید
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="serviceId" class="form-label">
                                                <i class="fas fa-stethoscope"></i> خدمت
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select id="serviceId" name="serviceId" class="form-control" required disabled aria-describedby="serviceIdHelp">
                                                <option value="">ابتدا دپارتمان را انتخاب کنید...</option>
                                            </select>
                                            <small id="serviceIdHelp" class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> ابتدا دپارتمان را انتخاب کنید
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="serviceAmount" class="form-label">
                                                <i class="fas fa-money-bill-wave"></i> مبلغ خدمت (تومان)
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" id="serviceAmount" name="serviceAmount" class="form-control" 
                                                       placeholder="مبلغ خدمت را وارد کنید" required min="0" step="1000" 
                                                       aria-describedby="serviceAmountHelp">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">تومان</span>
                                                </div>
                                            </div>
                                            <small id="serviceAmountHelp" class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> مبلغ خدمت به صورت خودکار پر می‌شود
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="calculationDate" class="form-label">
                                                <i class="fas fa-calendar-alt"></i> تاریخ محاسبه
                                            </label>
                                            <input type="text" id="calculationDate" name="calculationDate" class="form-control persian-datepicker" 
                                                   value="@DateTime.Now.ToString("yyyy/MM/dd")" aria-describedby="calculationDateHelp">
                                            <small id="calculationDateHelp" class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> تاریخ محاسبه بیمه را انتخاب کنید
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <button type="submit" class="btn btn-primary btn-lg" id="calculateBtn">
                                                    <i class="fas fa-calculator"></i> محاسبه بیمه ترکیبی
                                                </button>
                                                <button type="button" id="clearForm" class="btn btn-secondary btn-lg ml-2">
                                                    <i class="fas fa-eraser"></i> پاک کردن
                                                </button>
                                            </div>
                                            <div class="text-muted">
                                                <small>
                                                    <i class="fas fa-info-circle"></i> محاسبه بر اساس آخرین تعرفه‌های بیمه
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3">
                    <div class="card calculation-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i> راهنمای محاسبه
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="calculation-step">
                                <h6><i class="fas fa-shield-alt"></i> بیمه اصلی</h6>
                                <p class="mb-0">پوشش اولیه (معمولاً 70%)</p>
                            </div>
                            
                            <div class="calculation-step">
                                <h6><i class="fas fa-plus-circle"></i> بیمه تکمیلی</h6>
                                <p class="mb-0">پوشش اضافی از باقی‌مانده</p>
                            </div>
                            
                            <div class="calculation-step">
                                <h6><i class="fas fa-user"></i> سهم بیمار</h6>
                                <p class="mb-0">مبلغ نهایی پرداختی بیمار</p>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i>
                                <strong>نکته:</strong> محاسبه بر اساس استانداردهای پزشکی ایران انجام می‌شود.
                            </div>
                            
                            <div class="alert alert-warning mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>هشدار:</strong> در صورت عدم وجود بیمه تکمیلی، فقط بیمه اصلی محاسبه می‌شود.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- نتایج محاسبه -->
            <div id="calculationResults" class="row mt-4" style="display: none;">
                <div class="col-12">
                    <div class="card result-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0 text-white">
                                <i class="fas fa-chart-pie"></i> نتایج محاسبه بیمه ترکیبی
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center result-item">
                                        <h6 class="text-white-50">
                                            <i class="fas fa-money-bill-wave"></i> مبلغ کل خدمت
                                        </h6>
                                        <h4 class="text-white" id="totalServiceAmount">0 تومان</h4>
                                        <small class="text-white-50">قبل از بیمه</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center result-item">
                                        <h6 class="text-white-50">
                                            <i class="fas fa-shield-alt"></i> پوشش بیمه اصلی
                                        </h6>
                                        <h4 class="text-white" id="primaryCoverage">0 تومان</h4>
                                        <small class="text-white-50" id="primaryCoveragePercent">0%</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center result-item">
                                        <h6 class="text-white-50">
                                            <i class="fas fa-plus-circle"></i> پوشش بیمه تکمیلی
                                        </h6>
                                        <h4 class="text-white" id="supplementaryCoverage">0 تومان</h4>
                                        <small class="text-white-50" id="supplementaryCoveragePercent">0%</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center result-item">
                                        <h6 class="text-white-50">
                                            <i class="fas fa-user"></i> سهم نهایی بیمار
                                        </h6>
                                        <h4 class="text-white" id="finalPatientShare">0 تومان</h4>
                                        <small class="text-white-50" id="patientSharePercent">0%</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-light">
                                        <h6><i class="fas fa-info-circle"></i> جزئیات محاسبه</h6>
                                        <div id="calculationDetails">
                                            <!-- جزئیات محاسبه اینجا نمایش داده می‌شود -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Content/plugins/select2/js/select2.full.min.js"></script>
    <script src="~/Content/plugins/toastr/toastr.min.js"></script>
    <script src="~/Scripts/app/medical-environment.js"></script>
    <script src="~/Content/plugins/persian-datepicker/persian-datepicker.min.js"></script>
    <link href="~/Content/plugins/persian-datepicker/persian-datepicker.min.css" rel="stylesheet" />
    <script src="~/Scripts/app/combined-insurance-calculation.js?v=2.1&t=@DateTime.Now.Ticks"></script>
    
}
