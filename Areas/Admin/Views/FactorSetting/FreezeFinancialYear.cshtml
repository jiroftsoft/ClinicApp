@using ClinicApp.Extensions
@model IEnumerable<ClinicApp.Models.Entities.Clinic.FactorSetting>
@{
    ViewBag.Title = "فریز کردن کای‌های سال مالی";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <style>
        .freeze-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .warning-box h5 {
            color: #856404;
            margin-bottom: 15px;
        }

        .factor-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .factor-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .factor-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .factor-technical {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .factor-professional {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .btn-freeze {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-freeze:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            color: white;
            transform: translateY(-1px);
        }

        .confirm-input {
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 10px;
            font-size: 1.1rem;
            text-align: center;
            direction: rtl;
        }
    </style>
}

<div class="page-content">
    <div class="container-fluid">
        <!-- هدر صفحه -->
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <h1 class="page-title mb-0">
                    <i class="fas fa-snowflake text-danger me-2"></i>
                    فریز کردن کای‌های سال مالی @ViewBag.FinancialYear
                </h1>
                <p class="text-muted mb-0">فریز کردن کای‌های فعال سال مالی @ViewBag.FinancialYear</p>
            </div>
            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                <a href="@Url.Action("Index")" class="btn btn-secondary">
                    <i class="fas fa-arrow-right me-1"></i> بازگشت به لیست
                </a>
            </div>
        </div>

        <!-- هشدار مهم -->
        <div class="warning-box">
            <h5><i class="fas fa-exclamation-triangle"></i> هشدار مهم</h5>
            <ul class="mb-0">
                <li>فریز کردن کای‌ها عملیات غیرقابل بازگشت است</li>
                <li>کای‌های فریز شده دیگر قابل ویرایش یا حذف نیستند</li>
                <li>این عمل فقط برای کای‌های فعال انجام می‌شود</li>
                <li>تعداد کای‌های قابل فریز: <strong>@ViewBag.ActiveFactorsCount</strong></li>
            </ul>
        </div>

        @if (Model.Any())
        {
            <!-- لیست کای‌های قابل فریز -->
            <div class="freeze-section">
                <h5 class="mb-3">
                    <i class="fas fa-list"></i> کای‌های قابل فریز
                </h5>
                
                @foreach (var factor in Model)
                {
                    <div class="factor-item">
                        <div class="factor-header">
                            <div>
                                <span class="factor-type-badge @(factor.FactorType == ClinicApp.Models.Enums.ServiceComponentType.Technical ? "factor-technical" : "factor-professional")">
                                    @(factor.FactorType == ClinicApp.Models.Enums.ServiceComponentType.Technical ? "فنی" : "حرفه‌ای")
                                </span>
                                @if (factor.IsHashtagged)
                                {
                                    <span class="badge bg-info ms-2">هشتگ‌دار</span>
                                }
                            </div>
                            <div class="text-end">
                                <strong>@factor.Value.ToString("N0") تومان</strong>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(factor.Description))
                        {
                            <p class="text-muted small mb-2">@factor.Description</p>
                        }
                        
                        <div class="text-muted small">
                            <i class="fas fa-calendar me-1"></i> سال مالی: @factor.FinancialYear
                            <span class="ms-3">
                                <i class="fas fa-user me-1"></i> ایجاد کننده: @factor.CreatedByUserId
                            </span>
                        </div>
                    </div>
                }
            </div>

            <!-- فرم تأیید فریز -->
            <div class="freeze-section">
                <h5 class="mb-3">
                    <i class="fas fa-check-circle text-danger"></i> تأیید فریز کردن
                </h5>
                
                @using (Html.BeginForm("FreezeFinancialYear", "FactorSetting", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="financialYear" value="@ViewBag.FinancialYear" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">برای تأیید، کلمه "فریز" را وارد کنید:</label>
                            <input type="text" name="confirmText" class="form-control confirm-input" placeholder="فریز" required />
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="submit" class="btn btn-freeze" onclick="return confirmFreeze()">
                                <i class="fas fa-snowflake me-2"></i> فریز کردن کای‌ها
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h5>هیچ کای فعالی برای فریز یافت نشد</h5>
                <p>کای‌های سال مالی @ViewBag.FinancialYear قبلاً فریز شده‌اند یا فعال نیستند.</p>
                <a href="@Url.Action("Index")" class="btn btn-primary">
                    <i class="fas fa-arrow-right me-1"></i> بازگشت به لیست
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function confirmFreeze() {
            var confirmText = $('input[name="confirmText"]').val();
            if (confirmText !== 'فریز') {
                alert('برای تأیید، کلمه "فریز" را وارد کنید');
                return false;
            }
            
            return confirm('آیا مطمئن هستید که می‌خواهید کای‌های سال مالی @ViewBag.FinancialYear را فریز کنید؟\n\nاین عمل غیرقابل بازگشت است!');
        }

        $(document).ready(function() {
            // اعتبارسنجی فرم
            $('.needs-validation').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });
        });
    </script>
}
