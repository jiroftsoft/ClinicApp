@model ClinicApp.ViewModels.DoctorManagementVM.DoctorRemovalIndexViewModel
@{
    ViewBag.Title = Model.PageTitle;
    ViewBag.RequireDataTables = true;
    ViewBag.RequireSelect2 = true;
    ViewBag.RequireDatePicker = true;
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary" style="border-width: 2px;">
                <div class="card-header bg-primary text-white" style="background-color: #007bff !important;">
                    <h4 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                        <i class="fa fa-user-times" style="color: #ffffff !important;"></i>
                        @Model.PageTitle
                    </h4>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    <p class="card-text text-muted mb-0">
                        <i class="fa fa-info-circle"></i>
                        @Model.PageSubtitle
                    </p>
                    @if (!string.IsNullOrEmpty(Model.LastRefreshTime))
                    {
                        <small class="text-muted">
                            <i class="fa fa-clock-o"></i>
                            آخرین به‌روزرسانی: @Model.LastRefreshTime
                        </small>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    @if (Model.Statistics != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info" style="border-width: 2px;">
                    <div class="card-header bg-info text-white" style="background-color: #17a2b8 !important;">
                        <h5 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                            <i class="fa fa-bar-chart" style="color: #ffffff !important;"></i>
                            آمار کلی انتسابات
                        </h5>
                    </div>
                    <div class="card-body" style="background-color: #ffffff;">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #17a2b8;">
                                    <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #17a2b8;">
                                        کل انتسابات:
                                    </label>
                                    <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                        <span class="badge badge-info" style="background-color: #17a2b8 !important; color: #ffffff !important; font-weight: 600;">
                                            @Model.Statistics.TotalAssignments
                                        </span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #28a745;">
                                    <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #28a745;">
                                        انتسابات فعال:
                                    </label>
                                    <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                        <span class="badge badge-success" style="background-color: #28a745 !important; color: #ffffff !important; font-weight: 600;">
                                            @Model.Statistics.ActiveAssignments
                                        </span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #ffc107;">
                                    <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #ffc107;">
                                        انتسابات غیرفعال:
                                    </label>
                                    <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                        <span class="badge badge-warning" style="background-color: #ffc107 !important; color: #212529 !important; font-weight: 600;">
                                            @Model.Statistics.InactiveAssignments
                                        </span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #6c757d;">
                                    <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #6c757d;">
                                        کل پزشکان:
                                    </label>
                                    <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                        <span class="badge badge-secondary" style="background-color: #6c757d !important; color: #ffffff !important; font-weight: 600;">
                                            @Model.Statistics.TotalDoctors
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary" style="border-width: 2px;">
                <div class="card-header bg-secondary text-white" style="background-color: #6c757d !important;">
                    <h5 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                        <i class="fa fa-filter" style="color: #ffffff !important;"></i>
                        فیلترهای جستجو
                    </h5>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    <form id="filtersForm" class="form-horizontal">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <label for="doctorName" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        نام پزشک:
                                    </label>
                                    <input type="text" id="doctorName" name="doctorName" class="form-control" 
                                           placeholder="جستجو بر اساس نام پزشک..." 
                                           value="@(Model.Filters?.DoctorName)">
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <label for="nationalCode" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        کد ملی:
                                    </label>
                                    <input type="text" id="nationalCode" name="nationalCode" class="form-control" 
                                           placeholder="جستجو بر اساس کد ملی..." 
                                           value="@(Model.Filters?.NationalCode)">
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <label for="departmentId" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        دپارتمان:
                                    </label>
                                    <select id="departmentId" name="departmentId" class="form-control select2" style="height: 45px;">
                                        <option value="">همه دپارتمان‌ها</option>
                                        @if (Model.Filters?.Departments != null)
                                        {
                                            foreach (var dept in Model.Filters.Departments)
                                            {
                                                <option value="@dept.Value" @(Model.Filters.DepartmentId?.ToString() == dept.Value ? "selected" : "")>
                                                    @dept.Text
                                                </option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <label for="serviceCategoryId" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        سرفصل خدماتی:
                                    </label>
                                    <select id="serviceCategoryId" name="serviceCategoryId" class="form-control select2" style="height: 45px;">
                                        <option value="">همه سرفصل‌ها</option>
                                        @if (Model.Filters?.ServiceCategories != null)
                                        {
                                            foreach (var category in Model.Filters.ServiceCategories)
                                            {
                                                <option value="@category.Value" @(Model.Filters.ServiceCategoryId?.ToString() == category.Value ? "selected" : "")>
                                                    @category.Text
                                                </option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <label for="minAssignmentsCount" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        حداقل تعداد انتسابات:
                                    </label>
                                    <input type="number" id="minAssignmentsCount" name="minAssignmentsCount" class="form-control" 
                                           placeholder="حداقل تعداد انتسابات..." 
                                           value="@(Model.Filters?.MinAssignmentsCount)">
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" id="showOnlyActiveAssignments" name="showOnlyActiveAssignments" 
                                               class="form-check-input" @(Model.Filters?.ShowOnlyActiveAssignments == true ? "checked" : "")>
                                        <label for="showOnlyActiveAssignments" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            فقط انتسابات فعال
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" id="showOnlyWithoutDependencies" name="showOnlyWithoutDependencies" 
                                               class="form-check-input" @(Model.Filters?.ShowOnlyWithoutDependencies == true ? "checked" : "")>
                                        <label for="showOnlyWithoutDependencies" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            فقط بدون وابستگی
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-actions text-center">
                                    <button type="button" id="searchBtn" class="btn btn-primary btn-lg">
                                        <i class="fa fa-search"></i>
                                        جستجو
                                    </button>
                                    <button type="button" id="clearFiltersBtn" class="btn btn-secondary btn-lg">
                                        <i class="fa fa-refresh"></i>
                                        پاک کردن فیلترها
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctors List Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-success" style="border-width: 2px;">
                <div class="card-header bg-success text-white" style="background-color: #28a745 !important;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                                <i class="fa fa-list" style="color: #ffffff !important;"></i>
                                لیست پزشکان قابل حذف انتسابات
                            </h5>
                        </div>
                        <div class="col-md-6 text-right">
                            <div class="btn-group" role="group">
                                <button type="button" id="selectAllBtn" class="btn btn-outline-light btn-sm">
                                    <i class="fa fa-check-square-o"></i>
                                    انتخاب همه
                                </button>
                                <button type="button" id="deselectAllBtn" class="btn btn-outline-light btn-sm">
                                    <i class="fa fa-square-o"></i>
                                    لغو انتخاب همه
                                </button>
                                <button type="button" id="bulkRemovalBtn" class="btn btn-warning btn-sm" disabled>
                                    <i class="fa fa-trash"></i>
                                    حذف دسته‌ای
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    @if (Model.IsLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">در حال بارگذاری...</span>
                            </div>
                            <p class="mt-3 text-muted">@Model.LoadingMessage</p>
                        </div>
                    }
                    else if (Model.Doctors != null && Model.Doctors.Any())
                    {
                        @Html.Partial("_DoctorsList", Model)
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fa fa-info-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">هیچ پزشکی یافت نشد</h5>
                            <p class="text-muted">لطفاً فیلترهای جستجو را تغییر دهید</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Global variables
            var isInitialized = false;

            // Initialize DataTables
            function initializeDataTables() {
                if ($.fn.DataTable) {
                    var $table = $('#doctorsTable');
                    
                    // Check if table exists and has DataTable
                    if ($table.length > 0 && $.fn.DataTable.isDataTable('#doctorsTable')) {
                        try {
                            $table.DataTable().destroy();
                        } catch (e) {
                            console.warn('DataTable destroy failed:', e);
                        }
                    }
                    
                    // Initialize DataTable only if table exists
                    if ($table.length > 0) {
                        $table.DataTable({
                            "language": {
                                "url": "/Content/plugins/DataTables/js/fa.json"
                            },
                            "pageLength": 25,
                            "order": [[1, "asc"]],
                            "columnDefs": [
                                { "orderable": false, "targets": [0, 7] }
                            ]
                        });
                    }
                }
            }

            // Initialize Select2
            function initializeSelect2() {
                if ($.fn.select2) {
                    // Destroy existing Select2 if it exists
                    $('.select2').each(function() {
                        if ($(this).hasClass('select2-hidden-accessible')) {
                            $(this).select2('destroy');
                        }
                    });
                    
                    $('.select2').select2({
                        placeholder: "انتخاب کنید...",
                        allowClear: true
                    });
                }
            }

            // Update bulk removal button state
            function updateBulkRemovalButton() {
                var selectedCount = $('.doctor-checkbox:checked').length;
                var bulkBtn = $('#bulkRemovalBtn');
                
                if (selectedCount > 0) {
                    bulkBtn.prop('disabled', false).text('حذف انتسابات (' + selectedCount + ')');
                } else {
                    bulkBtn.prop('disabled', true).text('حذف انتسابات');
                }
            }

            // Update select all checkbox state
            function updateSelectAllCheckbox() {
                var totalCheckboxes = $('.doctor-checkbox').length;
                var checkedCheckboxes = $('.doctor-checkbox:checked').length;
                var selectAllCheckbox = $('#selectAllCheckbox');
                
                if (checkedCheckboxes === 0) {
                    selectAllCheckbox.prop('indeterminate', false).prop('checked', false);
                } else if (checkedCheckboxes === totalCheckboxes) {
                    selectAllCheckbox.prop('indeterminate', false).prop('checked', true);
                } else {
                    selectAllCheckbox.prop('indeterminate', true);
                }
            }

            // Initialize table events
            function initializeTableEvents() {
                // Initialize DataTables
                initializeDataTables();
                
                // Only bind events if table exists
                if ($('#doctorsTable').length > 0) {
                    // Select all functionality
                    $('#selectAllCheckbox, #selectAllBtn').off('change click').on('change click', function() {
                        var isChecked = $('#selectAllCheckbox').is(':checked');
                        $('.doctor-checkbox').prop('checked', isChecked);
                        updateBulkRemovalButton();
                        updateSelectAllCheckbox();
                    });

                    // Individual checkbox change
                    $('.doctor-checkbox').off('change').on('change', function() {
                        updateBulkRemovalButton();
                        updateSelectAllCheckbox();
                    });
                }
            }

            // Search function
            function performSearch() {
                var formData = {
                    DoctorName: $('#doctorName').val(),
                    NationalCode: $('#nationalCode').val(),
                    DepartmentId: $('#departmentId').val(),
                    ServiceCategoryId: $('#serviceCategoryId').val(),
                    MinAssignmentsCount: $('#minAssignmentsCount').val(),
                    ShowOnlyActiveAssignments: $('#showOnlyActiveAssignments').is(':checked'),
                    ShowOnlyWithoutDependencies: $('#showOnlyWithoutDependencies').is(':checked')
                };

                // Show loading
                var tableContainer = $('#doctorsTable').closest('.card-body');
                tableContainer.html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="sr-only">در حال جستجو...</span></div><p class="mt-3 text-muted">در حال جستجو...</p></div>');

                $.post('@Url.Action("SearchDoctors", "DoctorRemoval")', formData)
                    .done(function(response) {
                        if (response && response.trim()) {
                            tableContainer.html(response);
                            // Wait a bit for DOM to be ready, then initialize
                            setTimeout(function() {
                                if ($('#doctorsTable').length > 0) {
                                    initializeTableEvents();
                                }
                            }, 100);
                        } else {
                            tableContainer.html('<div class="text-center py-5"><i class="fa fa-info-circle fa-3x text-info mb-3"></i><h5 class="text-info">نتیجه‌ای یافت نشد</h5><p class="text-muted">لطفاً فیلترهای جستجو را تغییر دهید</p></div>');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Search error:', error);
                        tableContainer.html('<div class="text-center py-5"><i class="fa fa-exclamation-triangle fa-3x text-danger mb-3"></i><h5 class="text-danger">خطا در جستجو</h5><p class="text-muted">لطفاً دوباره تلاش کنید</p></div>');
                    });
            }

            // Bulk removal function
            function performBulkRemoval(doctorIds) {
                $.post('@Url.Action("BulkRemoval", "DoctorRemoval")', 
                    { doctorIds: doctorIds },
                    function(response) {
                        if (response.success) {
                            alert('حذف انتسابات با موفقیت انجام شد');
                            performSearch(); // Refresh the list
                        } else {
                            alert('خطا در حذف انتسابات: ' + response.message);
                        }
                    }
                ).fail(function() {
                    alert('خطا در ارتباط با سرور');
                });
            }

            // Show doctor details function
            function showDoctorDetails(doctorId) {
                // Create modal for doctor details
                var modalHtml = `
                    <div class="modal fade" id="doctorDetailsModal" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">جزئیات پزشک</h5>
                                    <button type="button" class="close" data-dismiss="modal">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">در حال بارگذاری...</span>
                                        </div>
                                        <p class="mt-3 text-muted">در حال بارگذاری جزئیات...</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                $('#doctorDetailsModal').remove();
                
                // Add modal to body
                $('body').append(modalHtml);
                
                // Show modal
                $('#doctorDetailsModal').modal('show');

                // Load doctor details
                $.get('@Url.Action("GetDoctorDetails", "DoctorRemoval")', { doctorId: doctorId })
                    .done(function(response) {
                        $('#doctorDetailsModal .modal-body').html(response);
                    })
                    .fail(function() {
                        $('#doctorDetailsModal .modal-body').html('<div class="text-center py-5"><i class="fa fa-exclamation-triangle fa-3x text-danger mb-3"></i><h5 class="text-danger">خطا در بارگذاری</h5><p class="text-muted">لطفاً دوباره تلاش کنید</p></div>');
                    });
            }

            // Initialize everything
            function initializeAll() {
                if (!isInitialized) {
                    // Initialize Select2 first (always available)
                    initializeSelect2();
                    
                    // Initialize table events only if table exists
                    if ($('#doctorsTable').length > 0) {
                        initializeTableEvents();
                    }
                    
                    isInitialized = true;
                }
            }

            // Event handlers
            $('#searchBtn').on('click', function() {
                performSearch();
            });

            // Department change - cascade to service categories
            $('#departmentId').on('change', function() {
                var departmentId = $(this).val();
                var serviceCategorySelect = $('#serviceCategoryId');
                
                if (departmentId) {
                    // Show loading
                    serviceCategorySelect.prop('disabled', true);
                    serviceCategorySelect.html('<option value="">در حال بارگذاری...</option>');
                    
                    // Get service categories for selected department
                    $.post('@Url.Action("GetServiceCategoriesByDepartment", "DoctorRemoval")', 
                        { departmentId: departmentId },
                        function(response) {
                            if (response && response.success && response.data) {
                                serviceCategorySelect.html('<option value="">همه سرفصل‌ها</option>');
                                $.each(response.data, function(index, item) {
                                    serviceCategorySelect.append('<option value="' + item.Value + '">' + item.Text + '</option>');
                                });
                            } else {
                                serviceCategorySelect.html('<option value="">خطا در بارگذاری</option>');
                            }
                            serviceCategorySelect.prop('disabled', false);
                            serviceCategorySelect.trigger('change');
                        }
                    ).fail(function(xhr, status, error) {
                        console.error('Error loading service categories:', error);
                        serviceCategorySelect.html('<option value="">خطا در بارگذاری</option>');
                        serviceCategorySelect.prop('disabled', false);
                    });
                } else {
                    // Reset to all service categories
                    serviceCategorySelect.html('<option value="">همه سرفصل‌ها</option>');
                    @if (Model.Filters?.ServiceCategories != null)
                    {
                        foreach (var category in Model.Filters.ServiceCategories)
                        {
                            <text>
                            serviceCategorySelect.append('<option value="@category.Value">@category.Text</option>');
                            </text>
                        }
                    }
                }
            });

            // Clear filters
            $('#clearFiltersBtn').on('click', function() {
                $('#filtersForm')[0].reset();
                $('.select2').val(null).trigger('change');
            });

            // Bulk removal
            $('#bulkRemovalBtn').on('click', function() {
                var selectedIds = $('.doctor-checkbox:checked').map(function() {
                    return $(this).val();
                }).get();

                if (selectedIds.length === 0) {
                    alert('لطفاً حداقل یک پزشک را انتخاب کنید');
                    return;
                }

                if (confirm('آیا از حذف انتسابات ' + selectedIds.length + ' پزشک اطمینان دارید؟')) {
                    performBulkRemoval(selectedIds);
                }
            });

            // View details
            $(document).on('click', '.viewDetailsBtn', function() {
                var doctorId = $(this).data('doctor-id');
                showDoctorDetails(doctorId);
            });

            // Initialize everything on page load
            initializeAll();
        });
    </script>
}
