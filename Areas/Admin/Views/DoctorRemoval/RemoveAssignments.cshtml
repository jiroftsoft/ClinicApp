@model ClinicApp.ViewModels.DoctorManagementVM.DoctorAssignmentRemovalViewModel
@{
    ViewBag.Title = "حذف انتسابات پزشک";
    ViewBag.RequireFormValidation = true;
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger" style="border-width: 2px;">
                <div class="card-header bg-danger text-white" style="background-color: #dc3545 !important;">
                    <h4 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                        <i class="fa fa-exclamation-triangle" style="color: #ffffff !important;"></i>
                        حذف انتسابات پزشک
                    </h4>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    <div class="alert alert-warning" role="alert">
                        <h5 class="alert-heading">
                            <i class="fa fa-warning"></i>
                            هشدار مهم!
                        </h5>
                        <p class="mb-0">
                            این عملیات تمام انتسابات پزشک به دپارتمان‌ها و سرفصل‌های خدماتی را حذف می‌کند. 
                            این عمل غیرقابل برگشت است و ممکن است بر عملکرد سیستم تأثیر بگذارد.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctor Information Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary" style="border-width: 2px;">
                <div class="card-header bg-primary text-white" style="background-color: #007bff !important;">
                    <h5 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                        <i class="fa fa-user" style="color: #ffffff !important;"></i>
                        اطلاعات پزشک
                    </h5>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #007bff;">
                                <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #007bff;">
                                    نام پزشک:
                                </label>
                                <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                    @Model.DoctorName
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #007bff;">
                                <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #007bff;">
                                    کد ملی:
                                </label>
                                <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                    @Model.DoctorNationalCode
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="info-row" style="background-color: #f8f9fa; border-right: 4px solid #007bff;">
                                <label class="info-label" style="color: #2c3e50 !important; background-color: #ffffff; border: 1px solid #007bff;">
                                    تعداد انتسابات فعال:
                                </label>
                                <span class="info-value" style="color: #212529 !important; background-color: #ffffff; border: 1px solid #e9ecef; font-weight: 600;">
                                    <span class="badge badge-success" style="background-color: #28a745 !important; color: #ffffff !important; font-weight: 600;">
                                        @Model.ActiveAssignmentsCount
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removal Form Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning" style="border-width: 2px;">
                <div class="card-header bg-warning text-dark" style="background-color: #ffc107 !important;">
                    <h5 class="card-title mb-0" style="color: #212529 !important; font-weight: 600;">
                        <i class="fa fa-edit" style="color: #212529 !important;"></i>
                        فرم حذف انتسابات
                    </h5>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    @using (Html.BeginForm("RemoveAssignments", "DoctorRemoval", FormMethod.Post, new { @class = "form-horizontal", @id = "removalForm" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.DoctorId)
                        @Html.HiddenFor(m => m.DoctorName)
                        @Html.HiddenFor(m => m.DoctorNationalCode)
                        @Html.HiddenFor(m => m.ActiveAssignmentsCount)

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="form-group">
                                    <label for="RemovalReason" class="form-label" style="color: #2c3e50 !important; font-weight: 600;">
                                        <i class="fa fa-asterisk text-danger"></i>
                                        دلیل حذف انتسابات:
                                    </label>
                                    @Html.TextAreaFor(m => m.RemovalReason, new { 
                                        @class = "form-control", 
                                        @rows = "4", 
                                        @placeholder = "لطفاً دلیل حذف انتسابات را به طور کامل توضیح دهید...",
                                        @style = "border: 2px solid #e9ecef; border-radius: 5px;"
                                    })
                                    @Html.ValidationMessageFor(m => m.RemovalReason, "", new { @class = "text-danger" })
                                    <small class="form-text text-muted">
                                        <i class="fa fa-info-circle"></i>
                                        این توضیحات در تاریخچه عملیات ثبت خواهد شد
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <div class="form-check">
                                        @Html.CheckBoxFor(m => m.IsPermanentRemoval, new { @class = "form-check-input" })
                                        <label for="IsPermanentRemoval" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            حذف قطعی (غیرقابل برگشت)
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fa fa-warning text-warning"></i>
                                        در صورت انتخاب این گزینه، انتسابات به طور کامل از دیتابیس حذف خواهند شد
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                    <div class="form-check">
                                        @Html.CheckBoxFor(m => m.DependenciesChecked, new { @class = "form-check-input" })
                                        <label for="DependenciesChecked" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            وابستگی‌ها بررسی شده‌اند
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fa fa-check text-success"></i>
                                        تأیید می‌کنم که وابستگی‌های پزشک بررسی شده‌اند
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="alert alert-info" role="alert">
                                    <h6 class="alert-heading">
                                        <i class="fa fa-info-circle"></i>
                                        تأییدات لازم:
                                    </h6>
                                    <div class="form-check mb-2">
                                        @Html.CheckBoxFor(m => m.ConfirmRemoval, new { @class = "form-check-input" })
                                        <label for="ConfirmRemoval" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            تأیید می‌کنم که می‌خواهم انتسابات این پزشک را حذف کنم
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        @Html.CheckBoxFor(m => m.ConfirmResponsibility, new { @class = "form-check-input" })
                                        <label for="ConfirmResponsibility" class="form-check-label" style="color: #2c3e50 !important; font-weight: 600;">
                                            تأیید می‌کنم که مسئولیت عواقب این عمل را می‌پذیرم
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-actions text-center">
                                    <button type="submit" id="submitBtn" class="btn btn-danger btn-lg" disabled>
                                        <i class="fa fa-trash"></i>
                                        حذف انتسابات
                                    </button>
                                    <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                                        <i class="fa fa-arrow-left"></i>
                                        بازگشت به لیست
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencies Check Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info" style="border-width: 2px;">
                <div class="card-header bg-info text-white" style="background-color: #17a2b8 !important;">
                    <h5 class="card-title mb-0" style="color: #ffffff !important; font-weight: 600;">
                        <i class="fa fa-link" style="color: #ffffff !important;"></i>
                        بررسی وابستگی‌ها
                    </h5>
                </div>
                <div class="card-body" style="background-color: #ffffff;">
                    <div class="text-center">
                        <button type="button" id="checkDependenciesBtn" class="btn btn-info btn-lg">
                            <i class="fa fa-search"></i>
                            بررسی وابستگی‌ها
                        </button>
                    </div>
                    <div id="dependenciesResult" class="mt-3" style="display: none;">
                        <!-- Dependencies result will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Form validation
            function validateForm() {
                var isValid = true;
                
                // Check required fields
                if (!$('#RemovalReason').val().trim()) {
                    isValid = false;
                }
                
                if (!$('#ConfirmRemoval').is(':checked')) {
                    isValid = false;
                }
                
                if (!$('#ConfirmResponsibility').is(':checked')) {
                    isValid = false;
                }
                
                if ($('#ActiveAssignmentsCount').val() > 0 && !$('#DependenciesChecked').is(':checked')) {
                    isValid = false;
                }
                
                $('#submitBtn').prop('disabled', !isValid);
            }

            // Real-time validation
            $('#RemovalReason, #ConfirmRemoval, #ConfirmResponsibility, #DependenciesChecked').on('change input', function() {
                validateForm();
            });

            // Check dependencies
            $('#checkDependenciesBtn').on('click', function() {
                var doctorId = $('#DoctorId').val();
                var $btn = $(this);
                var $result = $('#dependenciesResult');
                
                $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> در حال بررسی...');
                
                $.ajax({
                    url: '@Url.Action("ConfirmRemoval", "DoctorRemoval")',
                    type: 'POST',
                    data: { doctorId: doctorId },
                    success: function(response) {
                        if (response.success) {
                            $result.html(
                                '<div class="alert alert-success">' +
                                '<h6><i class="fa fa-check-circle"></i> ' + response.message + '</h6>' +
                                '<p>امکان حذف انتسابات وجود دارد.</p>' +
                                '</div>'
                            ).show();
                        } else {
                            $result.html(
                                '<div class="alert alert-danger">' +
                                '<h6><i class="fa fa-exclamation-triangle"></i> ' + response.message + '</h6>' +
                                '<p>امکان حذف انتسابات وجود ندارد.</p>' +
                                '</div>'
                            ).show();
                        }
                    },
                    error: function() {
                        $result.html(
                            '<div class="alert alert-danger">' +
                            '<h6><i class="fa fa-exclamation-triangle"></i> خطا در بررسی وابستگی‌ها</h6>' +
                            '<p>لطفاً دوباره تلاش کنید.</p>' +
                            '</div>'
                        ).show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html('<i class="fa fa-search"></i> بررسی وابستگی‌ها');
                    }
                });
            });

            // Form submission
            $('#removalForm').on('submit', function(e) {
                if (!$('#submitBtn').prop('disabled')) {
                    if (!confirm('آیا از حذف انتسابات این پزشک اطمینان دارید؟ این عمل غیرقابل برگشت است.')) {
                        e.preventDefault();
                    }
                } else {
                    e.preventDefault();
                    alert('لطفاً تمام فیلدهای اجباری را پر کنید و تأییدات لازم را انجام دهید.');
                }
            });

            // Initial validation
            validateForm();
        });
    </script>
}
