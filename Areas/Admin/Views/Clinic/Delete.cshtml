@model ClinicApp.ViewModels.ClinicDetailsViewModel
@{
    ViewBag.Title = "تأیید حذف کلینیک";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<!-- استایل‌های حیاتی برای عملکرد بالا (Inline برای کاهش درخواست‌ها) -->
<style type="text/css">
    /* استایل‌های حیاتی برای اولین رندر */
    .delete-container {
        max-width: 700px;
        margin: 0 auto;
    }

    .warning-box {
        background: #fff8f8;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 25px;
        color: #721c24;
    }

    .warning-icon {
        font-size: 2.5rem;
        color: #dc3545;
        margin-bottom: 15px;
    }

    .clinic-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .info-row {
        display: flex;
        margin-bottom: 10px;
    }

    .info-label {
        flex: 0 0 120px;
        font-weight: bold;
        color: #495057;
    }

    .info-value {
        flex: 1;
    }

    .stats-section {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        padding: 15px;
        background: #e9ecef;
        border-radius: 4px;
    }

    .stats-item {
        text-align: center;
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }

    .stats-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .confirmation-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 20px;
        margin-top: 25px;
    }

    .confirmation-input {
        margin: 15px 0;
    }

    .btn-delete {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
        padding: 10px 20px;
        font-weight: bold;
        transition: all 0.2s;
    }

        .btn-delete:hover {
            background: #c82333;
            border-color: #bd2130;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(220, 53, 69, 0.2);
        }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #e9ecef;
        border-top: 5px solid #dc3545;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* بهینه‌سازی برای دستگاه‌های پزشکی */
    @@media (max-width: 768px) {
        .stats-section {
            flex-direction: column;
            gap: 15px;
        }

        .info-row {
            flex-direction: column;
        }

        .info-label {
            margin-bottom: 5px;
        }
    }

    /* برای دستگاه‌های پزشکی با نور کم */
    @@media (prefers-contrast: high) {
        .warning-box {
            border: 2px solid #dc3545;
        }

        .clinic-info {
            border: 2px solid #000;
        }
    }

    /* افکت‌های تعاملی برای محیط‌های پزشکی */
    .btn-delete {
        touch-action: manipulation;
    }

        .btn-delete:active {
            transform: scale(0.98);
        }
</style>

<div class="delete-container">
    <div class="page-header">
        <h1 class="page-title">تأیید حذف کلینیک</h1>
        <p class="page-description">عملیات حذف کلینیک در سیستم کلینیک شفا</p>
    </div>

    <!-- هشدار امنیتی -->
    <div class="warning-box">
        <div class="text-center">
            <i class="fa fa-exclamation-triangle warning-icon"></i>
            <h3>هشدار امنیتی مهم</h3>
            <p>حذف کلینیک یک عملیات برگشت‌ناپذیر است و می‌تواند بر تمام داده‌های پزشکی تأثیر بگذارد.</p>
            <p>لطفاً قبل از ادامه، مطمئن شوید که این کلینیک دپارتمان فعالی ندارد یا از اطلاعات پشتیبان گرفته‌اید.</p>
        </div>
    </div>

    <!-- اطلاعات کلینیک -->
    <div class="clinic-info">
        <h2 class="mb-4">اطلاعات کلینیک "@Model.Name"</h2>

        <div class="info-row">
            <div class="info-label">نام کلینیک:</div>
            <div class="info-value">@Model.Name</div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Address))
        {
            <div class="info-row">
                <div class="info-label">آدرس:</div>
                <div class="info-value">@Model.Address</div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.PhoneNumber))
        {
            <div class="info-row">
                <div class="info-label">شماره تماس:</div>
                <div class="info-value">@Model.PhoneNumber</div>
            </div>
        }

        <div class="info-row">
            <div class="info-label">وضعیت:</div>
            <div class="info-value">
                <span class="badge @(Model.IsActive ? "badge-success" : "badge-danger")">
                    @(Model.IsActive ? "فعال" : "غیرفعال")
                </span>
            </div>
        </div>

        <div class="info-row">
            <div class="info-label">تاریخ ایجاد:</div>
            <div class="info-value">@Model.CreatedAt.ToString("yyyy/MM/dd HH:mm") توسط @Model.CreatedBy</div>
        </div>

        @if (Model.UpdatedAt.HasValue)
        {
            <div class="info-row">
                <div class="info-label">آخرین به‌روزرسانی:</div>
                <div class="info-value">@Model.UpdatedAt.Value.ToString("yyyy/MM/dd HH:mm") توسط @Model.UpdatedBy</div>
            </div>
        }
    </div>

    <!-- آمار کلینیک -->
    <div class="stats-section">
        <div class="stats-item">
            <div class="stats-value">@Model.DepartmentCount</div>
            <div class="stats-label">دپارتمان</div>
        </div>
        <div class="stats-item">
            <div class="stats-value">@Model.DoctorCount</div>
            <div class="stats-label">پزشک</div>
        </div>
        <div class="stats-item">
            <div class="stats-value">@(Model.DepartmentCount * 5)</div>
            <div class="stats-label">خدمات</div>
        </div>
    </div>

    <!-- بررسی امکان حذف -->
    @if (Model.DepartmentCount > 0)
    {
        <div class="alert alert-danger">
            <i class="fa fa-warning"></i>
            امکان حذف این کلینیک وجود ندارد چون @Model.DepartmentCount دپارتمان فعال دارد.
            لطفاً ابتدا تمام دپارتمان‌ها را حذف یا منتقل کنید.
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="fa fa-info-circle"></i>
            این کلینیک @Model.DoctorCount پزشک فعال دارد که پس از حذف کلینیک، به حالت غیرفعال درخواهند آمد.
            لطفاً مطمئن شوید که این عملیات مورد تأیید است.
        </div>
    }

    <!-- بخش تأیید حذف -->
    @if (Model.DepartmentCount == 0)
    {
        <div class="confirmation-section">
            <h3 class="mb-4">تأیید نهایی حذف کلینیک</h3>

            <p>برای تأیید حذف کلینیک "@Model.Name"، لطفاً نام کلینیک را دقیقاً همان‌طور که در زیر آمده است وارد کنید:</p>

            <div class="alert alert-light">
                <strong>@Model.Name</strong>
            </div>

            <div class="confirmation-input">
                <input type="text" id="confirmationInput" class="form-control"
                       placeholder="نام کلینیک را اینجا وارد کنید"
                       autocomplete="off">
                <div id="confirmationError" class="text-danger" style="display: none; margin-top: 5px;">
                    نام کلینیک وارد شده با نام کلینیک مورد نظر مطابقت ندارد
                </div>
            </div>

            <div class="text-center">
                <a href="@Url.RouteUrl("Admin_default", new { controller = "Clinic", action = "Index" })"
                   class="btn btn-secondary mr-2">
                    <i class="fa fa-arrow-left"></i> انصراف
                </a>
                <button type="button" id="deleteButton" class="btn btn-delete" disabled>
                    <i class="fa fa-trash"></i> تأیید و حذف کلینیک
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="text-center mt-4">
            <a href="@Url.RouteUrl("Admin_default", new { controller = "Clinic", action = "Index" })"
               class="btn btn-secondary">
                <i class="fa fa-arrow-left"></i> بازگشت به لیست کلینیک‌ها
            </a>
            <a href="@Url.RouteUrl("Admin_default", new { controller = "Department", action = "Index", clinicId = Model.ClinicId })"
               class="btn btn-primary ml-2">
                <i class="fa fa-sitemap"></i> مدیریت دپارتمان‌ها
            </a>
        </div>
    }
</div>

<!-- لایه لودینگ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p style="margin-top: 15px;">در حال پردازش درخواست حذف...</p>
</div>

<!-- اسکریپت‌های حیاتی برای عملکرد بالا -->
<script type="text/javascript">
    // این اسکریپت‌ها به صورت inline برای کاهش تعداد درخواست‌ها اضافه شده‌اند
    (function() {
        'use strict';

        document.addEventListener('DOMContentLoaded', function() {
            const confirmationInput = document.getElementById('confirmationInput');
            const deleteButton = document.getElementById('deleteButton');
            const confirmationError = document.getElementById('confirmationError');
            const loadingOverlay = document.getElementById('loadingOverlay');

            // بررسی مطابقت نام کلینیک
            function validateConfirmation() {
                const expectedName = '@Html.Raw(Model.Name)';
                const enteredName = confirmationInput.value.trim();

                if (enteredName === expectedName) {
                    confirmationError.style.display = 'none';
                    deleteButton.disabled = false;
                    return true;
                } else {
                    confirmationError.style.display = 'block';
                    deleteButton.disabled = true;
                    return false;
                }
            }

            // تنظیم رویداد تغییر متن
            if (confirmationInput) {
                confirmationInput.addEventListener('input', validateConfirmation);
            }

            // تنظیم کلیدهای میانبر پزشکی
            document.addEventListener('keydown', function(e) {
                // Alt + D برای فوکوس روی فیلد تأیید
                if (e.altKey && e.key === 'd' && confirmationInput) {
                    e.preventDefault();
                    confirmationInput.focus();
                }

                // Alt + C برای انصراف
                if (e.altKey && e.key === 'c') {
                    e.preventDefault();
                    window.location.href = '@Url.RouteUrl("Admin_default", new { controller = "Clinic", action = "Index" })';
                }

                // Alt + D دوباره برای حذف (پس از فوکوس روی فیلد)
                if (e.altKey && e.key === 'd' && !deleteButton.disabled) {
                    e.preventDefault();
                    deleteButton.click();
                }
            });

            // تنظیم دکمه حذف
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    if (!validateConfirmation()) {
                        return;
                    }

                    // نمایش لودر
                    loadingOverlay.style.display = 'flex';

                    // ایجاد فرم دیتا
                    const formData = new FormData();
                    formData.append('id', '@Model.ClinicId');
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                    // ارسال درخواست
                    fetch('@Url.RouteUrl("Admin_default", new { controller = "Clinic", action = "DeleteConfirmed", id = Model.ClinicId })', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        }
                        throw new Error('خطا در ارتباط با سرور');
                    })
                    .then(html => {
                        try {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const successMessage = doc.querySelector('.alert-success');

                            if (successMessage) {
                                // موفقیت‌آمیز بوده - هدایت به لیست
                                window.location.href = '@Url.RouteUrl("Admin_default", new { controller = "Clinic", action = "Index" })';
                            } else {
                                // خطا در حذف
                                const errorMessage = doc.querySelector('.alert-danger');
                                if (errorMessage) {
                                    alert('خطا در حذف کلینیک: ' + errorMessage.textContent);
                                } else {
                                    alert('خطای ناشناخته رخ داده است. لطفاً مجدداً تلاش کنید.');
                                }

                                // پنهان کردن لودر
                                loadingOverlay.style.display = 'none';
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            alert('خطای سیستم رخ داده است. لطفاً مجدداً تلاش کنید.');
                            loadingOverlay.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.');
                        loadingOverlay.style.display = 'none';
                    });
                });
            }

            // بهینه‌سازی برای دستگاه‌های پزشکی
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.body.style.transition = 'none';
            }

            // راهنمای سریع برای کاربران جدید
            if (!sessionStorage.getItem('deleteClinicHelpShown')) {
                setTimeout(() => {
                    alert('راهنمای حذف کلینیک:\n' +
                          '- برای تأیید حذف، نام کلینیک را دقیقاً وارد کنید\n' +
                          '- Alt+D: فوکوس روی فیلد تأیید یا حذف (در صورت تأیید)\n' +
                          '- Alt+C: انصراف از حذف');
                    sessionStorage.setItem('deleteClinicHelpShown', 'true');
                }, 2000);
            }
        });
    })();
</script>