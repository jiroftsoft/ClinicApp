@model ClinicApp.ViewModels.Insurance.InsuranceCalculation.InsuranceCalculationViewModel
@{
    ViewBag.Title = "Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- ğŸ›¡ï¸ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ Ùˆ Ù…ÙˆÙÙ‚ÛŒØª -->
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Ø®Ø·Ø§:</strong> @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>Ù…ÙˆÙÙ‚ÛŒØª:</strong> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-calculator"></i>
                        Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">
                            <i class="fas fa-shield-alt"></i>
                            Ø³ÛŒØ³ØªÙ… Ø¶Ø¯ Ú¯Ù„ÙˆÙ„Ù‡
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("CalculatePatientShare", "InsuranceCalculation", FormMethod.Post, new { @class = "form-horizontal", role = "form", id = "calculationForm" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        <!-- ğŸ›¡ï¸ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ -->
                        @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.PatientId, new { @class = "control-label" })
                                    @Html.DropDownListFor(m => m.PatientId, Model.PatientSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±", new { @class = "form-control", required = "required" })
                                    @Html.ValidationMessageFor(m => m.PatientId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.ServiceId, new { @class = "control-label" })
                                    @Html.DropDownListFor(m => m.ServiceId, Model.ServiceSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª", new { @class = "form-control", required = "required" })
                                    @Html.ValidationMessageFor(m => m.ServiceId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.PatientInsuranceId, new { @class = "control-label" })
                                    @Html.DropDownListFor(m => m.PatientInsuranceId, Model.PatientInsuranceSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±", new { @class = "form-control", required = "required" })
                                    @Html.ValidationMessageFor(m => m.PatientInsuranceId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.CalculationDate, new { @class = "control-label" })
                                    @Html.TextBoxFor(m => m.CalculationDate, "{0:yyyy/MM/dd}", new { @class = "form-control persian-datepicker", required = "required" })
                                    @Html.ValidationMessageFor(m => m.CalculationDate, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.ServiceAmount, new { @class = "control-label" })
                                    @Html.TextBoxFor(m => m.ServiceAmount, new { @class = "form-control", type = "number", step = "0.01", required = "required" })
                                    @Html.ValidationMessageFor(m => m.ServiceAmount, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.CalculationType, new { @class = "control-label" })
                                    @Html.TextBoxFor(m => m.CalculationType, new { @class = "form-control" })
                                    @Html.ValidationMessageFor(m => m.CalculationType, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.Notes, new { @class = "control-label" })
                                    @Html.TextAreaFor(m => m.Notes, new { @class = "form-control", rows = 3 })
                                    @Html.ValidationMessageFor(m => m.Notes, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-offset-2 col-md-10">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i>
                                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fas fa-list"></i>
                                    Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // ğŸ›¡ï¸ Initialize Persian DatePicker with error handling
            try {
                $('.persian-datepicker').persianDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    initialValue: false,
                    calendar: {
                        persian: {
                            locale: 'fa',
                            showHint: true,
                            leapYearMode: 'algorithmic'
                        }
                    },
                    onSelect: function(persianDate) {
                        // ğŸ›¡ï¸ Validate selected date
                        validateCalculationDate(persianDate);
                    }
                });
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ', 'error');
            }

            // ğŸ›¡ï¸ Load patient insurances when patient changes with error handling
            $('#PatientId').change(function() {
                var patientId = $(this).val();
                if (patientId && patientId > 0) {
                    loadPatientInsurances(patientId);
                } else {
                    $('#PatientInsuranceId').empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±</option>');
                }
            });

            // ğŸ›¡ï¸ Form validation before submit
            $('#calculationForm').submit(function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }
                
                // ğŸ›¡ï¸ Show loading state
                showLoadingState();
            });

            // ğŸ›¡ï¸ Real-time validation
            $('#ServiceAmount').on('input', function() {
                validateServiceAmount($(this).val());
            });

            function loadPatientInsurances(patientId) {
                // ğŸ›¡ï¸ Validate patient ID
                if (!patientId || patientId <= 0) {
                    console.error('Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                    return;
                }

                // ğŸ›¡ï¸ Show loading indicator
                var select = $('#PatientInsuranceId');
                select.prop('disabled', true);
                select.html('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>');

                $.ajax({
                    url: '@Url.Action("GetPatientInsurances", "InsuranceCalculation")',
                    type: 'POST',
                    data: { 
                        patientId: patientId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    timeout: 10000, // 10 seconds timeout
                    success: function(data) {
                        try {
                            select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±</option>');
                            
                            if (data && data.success && data.data) {
                                $.each(data.data, function(index, item) {
                                    select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                });
                            } else {
                                select.append('<option value="">Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                            }
                        } catch (error) {
                            console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡:', error);
                            select.html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±:', error);
                        select.html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>');
                        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±', 'error');
                    },
                    complete: function() {
                        select.prop('disabled', false);
                    }
                });
            }

            function validateForm() {
                var isValid = true;
                var errors = [];

                // ğŸ›¡ï¸ Validate patient selection
                var patientId = $('#PatientId').val();
                if (!patientId || patientId <= 0) {
                    errors.push('Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                    isValid = false;
                }

                // ğŸ›¡ï¸ Validate service selection
                var serviceId = $('#ServiceId').val();
                if (!serviceId || serviceId <= 0) {
                    errors.push('Ø®Ø¯Ù…Øª Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                    isValid = false;
                }

                // ğŸ›¡ï¸ Validate service amount
                var serviceAmount = parseFloat($('#ServiceAmount').val());
                if (!serviceAmount || serviceAmount <= 0) {
                    errors.push('Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
                    isValid = false;
                }

                if (serviceAmount > 1000000000) { // 1 billion
                    errors.push('Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Øª Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª');
                    isValid = false;
                }

                // ğŸ›¡ï¸ Validate calculation date
                var calculationDate = $('#CalculationDate').val();
                if (!calculationDate) {
                    errors.push('ØªØ§Ø±ÛŒØ® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                    isValid = false;
                }

                if (errors.length > 0) {
                    showAlert('Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: ' + errors.join(', '), 'error');
                }

                return isValid;
            }

            function validateServiceAmount(amount) {
                var amountValue = parseFloat(amount);
                var amountField = $('#ServiceAmount');
                
                if (amountValue < 0) {
                    amountField.addClass('is-invalid');
                    showFieldError(amountField, 'Ù…Ø¨Ù„Øº Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯');
                } else if (amountValue > 1000000000) {
                    amountField.addClass('is-invalid');
                    showFieldError(amountField, 'Ù…Ø¨Ù„Øº Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª');
                } else if (amountValue > 0) {
                    amountField.removeClass('is-invalid').addClass('is-valid');
                    clearFieldError(amountField);
                }
            }

            function validateCalculationDate(persianDate) {
                // ğŸ›¡ï¸ Validate date is not too far in future or past
                var now = new Date();
                var selectedDate = new Date(persianDate);
                var diffDays = Math.abs((selectedDate - now) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 365 * 2) { // More than 2 years
                    showAlert('ØªØ§Ø±ÛŒØ® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¬Ø§Ø² Ø§Ø³Øª', 'warning');
                }
            }

            function showFieldError(field, message) {
                field.siblings('.invalid-feedback').remove();
                field.after('<div class="invalid-feedback">' + message + '</div>');
            }

            function clearFieldError(field) {
                field.siblings('.invalid-feedback').remove();
            }

            function showAlert(message, type) {
                var alertClass = type === 'error' ? 'alert-danger' : 
                                type === 'warning' ? 'alert-warning' : 'alert-info';
                
                var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                    '<i class="fas fa-exclamation-triangle"></i> ' + message +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span></button></div>';
                
                $('.container-fluid').prepend(alertHtml);
                
                // Auto dismiss after 5 seconds
                setTimeout(function() {
                    $('.alert').fadeOut();
                }, 5000);
            }

            function showLoadingState() {
                var submitBtn = $('button[type="submit"]');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...');
            }
        });
    </script>
}
