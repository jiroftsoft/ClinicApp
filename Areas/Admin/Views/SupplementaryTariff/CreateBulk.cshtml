@model ClinicApp.ViewModels.Insurance.Supplementary.BulkSupplementaryTariffViewModel
@{
    ViewBag.Title = "Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ú¯Ø±ÙˆÙ‡ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-layer-group me-2"></i>
                                Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ú¯Ø±ÙˆÙ‡ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                            </h4>
                            <p class="mb-0 mt-1">Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ú¯Ø±ÙˆÙ‡ÛŒ</p>
                        </div>
                        <div>
                            <a href="@Url.Action("Index", "SupplementaryTariff")" class="btn btn-outline-light">
                                <i class="fas fa-arrow-right me-1"></i>
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="row">
        <div class="col-12">
            <form id="bulkTariffForm" method="post" action="@Url.Action("CreateBulk", "SupplementaryTariff")" novalidate>
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "alert alert-danger", @id = "validationSummary" })
                
                <!-- Progress Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100"
                                 id="progressBar">
                                Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Ù¾ÛŒØ´Ø±ÙØª: <span id="progressText">0%</span> - <span id="currentStep">Ø¢Ù…Ø§Ø¯Ù‡</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Insurance Selection -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="PrimaryInsurancePlanId" class="form-label">
                                        <i class="fas fa-hospital me-1"></i>
                                        Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ *
                                    </label>
                                    @Html.DropDownListFor(m => m.PrimaryInsurancePlanId, 
                                        new SelectList(Model.PrimaryInsurancePlans, "InsurancePlanId", "Name"), 
                                        "Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡", 
                                        new { @class = "form-select", @required = "required", @id = "PrimaryInsurancePlanId" })
                                    @Html.ValidationMessageFor(m => m.PrimaryInsurancePlanId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="InsurancePlanId" class="form-label">
                                        <i class="fas fa-plus-circle me-1"></i>
                                        Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ *
                                    </label>
                                    @Html.DropDownListFor(m => m.InsurancePlanId, 
                                        new SelectList(Model.SupplementaryInsurancePlans, "InsurancePlanId", "Name"), 
                                        "Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ", 
                                        new { @class = "form-select", @required = "required", @id = "InsurancePlanId" })
                                    @Html.ValidationMessageFor(m => m.InsurancePlanId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Note: Steps 2 and 3 (Department and Category Selection) have been replaced by Cascade Selection below -->

                <!-- Step 4: Coverage Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-percentage me-2"></i>
                            Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÙˆØ´Ø´
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="SupplementaryCoveragePercent" class="form-label">
                                        <i class="fas fa-percentage me-1"></i>
                                        Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ *
                                    </label>
                                    @Html.TextBoxFor(m => m.SupplementaryCoveragePercent, 
                                        new { @class = "form-control", @type = "number", @step = "0.01", @min = "0", @max = "100", @required = "required", @id = "SupplementaryCoveragePercent", @placeholder = "Ù…Ø«Ø§Ù„: 90.50" })
                                    @Html.ValidationMessageFor(m => m.SupplementaryCoveragePercent, "", new { @class = "text-danger" })
                                    <div class="form-text">Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ (0-100)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="Priority" class="form-label">
                                        <i class="fas fa-sort-numeric-up me-1"></i>
                                        Ø§ÙˆÙ„ÙˆÛŒØª ØªØ¹Ø±ÙÙ‡ *
                                    </label>
                                    @Html.TextBoxFor(m => m.Priority, 
                                        new { @class = "form-control", @type = "number", @min = "1", @max = "10", @required = "required", @id = "Priority" })
                                    @Html.ValidationMessageFor(m => m.Priority, "", new { @class = "text-danger" })
                                    <div class="form-text">Ø§ÙˆÙ„ÙˆÛŒØª ØªØ¹Ø±ÙÙ‡ (1-10ØŒ 1 Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø§ÙˆÙ„ÙˆÛŒØª)</div>
                                        </div>
                                    </div>
                        </div>
                    </div>
                </div>

                <!-- Insurance Information Display -->
                <div id="insuranceInfoDisplay" class="mb-4">
                    <!-- Insurance plan information will be displayed here -->
                </div>

                <!-- Cascade Selection Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>
                            Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Ø§Øª (Cascade Selection)
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Step 1: Department Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-building me-2"></i>
                                    Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
                                </h6>
                                <div class="row" id="departmentSelection">
                                    <!-- Departments will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Category Selection -->
                        <div class="row mb-4" id="categorySelectionSection" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-tags me-2"></i>
                                    Ù…Ø±Ø­Ù„Ù‡ 2: Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª
                                </h6>
                                <div class="row" id="categorySelection">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Ø§Ø¨ØªØ¯Ø§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Services Preview -->
                        <div class="row mb-4" id="servicesPreviewSection" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-list me-2"></i>
                                    Ù…Ø±Ø­Ù„Ù‡ 3: Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø®Ø¯Ù…Ø§Øª
                                </h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø®Ø¯Ù…Ø§Øª:</strong> <span id="totalServicesCount">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>ØªÙˆØ¬Ù‡:</strong> ØªÙ…Ø§Ù… Ø®Ø¯Ù…Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="servicesList" class="table-responsive">
                                    <!-- Services will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="card mb-4" id="previewSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-primary" id="previewTotalServices">0</div>
                                    <small class="text-muted">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-success" id="previewEstimatedTariffs">0</div>
                                    <small class="text-muted">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ®Ù…ÛŒÙ†ÛŒ</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-info" id="previewCoveragePercent">0%</div>
                                    <small class="text-muted">Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´</small>
                        </div>
                                </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 text-warning" id="previewEstimatedTime">0 Ø«Ø§Ù†ÛŒÙ‡</div>
                                    <small class="text-muted">Ø²Ù…Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ</small>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fas fa-layer-group me-2"></i>
                                    Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ú¯Ø±ÙˆÙ‡ÛŒ
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="previewBtn">
                                    <i class="fas fa-eye me-2"></i>
                                    Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                                </button>
                            </div>
                            <div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ØªÙ…Ø§Ù…ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="card">
        <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</span>
                </div>
            <h5>Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§...</h5>
                <p class="text-muted">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize form
            initializeBulkForm();
            
            // Event handlers
            setupEventHandlers();
            
            // Initialize insurance info display
            updateInsuranceInfo();
            
            // Form validation
            setupFormValidation();
        });

        function initializeBulkForm() {
            console.log('ğŸ¥ MEDICAL: Initializing bulk form');
            
            // Set default values
            $('#SupplementaryCoveragePercent').val('90');
            $('#Priority').val('5');
            
            // Update progress
            updateProgress(0, 'Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹');
        }

        function setupEventHandlers() {
            // Department selection
            $('#selectAllDepartments').on('click', function() {
                $('.department-checkbox').prop('checked', true);
                updatePreview();
            });

            $('#deselectAllDepartments').on('click', function() {
                $('.department-checkbox').prop('checked', false);
                updatePreview();
            });

            // Category selection
            $('#selectAllCategories').on('click', function() {
                $('.category-checkbox').prop('checked', true);
                updatePreview();
            });

            $('#deselectAllCategories').on('click', function() {
                $('.category-checkbox').prop('checked', false);
                updatePreview();
            });

            // Form changes
            $('.department-checkbox, .category-checkbox, #SupplementaryCoveragePercent, #Priority').on('change', function() {
                updatePreview();
            });

            // Preview button
            $('#previewBtn').on('click', function() {
                updatePreview();
                $('#previewSection').show();
            });

            // Form submission
            $('#bulkTariffForm').on('submit', function(e) {
                e.preventDefault();
                submitBulkForm();
            });
        }

        // ğŸ”§ MEDICAL: Update insurance information and auto-fill coverage percent
        function updateInsuranceInfo() {
            const primaryPlanId = $('#PrimaryInsurancePlanId').val();
            const supplementaryPlanId = $('#InsurancePlanId').val();
            
            // Auto-fill supplementary coverage percent to 100% when supplementary insurance is selected
            if (supplementaryPlanId && supplementaryPlanId !== '') {
                $('#SupplementaryCoveragePercent').val('100');
                $('#SupplementaryCoveragePercent').addClass('is-valid');
            }
            
            // Display insurance plan information
            displayInsurancePlanInfo(primaryPlanId, supplementaryPlanId);
        }
        
        // ğŸ”§ MEDICAL: Display insurance plan information
        function displayInsurancePlanInfo(primaryPlanId, supplementaryPlanId) {
            // Clear previous info
            $('#insuranceInfoDisplay').empty();
            
            if (primaryPlanId && primaryPlanId !== '') {
                // Find primary plan info
                const primaryPlan = window.primaryInsurancePlans?.find(p => p.InsurancePlanId == primaryPlanId);
                if (primaryPlan) {
                    const primaryInfo = `
                        <div class="alert alert-info mb-3">
                            <h6><i class="fas fa-shield-alt me-2"></i>Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡: ${primaryPlan.InsurancePlanName}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´:</strong> ${primaryPlan.CoveragePercent || 70}%</small>
                                </div>
                                <div class="col-md-6">
                                    <small><strong>ÙØ±Ø§Ù†Ø´ÛŒØ²:</strong> ${(primaryPlan.Deductible || 0).toLocaleString()} Ø±ÛŒØ§Ù„</small>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#insuranceInfoDisplay').append(primaryInfo);
                }
            }
            
            if (supplementaryPlanId && supplementaryPlanId !== '') {
                // Find supplementary plan info
                const supplementaryPlan = window.supplementaryInsurancePlans?.find(p => p.InsurancePlanId == supplementaryPlanId);
                if (supplementaryPlan) {
                    const supplementaryInfo = `
                        <div class="alert alert-success mb-3">
                            <h6><i class="fas fa-plus-circle me-2"></i>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ: ${supplementaryPlan.InsurancePlanName}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</strong> 100%</small>
                                </div>
                                <div class="col-md-6">
                                    <small><strong>Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…:</strong> Ø¨Ù„Ù‡</small>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#insuranceInfoDisplay').append(supplementaryInfo);
                }
            }
        }

        function setupFormValidation() {
            // Real-time validation
            $('#PrimaryInsurancePlanId, #InsurancePlanId').on('change', function() {
                validateForm();
                updateInsuranceInfo();
            });
            
            $('#SupplementaryCoveragePercent').on('input', function() {
                const value = parseFloat($(this).val());
                const valueStr = $(this).val().toString();
                
                // Remove previous validation classes
                $(this).removeClass('is-invalid is-valid');
                
                if (isNaN(value)) {
                    $(this).addClass('is-invalid');
                } else if (value < 0 || value > 100) {
                    $(this).addClass('is-invalid');
                } else {
                    // Check decimal places
                    const decimalIndex = valueStr.indexOf('.');
                    if (decimalIndex !== -1 && valueStr.length - decimalIndex - 1 > 2) {
                        $(this).addClass('is-invalid');
                    } else {
                        $(this).addClass('is-valid');
                    }
                }
                updatePreview();
            });

            // ğŸ”§ MEDICAL: Cascade selection event handlers
            $(document).on('change', '.department-checkbox', function() {
                console.log('ğŸ¥ MEDICAL: Department selection changed');
                const selectedDepartments = $('.department-checkbox:checked');
                
                if (selectedDepartments.length > 0) {
                    // Load categories for first selected department
                    const firstDeptId = selectedDepartments.first().val();
                    loadCategories(firstDeptId);
                } else {
                    // Hide categories and services sections
                    $('#categorySelectionSection').hide();
                    $('#servicesPreviewSection').hide();
                }
            });

            $(document).on('change', '.category-checkbox', function() {
                console.log('ğŸ¥ MEDICAL: Category selection changed');
                loadServices();
            });

            // ğŸ”§ MEDICAL: Load departments on form initialization
            console.log('ğŸ¥ MEDICAL: Form ready, loading departments');
            setTimeout(loadDepartments, 1000); // Delay to ensure form is fully loaded
        }

        function validateForm() {
            const errors = [];
            
            // ğŸ”’ CRITICAL: Required fields validation
            if (!$('#PrimaryInsurancePlanId').val()) {
                errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            }
            
            if (!$('#InsurancePlanId').val()) {
                errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            }
            
            // ğŸ”’ CRITICAL: Department selection validation
            const selectedDepartments = $('.department-checkbox:checked').length;
            if (selectedDepartments === 0) {
                errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            }
            else if (selectedDepartments > 10) {
                errors.push('Ø­Ø¯Ø§Ú©Ø«Ø± 10 Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Øª');
            }
            
            // ğŸ”’ CRITICAL: Category selection validation
            const selectedCategories = $('.category-checkbox:checked').length;
            if (selectedCategories === 0) {
                errors.push('Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³Ø±ÙØµÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            }
            else if (selectedCategories > 20) {
                errors.push('Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ø³Ø±ÙØµÙ„ Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Øª');
            }
            
            // ğŸ”’ CRITICAL: Coverage percent validation
            const coveragePercent = parseFloat($('#SupplementaryCoveragePercent').val());
            if (isNaN(coveragePercent)) {
                errors.push('Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯');
            }
            else if (coveragePercent < 0 || coveragePercent > 100) {
                errors.push('Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 Ø¨Ø§Ø´Ø¯');
            }
            else {
                // Check decimal places using string method
                const coverageStr = $('#SupplementaryCoveragePercent').val().toString();
                const decimalIndex = coverageStr.indexOf('.');
                if (decimalIndex !== -1 && coverageStr.length - decimalIndex - 1 > 2) {
                    errors.push('Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
                }
            }
            
            // ğŸ”’ CRITICAL: Priority validation
            const priority = parseInt($('#Priority').val());
            if (isNaN(priority)) {
                errors.push('Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯');
            }
            else if (priority < 1 || priority > 10) {
                errors.push('Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 ØªØ§ 10 Ø¨Ø§Ø´Ø¯');
            }
            
            // ğŸ”’ CRITICAL: Business logic validation
            if (selectedDepartments > 0 && selectedCategories > 0) {
                const estimatedServices = selectedDepartments * selectedCategories * 10; // Rough estimate
                if (estimatedServices > 1000) {
                    errors.push(`ØªØ¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª ØªØ®Ù…ÛŒÙ†ÛŒ (${estimatedServices}) Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² (1000) Ø¨ÛŒØ´ØªØ± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯.`);
                }
            }
            
            return errors;
        }

        function updatePreview() {
            const selectedDepartments = $('.department-checkbox:checked').length;
            const selectedCategories = $('.category-checkbox:checked').length;
            const coveragePercent = $('#SupplementaryCoveragePercent').val() || 90;
            
            // Estimate services count (simplified calculation)
            const estimatedServices = selectedDepartments * selectedCategories * 10; // Rough estimate
            
            // Update preview
            $('#previewTotalServices').text(estimatedServices);
            $('#previewEstimatedTariffs').text(estimatedServices);
            $('#previewCoveragePercent').text(coveragePercent + '%');
            $('#previewEstimatedTime').text(Math.ceil(estimatedServices / 10) + ' Ø«Ø§Ù†ÛŒÙ‡');
            
            // Update progress
            updateProgress(75, 'Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„');
        }

        function updateProgress(percentage, status) {
            $('#progressBar').css('width', percentage + '%').attr('aria-valuenow', percentage);
            $('#progressText').text(percentage + '%');
            $('#currentStep').text(status);
        }

        async function submitBulkForm() {
            try {
                console.log('ğŸ¥ MEDICAL: Starting bulk form submission');
                
                // ğŸ”§ DEBUG: Test basic functionality
                console.log('ğŸ¥ MEDICAL: Testing basic functionality');
                console.log('ğŸ¥ MEDICAL: PrimaryInsurancePlanId:', $('#PrimaryInsurancePlanId').val());
                console.log('ğŸ¥ MEDICAL: InsurancePlanId:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ MEDICAL: SelectedDepartments:', $('.department-checkbox:checked').length);
                console.log('ğŸ¥ MEDICAL: SelectedCategories:', $('.category-checkbox:checked').length);
                
                // Validate form
                const errors = validateForm();
                if (errors.length > 0) {
                    console.log('ğŸ¥ MEDICAL: Validation errors:', errors);
                    showErrors(errors);
                    return;
                }
                
                // Show loading
            $('#loadingOverlay').removeClass('d-none');
                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...');
                
                // Update progress
                updateProgress(25, 'Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                
                // Get form data
                const formData = getFormData();
                console.log('ğŸ¥ MEDICAL: Form data:', formData);
                
                // Submit form
                console.log('ğŸ¥ MEDICAL: Submitting to /Admin/SupplementaryTariff/CreateBulkPost');
                const response = await fetch('/Admin/SupplementaryTariff/CreateBulkPost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });
                
                updateProgress(50, 'Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                
                console.log('ğŸ¥ MEDICAL: Response status:', response.status);
                console.log('ğŸ¥ MEDICAL: Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ¥ MEDICAL: Response data:', result);
                    updateProgress(100, 'ØªÚ©Ù…ÛŒÙ„ Ù…ÙˆÙÙ‚');
                    
                    if (result.success) {
                        showSuccess(result.message);
                        setTimeout(() => {
                            window.location.href = '/Admin/SupplementaryTariff/Index';
                        }, 2000);
                    } else {
                        showErrors([result.message]);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('ğŸ¥ MEDICAL: Response error:', errorText);
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + response.status);
                }
                
            } catch (error) {
                console.error('ğŸ¥ MEDICAL: Bulk form submission error', error);
                showErrors(['Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + error.message]);
            } finally {
                // Hide loading
                $('#loadingOverlay').addClass('d-none');
                $('#submitBtn').prop('disabled', false).html('<i class="fas fa-layer-group me-2"></i>Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ú¯Ø±ÙˆÙ‡ÛŒ');
            }
        }

        function getFormData() {
            // ğŸ”§ MEDICAL: Get selected departments and categories from cascade selection
            const selectedDepartments = $('.department-checkbox:checked').map(function() { 
                return parseInt($(this).val()); 
            }).get();
            
            const selectedCategories = $('.category-checkbox:checked').map(function() { 
                return parseInt($(this).val()); 
            }).get();
            
            console.log('ğŸ¥ MEDICAL: Form data - Departments:', selectedDepartments, 'Categories:', selectedCategories);
            
            return {
                PrimaryInsurancePlanId: parseInt($('#PrimaryInsurancePlanId').val()),
                InsurancePlanId: parseInt($('#InsurancePlanId').val()),
                SelectedDepartmentIds: selectedDepartments,
                SelectedServiceCategoryIds: selectedCategories,
                SupplementaryCoveragePercent: parseFloat($('#SupplementaryCoveragePercent').val()),
                Priority: parseInt($('#Priority').val()),
                IsActive: true
            };
        }

        function showErrors(errors) {
            // Clear previous messages
            $('#validationSummary').empty().hide();
            
            // Show each error with toastr
            errors.forEach((error, index) => {
                setTimeout(() => {
                    toastr.error(error, 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ', {
                        timeOut: 5000,
                        positionClass: 'toast-top-right',
                        preventDuplicates: true,
                        progressBar: true,
                        closeButton: true
                    });
                }, index * 100); // Stagger the toasts
            });
            
            // Also show in validation summary for reference
            const errorHtml = '<div class="alert alert-danger"><ul class="mb-0">' + 
                errors.map(error => '<li>' + error + '</li>').join('') + 
                '</ul></div>';
            $('#validationSummary').html(errorHtml).show();
        }

        function showSuccess(message) {
            // Clear previous messages
            $('#validationSummary').empty().hide();
            
            // Show success with toastr
            toastr.success(message, 'Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚', {
                timeOut: 3000,
                positionClass: 'toast-top-right',
                preventDuplicates: true,
                progressBar: true,
                closeButton: true
            });
            
            // Also show in validation summary
            const successHtml = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>' + message + '</div>';
            $('#validationSummary').html(successHtml).show();
        }

        // ğŸ”§ MEDICAL: Load departments for cascade selection
        async function loadDepartments() {
            try {
                console.log('ğŸ¥ MEDICAL: Loading departments');
                
                const response = await fetch('/Admin/SupplementaryTariff/GetDepartments', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const departments = await response.json();
                    console.log('ğŸ¥ MEDICAL: Departments result:', departments);
                    
                    if (departments && departments.length > 0) {
                        displayDepartments(departments);
                    } else {
                        $('#departmentSelection').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Ù‡ÛŒÚ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>');
                    }
                } else {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§');
                }
                
            } catch (error) {
                console.error('ğŸ¥ MEDICAL: Error loading departments:', error);
                $('#departmentSelection').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§: ' + error.message + '</div>');
            }
        }

        // ğŸ”§ MEDICAL: Load categories for selected department
        async function loadCategories(departmentId) {
            try {
                console.log('ğŸ¥ MEDICAL: Loading categories for department:', departmentId);
                
                const response = await fetch('/Admin/SupplementaryTariff/GetCategories?departmentId=' + departmentId, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ¥ MEDICAL: Categories result:', result);
                    
                    if (result.success && result.data && result.data.categories) {
                        displayCategories(result.data.categories);
                        $('#categorySelectionSection').show();
                    } else {
                        $('#categorySelection').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Ù‡ÛŒÚ† Ø³Ø±ÙØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>');
                        $('#categorySelectionSection').show();
                    }
                } else {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§');
                }
                
            } catch (error) {
                console.error('ğŸ¥ MEDICAL: Error loading categories:', error);
                $('#categorySelection').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§: ' + error.message + '</div>');
                $('#categorySelectionSection').show();
            }
        }

        // ğŸ”§ MEDICAL: Load services for selected categories
        async function loadServices() {
            try {
                console.log('ğŸ¥ MEDICAL: Loading services for selected categories');
                
                const selectedDepartments = $('.department-checkbox:checked').map(function() { 
                    return parseInt($(this).val()); 
                }).get();
                
                const selectedCategories = $('.category-checkbox:checked').map(function() { 
                    return parseInt($(this).val()); 
                }).get();
                
                if (selectedDepartments.length === 0 || selectedCategories.length === 0) {
                    $('#servicesPreviewSection').hide();
                    return;
                }
                
                // Show loading
                $('#servicesPreviewSection').show();
                $('#servicesList').html('<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø¯Ù…Ø§Øª...</div>');
                
                const formData = {
                    SelectedDepartmentIds: selectedDepartments,
                    SelectedServiceCategoryIds: selectedCategories,
                    PrimaryInsurancePlanId: parseInt($('#PrimaryInsurancePlanId').val()),
                    InsurancePlanId: parseInt($('#InsurancePlanId').val()),
                    SupplementaryCoveragePercent: parseFloat($('#SupplementaryCoveragePercent').val()),
                    Priority: parseInt($('#Priority').val()),
                    IsActive: true
                };
                
                // Call server to get services
                const response = await fetch('/Admin/SupplementaryTariff/GetServicesPreview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ¥ MEDICAL: Services preview result:', result);
                    
                    if (result.success && result.data && result.data.services && result.data.services.length > 0) {
                        displayServicesPreview(result.data.services);
                        $('#totalServicesCount').text(result.data.services.length);
                        $('#previewTotalServices').text(result.data.services.length);
                        updatePreview();
                    } else {
                        $('#servicesList').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Ù‡ÛŒÚ† Ø®Ø¯Ù…ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>');
                        $('#totalServicesCount').text('0');
                        $('#previewTotalServices').text('0');
                    }
                } else {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø¯Ù…Ø§Øª');
                }
                
            } catch (error) {
                console.error('ğŸ¥ MEDICAL: Error loading services:', error);
                $('#servicesList').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø¯Ù…Ø§Øª: ' + error.message + '</div>');
            }
        }

        // ğŸ”§ MEDICAL: Display services preview
        function displayServicesPreview(services) {
            let html = '<table class="table table-striped table-hover">';
            html += '<thead class="table-dark">';
            html += '<tr><th>Ú©Ø¯ Ø®Ø¯Ù…Øª</th><th>Ù†Ø§Ù… Ø®Ø¯Ù…Øª</th><th>Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</th><th>Ø³Ø±ÙØµÙ„</th><th>Ù‚ÛŒÙ…Øª (Ø±ÛŒØ§Ù„)</th></tr>';
            html += '</thead><tbody>';
            
            services.forEach(service => {
                html += '<tr>';
                html += '<td><code>' + service.serviceCode + '</code></td>';
                html += '<td>' + service.title + '</td>';
                html += '<td>' + service.departmentName + '</td>';
                html += '<td>' + service.categoryName + '</td>';
                html += '<td class="text-end">' + formatCurrency(service.price) + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            $('#servicesList').html(html);
        }

        // ğŸ”§ MEDICAL: Display departments
        function displayDepartments(departments) {
            let html = '';
            departments.forEach(dept => {
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input department-checkbox" type="checkbox" 
                                           value="${dept.DepartmentId}" id="dept_${dept.DepartmentId}">
                                    <label class="form-check-label" for="dept_${dept.DepartmentId}">
                                        <strong>${dept.Name}</strong>
                                        <br><small class="text-muted">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø¯Ø±Ù…Ø§Ù†ÛŒ</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#departmentSelection').html(html);
        }

        // ğŸ”§ MEDICAL: Display categories
        function displayCategories(categories) {
            let html = '';
            categories.forEach(cat => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input category-checkbox" type="checkbox" 
                                           value="${cat.serviceCategoryId}" id="cat_${cat.serviceCategoryId}">
                                    <label class="form-check-label" for="cat_${cat.serviceCategoryId}">
                                        <strong>${cat.title}</strong>
                                        <br><small class="text-muted">${cat.description || ''}</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#categorySelection').html(html);
        }

        // ğŸ”§ MEDICAL: Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fa-IR').format(amount) + ' Ø±ÛŒØ§Ù„';
        }
    </script>
}