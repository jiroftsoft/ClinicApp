@model ClinicApp.Interfaces.PagedResult<ClinicApp.ViewModels.Insurance.Supplementary.SupplementaryTariffIndexViewModel>

@using System.Globalization

@functions{
    // ğŸ”§ CRITICAL: ÙØ±Ù…Øª ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø¯Ø±Ù…Ø§Ù†ÛŒ - ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ØŒ Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡
    string FormatToman(decimal amount)
    {
        var ci = new CultureInfo("fa-IR");
        return string.Format(ci, "{0:N0} ØªÙˆÙ…Ø§Ù†", amount);
    }

    // Ø¯Ø±ØµØ¯ ØªÙ…ÛŒØ² - Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² 100/0% Ùˆ ÙØ±Ù…Øª ÛŒÚ©Ø¯Ø³Øª
    string FormatPercent(decimal percent)
    {
        if (percent == 0) return "0%";
        if (percent == 100) return "100%";
        return percent % 1 == 0 ? $"{percent:0}%" : $"{percent:0.##}%";
    }
}

<div class="professional-table-container">
    <div class="table-responsive">
        <table class="professional-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="InsuranceTariffId">
                        <span>Ø´Ù†Ø§Ø³Ù‡</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="ServiceTitle">
                        <span>Ù†Ø§Ù… Ø®Ø¯Ù…Øª</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="InsurancePlanName">
                        <span>Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable currency-column" data-sort="TariffPrice">
                        <span>Ù‚ÛŒÙ…Øª Ø®Ø¯Ù…Øª</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="currency-column">Ø³Ù‡Ù… Ù¾Ø§ÛŒÙ‡</th>
                    <th class="sortable currency-column" data-sort="PatientShare">
                        <span>Ø³Ù‡Ù… Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="SupplementaryCoveragePercent">
                        <span>Ù¾ÙˆØ´Ø´ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ùª)</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="currency-column">Ù¾ÙˆØ´Ø´ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ù…Ø¨Ù„Øº)</th>
                    <th class="currency-column">Ø³Ù‡Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨ÛŒÙ…Ø§Ø±</th>
                    <th class="sortable" data-sort="Priority">
                        <span>Ø§ÙˆÙ„ÙˆÛŒØª</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="StartDate">
                        <span>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="EndDate">
                        <span>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-sort="IsActive">
                        <span>ÙˆØ¶Ø¹ÛŒØª</span>
                        <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="actions-column">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody id="tariffsTableBody">
                @if (!Model.Items.Any())
                {
                    <tr>
                        <td colspan="14" class="empty-state">
                            <div class="empty-state-content">
                                <i class="fas fa-search"></i>
                                <h4>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
                                <p>ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</p>
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Items)
                    {
                        <tr data-tariff-id="@item.InsuranceTariffId" class="table-row">
                            <td class="id-cell">
                                <span class="id-badge">@item.InsuranceTariffId</span>
                            </td>
                            <td class="service-cell">
                                <div class="service-info">
                                    <div class="service-title">@item.ServiceTitle</div>
                                    <div class="service-code">@item.ServiceCode</div>
                                </div>
                            </td>
                            <td class="insurance-cell">
                                <div class="insurance-info">
                                    <div class="plan-name">@item.InsurancePlanName</div>
                                    <div class="provider-name">@item.InsuranceProviderName</div>
                                </div>
                            </td>
                            <td class="currency-cell">
                                <span class="currency-amount">@FormatToman(item.TariffPriceToman)</span>
                            </td>
                            <td class="currency-cell">
                                <span class="currency-amount">@FormatToman(item.InsurerShareToman)</span>
                            </td>
                            <td class="currency-cell">
                                <span class="currency-amount">@FormatToman(item.PatientShareToman)</span>
                            </td>
                            <td class="percentage-cell">
                                <div class="percentage-info">
                                    <span class="percentage-badge">@FormatPercent(item.SupplementaryCoveragePercent ?? 0)</span>
                                    @if (item.SupplementaryMaxPaymentToman > 0)
                                    {
                                        <div class="max-payment">Ø³Ù‚Ù: @FormatToman(item.SupplementaryMaxPaymentToman)</div>
                                    }
                                </div>
                            </td>
                            <td class="currency-cell">
                                <span class="currency-amount">@FormatToman(item.SupplementaryCoverageAmountToman)</span>
                            </td>
                            <td class="currency-cell final-amount">
                                <span class="currency-amount">@FormatToman(item.FinalPatientShareToman)</span>
                            </td>
                            <td class="priority-cell">
                                <span class="priority-badge">@(item.Priority?.ToString() ?? "0")</span>
                            </td>
                            <td class="date-cell">
                                <span class="date-text">@(item.StartDate?.ToString("yyyy/MM/dd") ?? "Ù†Ø§Ù…Ø´Ø®Øµ")</span>
                            </td>
                            <td class="date-cell">
                                <span class="date-text">@(item.EndDate?.ToString("yyyy/MM/dd") ?? "Ù†Ø§Ù…Ø´Ø®Øµ")</span>
                            </td>
                            <td class="status-cell">
                                <span class="status-badge @(item.IsActive ? "active" : "inactive")">
                                    @(item.IsActive ? "ÙØ¹Ø§Ù„" : "ØºÛŒØ±ÙØ¹Ø§Ù„")
                                </span>
                            </td>
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    <a href="@Url.Action("Details", new { id = item.InsuranceTariffId })" 
                                       class="action-btn view-btn" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª" aria-label="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ @item.InsuranceTariffId">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Edit", new { id = item.InsuranceTariffId })" 
                                       class="action-btn edit-btn" title="ÙˆÛŒØ±Ø§ÛŒØ´" aria-label="ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡ @item.InsuranceTariffId">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="action-btn delete-btn" 
                                            onclick="deleteTariff(@item.InsuranceTariffId)" title="Ø­Ø°Ù" aria-label="Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ @item.InsuranceTariffId">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
        </tbody>
    </table>
</div>

<script>
    // Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨Ø§ Anti-forgery Token
    function deleteTariff(tariffId) {
        if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªØ¹Ø±ÙÙ‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
            // Ø¯Ø±ÛŒØ§ÙØª Anti-forgery Token
            var token = $('input[name="__RequestVerificationToken"]').val();
            
            $.ajax({
                url: '@Url.Action("DeleteTariff", "SupplementaryTariff", new { area = "Admin" })',
                type: 'POST',
                data: {
                    id: tariffId,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        // Ø­Ø°Ù Ø±Ø¯ÛŒÙ Ø§Ø² Ø¬Ø¯ÙˆÙ„
                        $('tr[data-tariff-id="' + tariffId + '"]').fadeOut(300, function() {
                            $(this).remove();
                        });
                        
                        if (typeof window.MedicalUI !== 'undefined') {
                            window.MedicalUI.showSuccess('ØªØ¹Ø±ÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                        }
                    } else {
                        if (typeof window.MedicalUI !== 'undefined') {
                            window.MedicalUI.showError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡: ' + (response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡:', error);
                    if (typeof window.MedicalUI !== 'undefined') {
                        window.MedicalUI.showError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡: ' + error);
                    }
                }
            });
        }
    }
</script>
</div>