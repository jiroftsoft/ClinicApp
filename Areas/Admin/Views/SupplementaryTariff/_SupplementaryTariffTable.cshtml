@model ClinicApp.Interfaces.PagedResult<ClinicApp.ViewModels.Insurance.Supplementary.SupplementaryTariffIndexViewModel>

@using System.Globalization

@functions{
    // 🔧 CRITICAL: فرمت صحیح برای محیط درمانی - فقط نمایش، نه محاسبه
    string FormatToman(decimal amount)
    {
        var ci = new CultureInfo("fa-IR");
        return string.Format(ci, "{0:N0} تومان", amount);
    }

    // درصد تمیز - جلوگیری از 100/0% و فرمت یکدست
    string FormatPercent(decimal percent)
    {
        if (percent == 0) return "0%";
        if (percent == 100) return "100%";
        return percent % 1 == 0 ? $"{percent:0}%" : $"{percent:0.##}%";
    }
}

<div class="table-responsive">
    <table class="table table-hover supplementary-tariff-table">
        <thead class="table-dark">
            <tr>
                <th>شناسه</th>
                <th>نام خدمت</th>
                <th>طرح بیمه</th>
                <th data-sort="TariffPrice">قیمت خدمت</th>
                <th>سهم پایه (نمایشی)</th>
                <th data-sort="PatientShare">سهم باقی‌مانده بیمار (R)</th>
                <th>پوشش تکمیلی (٪)</th>
                <th>پوشش تکمیلی (مبلغ)</th>
                <th>سهم نهایی بیمار</th>
                <th data-sort="Priority">اولویت</th>
                <th data-sort="StartDate">تاریخ شروع</th>
                <th data-sort="EndDate">تاریخ پایان</th>
                <th data-sort="IsActive">وضعیت</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="tariffsTableBody">
            @if (!Model.Items.Any())
            {
                <tr>
                    <td colspan="14" class="text-center text-muted py-4">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <div>نتیجه‌ای یافت نشد</div>
                        <small>فیلترها را تغییر دهید یا تعرفه جدید ایجاد کنید</small>
                    </td>
                </tr>
            }
            else
            {
                foreach (var item in Model.Items)
                {
                    <tr data-tariff-id="@item.InsuranceTariffId">
                        <td>
                            <span class="badge badge-secondary">@item.InsuranceTariffId</span>
                        </td>
                        <td>
                            <div class="fw-bold">@item.ServiceTitle</div>
                            <small class="text-muted">@item.ServiceCode</small>
                        </td>
                        <td>
                            <div class="fw-bold">@item.InsurancePlanName</div>
                            <small class="text-muted">@item.InsuranceProviderName</small>
                        </td>
                        <td>
                            <span class="currency-format" dir="ltr">@FormatToman(item.TariffPriceToman)</span>
                        </td>
                        <td>
                            <div class="small text-muted">سهم پایه (نمایشی)</div>
                            <div>@FormatToman(item.InsurerShareToman)</div>
                        </td>
                        <td>
                            <div class="small text-muted">سهم باقی‌مانده بیمار (R)</div>
                            <div class="fw-600">@FormatToman(item.PatientShareToman)</div>
                        </td>
                        <td>
                            <div class="text-center">
                                <span class="badge badge-info">@FormatPercent(item.SupplementaryCoveragePercent ?? 0)</span>
                                @if (item.SupplementaryMaxPaymentToman > 0)
                                {
                                    <div class="text-muted small mt-1">سقف: @FormatToman(item.SupplementaryMaxPaymentToman)</div>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="text-center">
                                <span class="fw-600 text-primary">@FormatToman(item.SupplementaryCoverageAmountToman)</span>
                            </div>
                        </td>
                        <td class="text-success fw-600 text-center">@FormatToman(item.FinalPatientShareToman)</td>
                        <td>
                            <span class="badge badge-info">@(item.Priority?.ToString() ?? "0")</span>
                        </td>
                        <td>
                            <span class="text-muted">@(item.StartDate?.ToString("yyyy/MM/dd") ?? "نامشخص")</span>
                        </td>
                        <td>
                            <span class="text-muted">@(item.EndDate?.ToString("yyyy/MM/dd") ?? "نامشخص")</span>
                        </td>
                        <td>
                            <span class="badge @(item.IsActive ? "bg-success" : "bg-secondary")">
                                @(item.IsActive ? "فعال" : "غیرفعال")
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group" aria-label="عملیات">
                                <a href="@Url.Action("Details", new { id = item.InsuranceTariffId })" 
                                   class="btn btn-sm btn-outline-info" title="مشاهده جزئیات" aria-label="مشاهده جزئیات تعرفه @item.InsuranceTariffId">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="@Url.Action("Edit", new { id = item.InsuranceTariffId })" 
                                   class="btn btn-sm btn-outline-warning" title="ویرایش" aria-label="ویرایش تعرفه @item.InsuranceTariffId">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteTariff(@item.InsuranceTariffId)" title="حذف" aria-label="حذف تعرفه @item.InsuranceTariffId">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<script>
    // حذف تعرفه با Anti-forgery Token
    function deleteTariff(tariffId) {
        if (confirm('آیا از حذف این تعرفه اطمینان دارید؟')) {
            // دریافت Anti-forgery Token
            var token = $('input[name="__RequestVerificationToken"]').val();
            
            $.ajax({
                url: '@Url.Action("DeleteTariff", "SupplementaryTariff", new { area = "Admin" })',
                type: 'POST',
                data: {
                    id: tariffId,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        // حذف ردیف از جدول
                        $('tr[data-tariff-id="' + tariffId + '"]').fadeOut(300, function() {
                            $(this).remove();
                        });
                        
                        if (typeof window.MedicalUI !== 'undefined') {
                            window.MedicalUI.showSuccess('تعرفه با موفقیت حذف شد');
                        }
                    } else {
                        if (typeof window.MedicalUI !== 'undefined') {
                            window.MedicalUI.showError('خطا در حذف تعرفه: ' + (response.message || 'خطای نامشخص'));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('خطا در حذف تعرفه:', error);
                    if (typeof window.MedicalUI !== 'undefined') {
                        window.MedicalUI.showError('خطا در حذف تعرفه: ' + error);
                    }
                }
            });
        }
    }
</script>