@model ClinicApp.Interfaces.PagedResult<ClinicApp.ViewModels.DoctorManagementVM.DoctorServiceCategoryViewModel>
@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ„Ø§Ø­ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§ØªÛŒ Ù¾Ø²Ø´Ú©Ø§Ù†";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fa fa-user"></i>
                        Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ„Ø§Ø­ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§ØªÛŒ Ù¾Ø²Ø´Ú©Ø§Ù†
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" id="openAddModalBtn">
                            <i class="fa fa-plus"></i>
                            Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØµÙ„Ø§Ø­ÛŒØª Ø¬Ø¯ÛŒØ¯
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                            <i class="fa fa-check"></i>
                            @TempData["Success"]
                        </div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                            <i class="fa fa-warning"></i>
                            @TempData["Error"]
                        </div>
                    }

                    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="doctorFilter">Ù¾Ø²Ø´Ú©:</label>
                                <select id="doctorFilter" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ Ù¾Ø²Ø´Ú©Ø§Ù†</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="serviceCategoryFilter">Ø³Ø±ÙØµÙ„ Ø®Ø¯Ù…Ø§ØªÛŒ:</label>
                                <select id="serviceCategoryFilter" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="statusFilter">ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select id="statusFilter" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                                    <option value="true">ÙØ¹Ø§Ù„</option>
                                    <option value="false">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div class="btn-group btn-block" role="group">
                                    <button type="button" id="searchBtn" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                        Ø¬Ø³ØªØ¬Ùˆ
                                    </button>
                                    <button type="button" id="clearFiltersBtn" class="btn btn-outline-secondary">
                                        <i class="fa fa-times"></i>
                                        Ø­Ø°Ù ÙÛŒÙ„ØªØ±
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø¬Ø¯ÙˆÙ„ ØµÙ„Ø§Ø­ÛŒØªâ€ŒÙ‡Ø§ -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Ù¾Ø²Ø´Ú©</th>
                                    <th>Ø³Ø±ÙØµÙ„ Ø®Ø¯Ù…Ø§ØªÛŒ</th>
                                    <th>Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</th>
                                    <th>Ø³Ø·Ø­ ØµÙ„Ø§Ø­ÛŒØª</th>
                                    <th>Ø´Ù…Ø§Ø±Ù‡ Ú¯ÙˆØ§Ù‡ÛŒ</th>
                                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                    <th>ØªØ§Ø±ÛŒØ® Ø§Ø¹Ø·Ø§</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="serviceCategoriesTable">
                                @if (Model?.Items != null && Model.Items.Any())
                                {
                                    foreach (var item in Model.Items)
                                    {
                                        <tr data-id="@item.AssignmentId">
                                            <td>@(item.DoctorName ?? "-")</td>
                                            <td>@(item.ServiceCategoryTitle ?? "-")</td>
                                            <td>@(item.DepartmentName ?? "-")</td>
                                            <td>@(item.AuthorizationLevel ?? "-")</td>
                                            <td>@(item.CertificateNumber ?? "-")</td>
                                            <td>
                                                @if (item.IsActive)
                                                {
                                                    <span class="badge badge-success">ÙØ¹Ø§Ù„</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-danger">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                                                }
                                            </td>
                                            <td>@(item.GrantedDate?.ToString("yyyy/MM/dd") ?? "-")</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-sm btn-primary" onclick="viewServiceCategory('@item.AssignmentId')" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">
                                                        <i class="fa fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-warning" onclick="editServiceCategory('@item.AssignmentId')" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                                        <i class="fa fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeServiceCategory(@item.DoctorId, @item.ServiceCategoryId)" title="Ø­Ø°Ù">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="fa fa-info-circle"></i>
                                            Ù‡ÛŒÚ† ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
                    @if (Model != null && Model.TotalPages > 1)
                    {
                        <div class="d-flex justify-content-center">
                            <nav>
                                <ul class="pagination">
                                    @for (int i = 1; i <= Model.TotalPages; i++)
                                    {
                                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                            <a class="page-link" href="#" onclick="loadPage(@i)">@i</a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØµÙ„Ø§Ø­ÛŒØª Ø¬Ø¯ÛŒØ¯ -->
<div class="modal fade" id="addServiceCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addServiceCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceCategoryModalLabel">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ Ø¬Ø¯ÛŒØ¯</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addServiceCategoryForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="doctorId">Ù¾Ø²Ø´Ú© *</label>
                                <select id="doctorId" name="DoctorId" class="form-control" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="departmentId">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† *</label>
                                <select id="departmentId" name="DepartmentId" class="form-control" required>
                                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ù¾Ø²Ø´Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="serviceCategoryId">Ø³Ø±ÙØµÙ„ Ø®Ø¯Ù…Ø§ØªÛŒ *</label>
                                <select id="serviceCategoryId" name="ServiceCategoryId" class="form-control" multiple size="5" required>
                                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                </select>
                                <div class="mt-2">
                                    <button type="button" id="selectAllCategories" class="btn btn-sm btn-outline-primary">
                                        <i class="fa fa-check-square"></i>
                                        Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                                    </button>
                                    <button type="button" id="deselectAllCategories" class="btn btn-sm btn-outline-secondary">
                                        <i class="fa fa-square"></i>
                                        Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle"></i>
                                    Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡: Ctrl+Click (Windows) ÛŒØ§ Cmd+Click (Mac)
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="authorizationLevel">Ø³Ø·Ø­ ØµÙ„Ø§Ø­ÛŒØª</label>
                                <select id="authorizationLevel" name="AuthorizationLevel" class="form-control">
                                    <option value="Basic">Ù¾Ø§ÛŒÙ‡</option>
                                    <option value="Intermediate">Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Advanced">Ù¾ÛŒØ´Ø±ÙØªÙ‡</option>
                                    <option value="Expert">Ù…ØªØ®ØµØµ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="certificateNumber">Ø´Ù…Ø§Ø±Ù‡ Ú¯ÙˆØ§Ù‡ÛŒ</label>
                                <input type="text" id="certificateNumber" name="CertificateNumber" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grantedDate">ØªØ§Ø±ÛŒØ® Ø§Ø¹Ø·Ø§</label>
                                <input type="text" id="grantedDate" name="GrantedDate" class="form-control persian-date" 
                                       data-alt-field="#grantedDateGregorian"
                                       placeholder="Ù…Ø«Ø§Ù„: 1404/06/01" />
                                <!-- ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ -->
                                <input type="hidden" id="grantedDateGregorian" name="GrantedDateGregorian" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="expiryDate">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                                <input type="text" id="expiryDate" name="ExpiryDate" class="form-control persian-date" 
                                       data-alt-field="#expiryDateGregorian"
                                       placeholder="Ù…Ø«Ø§Ù„: 1404/06/01" />
                                <!-- ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ -->
                                <input type="hidden" id="expiryDateGregorian" name="ExpiryDateGregorian" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="isActive">ÙˆØ¶Ø¹ÛŒØª</label>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" id="isActive" name="IsActive" class="custom-control-input" checked>
                                    <label class="custom-control-label" for="isActive">ÙØ¹Ø§Ù„</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <textarea id="notes" name="Notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" id="saveAddServiceCategoryBtn" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ø§ÙØ²ÙˆØ¯Ù† ØªÙˆÚ©Ù† Ø¶Ø¯ Ø¬Ø¹Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ POST
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (settings.type === 'POST') {
                    var token = $('input[name="__RequestVerificationToken"]').val();
                    if (token) {
                        xhr.setRequestHeader('RequestVerificationToken', token);
                        xhr.setRequestHeader('X-RequestVerificationToken', token);
                    }
                }
            }
        });

        $(document).ready(function () {
            console.log('Document ready - jQuery version:', $.fn.jquery);
            console.log('Bootstrap modal available:', typeof $.fn.modal !== 'undefined');
            
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Bootstrap
            if (typeof $.fn.modal === 'undefined') {
                console.error('Bootstrap modal not loaded!');
                console.log('Available jQuery methods:', Object.keys($.fn).filter(k => k.includes('modal')));
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Bootstrap. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            // ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ø§Ø±Ú©Ø±Ø¯ Ù…ÙˆØ¯Ø§Ù„
            console.log('Testing modal functionality...');
            try {
                var modalElement = $('#addServiceCategoryModal');
                console.log('Modal element found:', modalElement.length > 0);
                console.log('Modal classes:', modalElement.attr('class'));
            } catch (e) {
                console.error('Error testing modal:', e);
            }
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡
            $('#openAddModalBtn').on('click', function(e) {
                console.log('Button clicked - attempting to open modal');
                e.preventDefault();
                
                // ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„
                setTimeout(function() {
                    try {
                        // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Bootstrap
                        $('#addServiceCategoryModal').modal('show');
                        console.log('Modal should be open now');
                        
                        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Persian DatePicker Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„
                        setTimeout(function() {
                            console.log('Modal opened - DatePicker will be initialized by global handler');
                        }, 200);

                    } catch (error) {
                        console.error('Error opening modal:', error);
                        
                        // Ø±Ø§Ù‡â€ŒØ­Ù„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ
                        console.log('Falling back to manual modal display');
                        $('#addServiceCategoryModal').show();
                        $('body').addClass('modal-open');
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† backdrop
                        if (!$('.modal-backdrop').length) {
                            $('body').append('<div class="modal-backdrop fade show"></div>');
                        }
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† CSS Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
                        $('#addServiceCategoryModal').css({
                            'display': 'block',
                            'position': 'fixed',
                            'top': '0',
                            'left': '0',
                            'width': '100%',
                            'height': '100%',
                            'z-index': '1050',
                            'background-color': 'rgba(0,0,0,0.5)'
                        });
                        
                        // Ù…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
                        $('.modal-dialog').css({
                            'margin': '50px auto',
                            'max-width': '800px'
                        });
                        
                        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Persian DatePicker Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„
                        setTimeout(function() {
                            console.log('Modal opened (fallback) - DatePicker will be initialized by global handler');
                        }, 200);

                    }
                }, 100);
            });
            
            // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ backdrop ÛŒØ§ Ø¯Ú©Ù…Ù‡ close
            $(document).on('click', '.modal-backdrop, [data-dismiss="modal"]', function() {
                $('#addServiceCategoryModal').hide();
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
                
                // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ CSS
                $('#addServiceCategoryModal').css({
                    'display': 'none',
                    'position': '',
                    'top': '',
                    'left': '',
                    'width': '',
                    'height': '',
                    'z-index': '',
                    'background-color': ''
                });
            });
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Persian DatePicker Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„
            $('#addServiceCategoryModal').on('shown.bs.modal', function() {
                console.log('Modal shown - initializing DatePicker for modal fields');
                setTimeout(function() {
                    if (typeof $.fn.persianDatepicker !== 'undefined') {
                        $('#addServiceCategoryModal .persian-date').each(function() {
                            var $this = $(this);
                            if (!$this.data('persian-datepicker-initialized')) {
                                $this.persianDatepicker({
                                    format: 'YYYY/MM/DD',
                                    initialValue: false,
                                    autoClose: true,
                                    observer: false,
                                    persianDigit: true,
                                    calendar: {
                                        persian: {
                                            locale: 'fa',
                                            leapYearMode: 'astronomical'
                                        }
                                    },
                                    toolbox: {
                                        todayBtn: { enabled: true, text: { fa: 'Ø§Ù…Ø±ÙˆØ²' } },
                                        clearBtn: { enabled: true, text: { fa: 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†' } }
                                    },
                                    onSelect: function(unix) {
                                        // Convert to Persian date using jalaali-js
                                        if (typeof window.jalaali !== 'undefined') {
                                            var date = new Date(unix);
                                            var persianDate = window.jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                                            var formattedDate = persianDate.jy + '/' + 
                                                String(persianDate.jm).padStart(2, '0') + '/' + 
                                                String(persianDate.jd).padStart(2, '0');
                                            $this.val(formattedDate);
                                        } else {
                                            // Fallback to simple display
                                            $this.val($this.val());
                                        }
                                        
                                        // Trigger change event
                                        $this.trigger('change');
                                    }
                                });
                                $this.data('persian-datepicker-initialized', true);
                            }
                        });
                    }
                }, 100);
            });
            
            loadDoctors();
            loadServiceCategories();
            
            // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø´Ù…Ø³ÛŒ)
            // Let the DatePicker handle the default date setting
            console.log('Date fields will be initialized by global DatePicker handler');
            
            // ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ú©Ù…Ù‡
            console.log('Add button found:', $('#openAddModalBtn').length > 0);
            console.log('Modal found:', $('#addServiceCategoryModal').length > 0);
            console.log('Persian DatePicker fields found:', $('.persian-date').length);
            
            // Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨Ù‡ Ø§Ú©Ø´Ù† Index Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§
            $('#searchBtn').click(function () {
                var doctorId = $('#doctorFilter').val();
                var serviceCategoryId = $('#serviceCategoryFilter').val();
                var isActive = $('#statusFilter').val();
                var url = '@Url.Action("Index")?page=1';
                if (doctorId) url += '&doctorId=' + encodeURIComponent(doctorId);
                if (serviceCategoryId) url += '&serviceCategoryId=' + encodeURIComponent(serviceCategoryId);
                if (isActive !== '') url += '&isActive=' + encodeURIComponent(isActive);
                window.location.href = url;
            });
            
            // ÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†
            $('#addServiceCategoryForm').submit(function (e) {
                e.preventDefault();
                addServiceCategory();
            });
            // Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
            $('#saveAddServiceCategoryBtn').on('click', function (e) {
                e.preventDefault();
                addServiceCategory();
            });
        });

        function parseIfString(data) {
            if (typeof data === 'string') {
                try { return JSON.parse(data); } catch (e) { return null; }
            }
            return data;
        }

        function loadDoctors() {
            $.ajax({
                url: '@Url.Action("GetDoctors", "Doctor")',
                type: 'GET',
                dataType: 'json'
            })
            .done(function (data) {
                var parsed = parseIfString(data);
                if (parsed && parsed.success && Array.isArray(parsed.data)) {
                    var options = '<option value="">Ù‡Ù…Ù‡ Ù¾Ø²Ø´Ú©Ø§Ù†</option>';
                    parsed.data.forEach(function (doctor) {
                        options += '<option value="' + doctor.Id + '">' + doctor.FullName + '</option>';
                    });
                    $('#doctorFilter').html(options);
                    $('#doctorId').html(options);
                } else {
                    console.warn('No doctors returned or response malformed.', data);
                }
            })
            .fail(function (xhr, status, error) {
                console.error('Failed to load doctors:', status, error);
            });
        }

        function loadServiceCategories() {
            var filters = {
                doctorId: $('#doctorFilter').val(),
                serviceCategoryId: $('#serviceCategoryFilter').val(),
                isActive: $('#statusFilter').val()
            };

            $.ajax({
                url: '@Url.Action("GetServiceCategories")',
                type: 'GET',
                data: filters,
                dataType: 'json'
            })
            .done(function (data) {
                var parsed = parseIfString(data);
                if (parsed && parsed.success && Array.isArray(parsed.data)) {
                    var options = '<option value="">Ù‡Ù…Ù‡ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§</option>';
                    parsed.data.forEach(function (category) {
                        options += '<option value="' + category.Id + '">' + category.Name + '</option>';
                    });
                    $('#serviceCategoryFilter').html(options);
                    $('#serviceCategoryId').html(options);
                } else {
                    console.warn('No service categories returned or response malformed.', data);
                }
            })
            .fail(function (xhr, status, error) {
                console.error('Failed to load service categories:', status, error);
            });
        }

        function addServiceCategory() {
            var selectedDoctor = $('#doctorId').val();
            var selectedDepartment = $('#departmentId').val();
            var selectedCategories = $('#serviceCategoryId').val();
            
            if (!selectedDoctor || !selectedDepartment) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù¾Ø²Ø´Ú© Ùˆ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            if (!selectedCategories || selectedCategories.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³Ø±ÙØµÙ„ Ø®Ø¯Ù…Ø§ØªÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                return;
            }

            // Ø¯Ø±ÛŒØ§ÙØª Anti-Forgery Token
            var token = $('input[name="__RequestVerificationToken"]').val();
            console.log('Anti-Forgery Token:', token);
            
            if (!token) {
                alert('Ø®Ø·Ø§: ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú†Ù†Ø¯ÛŒÙ† Ø³Ø±ÙØµÙ„
            var formData = {
                DoctorId: selectedDoctor,
                DepartmentId: selectedDepartment,
                ServiceCategoryIds: selectedCategories,
                AuthorizationLevel: $('#authorizationLevel').val(),
                CertificateNumber: $('#certificateNumber').val(),
                GrantedDate: $('#grantedDate').val(),
                GrantedDateGregorian: $('#grantedDateGregorian').val(),
                ExpiryDate: $('#expiryDate').val(),
                ExpiryDateGregorian: $('#expiryDateGregorian').val(),
                IsActive: $('#isActive').is(':checked'),
                Notes: $('#notes').val(),
                __RequestVerificationToken: token
            };
            
            console.log('Form data for multiple categories:', formData);
            console.log('Submitting addServiceCategory with multiple categories');
            
            $.ajax({
                url: '@Url.Action("AddMultipleServiceCategories")',
                type: 'POST',
                data: formData,
                dataType: 'json',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('RequestVerificationToken', token);
                }
            })
            .done(function (data) {
                var parsed = parseIfString(data);
                console.log('AddServiceCategory response', parsed || data);
                if (parsed && parsed.success) {
                    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                    try {
                        $('#addServiceCategoryModal').modal('hide');
                    } catch (e) {
                        // Ø±Ø§Ù‡â€ŒØ­Ù„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                        $('#addServiceCategoryModal').hide();
                        $('body').removeClass('modal-open');
                        $('.modal-backdrop').remove();
                        
                        // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ CSS
                        $('#addServiceCategoryModal').css({
                            'display': 'none',
                            'position': '',
                            'top': '',
                            'left': '',
                            'width': '',
                            'height': '',
                            'z-index': '',
                            'background-color': ''
                        });
                    }
                    
                    var redirectDoctorId = $('#doctorId').val() || '';
                    var redirectUrl = '@Url.Action("Index")';
                    if (redirectDoctorId) {
                        redirectUrl += '?doctorId=' + encodeURIComponent(redirectDoctorId);
                    }
                    window.location.href = redirectUrl;
                } else {
                    alert('Ø®Ø·Ø§: ' + (parsed && parsed.message ? parsed.message : 'Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±'));
                }
            })
            .fail(function (xhr, status, error) {
                console.error('Failed to add service category:', status, error, xhr && xhr.responseText);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            });
        }

        function viewServiceCategory(assignmentId) {
            try {
                console.log('ğŸ” Viewing service category with assignmentId:', assignmentId);
                console.log('ğŸ” AssignmentId type:', typeof assignmentId);
                if (!assignmentId || assignmentId === 'undefined' || assignmentId === '') {
                    console.error('âŒ Invalid assignmentId:', assignmentId);
                    alert('Ø´Ù†Ø§Ø³Ù‡ ØµÙ„Ø§Ø­ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                    return;
                }
                var url = '@Url.Action("Details")?assignmentId=' + encodeURIComponent(assignmentId);
                console.log('ğŸ”— Navigating to:', url);
                window.location.href = url;
            } catch (error) {
                console.error('âŒ Error in viewServiceCategory:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ');
            }
        }

        function editServiceCategory(assignmentId) {
            try {
                console.log('âœï¸ Editing service category with assignmentId:', assignmentId);
                console.log('âœï¸ AssignmentId type:', typeof assignmentId);
                if (!assignmentId || assignmentId === 'undefined' || assignmentId === '') {
                    console.error('âŒ Invalid assignmentId:', assignmentId);
                    alert('Ø´Ù†Ø§Ø³Ù‡ ØµÙ„Ø§Ø­ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                    return;
                }
                var url = '@Url.Action("Edit")?assignmentId=' + encodeURIComponent(assignmentId);
                console.log('ğŸ”— Navigating to:', url);
                window.location.href = url;
            } catch (error) {
                console.error('âŒ Error in editServiceCategory:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ');
            }
        }

        function removeServiceCategory(doctorId, serviceCategoryId) {
            try {
                console.log('Removing service category. DoctorId:', doctorId, 'ServiceCategoryId:', serviceCategoryId);
                if (!doctorId || !serviceCategoryId) {
                    console.error('Invalid parameters. DoctorId:', doctorId, 'ServiceCategoryId:', serviceCategoryId);
                    alert('Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                    return;
                }

                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    $.ajax({
                        url: '@Url.Action("RemoveServiceCategory")',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            doctorId: doctorId,
                            categoryId: serviceCategoryId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        }
                    })
                    .done(function (data) {
                        var parsed = parseIfString(data);
                        if (parsed && parsed.success) {
                            location.reload();
                        } else {
                            console.error('Remove service category failed:', data);
                            alert('Ø®Ø·Ø§: ' + (parsed && parsed.message ? parsed.message : 'Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±'));
                        }
                    })
                    .fail(function (xhr, status, error) {
                        console.error('AJAX request failed:', status, error);
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    });
                }
            } catch (error) {
                console.error('Error in removeServiceCategory:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØµÙ„Ø§Ø­ÛŒØª Ø®Ø¯Ù…Ø§ØªÛŒ');
            }
        }

        // Event Handler Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©
        $(document).on('change', '#doctorId', function() {
            var doctorId = $(this).val();
            if (doctorId) {
                loadDoctorDepartments(doctorId);
            } else {
                // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ§Ø¨Ø³ØªÙ‡
                $('#departmentId').html('<option value="">Ø§Ø¨ØªØ¯Ø§ Ù¾Ø²Ø´Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
                $('#serviceCategoryId').html('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
            }
        });

        // Event Handler Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†
        $(document).on('change', '#departmentId', function() {
            var departmentId = $(this).val();
            if (departmentId) {
                loadServiceCategoriesByDepartment(departmentId);
            } else {
                // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯ Ø³Ø±ÙØµÙ„
                $('#serviceCategoryId').html('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
            }
        });

        function loadDoctorDepartments(doctorId) {
            $.ajax({
                url: '@Url.Action("GetDoctorDepartments")',
                type: 'GET',
                data: { doctorId: doctorId },
                dataType: 'json'
            })
            .done(function (data) {
                var parsed = parseIfString(data);
                if (parsed && parsed.success && Array.isArray(parsed.data)) {
                    var options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</option>';
                    parsed.data.forEach(function (department) {
                        options += '<option value="' + department.Id + '">' + department.Name + '</option>';
                    });
                    $('#departmentId').html(options);
                } else {
                    console.warn('No departments returned or response malformed.', data);
                    $('#departmentId').html('<option value="">Ù‡ÛŒÚ† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                }
            })
            .fail(function (xhr, status, error) {
                console.error('Failed to load doctor departments:', status, error);
                $('#departmentId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§</option>');
            });
        }

        function loadServiceCategoriesByDepartment(departmentId) {
            $.ajax({
                url: '@Url.Action("GetServiceCategoriesByDepartment")',
                type: 'GET',
                data: { departmentId: departmentId },
                dataType: 'json'
            })
            .done(function (data) {
                var parsed = parseIfString(data);
                if (parsed && parsed.success && Array.isArray(parsed.data)) {
                    var options = '';
                    parsed.data.forEach(function (category) {
                        options += '<option value="' + category.Id + '">' + category.Name + '</option>';
                    });
                    $('#serviceCategoryId').html(options);
                } else {
                    console.warn('No service categories returned or response malformed.', data);
                    $('#serviceCategoryId').html('<option value="">Ù‡ÛŒÚ† Ø³Ø±ÙØµÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                }
            })
            .fail(function (xhr, status, error) {
                console.error('Failed to load service categories by department:', status, error);
                $('#serviceCategoryId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§</option>');
            });
        }

        // Event Handler Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§
        $(document).on('click', '#selectAllCategories', function() {
            $('#serviceCategoryId option').prop('selected', true);
        });

        // Event Handler Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§
        $(document).on('click', '#deselectAllCategories', function() {
            $('#serviceCategoryId option').prop('selected', false);
        });

        // Event Handler Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§
        $(document).on('click', '#clearFiltersBtn', function() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§
            $('#doctorFilter').val('');
            $('#serviceCategoryFilter').val('');
            $('#statusFilter').val('');
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ Ø¨Ø¯ÙˆÙ† ÙÛŒÙ„ØªØ±
            var url = '@Url.Action("Index")';
            window.location.href = url;
        });

        // Event Handler Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø¬Ø³ØªØ¬Ùˆ
        $(document).on('click', '#searchBtn', function() {
            performSearch();
        });

        // Event Handler Ø¨Ø±Ø§ÛŒ Enter Ø¯Ø± ÙÛŒÙ„ØªØ±Ù‡Ø§
        $(document).on('keypress', '#doctorFilter, #serviceCategoryFilter, #statusFilter', function(e) {
            if (e.which === 13) { // Enter key
                performSearch();
            }
        });

        function performSearch() {
            var url = '@Url.Action("Index")';
            var filters = {
                doctorId: $('#doctorFilter').val(),
                serviceCategoryId: $('#serviceCategoryFilter').val(),
                isActive: $('#statusFilter').val()
            };
            
            var hasFilters = false;
            $.each(filters, function (key, value) {
                if (value && value !== '') {
                    url += (hasFilters ? '&' : '?') + key + '=' + encodeURIComponent(value);
                    hasFilters = true;
                }
            });
            
            window.location.href = url;
        }

        function loadPage(page) {
            var url = '@Url.Action("Index")?page=' + page;
            var filters = {
                doctorId: $('#doctorFilter').val(),
                serviceCategoryId: $('#serviceCategoryFilter').val(),
                isActive: $('#statusFilter').val()
            };
            $.each(filters, function (key, value) {
                if (value) {
                    url += '&' + key + '=' + encodeURIComponent(value);
                }
            });
            window.location.href = url;
        }
    </script>
}
