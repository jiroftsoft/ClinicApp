@model ClinicApp.ViewModels.DoctorManagementVM.DoctorServiceCategoryAssignFormViewModel
@{
    ViewBag.Title = "انتساب پزشک به دسته‌بندی خدمات";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

@section Styles {
    <link href="~/Content/plugins/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <style>
        .assignment-form {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin-bottom: 30px;
        }

            .form-section h5 {
                color: #667eea;
                font-weight: 600;
            }

        .doctor-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
        }

        .btn-submit {
            border-radius: 25px;
            font-weight: 600;
            padding: 12px 30px;
            transition: all 0.3s ease;
        }

            .btn-submit:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }

        .validation-summary {
            border-radius: 10px;
            border: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
}

<div class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">در حال پردازش...</span>
    </div>
</div>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 text-primary">
                        <i class="fas fa-user-plus me-2"></i>
                        انتساب پزشک به دسته‌بندی خدمات
                    </h2>
                    <p class="text-muted mb-0">انتساب پزشک به دسته‌بندی خدمات و تعیین سطح صلاحیت</p>
                </div>
                <div>
                    <a href="@Url.Action("Index", "Doctor")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right me-2"></i>
                        بازگشت به لیست پزشکان
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctor Information Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="doctor-info-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-2">
                            <i class="fas fa-user-md me-2"></i>
                            @(Model?.Doctor?.FullName ?? "نامشخص")
                        </h4>
                        <p class="mb-0">
                            <i class="fas fa-id-card me-2"></i>
                            پزشک متخصص
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="badge bg-light text-dark fs-6">
                            <i class="fas fa-user-md me-1"></i>
                            پزشک
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Form -->
    <div class="row">
        <div class="col-12">
            <div class="assignment-form p-4">
                @using (Html.BeginForm("AssignToServiceCategory", "DoctorServiceCategory", FormMethod.Post,
                       new { id = "assignmentForm", @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.Assignment.DoctorId)
                    @Html.HiddenFor(m => m.Doctor.FullName)

                    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger validation-summary" })

                    <!-- Doctor Information -->
                    <div class="form-section">
                        <h5>
                            <i class="fas fa-user-md me-2"></i>
                            اطلاعات پزشک
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Doctor.FullName, "نام پزشک", new { @class = "form-label fw-bold" })
                                    @Html.TextBoxFor(m => m.Doctor.FullName, new { @class = "form-control", @readonly = "readonly" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">نوع کاربر</label>
                                    <input type="text" class="form-control" value="پزشک متخصص" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Category Selection (نسخه بروزرسانی شده) -->
                    <div class="form-section">
                        <h5>
                            <i class="fas fa-stethoscope me-2"></i>
                            انتخاب دسته‌بندی‌های خدمات
                        </h5>
                        
                        <!-- فیلتر دپارتمان -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">فیلتر بر اساس دپارتمان</label>
                                    <select id="departmentFilter" class="form-select">
                                        <option value="">همه دپارتمان‌ها</option>
                                        @if (Model.AvailableDepartments != null)
                                        {
                                            foreach (var dept in Model.AvailableDepartments)
                                            {
                                                <option value="@dept.Value">@dept.Text</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">وضعیت انتخاب</label>
                                    <div class="form-check">
                                        <input type="checkbox" id="selectAll" class="form-check-input" />
                                        <label class="form-check-label" for="selectAll">
                                            انتخاب همه
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- انتخاب چندگانه دسته‌بندی‌های خدمات -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">دسته‌بندی‌های خدمات</label>
                                    <select id="serviceCategories" name="SelectedServiceCategoryIds" multiple class="form-select" size="8" required>
                                        @if (Model.AvailableServiceCategories != null)
                                        {
                                            foreach (var category in Model.AvailableServiceCategories)
                                            {
                                                <option value="@category.Value" data-department="@category.Group?.Name">@category.Text</option>
                                            }
                                        }
                                    </select>
                                    <div class="form-text">برای انتخاب چندگانه، Ctrl را نگه دارید و کلیک کنید</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Assignment.AuthorizationLevel, "سطح صلاحیت", new { @class = "form-label fw-bold" })
                                    @Html.DropDownListFor(m => m.Assignment.AuthorizationLevel,
                                        new SelectList(new[] {
                                            new { Value = "مبتدی", Text = "مبتدی" },
                                            new { Value = "متوسط", Text = "متوسط" },
                                            new { Value = "پیشرفته", Text = "پیشرفته" },
                                            new { Value = "متخصص", Text = "متخصص" }
                                        }, "Value", "Text"),
                                        "انتخاب سطح صلاحیت...",
                                        new { @class = "form-select", required = "required" })
                                    @Html.ValidationMessageFor(m => m.Assignment.AuthorizationLevel, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <!-- نمایش دسته‌بندی‌های انتخاب شده -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">دسته‌بندی‌های انتخاب شده:</label>
                                    <div id="selectedCategories" class="border rounded p-2 bg-light" style="min-height: 50px;">
                                        <span class="text-muted">هیچ دسته‌بندی انتخاب نشده</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Details -->
                    <div class="form-section">
                        <h5>
                            <i class="fas fa-calendar-alt me-2"></i>
                            جزئیات انتساب
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Assignment.GrantedDate, "تاریخ اعطا", new { @class = "form-label fw-bold" })
                                    @Html.TextBoxFor(m => m.Assignment.GrantedDate, "{0:yyyy/MM/dd}", new { @class = "form-control", @readonly = "readonly" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">وضعیت انتساب</label>
                                    <div class="form-check">
                                        @Html.CheckBoxFor(m => m.Assignment.IsActive, new { @class = "form-check-input", @checked = "checked" })
                                        <label class="form-check-label" for="@Html.IdFor(m => m.Assignment.IsActive)">
                                            انتساب فعال
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificate Information -->
                    <div class="form-section">
                        <h5>
                            <i class="fas fa-certificate me-2"></i>
                            اطلاعات گواهی‌نامه
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Assignment.CertificateNumber, "شماره گواهی‌نامه", new { @class = "form-label fw-bold" })
                                    @Html.TextBoxFor(m => m.Assignment.CertificateNumber, new
                                    {
                                        @class = "form-control",
                                        placeholder = "شماره گواهی‌نامه پزشکی..."
                                    })
                                    @Html.ValidationMessageFor(m => m.Assignment.CertificateNumber, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Assignment.GrantedDate, "تاریخ اعطا", new { @class = "form-label fw-bold" })
                                    @Html.TextBoxFor(m => m.Assignment.GrantedDate, new { @class = "form-control", type = "date" })
                                    @Html.ValidationMessageFor(m => m.Assignment.GrantedDate, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Permissions -->
                    if (Model.CurrentPermissions != null && Model.CurrentPermissions.Any())
                    {
                        <div class="form-section">
                            <h5>
                                <i class="fas fa-list-check me-2"></i>
                                صلاحیت‌های فعلی پزشک
                            </h5>
                            <div class="row">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>دسته‌بندی خدمات</th>
                                                    <th>سطح صلاحیت</th>
                                                    <th>تاریخ اعطا</th>
                                                    <th>وضعیت</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var permission in Model.CurrentPermissions)
                                                {
                                                    <tr>
                                                        <td>@permission.ServiceCategoryName</td>
                                                        <td>
                                                            <span class="badge bg-info">@permission.AuthorizationLevel</span>
                                                        </td>
                                                        <td>@(permission.GrantedDate?.ToString("yyyy/MM/dd") ?? "نامشخص")</td>
                                                        <td>
                                                            @if (permission.IsActive)
                                                            {
                                                                <span class="badge bg-success">فعال</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">غیرفعال</span>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Description -->
                    <div class="form-section">
                        <h5>
                            <i class="fas fa-comment me-2"></i>
                            توضیحات
                        </h5>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    @Html.LabelFor(m => m.Assignment.Notes, "توضیحات", new { @class = "form-label fw-bold" })
                                    @Html.TextAreaFor(m => m.Assignment.Notes, new
                                    {
                                        @class = "form-control",
                                        rows = "3",
                                        placeholder = "توضیحات مربوط به انتساب پزشک..."
                                    })
                                    @Html.ValidationMessageFor(m => m.Assignment.Notes, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="form-section">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="@Url.Action("Index", "Doctor")" class="btn btn-outline-secondary btn-submit">
                                        <i class="fas fa-times me-2"></i>
                                        انصراف
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-submit">
                                        <i class="fas fa-save me-2"></i>
                                        انتساب پزشک
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Content/plugins/sweetalert2/sweetalert2@11.js"></script>
    <script src="~/Content/plugins/select2/js/select2.full.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize Select2
            $('#Assignment_AuthorizationLevel').select2({
                placeholder: 'انتخاب سطح صلاحیت...',
                allowClear: true,
                language: 'fa'
            });

            // فیلتر دپارتمان
            $('#departmentFilter').on('change', function() {
                var selectedDepartment = $(this).val();
                var $serviceCategories = $('#serviceCategories');
                
                if (selectedDepartment === '') {
                    // نمایش همه سرفصل‌ها
                    loadAllServiceCategories();
                } else {
                    // بارگذاری سرفصل‌های دپارتمان انتخاب شده
                    loadServiceCategoriesByDepartment(selectedDepartment);
                }
            });
            
            // بارگذاری همه سرفصل‌های خدماتی
            function loadAllServiceCategories() {
                $.ajax({
                    url: '@Url.Action("GetServiceCategories", "DoctorServiceCategory")',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response && response.success && response.data) {
                            updateServiceCategoriesDropdown(response.data);
                        }
                    },
                    error: function() {
                        showAlert('error', 'خطا در بارگذاری سرفصل‌های خدماتی');
                    }
                });
            }
            
            // بارگذاری سرفصل‌های خدماتی بر اساس دپارتمان
            function loadServiceCategoriesByDepartment(departmentId) {
                $.ajax({
                    url: '@Url.Action("GetServiceCategoriesByDepartment", "DoctorServiceCategory")',
                    type: 'GET',
                    dataType: 'json',
                    data: { departmentId: departmentId },
                    success: function(response) {
                        if (response && response.success && response.data) {
                            updateServiceCategoriesDropdown(response.data);
                        } else {
                            showAlert('error', response.message || 'خطا در بارگذاری سرفصل‌های خدماتی');
                        }
                    },
                    error: function() {
                        showAlert('error', 'خطا در بارگذاری سرفصل‌های خدماتی');
                    }
                });
            }
            
            // به‌روزرسانی dropdown سرفصل‌های خدماتی
            function updateServiceCategoriesDropdown(categories) {
                var $serviceCategories = $('#serviceCategories');
                $serviceCategories.empty();
                
                if (categories && categories.length > 0) {
                    $.each(categories, function(index, category) {
                        $serviceCategories.append(
                            '<option value="' + category.Id + '">' + category.Name + '</option>'
                        );
                    });
                } else {
                    $serviceCategories.append('<option value="">هیچ سرفصل خدماتی یافت نشد</option>');
                }
                
                updateSelectedCategories();
            }

            // انتخاب همه
            $('#selectAll').on('change', function() {
                var $options = $('#serviceCategories option:visible');
                if ($(this).is(':checked')) {
                    $options.prop('selected', true);
                } else {
                    $options.prop('selected', false);
                }
                updateSelectedCategories();
            });

            // به‌روزرسانی نمایش دسته‌بندی‌های انتخاب شده
            $('#serviceCategories').on('change', function() {
                updateSelectedCategories();
            });

            function updateSelectedCategories() {
                var selected = $('#serviceCategories option:selected');
                var $container = $('#selectedCategories');
                
                if (selected.length === 0) {
                    $container.html('<span class="text-muted">هیچ دسته‌بندی انتخاب نشده</span>');
                } else {
                    var html = '<div class="d-flex flex-wrap gap-2">';
                    selected.each(function() {
                        html += '<span class="badge bg-primary">' + $(this).text() + '</span>';
                    });
                    html += '</div>';
                    $container.html(html);
                }
            }

            // Form submission
            $('#assignmentForm').on('submit', function (e) {
                e.preventDefault();

                // بررسی انتخاب دسته‌بندی‌های خدمات
                var selectedCategories = $('#serviceCategories option:selected');
                if (selectedCategories.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'هشدار',
                        text: 'لطفاً حداقل یک دسته‌بندی خدمات انتخاب کنید'
                    });
                    return false;
                }

                if (!$(this)[0].checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return false;
                }

                // نمایش تایید
                Swal.fire({
                    title: 'تایید انتساب',
                    text: `آیا مطمئن هستید که می‌خواهید پزشک را به ${selectedCategories.length} دسته‌بندی خدمات انتساب دهید؟`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'بله، انتساب کن',
                    cancelButtonText: 'انصراف',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading overlay
                        $('.loading-overlay').show();

                        // Submit form
                        this.submit();
                    }
                });
            });

            // Success message
            @if (TempData["Success"] != null)
            {
                <text>
                Swal.fire({
                    title: 'موفقیت',
                    text: '@TempData["Success"]',
                    icon: 'success',
                    confirmButtonText: 'باشه'
                });
                </text>
            }

            // Error message
            @if (TempData["Error"] != null)
            {
                <text>
                Swal.fire({
                    title: 'خطا',
                    text: '@TempData["Error"]',
                    icon: 'error',
                    confirmButtonText: 'باشه'
                });
                </text>
            }
        });
    </script>
}
