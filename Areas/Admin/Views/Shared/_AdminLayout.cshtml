@{
    var appName = "کلینیک درمانی شفا";
    var title = ViewBag.Title ?? "داشبورد مدیریت";
    var metaDescription = ViewBag.MetaDescription ?? "کلینیک درمانی شفا - ارائه خدمات پزشکی تخصصی";
    var currentUser = User.Identity.Name;
    var currentTime = DateTime.Now;
}

<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="description" content="@metaDescription">
    <meta name="author" content="@appName">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- X-Frame-Options should be set in HTTP headers, not in meta tags -->
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <title>@title - @appName</title>
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="~/Content/css/admin-layout.css" as="style">
    <link rel="preload" href="~/Content/js/admin-layout.js" as="script">
    <link rel="preload" href="~/Content/Fonts/fontawesome-free-6.7.2-web/css/all.min.css" as="style">
    
    <!-- Stylesheets -->
    @Styles.Render("~/Content/admin")
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/plugins/css")
    <link href="~/Content/Fonts/fontawesome-free-6.7.2-web/css/all.min.css?v=1.0.1" rel="stylesheet" />
    @RenderSection("styles", required: false)
    
    <!-- Medical Environment: Icon Fallback CSS -->
    <style>
        /* Fallback Icons for Medical Environment */
        .fa-medical-kit:before, .fas.fa-medical-kit:before { content: "🏥"; }
        .fa-edit:before, .fas.fa-edit:before { content: "✏️"; }
        .fa-info-circle:before, .fas.fa-info-circle:before { content: "ℹ️"; }
        .fa-trash:before, .fas.fa-trash:before { content: "🗑️"; }
        .fa-plus:before, .fas.fa-plus:before { content: "➕"; }
        .fa-save:before, .fas.fa-save:before { content: "💾"; }
        .fa-arrow-right:before, .fas.fa-arrow-right:before { content: "➡️"; }
        .fa-sitemap:before, .fas.fa-sitemap:before { content: "🏗️"; }
        .fa-search:before, .fas.fa-search:before { content: "🔍"; }
        
        /* Only apply if FontAwesome failed to load */
        .fa:not([class*=" fa-"]):before,
        .fas:not([class*=" fa-"]):before {
            font-family: "Segoe UI Emoji", "Apple Color Emoji", sans-serif;
            font-weight: normal;
            font-style: normal;
            text-decoration: none;
            line-height: 1;
        }
    </style>

    <!-- Preload Font -->
    <!-- حذف Google Fonts برای سادگی و امنیت Admin Panel -->

    <!-- Schema.org -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "MedicalOrganization",
        "name": "@appName",
        "url": "@(Request.Url?.GetLeftPart(UriPartial.Authority))",
        "telephone": "+98-34-32245600",
        "address": {
            "@@type": "PostalAddress",
            "addressLocality": "جیرفت",
            "addressCountry": "IR"
        }
    }
    </script>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link sr-only" aria-label="پرش به محتوای اصلی">پرش به محتوای اصلی</a>

    <!-- Header -->
    <header class="header" role="banner">
        <div class="container">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="@Url.Action("Index","Home")" class="logo" aria-label="@appName - صفحه اصلی">
                        <i class="fas fa-hospital me-2" aria-hidden="true"></i>
                        @appName
                    </a>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <form class="hidden md:block" action="@Url.Action("Search")" method="get" data-search-form role="search">
                        <div class="search-container">
                            <input name="q" 
                                   type="search" 
                                   placeholder="جستجو در سیستم..."
                                   data-search-input
                                   aria-label="جستجو"
                                   class="search-input">
                            <button type="submit" class="search-button" aria-label="جستجو">
                                <i class="fas fa-search" aria-hidden="true"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Theme Toggle -->
                    <button data-theme-toggle 
                            class="btn theme-toggle" 
                            aria-label="تغییر تم"
                            title="تغییر تم (Ctrl+T)">
                        <i class="fas fa-sun" aria-hidden="true"></i>
                    </button>

                    <!-- Mobile Menu Toggle -->
                    <button data-mobile-menu-toggle 
                            class="btn mobile-menu-toggle md:hidden" 
                            aria-label="منوی موبایل"
                            aria-expanded="false">
                        <i class="fas fa-bars" aria-hidden="true"></i>
                    </button>

                    <!-- User Menu -->
                    <div class="user-menu">
                        <span class="user-name" aria-label="کاربر فعلی">
                            <i class="fas fa-user me-1" aria-hidden="true"></i>
                            @currentUser
                        </span>
                        <a href="@Url.Action("LogOff","Account")" 
                           class="btn btn-logout" 
                           aria-label="خروج از سیستم"
                           title="خروج از سیستم">
                            <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i>
                            خروج
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="container">
        <div class="layout">
            <!-- Sidebar -->
            <aside class="sidebar" role="complementary" aria-label="منوی اصلی">
                <nav role="navigation" aria-label="منوی ناوبری">
                    <div class="nav-section">
                        <h3 class="nav-section-title" aria-label="منوی اصلی">منوی اصلی</h3>
                        
                        <a href="@Url.Action("Index","Dashboard")" class="nav-item" aria-label="داشبورد">
                            <i class="fas fa-tachometer-alt icon" aria-hidden="true"></i>
                            <span>داشبورد</span>
                        </a>

                        <a href="@Url.Action("Index","Patients")" class="nav-item" aria-label="مدیریت بیماران">
                            <i class="fas fa-users icon" aria-hidden="true"></i>
                            <span>بیماران</span>
                        </a>

                        <a href="@Url.Action("Index","Appointments")" class="nav-item" aria-label="مدیریت نوبت‌ها">
                            <i class="fas fa-calendar-alt icon" aria-hidden="true"></i>
                            <span>نوبت‌ها</span>
                        </a>

                        <a href="@Url.Action("Index","Doctors")" class="nav-item" aria-label="مدیریت پزشکان">
                            <i class="fas fa-user-md icon" aria-hidden="true"></i>
                            <span>پزشکان</span>
                        </a>

                        <a href="@Url.Action("Index","Reports")" class="nav-item" aria-label="گزارش‌ها">
                            <i class="fas fa-chart-bar icon" aria-hidden="true"></i>
                            <span>گزارش‌ها</span>
                        </a>
                    </div>

                    <hr class="nav-divider">

                    <div class="nav-section">
                        <h3 class="nav-section-title" aria-label="عملیات سریع">عملیات سریع</h3>
                        
                        <a href="@Url.Action("Create","Appointments")" class="btn btn-primary nav-action-btn" aria-label="ایجاد نوبت جدید">
                            <i class="fas fa-plus icon" aria-hidden="true"></i>
                            <span>نوبت جدید</span>
                        </a>

                        <a href="@Url.Action("Create","Patients")" class="btn btn-outline nav-action-btn" aria-label="ثبت بیمار جدید">
                            <i class="fas fa-user-plus icon" aria-hidden="true"></i>
                            <span>بیمار جدید</span>
                        </a>
                    </div>

                    <hr class="nav-divider">

                    <div class="nav-section">
                        <h3 class="nav-section-title" aria-label="اطلاعات سیستم">اطلاعات سیستم</h3>
                        
                        <div class="system-info">
                            <div class="info-item">
                                <i class="fas fa-clock icon" aria-hidden="true"></i>
                                <span>@currentTime.ToString("HH:mm")</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar icon" aria-hidden="true"></i>
                                <span>@currentTime.ToString("yyyy/MM/dd")</span>
                            </div>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="main-content" role="main" aria-label="محتوای اصلی">
                @RenderBody()
            </main>
        </div>
    </div>
    <!-- Notifications Container -->
    <div data-notifications class="notifications-container"></div>

    <!-- Scripts -->
    @Html.Partial("_ValidationToasts")
    
    <!-- Core Scripts -->
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/plugins")
    <!-- jsDelivr (می‌گیرد آخرین نسخه) -->
<script src="~/Content/plugins/chartjs/chart.umd.min.js"></script>
    <!-- یا unpkg -->

    
    <!-- Admin Layout Scripts -->
    <script src="~/Content/js/admin-layout.js" defer></script>
    
    <!-- Medical Toast Notifications -->
    <script src="~/Content/js/medical-toast.js" defer></script>
    
    <!-- Medical Debug Utilities -->
    <script src="~/Content/js/medical-debug.js" defer></script>
    
    <!-- Persian DatePicker Integration -->
    <script>
        // محافظت jQuery و Persian DatePicker
        (function() {
            'use strict';
            
            function ensureJQuery(callback) {
                if (typeof jQuery !== 'undefined' && typeof $.fn !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function() {
                        ensureJQuery(callback);
                    }, 50);
                }
            }

            function initializePersianDatePicker() {
                ensureJQuery(function() {
                    if (typeof $.fn.persianDatepicker !== 'undefined') {
                        $('.persian-date').each(function() {
                            var $this = $(this);
                            if (!$this.data('persian-datepicker-initialized')) {
                                $this.persianDatepicker({
                                    format: 'YYYY/MM/DD',
                                    initialValue: false,
                                    autoClose: true,
                                    observer: false,
                                    persianDigit: true,
                                    calendar: {
                                        persian: {
                                            locale: 'fa',
                                            leapYearMode: 'astronomical'
                                        }
                                    },
                                    toolbox: {
                                        todayBtn: { enabled: true, text: { fa: 'امروز' } },
                                        clearBtn: { enabled: true, text: { fa: 'پاک کردن' } }
                                    },
                                    onSelect: function(unix) {
                                        // Convert to Persian date using jalaali-js
                                        if (typeof window.jalaali !== 'undefined') {
                                            var date = new Date(unix);
                                            var persianDate = window.jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                                            var formattedDate = persianDate.jy + '/' + 
                                                String(persianDate.jm).padStart(2, '0') + '/' + 
                                                String(persianDate.jd).padStart(2, '0');
                                            $this.val(formattedDate);
                                        } else {
                                            // Fallback to simple display
                                            $this.val($this.val());
                                        }
                                        
                                        // Trigger change event
                                        $this.trigger('change');
                                    }
                                });
                                $this.data('persian-datepicker-initialized', true);
                            }
                        });
                    } else {
                        console.warn('Persian DatePicker plugin not loaded');
                    }
                });
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePersianDatePicker);
            } else {
                initializePersianDatePicker();
            }

            // Re-initialize for dynamic content
            $(document).on('DOMNodeInserted', function(e) {
                if ($(e.target).hasClass('persian-date') || 
                    $(e.target).find('.persian-date').length > 0) {
                    setTimeout(initializePersianDatePicker, 100);
                }
            });
        })();
    </script>

    <!-- Performance Monitoring -->
    <script>
        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                const perfData = performance.getEntriesByType('navigation')[0];
                const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                
                // Log performance data
                console.log('Page Load Time:', loadTime + 'ms');
                
                // Send to analytics if needed
                if (window.gtag && loadTime > 3000) {
                    window.gtag('event', 'slow_page_load', {
                        value: loadTime,
                        page_title: document.title
                    });
                }
            });
        }
    </script>

    <!-- Error Tracking -->
    <script>
        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
            
            // Send to error tracking service
            if (window.gtag) {
                window.gtag('event', 'exception', {
                    description: e.error.message,
                    fatal: false
                });
            }
        });

        // Unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            
            if (window.gtag) {
                window.gtag('event', 'exception', {
                    description: e.reason.message || 'Unhandled Promise Rejection',
                    fatal: false
                });
            }
        });
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>