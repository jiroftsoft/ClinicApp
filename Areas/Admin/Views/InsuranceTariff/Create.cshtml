@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffCreateEditViewModel

@{
    ViewBag.Title = "Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Description = "ØªØ¹Ø±ÛŒÙ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ - Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§";
    ViewBag.Keywords = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡, Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ, Ú©Ù„ÛŒÙ†ÛŒÚ©, Ø¨ÛŒÙ…Ù‡, ØªØ¹Ø±ÙÙ‡";
}

<!-- ğŸš€ SEO: Meta Tags -->
@section MetaTags {
    <meta name="description" content="@ViewBag.Description" />
    <meta name="keywords" content="@ViewBag.Keywords" />
    <meta name="author" content="Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§" />
    <meta name="robots" content="noindex, nofollow" />
}

@section Styles {
    <style>
        /* ğŸ¥ MEDICAL: Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø¯Ø±Ù…Ø§Ù†ÛŒ */
        .medical-form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            font-family: 'Vazirmatn', 'Vazir', 'Tahoma', sans-serif;
            direction: rtl;
            text-align: right;
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ğŸš€ FIX: Override backgrounds */
        .main-content, body, html {
            background: #ffffff !important;
        }

        /* ğŸš€ PERFORMANCE: Select2 Remote Styling */
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 0 8px;
        }

        /* ğŸ¥ MEDICAL: Bulk Operation Styling */
        .bulk-operation-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .bulk-operation-disabled .select2-container {
            opacity: 0.6;
            pointer-events: none;
        }

        .bulk-operation-disabled .form-control {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }

        #bulkOperationIndicator {
            border-left: 4px solid #17a2b8;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        #bulkProgressModal .modal-content {
            border-radius: 10px;
        }

        #bulkProgressModal .progress {
            height: 25px;
            border-radius: 12px;
        }

        #bulkProgressModal .progress-bar {
            border-radius: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-right: 20px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 8px;
        }

        .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .select2-results__option {
            padding: 8px 12px;
            font-size: 14px;
        }

        .select2-results__option--highlighted {
            background: #e3f2fd;
            color: #1976d2;
        }

        /* ğŸ¥ MEDICAL: Form Styling */
        .medical-form-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e3f2fd;
            overflow: hidden;
        }

        .medical-form-header {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
            padding: 20px;
            border-bottom: none;
        }

        .medical-form-body {
            padding: 30px;
        }

        .medical-form-group {
            margin-bottom: 24px;
        }

        .medical-form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .medical-form-control {
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .medical-form-control:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
            outline: none;
        }

        .medical-form-control.is-invalid {
            border-color: #dc3545;
        }

        .medical-form-control.is-valid {
            border-color: #28a745;
        }

        .medical-form-help {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .medical-form-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }

        .medical-form-success {
            color: #28a745;
            font-size: 12px;
            margin-top: 4px;
        }

        /* ğŸ¥ MEDICAL: Calculation Section */
        .medical-calculation-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .medical-calculation-header {
            background: #e3f2fd;
            color: #1976d2;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .medical-calculation-result {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .medical-calculation-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .medical-calculation-field:last-child {
            border-bottom: none;
            font-weight: 600;
            color: #1976d2;
        }

        .medical-calculation-label {
            font-weight: 500;
            color: #333;
        }

        .medical-calculation-value {
            font-weight: 600;
            color: #1976d2;
        }

        /* ğŸ¥ MEDICAL: Button Styling */
        .medical-btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .medical-btn-primary {
            background: #1976d2;
            color: white;
        }

        .medical-btn-primary:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }

        .medical-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .medical-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .medical-btn-success {
            background: #28a745;
            color: white;
        }

        .medical-btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* ğŸ¥ MEDICAL: Loading States */
        .medical-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .medical-loading.show {
            display: block;
        }

        .medical-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ğŸ¥ MEDICAL: Progress Indicator */
        .medical-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 6px;
            margin: 16px 0;
            overflow: hidden;
        }

        .medical-progress-bar {
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ğŸ¥ MEDICAL: Responsive Design */
        @@media (max-width: 768px) {
            .medical-form-container {
                padding: 16px;
            }
            
            .medical-form-body {
                padding: 20px;
            }
            
            .medical-calculation-card {
                padding: 16px;
            }
        }

        /* ğŸ¥ MEDICAL: Accessibility */
        .medical-form-control:focus {
            outline: 2px solid #1976d2;
            outline-offset: 2px;
        }

        .medical-btn:focus {
            outline: 2px solid #1976d2;
            outline-offset: 2px;
        }

        /* ğŸ¥ MEDICAL: Print Styles */
        @@media print {
            .medical-form-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .medical-btn {
                display: none;
            }
        }
    </style>
}

<div class="medical-form-container">
    <div class="medical-form-card">
        <!-- Header -->
        <div class="medical-form-header">
            <h2 class="mb-2">
                <i class="fas fa-money-bill-wave"></i>
                Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ Ø¬Ø¯ÛŒØ¯
            </h2>
            <p class="mb-0 opacity-75">ØªØ¹Ø±ÛŒÙ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ</p>
        </div>

        <!-- Form Body -->
        <div class="medical-form-body">
            @using (Html.BeginForm("Create", "InsuranceTariff", FormMethod.Post, new { @class = "medical-form", @id = "insuranceTariffForm" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.IdempotencyKey, new { @id = "idempotencyKey" })

                <!-- Service Selection Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-stethoscope"></i>
                            Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª
                        </h5>
                    </div>
                </div>

                <div class="row">
                    <!-- Department -->
                    <div class="col-md-6 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="DepartmentId">
                                Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† <span class="text-danger">*</span>
                            </label>
                            @Html.DropDownListFor(m => m.DepartmentId, Model.Departments, "Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", new { @class = "medical-form-control", @id = "DepartmentId", @required = "required" })
                            <div class="medical-form-help">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            @Html.ValidationMessageFor(m => m.DepartmentId, "", new { @class = "medical-form-error" })
                        </div>
                    </div>

                    <!-- Service Category -->
                    <div class="col-md-6 mb-3 service-selection-group">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="ServiceCategoryId">
                                Ø³Ø±ÙØµÙ„ Ø®Ø¯Ù…Øª
                            </label>
                            @Html.DropDownListFor(m => m.ServiceCategoryId, Model.ServiceCategories, "Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", new { @class = "medical-form-control", @id = "ServiceCategoryId" })
                            <div class="medical-form-help">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            @Html.ValidationMessageFor(m => m.ServiceCategoryId, "", new { @class = "medical-form-error" })
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Service -->
                    <div class="col-md-6 mb-3 service-selection-group">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="ServiceId">
                                Ø®Ø¯Ù…Øª <span class="text-danger">*</span>
                            </label>
                            @Html.DropDownListFor(m => m.ServiceId, Model.Services, "Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", new { @class = "medical-form-control", @id = "ServiceId" })
                            <div class="medical-form-help">Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            @Html.ValidationMessageFor(m => m.ServiceId, "", new { @class = "medical-form-error" })
                        </div>
                    </div>

                    <!-- All Services Checkbox -->
                    <div class="col-md-6 mb-3">
                        <div class="medical-form-group">
                            <div class="form-check">
                                <input type="checkbox" name="IsAllServices" id="IsAllServices" class="form-check-input" value="true" />
                                <label class="form-check-label" for="IsAllServices">
                                    Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª
                                </label>
                            </div>
                            <div class="medical-form-help">Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ØŒ ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                        </div>
                    </div>
                </div>

                <!-- Insurance Information Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-shield-alt"></i>
                            Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡
                        </h5>
                    </div>
                </div>

                <div class="row">
                    <!-- Insurance Provider -->
                    <div class="col-md-6 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="InsuranceProviderId">
                                Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ <span class="text-danger">*</span>
                            </label>
                            @Html.DropDownListFor(m => m.InsuranceProviderId, Model.InsuranceProviders, "Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", new { @class = "medical-form-control", @id = "InsuranceProviderId", @required = "required" })
                            <div class="medical-form-help">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            @Html.ValidationMessageFor(m => m.InsuranceProviderId, "", new { @class = "medical-form-error" })
                        </div>
                    </div>

                    <!-- Insurance Plan -->
                    <div class="col-md-6 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="InsurancePlanId">
                                Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ <span class="text-danger">*</span>
                            </label>
                            @Html.DropDownListFor(m => m.InsurancePlanId, Model.InsurancePlans, "Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", new { @class = "medical-form-control", @id = "InsurancePlanId", @required = "required" })
                            <div class="medical-form-help">Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            @Html.ValidationMessageFor(m => m.InsurancePlanId, "", new { @class = "medical-form-error" })
                        </div>
                    </div>
                </div>

                <!-- Tariff Calculation Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-calculator"></i>
                            Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡
                        </h5>
                    </div>
                </div>

                <div class="row">
                    <!-- Tariff Price -->
                    <div class="col-md-4 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="TariffPrice">
                                Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡ (Ø±ÛŒØ§Ù„)
                            </label>
                            @Html.TextBoxFor(m => m.TariffPrice, new { @class = "medical-form-control", @id = "TariffPrice", @type = "number", @min = "0", @max = "2000000000", @step = "1", @inputmode = "numeric" })
                            <div class="medical-form-help">Ù…Ø¨Ù„Øº ØªØ¹Ø±ÙÙ‡ (Ø±ÛŒØ§Ù„) - Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ±ÙˆØ¯ Ø§Ø² Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ Ø®Ø¯Ù…Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                            @Html.ValidationMessageFor(m => m.TariffPrice, "", new { @class = "medical-form-error" })
                        </div>
                    </div>

                    <!-- Patient Share -->
                    <div class="col-md-4 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="PatientShare">
                                Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (Ø±ÛŒØ§Ù„)
                            </label>
                            @Html.TextBoxFor(m => m.PatientShare, new { @class = "medical-form-control", @id = "PatientShare", @type = "number", @min = "0", @max = "2000000000", @step = "1", @inputmode = "numeric" })
                            <div class="medical-form-help">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (Ø±ÛŒØ§Ù„)</div>
                            @Html.ValidationMessageFor(m => m.PatientShare, "", new { @class = "medical-form-error" })
                        </div>
                    </div>

                    <!-- Insurer Share -->
                    <div class="col-md-4 mb-3">
                        <div class="medical-form-group">
                            <label class="medical-form-label" for="InsurerShare">
                                Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ (Ø±ÛŒØ§Ù„)
                            </label>
                            @Html.TextBoxFor(m => m.InsurerShare, new { @class = "medical-form-control", @id = "InsurerShare", @type = "number", @min = "0", @max = "2000000000", @step = "1", @inputmode = "numeric" })
                            <div class="medical-form-help">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ (Ø±ÛŒØ§Ù„)</div>
                            @Html.ValidationMessageFor(m => m.InsurerShare, "", new { @class = "medical-form-error" })
                        </div>
                    </div>
                </div>

                <!-- Auto Calculation Section -->
                <div class="medical-calculation-card">
                    <div class="medical-calculation-header">
                        <i class="fas fa-calculator"></i>
                        Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="medical-btn medical-btn-primary" id="calculateBtn">
                                <i class="fas fa-calculator"></i>
                                Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="medical-progress">
                                <div class="medical-progress-bar" id="progressBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Calculation Results -->
                    <div id="calculationResults" style="display: none;">
                        <div class="medical-calculation-result">
                            <div class="medical-calculation-field">
                                <span class="medical-calculation-label">Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡:</span>
                                <span class="medical-calculation-value" id="calculatedTariffPrice">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="medical-calculation-field">
                                <span class="medical-calculation-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±:</span>
                                <span class="medical-calculation-value" id="calculatedPatientShare">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="medical-calculation-field">
                                <span class="medical-calculation-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡:</span>
                                <span class="medical-calculation-value" id="calculatedInsurerShare">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calculation Summary -->
                    <div id="calculationSummary" class="medical-form-help"></div>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Index")" class="medical-btn medical-btn-secondary">
                                <i class="fas fa-arrow-right"></i>
                                Ø¨Ø§Ø²Ú¯Ø´Øª
                            </a>
                            <button type="submit" class="medical-btn medical-btn-success">
                                <i class="fas fa-save"></i>
                                Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="medical-loading" id="loadingOverlay">
                    <div class="medical-spinner"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/Scripts/select2.min.js"></script>
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />

    <script>
        (function () {
            // ---------- Utils ----------
            function convertPersianToEnglish(str) {
                if (!str) return str;
                return str.toString()
                    .replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d))
                    .replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d))
                    .replace(/[,\s]/g, '');
            }

            function formatCurrency(value) {
                if (value === null || value === undefined || value === '') return '';
                var num = parseFloat(convertPersianToEnglish(value));
                if (isNaN(num)) return '';
                return num.toLocaleString('fa-IR');
            }

            function parseCurrency(value) {
                if (!value) return 0;
                var clean = convertPersianToEnglish(value.toString().replace(/[,\s]/g, ''));
                return parseFloat(clean) || 0;
            }

            // ğŸ”§ CRITICAL FIX: Ø­Ø°Ù ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯ - Ø³ÛŒØ³ØªÙ… Ø¨Ø± Ù…Ø¨Ù†Ø§ÛŒ Ø±ÛŒØ§Ù„
            // ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø±ÛŒØ§Ù„ Ù‡Ø³ØªÙ†Ø¯

            // ---------- Global State ----------
            var calculationTimeout, lastCalculationData = null, isCalculating = false;
            var lastCalcXhr = null, lastCid = null; // ğŸ”§ CRITICAL FIX: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Race Condition

            // ---------- Initialize ----------
            $(document).ready(function () {
                console.log('ğŸ¥ MEDICAL: Insurance Tariff Create form initialized');

                // Generate idempotency key
                $('#idempotencyKey').val('create_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));

                loadInitialDataParallel();
                setupFormProtection();
                setupCurrencyFormatting();
                setupDateValidation();
                setupPersianNumberConversion();
                setupNumberInputHandling();
                setupFormValidation();
                setupAccessibility();
                setupAutoCalculation();
            });

            // ---------- Cascading Dropdowns ----------
            function setupCascadingDropdowns() {
                $('#DepartmentId').off('change').on('change', function () {
                    var departmentId = $(this).val();
                    if (departmentId) loadServiceCategories(departmentId); else clearServiceCategories();
                    clearServices();
                });

                $('#ServiceCategoryId').off('change').on('change', function () {
                    var categoryId = $(this).val();
                    if (categoryId) loadServices(categoryId); else clearServices();
                });

                $('#InsuranceProviderId').off('change').on('change', function () {
                    var providerId = $(this).val();
                    if (providerId) loadInsurancePlans(providerId); else clearInsurancePlans();
                });
            }

            function loadServiceCategories(departmentId) {
                $('#ServiceCategoryId').prop('disabled', true).html('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>');
                $.ajax({
                    url: '@Url.Action("GetServiceCategories", "InsuranceTariff")',
                    type: 'GET',
                    dataType: 'json',
                    cache: false,
                    headers: {'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'},
                    data: { departmentId: departmentId },
                    success: function (response) {
                        if (response.success && Array.isArray(response.data) && response.data.length) {
                            var opts = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª</option>';
                            $.each(response.data, function (_, item) { 
                                opts += '<option value="' + item.id + '">' + item.name + '</option>'; 
                            });
                            $('#ServiceCategoryId').html(opts).prop('disabled', false);
                        } else {
                            $('#ServiceCategoryId').html('<option value="">Ù‡ÛŒÚ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>').prop('disabled', false);
                        }
                    },
                    error: function () {
                        $('#ServiceCategoryId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>').prop('disabled', false);
                    }
                });
            }

            function loadServices(categoryId) {
                if ($.fn.select2 && $('#ServiceId').data('select2')) {
                    $('#ServiceId').select2('destroy');
                }
                $('#ServiceId').empty();

                $('#ServiceId').select2({
                    placeholder: 'Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                    allowClear: true,
                    minimumInputLength: 2,
                    ajax: {
                        url: '@Url.Action("GetServices", "InsuranceTariff")',
                        dataType: 'json',
                        cache: false,
                        delay: 300,
                        headers: {'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'},
                        data: function (params) {
                            return { serviceCategoryId: categoryId, search: params.term, page: params.page || 1, pageSize: 20 };
                        },
                        processResults: function (data) {
                            if (data.success && Array.isArray(data.data)) {
                                var results = data.data.map(function (x) { 
                                    return { id: x.id, text: x.name, description: x.description || '' }; 
                                });
                                return { results: results, pagination: { more: !!data.hasMore } };
                            }
                            return { results: [] };
                        }
                    },
                    templateResult: function (s) {
                        if (s.loading) return s.text;
                        // ğŸ”§ CRITICAL FIX: Ø¶Ø¯ XSS Ø¯Ø± Select2
                        var $root = $('<div class="service-option"/>');
                        $('<div class="service-name"/>').text(s.text).appendTo($root);
                        if (s.description) $('<div class="service-description"/>').text(s.description).appendTo($root);
                        return $root;
                    },
                    templateSelection: function (s) { return s.text || ''; }
                });
                if (categoryId) $('#ServiceId').trigger('change');
            }

            function loadInsuranceProviders() {
                return new Promise(function (resolve, reject) {
                    if ($.fn.select2 && $('#InsuranceProviderId').data('select2')) {
                        $('#InsuranceProviderId').select2('destroy');
                    }
                    $('#InsuranceProviderId').empty();

                    $('#InsuranceProviderId').select2({
                        placeholder: 'Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                        allowClear: true,
                        minimumInputLength: 1,
                        ajax: {
                            url: '@Url.Action("GetInsuranceProviders", "InsuranceTariff")',
                            dataType: 'json',
                            cache: false,
                            delay: 300,
                            headers: {'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'},
                            data: function (p) { return { search: p.term, page: p.page || 1, pageSize: 10 }; },
                            processResults: function (data) {
                                if (data.success && Array.isArray(data.data)) {
                                    var results = data.data.map(function (x) { 
                                        return { id: x.id, text: x.name, description: x.description || '' }; 
                                    });
                                    return { results: results, pagination: { more: !!data.hasMore } };
                                }
                                return { results: [] };
                            },
                            error: function (xhr, s, e) { reject(e); }
                        },
                        templateResult: function (p) {
                            if (p.loading) return p.text;
                            // ğŸ”§ CRITICAL FIX: Ø¶Ø¯ XSS Ø¯Ø± Select2
                            var $root = $('<div class="provider-option"/>');
                            $('<div class="provider-name"/>').text(p.text).appendTo($root);
                            if (p.description) $('<div class="provider-description"/>').text(p.description).appendTo($root);
                            return $root;
                        },
                        templateSelection: function (p) { return p.text || ''; }
                    });
                    resolve([]);
                });
            }

            function loadInsurancePlans(providerId) {
                if ($.fn.select2 && $('#InsurancePlanId').data('select2')) {
                    $('#InsurancePlanId').select2('destroy');
                }
                $('#InsurancePlanId').empty();

                $('#InsurancePlanId').select2({
                    placeholder: 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                    allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        url: '@Url.Action("GetInsurancePlans", "InsuranceTariff")',
                        dataType: 'json',
                        cache: false,
                        delay: 300,
                        headers: {'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'},
                        data: function (p) { return { providerId: providerId, search: p.term, page: p.page || 1, pageSize: 15 }; },
                        processResults: function (data) {
                            if (data.success && Array.isArray(data.data)) {
                                var results = data.data.map(function (x) { 
                                    return { id: x.id, text: x.name, planCode: x.planCode || '', coveragePercent: x.coveragePercent || 0 }; 
                                });
                                return { results: results, pagination: { more: !!data.hasMore } };
                            }
                            return { results: [] };
                        }
                    },
                    templateResult: function (plan) {
                        if (plan.loading) return plan.text;
                        // ğŸ”§ CRITICAL FIX: Ø¶Ø¯ XSS Ø¯Ø± Select2
                        var $root = $('<div class="plan-option"/>');
                        $('<div class="plan-name"/>').text(plan.text).appendTo($root);
                        if (plan.planCode) $('<div class="plan-code"/>').text('Ú©Ø¯: ' + plan.planCode).appendTo($root);
                        if (plan.coveragePercent) $('<div class="plan-coverage"/>').text('Ù¾ÙˆØ´Ø´: ' + plan.coveragePercent + '%').appendTo($root);
                        return $root;
                    },
                    templateSelection: function (plan) { return plan.text || ''; }
                });
                if (providerId) $('#InsurancePlanId').trigger('change');
            }

            // ---------- Clear Helpers ----------
            function clearServiceCategories() { 
                $('#ServiceCategoryId').html('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª</option>').prop('disabled', false); 
            }
            function clearServices() { 
                if ($.fn.select2 && $('#ServiceId').data('select2')) {
                    $('#ServiceId').select2('destroy');
                }
                $('#ServiceId').empty(); 
            }
            function clearInsurancePlans() { 
                if ($.fn.select2 && $('#InsurancePlanId').data('select2')) {
                    $('#InsurancePlanId').select2('destroy');
                }
                $('#InsurancePlanId').empty(); 
            }

            // ---------- Parallel Data Loading ----------
            function loadInitialDataParallel() {
                console.log('ğŸš€ PERFORMANCE: Starting parallel data loading...');
                var startTime = performance.now();
                
                Promise.all([
                    loadInsuranceProviders(),
                    loadDepartments()
                ]).then(function() {
                    var duration = performance.now() - startTime;
                    console.log('ğŸš€ PERFORMANCE: Parallel loading completed in ' + duration.toFixed(2) + 'ms');
                }).catch(function(error) {
                    console.error('ğŸš€ PERFORMANCE: Parallel loading failed:', error);
                });
            }

            function loadDepartments() {
                return new Promise(function (resolve, reject) {
                    $.ajax({
                        url: '@Url.Action("GetDepartments", "InsuranceTariff")',
                        type: 'GET',
                        dataType: 'json',
                        cache: false,
                        headers: {'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'},
                        success: function (response) {
                            if (response.success && Array.isArray(response.data)) {
                                console.log('ğŸš€ PERFORMANCE: Departments loaded successfully');
                                resolve(response.data);
                            } else {
                                reject('No departments found');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('ğŸš€ PERFORMANCE: Failed to load departments:', error);
                            reject(error);
                        }
                    });
                });
            }

            // ---------- Form Protection ----------
            function setupFormProtection() {
                // ğŸ”§ CRITICAL FIX: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² double-submit Ø¨Ø§ ÙÙ„Ú¯
                $('#insuranceTariffForm').on('submit', function() {
                    var submitBtn = $(this).find('button[type="submit"]');
                    if (submitBtn.data('submitting') || submitBtn.prop('disabled')) {
                        return false;
                    }
                    submitBtn.data('submitting', true).prop('disabled', true);
                    // ğŸ”§ CRITICAL FIX: ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØ§ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ
                    // setTimeout Ø­Ø°Ù Ø´Ø¯ - Ø¯Ú©Ù…Ù‡ ØªØ§ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
                });

                // ğŸ›¡ï¸ P0 FIX: Setup custom validation
                setupCustomValidation();
                
                // ğŸ¥ MEDICAL: Setup bulk operation handling
                setupBulkOperationHandling();
                
                // Warn before leaving with unsaved changes
                var formChanged = false;
                $('.medical-form-control').on('change input', function() {
                    formChanged = true;
                });

                $(window).on('beforeunload', function() {
                    if (formChanged) {
                        return 'ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ';
                    }
                });

                $('#insuranceTariffForm').on('submit', function() {
                    formChanged = false;
                });
            }

            // ---------- Bulk Operation Handling ----------
            function setupBulkOperationHandling() {
                console.log('ğŸ¥ MEDICAL: Setting up bulk operation handling');
                
                // Handle IsAllServices checkbox change
                $('#IsAllServices').on('change', function() {
                    var isChecked = $(this).is(':checked');
                    console.log('ğŸ¥ MEDICAL: IsAllServices changed:', isChecked);
                    
                    if (isChecked) {
                        // Show confirmation dialog
                        showBulkOperationConfirmation();
                        
                        // Disable service-related dropdowns
                        disableServiceDropdowns();
                        
                        // Clear service selections
                        clearServiceSelections();
                        
                        // Update form labels and help text
                        updateFormForBulkOperation();
                    } else {
                        // Enable service-related dropdowns
                        enableServiceDropdowns();
                        
                        // Restore form labels and help text
                        restoreFormForSingleOperation();
                    }
                });
                
                // Handle form submission for bulk operation
                $('#insuranceTariffForm').on('submit', function(e) {
                    if ($('#IsAllServices').is(':checked')) {
                        e.preventDefault();
                        showBulkOperationProgress();
                        submitBulkOperation();
                    }
                });
            }
            
            function showBulkOperationConfirmation() {
                var confirmationMessage = `
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> ØªØ§ÛŒÛŒØ¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡</h5>
                        <p>Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØ¹Ø±ÙÙ‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ <strong>Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª</strong> Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ</p>
                        <p class="mb-0"><small>Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø¨Ø§Ø´Ø¯ Ùˆ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</small></p>
                    </div>
                `;
                
                // Show confirmation in a modal or alert
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'ØªØ§ÛŒÛŒØ¯ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡',
                        html: confirmationMessage,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡',
                        cancelButtonText: 'Ù„ØºÙˆ',
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6'
                    }).then((result) => {
                        if (!result.isConfirmed) {
                            $('#IsAllServices').prop('checked', false);
                            enableServiceDropdowns();
                            restoreFormForSingleOperation();
                        }
                    });
                } else {
                    // Fallback to browser confirm
                    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØ¹Ø±ÙÙ‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ')) {
                        $('#IsAllServices').prop('checked', false);
                        enableServiceDropdowns();
                        restoreFormForSingleOperation();
                    }
                }
            }
            
            function disableServiceDropdowns() {
                console.log('ğŸ¥ MEDICAL: Disabling service dropdowns for bulk operation');
                
                // Disable service category dropdown
                $('#ServiceCategoryId').prop('disabled', true).addClass('disabled');
                
                // Disable service dropdown
                $('#ServiceId').prop('disabled', true).addClass('disabled');
                
                // ğŸš€ P0 FIX: Ø­Ø°Ù required attribute Ø¨Ø±Ø§ÛŒ bulk operation
                $('#ServiceId').removeAttr('required');
                $('#ServiceCategoryId').removeAttr('required');
                
                // Add visual indicators
                $('.service-selection-group').addClass('bulk-operation-disabled');
            }
            
            function enableServiceDropdowns() {
                console.log('ğŸ¥ MEDICAL: Enabling service dropdowns for single operation');
                
                // Enable service category dropdown
                $('#ServiceCategoryId').prop('disabled', false).removeClass('disabled');
                
                // Enable service dropdown
                $('#ServiceId').prop('disabled', false).removeClass('disabled');
                
                // ğŸš€ P0 FIX: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† required attribute Ø¨Ø±Ø§ÛŒ single operation
                $('#ServiceId').attr('required', 'required');
                
                // Remove visual indicators
                $('.service-selection-group').removeClass('bulk-operation-disabled');
            }
            
            function clearServiceSelections() {
                console.log('ğŸ¥ MEDICAL: Clearing service selections for bulk operation');
                
                // Clear service category selection
                $('#ServiceCategoryId').val(null).trigger('change');
                
                // Clear service selection
                $('#ServiceId').val(null).trigger('change');
            }
            
            function updateFormForBulkOperation() {
                console.log('ğŸ¥ MEDICAL: Updating form for bulk operation');
                
                // ğŸ”§ CRITICAL FIX: ÙÙ‚Ø· Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ù…Ø§Ù† Ø³Ú©Ø´Ù† Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
                $('#IsAllServices').closest('.medical-form-group').find('.medical-form-help')
                    .text('ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª ÙØ¹Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯');
                
                // Add bulk operation indicator
                if (!$('#bulkOperationIndicator').length) {
                    $('<div id="bulkOperationIndicator" class="alert alert-info mt-2">' +
                        '<i class="fas fa-info-circle"></i> ' +
                        'Ø­Ø§Ù„Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª - ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø§ÛŒØ¬Ø§Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯' +
                        '</div>').insertAfter('#IsAllServices').parent();
                }
            }
            
            function restoreFormForSingleOperation() {
                console.log('ğŸ¥ MEDICAL: Restoring form for single operation');
                
                // ğŸ”§ CRITICAL FIX: Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Single operation
                $('#ServiceId').attr('required', 'required');
                // Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª:
                // $('#ServiceCategoryId').attr('required', 'required');
                
                // Restore help text
                $('#IsAllServices').closest('.medical-form-group').find('.medical-form-help')
                    .text('Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ØŒ ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯');
                
                // Remove bulk operation indicator
                $('#bulkOperationIndicator').remove();
            }
            
            function showBulkOperationProgress() {
                console.log('ğŸ¥ MEDICAL: Showing bulk operation progress');
                
                // Create progress modal
                var progressHtml = `
                    <div id="bulkProgressModal" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-cogs"></i> Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª
                                    </h5>
                                </div>
                                <div class="modal-body">
                                    <div class="progress mb-3">
                                        <div id="bulkProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div id="bulkProgressText" class="text-center">
                                        Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª...
                                    </div>
                                    <div id="bulkProgressDetails" class="mt-3">
                                        <small class="text-muted">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ğŸ”§ CRITICAL FIX: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Modal Ú†Ù†Ø¯Ø¨Ø§Ø±
                if (!$('#bulkProgressModal').length) {
                    $('body').append(progressHtml);
                }
                $('#bulkProgressModal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
            }
            
            function submitBulkOperation() {
                console.log('ğŸ¥ MEDICAL: Submitting bulk operation');
                
                // ğŸš€ P0 FIX: Ø¨Ø±Ø±Ø³ÛŒ IsAllServices Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
                var isAllServices = $('#IsAllServices').is(':checked');
                console.log('ğŸ¥ MEDICAL: IsAllServices checkbox state:', isAllServices);
                
                // Update progress
                updateBulkProgress(10, 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...');
                
                // Get form data
                var formData = $('#insuranceTariffForm').serialize();
                console.log('ğŸ¥ MEDICAL: Form data:', formData);
                
                // ğŸš€ P0 FIX: ØªØ¶Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ IsAllServices
                if (isAllServices && !formData.includes('IsAllServices=true')) {
                    console.log('ğŸš€ P0 FIX: Adding IsAllServices=true to form data');
                    formData += '&IsAllServices=true';
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ IsAllServices Ø¯Ø± formData
                if (formData.includes('IsAllServices=true')) {
                    console.log('âœ… IsAllServices=true found in form data');
                } else if (formData.includes('IsAllServices=false')) {
                    console.log('âŒ IsAllServices=false found in form data');
                } else {
                    console.log('âš ï¸ IsAllServices not found in form data');
                }
                
                // Submit via AJAX
                $.ajax({
                    url: '@Url.Action("Create", "InsuranceTariff")',
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Bulk operation response:', response);
                        
                        if (response.success) {
                            updateBulkProgress(100, 'Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!');
                            
                            setTimeout(function() {
                                $('#bulkProgressModal').modal('hide');
                                if (response.redirectUrl) {
                                    window.location.href = response.redirectUrl;
                                } else {
                                    window.location.href = '@Url.Action("Index", "InsuranceTariff")';
                                }
                            }, 2000);
                        } else {
                            var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª: ' + (response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§
                            if (response.isBulkOperation) {
                                errorMessage += ' (Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡)';
                            }
                            if (response.planId) {
                                errorMessage += ' - PlanId: ' + response.planId;
                            }
                            if (response.serviceId) {
                                errorMessage += ' - ServiceId: ' + response.serviceId;
                            }
                            
                            updateBulkProgress(0, errorMessage);
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§
                            if (response.errors && response.errors.length > 0) {
                                console.error('ğŸ¥ MEDICAL: Validation errors:', response.errors);
                            }
                            
                            console.error('ğŸ¥ MEDICAL: Bulk operation failed:', response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Bulk operation error:', error);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ø®Ø·Ø§
                        var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª: ' + error;
                        
                        if (xhr.responseText) {
                            try {
                                var errorResponse = JSON.parse(xhr.responseText);
                                if (errorResponse.message) {
                                    errorMessage = errorResponse.message;
                                }
                            } catch (e) {
                                // Ø§Ú¯Ø± JSON Ù†ÛŒØ³ØªØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ HTML error page Ø§Ø³Øª
                                errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø±ÙˆØ± - Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ refresh Ú©Ù†ÛŒØ¯';
                            }
                        }
                        
                        updateBulkProgress(0, errorMessage);
                    }
                });
            }
            
            function updateBulkProgress(percent, text) {
                $('#bulkProgressBar').css('width', percent + '%');
                $('#bulkProgressText').text(text);
            }

            // ---------- Currency Formatting ----------
            function setupCurrencyFormatting() {
                $('.medical-form-control[type="number"]').on('input', function() {
                    var value = $(this).val();
                    if (value) {
                        var formatted = formatCurrency(value);
                        $(this).attr('data-formatted', formatted);
                    }
                });
            }

            // ---------- Date Validation ----------
            function setupDateValidation() {
                $('.medical-form-control[type="date"]').on('change', function() {
                    var value = $(this).val();
                    if (value) {
                        var date = new Date(value);
                        var today = new Date();
                        if (date < today) {
                            $(this).addClass('is-invalid');
                            $(this).next('.medical-form-error').text('ØªØ§Ø±ÛŒØ® Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
                        } else {
                            $(this).removeClass('is-invalid');
                            $(this).next('.medical-form-error').text('');
                        }
                    }
                });
            }

            // ---------- Persian Number Conversion ----------
            function setupPersianNumberConversion() {
                $('.medical-form-control').on('input', function() {
                    var value = $(this).val();
                    if (value) {
                        var englishValue = convertPersianToEnglish(value);
                        if (englishValue !== value) {
                            $(this).val(englishValue);
                        }
                    }
                });
            }

            // ---------- Number Input Handling ----------
            function setupNumberInputHandling() {
                $('.medical-form-control[type="number"]').on('keypress', function(e) {
                    var char = String.fromCharCode(e.which);
                    if (!/[0-9]/.test(char) && e.which !== 8 && e.which !== 0) {
                        e.preventDefault();
                    }
                });
            }

            // ---------- Form Validation ----------
            function setupFormValidation() {
                // Real-time validation
                $('.medical-form-control').on('blur', function() {
                    validateField($(this));
                });

                // Form submission validation
                $('#insuranceTariffForm').on('submit', function(e) {
                    var isValid = true;
                    $('.medical-form-control[required]').each(function() {
                        if (!validateField($(this))) {
                            isValid = false;
                        }
                    });

                    // ğŸ”§ CRITICAL FIX: Validation ØªØ¬Ø§Ø±ÛŒ
                    if (!$('#IsAllServices').is(':checked')) {
                        var t = parseCurrency($('#TariffPrice').val());
                        var p = parseCurrency($('#PatientShare').val());
                        var i = parseCurrency($('#InsurerShare').val());
                        if (t > 0 && p >= 0 && i >= 0 && t !== (p + i)) {
                            e.preventDefault();
                            alert('Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± + Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡ (Ø¨Ù‡ Ø±ÛŒØ§Ù„) Ø¨Ø§Ø´Ø¯.');
                            isValid = false;
                        }
                    }

                    if (!isValid) {
                        e.preventDefault();
                        alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                    }
                });
            }

            function validateField(field) {
                var value = field.val();
                var isValid = true;

                if (field.prop('required') && (!value || value.trim() === '')) {
                    field.addClass('is-invalid');
                    field.next('.medical-form-error').text('Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                } else if (field.attr('type') === 'number' && value) {
                    var num = parseFloat(value);
                    if (isNaN(num) || num < 0) {
                        field.addClass('is-invalid');
                        field.next('.medical-form-error').text('Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                        isValid = false;
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.medical-form-error').text('');
                    }
                } else {
                    field.removeClass('is-invalid');
                    field.next('.medical-form-error').text('');
                }

                return isValid;
            }

            // ---------- Accessibility ----------
            function setupAccessibility() {
                // Keyboard navigation
                $('.medical-form-control').on('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        var nextField = $(this).closest('.medical-form-group').next().find('.medical-form-control');
                        if (nextField.length) {
                            nextField.focus();
                        }
                    }
                });

                // ARIA labels
                $('.medical-form-control').each(function() {
                    var field = $(this);
                    var label = field.closest('.medical-form-group').find('.medical-form-label').text();
                    field.attr('aria-label', label);
                });
            }

            // ---------- Auto Calculation ----------
            function setupAutoCalculation() {
                setupCascadingDropdowns();

                // Field change detection
                $('#ServiceId, #InsurancePlanId, #TariffPrice, #PatientShare, #InsurerShare').on('change input', function() {
                    debounceCalculation();
                });

                // ğŸ”§ CRITICAL FIX: Ø¢Ú¯Ø§Ù‡ÛŒ Ø§Ø² Ù¾ÙˆØ´Ø´/ÙØ±Ø§Ù†Ø´ÛŒØ² Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡
                $('#InsurancePlanId').on('change', function() {
                    var planId = $(this).val();
                    if (planId) {
                        loadDeductibleAndCoverageInfo(planId);
                    }
                });

                // Manual calculation button
                $('#calculateBtn').on('click', function() {
                    performCalculation();
                });
            }

            function debounceCalculation() {
                clearTimeout(calculationTimeout);
                calculationTimeout = setTimeout(function() {
                    if (!isCalculating) {
                        performCalculation();
                    }
                }, 500);
            }

            function performCalculation() {
                var serviceId = $('#ServiceId').val();
                var planId = $('#InsurancePlanId').val();
                
                if (!serviceId || !planId) {
                    console.log('ğŸ¥ MEDICAL: Skipping calculation - missing required fields. ServiceId:', serviceId, 'PlanId:', planId);
                    return;
                }

                // ğŸ›¡ï¸ P0 FIX: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² infinite loop
                if (isCalculating) {
                    console.log('ğŸ¥ MEDICAL: Calculation already in progress, skipping...');
                    return;
                }

                // ğŸ”§ CRITICAL FIX: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Race Condition
                if (lastCalcXhr) try { lastCalcXhr.abort(); } catch(e){}
                
                isCalculating = true;
                updateProgress(0);

                var correlationId = lastCid = 'calc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('ğŸ¥ MEDICAL: Performing calculation - CorrelationId:', correlationId, 'ServiceId:', serviceId, 'PlanId:', planId);

                // ğŸ”§ CRITICAL FIX: Ø§Ø±Ø³Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÛŒØ§Ù„ (Ø¨Ø¯ÙˆÙ† ØªØ¨Ø¯ÛŒÙ„)
                var formData = {
                    serviceId: serviceId,
                    insurancePlanId: planId,
                    providerId: $('#InsuranceProviderId').val(),
                    currentTariffPrice: parseCurrency($('#TariffPrice').val()) || 0, // Ø±ÛŒØ§Ù„
                    currentPatientShare: parseCurrency($('#PatientShare').val()) || 0, // Ø±ÛŒØ§Ù„
                    currentInsurerShare: parseCurrency($('#InsurerShare').val()) || 0, // Ø±ÛŒØ§Ù„
                    unit: 'RIAL', // ğŸ”§ CRITICAL FIX: ÙˆØ§Ø­Ø¯ ØµØ±ÛŒØ­
                    correlationId: correlationId
                };

                updateProgress(30);

                // ğŸ”§ CRITICAL FIX: Anti-Forgery Token Ø¯Ø± Header
                var token = $('input[name="__RequestVerificationToken"]').val();
                formData.__RequestVerificationToken = token;

                lastCalcXhr = $.ajax({
                    url: '@Url.Action("CalculateAdvancedTariff", "InsuranceTariff")',
                    type: 'POST',
                    dataType: 'json',
                    timeout: 15000, // ğŸ”§ CRITICAL FIX: Timeout 15 Ø«Ø§Ù†ÛŒÙ‡
                    headers: { 'RequestVerificationToken': token }, // ğŸ”§ CRITICAL FIX: Anti-Forgery Ø¯Ø± Header
                    data: formData,
                    success: function(response) {
                        // ğŸ”§ CRITICAL FIX: Ø¨Ø±Ø±Ø³ÛŒ CorrelationId Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ú©Ù‡Ù†Ù‡
                        if (correlationId !== lastCid) {
                            console.log('ğŸ¥ MEDICAL: Ignoring stale calculation response');
                            return;
                        }
                        updateProgress(100);
                        console.log('ğŸ¥ MEDICAL: Calculation Response Received:', response);
                        
                        // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response structure
                        if (response && (response.success === true || response.Success === true)) {
                            console.log('ğŸ¥ MEDICAL: Success response detected, calling displayCalculationResults');
                            displayCalculationResults(response.data || response.Data);
                            logCalculationSuccess(correlationId, response.data || response.Data);
                        } else {
                            var errorMessage = response?.message || response?.Message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
                            console.log('ğŸ¥ MEDICAL: Error response detected:', errorMessage);
                            displayCalculationError(errorMessage);
                            logCalculationError(correlationId, 'Server Error', errorMessage);
                        }
                        isCalculating = false;
                    },
                    error: function(xhr, status, error) {
                        updateProgress(100);
                        console.error('ğŸ¥ MEDICAL: AJAX Error Details:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
                        if (xhr.responseText) {
                            try {
                                var errorResponse = JSON.parse(xhr.responseText);
                                errorMessage = errorResponse.message || errorResponse.Message || errorMessage;
                            } catch (e) {
                                errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡: ' + (error || xhr.statusText);
                            }
                        }
                        
                        displayCalculationError(errorMessage);
                        logCalculationError(correlationId, 'Network Error', errorMessage);
                        isCalculating = false;
                    }
                });
            }

            function displayCalculationResults(data) {
                // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                if (!data) {
                    console.error('ğŸ¥ MEDICAL: No calculation data received');
                    displayCalculationError('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    return;
                }

                console.log('ğŸ¥ MEDICAL: Binding calculation results to form fields - Data:', data);
                
                // ğŸ” ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± response
                if (window.analyzeResponse) {
                    window.analyzeResponse({ data: data });
                }
                
                // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ·Ø¨ÛŒÙ‚ Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                var tariffPrice = data.tariffPrice || data.TariffPrice;
                var patientShare = data.patientShare || data.PatientShare;
                var insurerShare = data.insurerShare || data.InsurerShare;
                
                console.log('ğŸ¥ MEDICAL: Extracted values:', {
                    tariffPrice: tariffPrice,
                    patientShare: patientShare,
                    insurerShare: insurerShare
                });

                // ğŸ” Debug: Ø¨Ø±Ø±Ø³ÛŒ element Ù‡Ø§
                debugFormElements();
                debugHTMLStructure();

                // ğŸš€ P0 FIX: Bind Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ textbox Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ÙØ±Ù…
                try {
                    // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ element Ù‡Ø§
                    var tariffPriceElement = $('#TariffPrice');
                    var patientShareElement = $('#PatientShare');
                    var insurerShareElement = $('#InsurerShare');
                    
                    console.log('ğŸ¥ MEDICAL: Element Check:', {
                        tariffPriceExists: tariffPriceElement.length > 0,
                        patientShareExists: patientShareElement.length > 0,
                        insurerShareExists: insurerShareElement.length > 0
                    });

                    // ğŸ”§ CRITICAL FIX: Ù†Ù…Ø§ÛŒØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÛŒØ§Ù„ (Ø¨Ø¯ÙˆÙ† ØªØ¨Ø¯ÛŒÙ„)
                    // Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡
                    if (tariffPrice !== undefined && tariffPrice !== null && tariffPriceElement.length > 0) {
                        tariffPriceElement.val(tariffPrice);
                        console.log('ğŸ¥ MEDICAL: TariffPrice bound:', tariffPrice);
                    }

                    // Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±
                    if (patientShare !== undefined && patientShare !== null && patientShareElement.length > 0) {
                        patientShareElement.val(patientShare);
                        console.log('ğŸ¥ MEDICAL: PatientShare bound:', patientShare);
                    }

                    // Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡
                    if (insurerShare !== undefined && insurerShare !== null && insurerShareElement.length > 0) {
                        insurerShareElement.val(insurerShare);
                        console.log('ğŸ¥ MEDICAL: InsurerShare bound:', insurerShare);
                    }

                    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ (Ø±ÛŒØ§Ù„)
                    $('#calculatedTariffPrice').text(formatCurrency(tariffPrice) + ' Ø±ÛŒØ§Ù„');
                    $('#calculatedPatientShare').text(formatCurrency(patientShare) + ' Ø±ÛŒØ§Ù„');
                    $('#calculatedInsurerShare').text(formatCurrency(insurerShare) + ' Ø±ÛŒØ§Ù„');
                    
                    $('#calculationResults').show();
                    $('#calculationSummary').html('<div class="alert alert-success">âœ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</div>');

                    console.log('ğŸ¥ MEDICAL: All calculation results bound successfully');
                    
                    // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² binding
                    if (window.checkFieldValues) {
                        window.checkFieldValues();
                    }
                } catch (error) {
                    console.error('ğŸ¥ MEDICAL: Error binding calculation results:', error);
                    
                    // ğŸ”„ Fallback: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ bind Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                    try {
                        console.log('ğŸ¥ MEDICAL: Attempting fallback binding...');
                        fallbackBinding(data);
                        
                        // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² fallback
                        if (window.checkFieldValues) {
                            window.checkFieldValues();
                        }
                    } catch (fallbackError) {
                        console.error('ğŸ¥ MEDICAL: Fallback binding also failed:', fallbackError);
                        displayCalculationError('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ù‡');
                    }
                }
            }

            function displayCalculationError(message) {
                console.error('ğŸ¥ MEDICAL: Calculation Error Display:', message);
                
                // ğŸ”§ CRITICAL FIX: Ø¹Ø¯Ù… Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø®Ø·Ø§
                // $('#TariffPrice').val('');
                // $('#PatientShare').val('');
                // $('#InsurerShare').val('');
                
                $('#calculationResults').hide();
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±
                var errorMessage = message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
                $('#calculationSummary').html('<div class="alert alert-danger">âŒ ' + errorMessage + '</div>');
            }

            function updateProgress(percent) {
                $('#progressBar').css('width', percent + '%');
            }

            // ğŸ”§ CRITICAL FIX: Ø¢Ú¯Ø§Ù‡ÛŒ Ø§Ø² Ù¾ÙˆØ´Ø´/ÙØ±Ø§Ù†Ø´ÛŒØ² Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ù‡
            function loadDeductibleAndCoverageInfo(planId) {
                if (!planId) return;
                
                console.log('ğŸ¥ MEDICAL: Loading deductible and coverage info for plan:', planId);
                
                $.ajax({
                    url: '@Url.Action("GetInsurancePlanDeductible", "InsuranceTariff")',
                    type: 'GET',
                    dataType: 'json',
                    data: { planId: planId },
                    success: function(response) {
                        if (response.success && response.data) {
                            var deductible = response.data.deductible || 0;
                            var coveragePercent = response.data.coveragePercent || 0;
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± UI
                            showPlanInfo(deductible, coveragePercent);
                            
                            console.log('ğŸ¥ MEDICAL: Plan info loaded - Deductible:', deductible, 'Coverage:', coveragePercent + '%');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Error loading plan info:', error);
                    }
                });
            }

            function showPlanInfo(deductible, coveragePercent) {
                // Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø·Ø±Ø­
                var infoHtml = `
                    <div id="planInfoCard" class="alert alert-info mt-3">
                        <h6><i class="fas fa-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ÙØ±Ø§Ù†Ø´ÛŒØ²:</strong> ${formatCurrency(deductible)} Ø±ÛŒØ§Ù„
                            </div>
                            <div class="col-md-6">
                                <strong>Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´:</strong> ${coveragePercent}%
                            </div>
                        </div>
                    </div>
                `;
                
                // Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ÛŒ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¬Ø¯ÛŒØ¯
                $('#planInfoCard').remove();
                $('#InsurancePlanId').closest('.medical-form-group').after(infoHtml);
            }

            function logCalculationSuccess(correlationId, data) {
                console.log('ğŸ¥ MEDICAL: Calculation Success - CorrelationId:', correlationId, 'Data:', data);
                
                // ğŸ” Debug: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                if (data) {
                    console.log('ğŸ¥ MEDICAL: Data Structure Analysis:', {
                        hasTariffPrice: 'tariffPrice' in data,
                        hasPatientShare: 'patientShare' in data,
                        hasInsurerShare: 'insurerShare' in data,
                        tariffPriceValue: data.tariffPrice,
                        patientShareValue: data.patientShare,
                        insurerShareValue: data.insurerShare
                    });
                }
            }

            function logCalculationError(correlationId, type, message) {
                console.log('ğŸ¥ MEDICAL: Calculation Error - CorrelationId:', correlationId, 'Type:', type, 'Message:', message);
            }

            // ğŸ” Debug Helper: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ element Ù‡Ø§
            function debugFormElements() {
                console.log('ğŸ¥ MEDICAL: Form Elements Debug:', {
                    'TariffPrice': $('#TariffPrice').length,
                    'PatientShare': $('#PatientShare').length,
                    'InsurerShare': $('#InsurerShare').length,
                    'ServiceId': $('#ServiceId').length,
                    'InsurancePlanId': $('#InsurancePlanId').length,
                    'InsuranceProviderId': $('#InsuranceProviderId').length
                });

                // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§
                $('input[name*="Tariff"], input[name*="Share"]').each(function() {
                    console.log('ğŸ¥ MEDICAL: Found field:', {
                        name: $(this).attr('name'),
                        id: $(this).attr('id'),
                        type: $(this).attr('type')
                    });
                });
            }

            // ğŸ”„ Fallback Binding: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ bind Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            function fallbackBinding(data) {
                console.log('ğŸ¥ MEDICAL: Fallback binding started with data:', data);

                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                var tariffSelectors = [
                    '#TariffPrice', 'input[name="TariffPrice"]', 'input[name="tariffPrice"]',
                    'input[name="Tariff"]', 'input[name="tariff"]'
                ];

                var patientSelectors = [
                    '#PatientShare', 'input[name="PatientShare"]', 'input[name="patientShare"]',
                    'input[name="Patient"]', 'input[name="patient"]'
                ];

                var insurerSelectors = [
                    '#InsurerShare', 'input[name="InsurerShare"]', 'input[name="insurerShare"]',
                    'input[name="Insurer"]', 'input[name="insurer"]'
                ];

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                var tariffPrice = data.tariffPrice || data.TariffPrice;
                var patientShare = data.patientShare || data.PatientShare;
                var insurerShare = data.insurerShare || data.InsurerShare;

                // Bind Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡
                if (tariffPrice !== undefined && tariffPrice !== null) {
                    for (var i = 0; i < tariffSelectors.length; i++) {
                        var element = $(tariffSelectors[i]);
                        if (element.length > 0) {
                            // ğŸ›¡ï¸ P0 FIX: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ input type="number"
                            element.val(tariffPrice);
                            console.log('ğŸ¥ MEDICAL: Fallback TariffPrice bound using selector:', tariffSelectors[i]);
                            break;
                        }
                    }
                }

                // Bind Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±
                if (patientShare !== undefined && patientShare !== null) {
                    for (var i = 0; i < patientSelectors.length; i++) {
                        var element = $(patientSelectors[i]);
                        if (element.length > 0) {
                            // ğŸ›¡ï¸ P0 FIX: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ input type="number"
                            element.val(patientShare);
                            console.log('ğŸ¥ MEDICAL: Fallback PatientShare bound using selector:', patientSelectors[i]);
                            break;
                        }
                    }
                }

                // Bind Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡
                if (insurerShare !== undefined && insurerShare !== null) {
                    for (var i = 0; i < insurerSelectors.length; i++) {
                        var element = $(insurerSelectors[i]);
                        if (element.length > 0) {
                            // ğŸ›¡ï¸ P0 FIX: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ input type="number"
                            element.val(insurerShare);
                            console.log('ğŸ¥ MEDICAL: Fallback InsurerShare bound using selector:', insurerSelectors[i]);
                            break;
                        }
                    }
                }

                console.log('ğŸ¥ MEDICAL: Fallback binding completed');
            }

            // ğŸ” HTML Structure Debug: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± HTML
            function debugHTMLStructure() {
                console.log('ğŸ¥ MEDICAL: HTML Structure Debug:');
                console.log('ğŸ¥ MEDICAL: All input fields:', $('input').map(function() {
                    return {
                        id: $(this).attr('id'),
                        name: $(this).attr('name'),
                        type: $(this).attr('type'),
                        class: $(this).attr('class')
                    };
                }).get());
            }

            // ğŸŒ Global Debug Helper: Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± console
            window.debugInsuranceTariff = function() {
                console.log('ğŸ¥ MEDICAL: Global Debug Helper Activated');
                debugFormElements();
                debugHTMLStructure();
                console.log('ğŸ¥ MEDICAL: Current form values:', {
                    TariffPrice: $('#TariffPrice').val(),
                    PatientShare: $('#PatientShare').val(),
                    InsurerShare: $('#InsurerShare').val(),
                    ServiceId: $('#ServiceId').val(),
                    InsurancePlanId: $('#InsurancePlanId').val()
                });
            };

            // ğŸ§ª Test Binding Helper: Ø¨Ø±Ø§ÛŒ ØªØ³Øª binding
            window.testBinding = function() {
                console.log('ğŸ¥ MEDICAL: Test Binding Helper Activated');
                var testData = {
                    tariffPrice: 119300,
                    patientShare: 47720,
                    insurerShare: 71580
                };
                console.log('ğŸ¥ MEDICAL: Testing with data:', testData);
                displayCalculationResults(testData);
            };

            // ğŸ” Response Structure Analyzer: Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± response
            window.analyzeResponse = function(response) {
                console.log('ğŸ¥ MEDICAL: Response Structure Analysis:');
                console.log('ğŸ¥ MEDICAL: Response type:', typeof response);
                console.log('ğŸ¥ MEDICAL: Response keys:', Object.keys(response || {}));
                console.log('ğŸ¥ MEDICAL: Success check:', {
                    'response.success': response?.success,
                    'response.Success': response?.Success,
                    'response.data': response?.data,
                    'response.Data': response?.Data
                });
                
                if (response?.data || response?.Data) {
                    var data = response.data || response.Data;
                    console.log('ğŸ¥ MEDICAL: Data structure:', {
                        'data.tariffPrice': data?.tariffPrice,
                        'data.TariffPrice': data?.TariffPrice,
                        'data.patientShare': data?.patientShare,
                        'data.PatientShare': data?.PatientShare,
                        'data.insurerShare': data?.insurerShare,
                        'data.InsurerShare': data?.InsurerShare
                    });
                }
            };

            // ğŸ” Field Values Checker: Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§
            window.checkFieldValues = function() {
                console.log('ğŸ¥ MEDICAL: Field Values Check:');
                console.log('ğŸ¥ MEDICAL: TariffPrice value:', $('#TariffPrice').val());
                console.log('ğŸ¥ MEDICAL: PatientShare value:', $('#PatientShare').val());
                console.log('ğŸ¥ MEDICAL: InsurerShare value:', $('#InsurerShare').val());
                console.log('ğŸ¥ MEDICAL: TariffPrice element exists:', $('#TariffPrice').length > 0);
                console.log('ğŸ¥ MEDICAL: PatientShare element exists:', $('#PatientShare').length > 0);
                console.log('ğŸ¥ MEDICAL: InsurerShare element exists:', $('#InsurerShare').length > 0);
            };

            // ğŸ›¡ï¸ Loop Prevention Helper: Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² infinite loop
            window.stopInfiniteLoop = function() {
                console.log('ğŸ¥ MEDICAL: Stopping infinite loop...');
                isCalculating = false;
                clearTimeout(calculationTimeout);
                console.log('ğŸ¥ MEDICAL: Infinite loop stopped');
            };

            // ğŸ”„ System Reset Helper: Ø¨Ø±Ø§ÛŒ reset Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ…
            window.resetCalculationSystem = function() {
                console.log('ğŸ¥ MEDICAL: Resetting calculation system...');
                isCalculating = false;
                clearTimeout(calculationTimeout);
                $('#TariffPrice').val('');
                $('#PatientShare').val('');
                $('#InsurerShare').val('');
                $('#calculationResults').hide();
                $('#calculationSummary').html('');
                console.log('ğŸ¥ MEDICAL: Calculation system reset');
            };

            // ğŸ” Event Listeners Checker: Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ event listeners
            window.checkEventListeners = function() {
                console.log('ğŸ¥ MEDICAL: Event Listeners Check:');
                console.log('ğŸ¥ MEDICAL: TariffPrice change listeners:', $._data($('#TariffPrice')[0], 'events'));
                console.log('ğŸ¥ MEDICAL: PatientShare change listeners:', $._data($('#PatientShare')[0], 'events'));
                console.log('ğŸ¥ MEDICAL: InsurerShare change listeners:', $._data($('#InsurerShare')[0], 'events'));
                console.log('ğŸ¥ MEDICAL: ServiceId change listeners:', $._data($('#ServiceId')[0], 'events'));
                console.log('ğŸ¥ MEDICAL: InsurancePlanId change listeners:', $._data($('#InsurancePlanId')[0], 'events'));
            };

            // ğŸ›¡ï¸ Custom Validation: Ø¨Ø±Ø§ÛŒ validation Ø³ÙØ§Ø±Ø´ÛŒ
            function setupCustomValidation() {
                // Ø­Ø°Ù HTML5 validation
                $('input[type="number"]').removeAttr('step');
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† validation Ø³ÙØ§Ø±Ø´ÛŒ
                $('#TariffPrice, #PatientShare, #InsurerShare').on('input', function() {
                    var value = parseFloat($(this).val());
                    if (value && value < 0) {
                        $(this).val(0);
                    }
                });
                
                console.log('ğŸ¥ MEDICAL: Custom validation setup completed');
            }

            // ğŸ” Validation Helper: Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ validation
            window.checkValidation = function() {
                console.log('ğŸ¥ MEDICAL: Validation Check:');
                console.log('ğŸ¥ MEDICAL: TariffPrice step attribute:', $('#TariffPrice').attr('step'));
                console.log('ğŸ¥ MEDICAL: PatientShare step attribute:', $('#PatientShare').attr('step'));
                console.log('ğŸ¥ MEDICAL: InsurerShare step attribute:', $('#InsurerShare').attr('step'));
                console.log('ğŸ¥ MEDICAL: All number inputs:', $('input[type="number"]').length);
            };
        })();
    </script>
}
