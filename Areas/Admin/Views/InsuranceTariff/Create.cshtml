@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffCreateEditViewModel

@{
    ViewBag.Title = "Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Description = "ØªØ¹Ø±ÛŒÙ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ - Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§";
    ViewBag.Keywords = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡, Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ, Ú©Ù„ÛŒÙ†ÛŒÚ©, Ø¨ÛŒÙ…Ù‡, ØªØ¹Ø±ÙÙ‡";
}

<!-- ğŸš€ SEO: Meta Tags Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ SEO -->
@section MetaTags {
    <meta name="description" content="@ViewBag.Description" />
    <meta name="keywords" content="@ViewBag.Keywords" />
    <meta name="author" content="Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§" />
    <meta name="robots" content="noindex, nofollow" />
}

@section Styles {
    <style>
        /* ğŸ¥ MEDICAL: Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø¯Ø±Ù…Ø§Ù†ÛŒ */
        .medical-form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            font-family: 'Vazirmatn', 'Vazir', 'Tahoma', sans-serif;
            direction: rtl;
            text-align: right;
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ğŸš€ FIX: Override main-content background */
        .main-content {
            background: #ffffff !important;
        }

        /* ğŸš€ FIX: Override body background */
        body {
            background: #ffffff !important;
        }

        /* ğŸš€ FIX: Override html background */
        html {
            background: #ffffff !important;
        }


        /* ğŸš€ PERFORMANCE: Select2 Remote Styling */
        .select2-container--default .select2-results__option {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #007bff;
            color: white;
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-left: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        /* ğŸš€ UX: Enhanced option display */
        .service-option, .plan-option, .provider-option {
            padding: 4px 0;
        }

        .service-name, .plan-name, .provider-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .service-description, .plan-code, .plan-coverage, .provider-description {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .plan-coverage {
            color: #28a745;
            font-weight: 500;
        }

        /* ğŸš€ PERFORMANCE: Loading states */
        .select2-container--default .select2-results__option[aria-disabled=true] {
            color: #999;
            background-color: #f8f9fa;
        }

        .select2-container--default .select2-results__option[data-select2-id] {
            cursor: pointer;
        }

        /* ğŸš€ UX: Form Field Animations */
        .medical-form-input, .medical-form-select, .medical-form-textarea {
            transition: all 0.3s ease;
        }

            .medical-form-input:focus, .medical-form-select:focus, .medical-form-textarea:focus {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            }

        /* ğŸš€ UX: Button Animations */
        .btn {
            transition: all 0.3s ease;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

        /* ğŸš€ UX: Success/Error States */
        .form-success {
            background: #10b981;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .form-error {
            background: #ef4444;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        /* ğŸš€ UX: Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            margin: 24px 0;
        }

        /* ğŸš€ ACCESSIBILITY: Basic Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 8px;
            transition: all 0.3s ease;
        }

            .progress-step.active {
                background: #3b82f6;
                color: white;
                transform: scale(1.1);
            }

            .progress-step.completed {
                background: #10b981;
                color: white;
            }

        .progress-line {
            height: 2px;
            background: #e5e7eb;
            flex: 1;
            margin: 0 8px;
            align-self: center;
        }

            .progress-line.completed {
                background: #10b981;
            }

        .medical-form-header {
            background: #3b82f6;
            color: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            position: relative;
            z-index: 2;
        }


        .medical-form-title {
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 12px 0;
        }

        .medical-form-subtitle {
            font-size: 18px;
            margin: 0;
            opacity: 0.95;
        }

        .medical-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @@media (min-width: 768px) {
            .medical-form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @@media (min-width: 1200px) {
            .medical-form-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .medical-fieldset {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

            .medical-fieldset:hover {
                box-shadow: 0 8px 24px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }

        .medical-fieldset-legend {
            font-size: 20px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 3px solid #3b82f6;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .medical-fieldset-legend::before {
                content: 'ğŸ¥';
                font-size: 24px;
            }

        .medical-form-group {
            margin-bottom: 24px;
        }

            /* ğŸš€ UX: Enhanced dropdown styling for grouped services */
            .medical-form-group select optgroup {
                font-weight: 700;
                font-size: 14px;
                color: #1e40af;
                background-color: #f8fafc;
                padding: 8px 12px;
                border-bottom: 1px solid #e2e8f0;
            }

            .medical-form-group select option {
                padding: 8px 12px;
                font-size: 13px;
                line-height: 1.4;
                color: #374151;
                background-color: #ffffff;
            }

                .medical-form-group select option:hover {
                    background-color: #f1f5f9;
                    color: #1e40af;
                }

                .medical-form-group select option:checked {
                    background-color: #3b82f6;
                    color: #ffffff;
                }

        .medical-form-label {
            display: block;
            font-size: 15px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 8px;
            line-height: 1.4;
        }

            .medical-form-label.required::after {
                content: " (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)";
                color: #dc2626;
                font-weight: 600;
                font-size: 13px;
            }

        .medical-form-input,
        .medical-form-select,
        .medical-form-textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Vazirmatn', 'Vazir', 'Tahoma', sans-serif;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

            .medical-form-input:focus,
            .medical-form-select:focus,
            .medical-form-textarea:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
                transform: translateY(-1px);
            }

            .medical-form-input.currency {
                text-align: left;
                direction: ltr;
                font-family: 'Courier New', monospace;
                font-weight: 600;
            }

            .medical-form-input.persian-date {
                text-align: center;
                font-family: 'Vazirmatn', 'Vazir', 'Tahoma', sans-serif;
            }

        .medical-form-help {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
            line-height: 1.5;
            font-style: italic;
        }

        .medical-form-error {
            font-size: 13px;
            color: #dc2626;
            margin-top: 6px;
            display: block;
            font-weight: 600;
        }

        .medical-toggle {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .medical-toggle-input {
            width: 24px;
            height: 24px;
            accent-color: #3b82f6;
            cursor: pointer;
        }

        .medical-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

            .medical-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #0ea5e9, #3b82f6, #1d4ed8);
            }

            .medical-card h4 {
                margin: 0 0 16px 0;
                font-size: 18px;
                color: #0c4a6e;
                font-weight: 700;
            }

        .medical-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            font-family: 'Vazirmatn', 'Vazir', 'Tahoma', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

            .medical-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }

            .medical-btn:hover::before {
                left: 100%;
            }

        .medical-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

            .medical-btn-primary:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            }

        .medical-btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(107, 114, 128, 0.3);
        }

            .medical-btn-secondary:hover {
                background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(107, 114, 128, 0.4);
            }

        .medical-btn-group {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
            margin-top: 40px;
            padding-top: 32px;
            border-top: 2px solid #e5e7eb;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid;
        }

        .alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fecaca;
            color: #dc2626;
        }

        .alert-success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #bbf7d0;
            color: #166534;
        }

        /* ğŸ¥ MEDICAL: RTL Support */
        .medical-form-container * {
            direction: rtl;
        }

        .medical-form-input.currency,
        .medical-form-input.persian-date {
            direction: ltr;
            text-align: left;
        }

        /* ğŸ¥ MEDICAL: Accessibility */
        .medical-form-input:focus,
        .medical-form-select:focus,
        .medical-form-textarea:focus {
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
        }

        /* ğŸ¥ MEDICAL: Loading States */
        .medical-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

            .medical-btn.loading::after {
                content: '';
                width: 16px;
                height: 16px;
                border: 2px solid transparent;
                border-top: 2px solid currentColor;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 8px;
            }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ğŸ¥ MEDICAL: Print Styles */
        @@media print {
            .medical-btn-group,
            .medical-card {
                display: none;
            }

            .medical-form-container {
                max-width: none;
                padding: 0;
                background: white;
            }

            .medical-fieldset {
                break-inside: avoid;
                margin-bottom: 20px;
                box-shadow: none;
                border: 1px solid #000;
            }
        }

        /* ğŸ¥ MEDICAL: Mobile Responsive */
        @@media (max-width: 768px) {
            .medical-form-container {
                padding: 16px;
                margin: 0;
            }

            .medical-form-header {
                padding: 24px;
            }

            .medical-form-title {
                font-size: 24px;
            }

            .medical-form-subtitle {
                font-size: 16px;
            }

            .progress-indicator {
                flex-direction: column;
                gap: 8px;
            }

            .progress-step {
                width: 100%;
                justify-content: center;
            }

            .medical-form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .medical-form-input,
            .medical-form-select,
            .medical-form-textarea {
                padding: 12px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .medical-btn {
                width: 100%;
                margin-bottom: 8px;
                padding: 16px;
                font-size: 16px;
            }

            .medical-fieldset {
                padding: 20px;
            }

            .medical-btn-group {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* ğŸ¥ MEDICAL: Tablet Responsive */
        @@media (min-width: 769px) and (max-width: 1024px) {
            .medical-form-container {
                padding: 20px;
            }

            .medical-form-grid {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .medical-form-header {
                padding: 28px;
            }
        }

        /* ğŸ¥ MEDICAL: Desktop Responsive */
        @@media (min-width: 1025px) {
            .medical-form-container {
                padding: 24px;
            }

            .medical-form-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 24px;
            }
        }

        /* ğŸ¥ MEDICAL: High DPI displays */
        @@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .medical-form-input,
            .medical-form-select,
            .medical-form-textarea {
                border-width: 0.5px;
            }
        }

        /* ğŸ¥ MEDICAL: Print styles */
        @@media print {
            .medical-form-container {
                max-width: none;
                padding: 0;
                background: white;
            }

            .medical-form-header {
                background: white !important;
                color: black !important;
                border-bottom: 2px solid #000;
            }

            .medical-btn {
                display: none;
            }

            .progress-indicator {
                display: none;
            }
        }
    </style>
}

<div class="medical-form-container">
    <!-- ğŸ¥ MEDICAL: Header -->
    <header class="medical-form-header" role="banner">
        <h1 class="medical-form-title" id="page-title">Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡</h1>
        <p class="medical-form-subtitle" id="page-description">ØªØ¹Ø±ÛŒÙ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ - Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§</p>

        <!-- ğŸš€ UX: Progress Indicator -->
        <nav class="progress-indicator" role="progressbar" aria-label="Ù…Ø±Ø§Ø­Ù„ ØªÚ©Ù…ÛŒÙ„ ÙØ±Ù…" aria-valuenow="2" aria-valuemin="1" aria-valuemax="4">
            <div class="progress-step completed" data-step="1" aria-label="Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† - ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡">
                <i class="fas fa-check" aria-hidden="true"></i>
                <span class="sr-only">Ù…Ø±Ø­Ù„Ù‡ 1 ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>
                </div>
            <div class="progress-line completed" aria-hidden="true"></div>
            <div class="progress-step active" data-step="2" aria-label="Ù…Ø±Ø­Ù„Ù‡ 2: Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª - Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">
                <span>2</span>
                <span class="sr-only">Ù…Ø±Ø­Ù„Ù‡ 2 Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
                </div>
            <div class="progress-line" aria-hidden="true"></div>
            <div class="progress-step" data-step="3" aria-label="Ù…Ø±Ø­Ù„Ù‡ 3: ØªÙ†Ø¸ÛŒÙ… ØªØ¹Ø±ÙÙ‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±">
                <span>3</span>
                <span class="sr-only">Ù…Ø±Ø­Ù„Ù‡ 3 Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
            <div class="progress-line" aria-hidden="true"></div>
            <div class="progress-step" data-step="4" aria-label="Ù…Ø±Ø­Ù„Ù‡ 4: ØªØ§ÛŒÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±">
                <span>4</span>
                <span class="sr-only">Ù…Ø±Ø­Ù„Ù‡ 4 Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
        </div>
        </nav>
    </header>

    @using (Html.BeginForm("Create", "InsuranceTariff", FormMethod.Post, new { @class = "medical-form", id = "insuranceTariffForm", role = "form", @aria_labelledby = "page-title" }))
                    {
                        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.IdempotencyKey)

        <!-- ğŸ¥ MEDICAL: Error Summary -->
        <div id="errorSummary" role="alert" aria-live="polite">
                        @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })
        </div>

        <div class="medical-form-grid">
            <!-- ğŸ¥ MEDICAL: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡ -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡</legend>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.DepartmentId, new { @class = "medical-form-label required", @for = "DepartmentId" })
                    @Html.DropDownListFor(m => m.DepartmentId, Model.DepartmentSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†", new
                    {
                        @class = "medical-form-select",
                        id = "DepartmentId",
                        @aria_required = "true",
                        @aria_describedby = "DepartmentId-help DepartmentId-error"
                    })
                    @Html.ValidationMessageFor(m => m.DepartmentId, "", new { @class = "medical-form-error", id = "DepartmentId-error" })
                    <div class="medical-form-help" id="DepartmentId-help">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.ServiceCategoryId, new { @class = "medical-form-label", @for = "ServiceCategoryId" })
                    @Html.DropDownListFor(m => m.ServiceCategoryId, Model.ServiceCategorySelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª", new
                    {
                        @class = "medical-form-select",
                        id = "ServiceCategoryId",
                        @aria_describedby = "ServiceCategoryId-help ServiceCategoryId-error"
                    })
                    @Html.ValidationMessageFor(m => m.ServiceCategoryId, "", new { @class = "medical-form-error", id = "ServiceCategoryId-error" })
                    <div class="medical-form-help" id="ServiceCategoryId-help">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.ServiceId, new { @class = "medical-form-label required", @for = "ServiceId" })
                    @Html.DropDownListFor(m => m.ServiceId, Model.ServiceSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª", new
                    {
                        @class = "medical-form-select",
                        id = "ServiceId",
                        @aria_required = "true",
                        @aria_describedby = "ServiceId-help ServiceId-error"
                    })
                    @Html.ValidationMessageFor(m => m.ServiceId, "", new { @class = "medical-form-error", id = "ServiceId-error" })
                    <div class="medical-form-help" id="ServiceId-help">Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                                    </div>
            </fieldset>

            <!-- ğŸ¥ MEDICAL: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡</legend>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.InsuranceProviderId, new { @class = "medical-form-label required", @for = "InsuranceProviderId" })
                    @Html.DropDownListFor(m => m.InsuranceProviderId, Model.InsuranceProviderSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡", new
                    {
                        @class = "medical-form-select",
                        id = "InsuranceProviderId",
                        @aria_required = "true",
                        @aria_describedby = "InsuranceProviderId-help InsuranceProviderId-error"
                    })
                    @Html.ValidationMessageFor(m => m.InsuranceProviderId, "", new { @class = "medical-form-error", id = "InsuranceProviderId-error" })
                    <div class="medical-form-help" id="InsuranceProviderId-help">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                        </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.InsurancePlanId, new { @class = "medical-form-label required", @for = "InsurancePlanId" })
                    @Html.DropDownListFor(m => m.InsurancePlanId, Model.InsurancePlanSelectList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡", new
                    {
                        @class = "medical-form-select",
                        id = "InsurancePlanId",
                        @aria_required = "true",
                        @aria_describedby = "InsurancePlanId-help InsurancePlanId-error"
                    })
                    @Html.ValidationMessageFor(m => m.InsurancePlanId, "", new { @class = "medical-form-error", id = "InsurancePlanId-error" })
                    <div class="medical-form-help" id="InsurancePlanId-help">Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                                </div>
            </fieldset>

            <!-- ğŸ¥ MEDICAL: Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡</legend>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.TariffPrice, new { @class = "medical-form-label" })
                    @Html.TextBoxFor(m => m.TariffPrice, new { @class = "medical-form-input currency", id = "TariffPrice", placeholder = "0", data_persian_numbers = "true" })
                    @Html.ValidationMessageFor(m => m.TariffPrice, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">Ù…Ø¨Ù„Øº ØªØ¹Ø±ÙÙ‡ (ØªÙˆÙ…Ø§Ù†) - Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ±ÙˆØ¯ Ø§Ø² Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ Ø®Ø¯Ù…Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                            </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.PatientShare, new { @class = "medical-form-label" })
                    @Html.TextBoxFor(m => m.PatientShare, new { @class = "medical-form-input currency", id = "PatientShare", placeholder = "0", data_persian_numbers = "true" })
                    @Html.ValidationMessageFor(m => m.PatientShare, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.InsurerShare, new { @class = "medical-form-label" })
                    @Html.TextBoxFor(m => m.InsurerShare, new { @class = "medical-form-input currency", id = "InsurerShare", placeholder = "0", data_persian_numbers = "true" })
                    @Html.ValidationMessageFor(m => m.InsurerShare, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>

                <!-- ğŸ¥ MEDICAL: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± -->
                <div class="medical-card">
                    <h4>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±</h4>
                    <div class="medical-form-group">
                        <button type="button" id="calculateButton" class="medical-btn medical-btn-primary">
                            <i class="fa fa-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
                                    </button>
                        <div id="calculationResult" class="medical-form-help">
                            <div id="calculationTimestamp"></div>
                        </div>
                        <!-- ğŸš€ FIX: Add calculation summary div -->
                        <div id="calculationSummary" class="medical-form-help"></div>
                    </div>
                </div>
            </fieldset>

            <!-- ğŸ¥ MEDICAL: ØªØ§Ø±ÛŒØ® Ø§Ø«Ø± -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">ØªØ§Ø±ÛŒØ® Ø§Ø«Ø±</legend>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.StartDate, new { @class = "medical-form-label" })
                    @Html.TextBoxFor(m => m.StartDate, new { @class = "medical-form-input persian-date", placeholder = "1403/01/01", id = "StartDate" })
                    @Html.ValidationMessageFor(m => m.StartDate, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø± ØªØ¹Ø±ÙÙ‡ (ÙØ±Ù…Øª: 1403/01/01)</div>
                </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.EndDate, new { @class = "medical-form-label" })
                    @Html.TextBoxFor(m => m.EndDate, new { @class = "medical-form-input persian-date", placeholder = "1403/12/29", id = "EndDate" })
                    @Html.ValidationMessageFor(m => m.EndDate, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø§Ø¹ØªØ¨Ø§Ø± ØªØ¹Ø±ÙÙ‡ (ÙØ±Ù…Øª: 1403/12/29)</div>
            </div>
            </fieldset>

            <!-- ğŸ¥ MEDICAL: ÙˆØ¶Ø¹ÛŒØª -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">ÙˆØ¶Ø¹ÛŒØª</legend>

                <div class="medical-toggle">
                    @Html.CheckBoxFor(m => m.IsActive, new { @class = "medical-toggle-input", id = "IsActive" })
                    @Html.LabelFor(m => m.IsActive, new { @class = "medical-form-label" })
                    <div class="medical-form-help">ØªØ¹Ø±ÙÙ‡ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</div>
        </div>

                <div class="medical-form-group">
                    @Html.LabelFor(m => m.Notes, new { @class = "medical-form-label" })
                    @Html.TextAreaFor(m => m.Notes, new { @class = "medical-form-textarea", rows = 4, placeholder = "ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ...", id = "Notes" })
                    @Html.ValidationMessageFor(m => m.Notes, "", new { @class = "medical-form-error" })
                    <div class="medical-form-help">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ ØªØ¹Ø±ÙÙ‡</div>
                </div>
            </fieldset>

            <!-- ğŸ¥ MEDICAL: Ø¹Ù…Ù„ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡ÛŒ -->
            <fieldset class="medical-fieldset">
                <legend class="medical-fieldset-legend">Ø¹Ù…Ù„ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡ÛŒ</legend>

                <div class="medical-toggle">
                    @Html.CheckBoxFor(m => m.IsAllServiceCategories, new { @class = "medical-toggle-input", id = "IsAllServiceCategories" })
                    @Html.LabelFor(m => m.IsAllServiceCategories, new { @class = "medical-form-label" })
                    <div class="medical-form-help">Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Øª</div>
                    </div>

                <div class="medical-toggle">
                    @Html.CheckBoxFor(m => m.IsAllServices, new { @class = "medical-toggle-input", id = "IsAllServices" })
                    @Html.LabelFor(m => m.IsAllServices, new { @class = "medical-form-label" })
                    <div class="medical-form-help">Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª</div>
                </div>
            </fieldset>
            </div>

        <!-- ğŸ¥ MEDICAL: Action Buttons -->
        <div class="medical-btn-group">
            <button type="button" class="medical-btn medical-btn-secondary" onclick="history.back()">
                <i class="fa fa-arrow-right"></i> Ø§Ù†ØµØ±Ø§Ù
            </button>
            <button type="submit" class="medical-btn medical-btn-primary" id="submitButton">
                <i class="fa fa-save"></i> Ø«Ø¨Øª ØªØ¹Ø±ÙÙ‡
            </button>
        </div>
    }
</div>

@section Scripts {
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $(document).ready(function() {
            // ğŸ¥ MEDICAL: Initialize form
            console.log('ğŸ¥ MEDICAL: Insurance Tariff Create form initialized');

            // Load insurance providers initially
            loadInsuranceProviders();

            // Setup cascading dropdowns
            setupCascadingDropdowns();

            // Setup form validation
            setupFormValidation();

            // Setup currency formatting
            setupCurrencyFormatting();

            // Setup date validation
            setupDateValidation();

            // Setup form protection
            setupFormProtection();

            // Setup accessibility
            setupAccessibility();

            // Setup auto-calculation
            setupAutoCalculation();

            // Setup Persian number conversion
            setupPersianNumberConversion();

            // Setup number input handling
            setupNumberInputHandling();
        });

        // ğŸ¥ MEDICAL: Cascading Dropdowns
        function setupCascadingDropdowns() {
            console.log('ğŸ¥ MEDICAL: Setting up cascading dropdowns');

            // Department -> Service Categories
            $('#DepartmentId').on('change', function() {
                var departmentId = $(this).val();
                console.log('ğŸ¥ MEDICAL: Department changed to:', departmentId);

                if (departmentId) {
                    loadServiceCategories(departmentId);
                } else {
                    clearServiceCategories();
                }
                clearServices();
            });
            
            // Service Category -> Services
            $('#ServiceCategoryId').on('change', function() {
                var categoryId = $(this).val();
                console.log('ğŸ¥ MEDICAL: Service Category changed to:', categoryId);

                if (categoryId) {
                    loadServices(categoryId);
                } else {
                    clearServices();
                }
            });
            
            // Insurance Provider -> Insurance Plans
            $('#InsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                console.log('ğŸ¥ MEDICAL: Insurance Provider changed to:', providerId);

                if (providerId) {
                    loadInsurancePlans(providerId);
                } else {
                    clearInsurancePlans();
                }
            });
        }

        // ğŸ¥ MEDICAL: Load Service Categories
        function loadServiceCategories(departmentId) {
            console.log('ğŸ¥ MEDICAL: Loading service categories for department:', departmentId);

            $('#ServiceCategoryId').prop('disabled', true).html('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>');
                
                $.ajax({
                url: '@Url.Action("GetServiceCategories", "InsuranceTariff")',
                type: 'GET',
                dataType: 'json',
                cache: false,
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                data: { departmentId: departmentId },
                    success: function(response) {
                    console.log('ğŸ¥ MEDICAL: Service categories response:', response);
                    console.log('ğŸ¥ MEDICAL: Response data type:', typeof response.data);
                    console.log('ğŸ¥ MEDICAL: Response data length:', response.data ? response.data.length : 'undefined');
                    console.log('ğŸ¥ MEDICAL: Is array:', Array.isArray(response.data));

                    if (response.success && response.data && Array.isArray(response.data) && response.data.length > 0) {
                        console.log('ğŸ¥ MEDICAL: Processing service categories data:', response.data);
                        var options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª</option>';
                        $.each(response.data, function(index, item) {
                            console.log('ğŸ¥ MEDICAL: Processing item:', item);
                            options += '<option value="' + item.id + '">' + item.name + '</option>';
                        });
                        $('#ServiceCategoryId').html(options).prop('disabled', false);
                        console.log('ğŸ¥ MEDICAL: Service categories loaded successfully');
                    } else {
                        $('#ServiceCategoryId').html('<option value="">Ù‡ÛŒÚ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>').prop('disabled', false);
                        console.log('ğŸ¥ MEDICAL: No service categories found for department:', departmentId);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ğŸ¥ MEDICAL: AJAX error loading service categories:', error);
                    $('#ServiceCategoryId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>').prop('disabled', false);
                    }
                });
            }

        // ğŸš€ PERFORMANCE: Load Services with Select2 Remote + Debounce
        function loadServices(categoryId) {
            console.log('ğŸ¥ MEDICAL: Loading services for category:', categoryId);

            // ğŸš€ FIX: Destroy existing Select2 before re-initializing
            if ($('#ServiceId').hasClass('select2-hidden-accessible')) {
                $('#ServiceId').select2('destroy');
            }

            // ğŸš€ PERFORMANCE: Initialize Select2 with Remote Data + Debounce
            $('#ServiceId').select2({
                placeholder: 'Ø®Ø¯Ù…Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                allowClear: true,
                minimumInputLength: 2,
                delay: 300, // ğŸš€ DEBOUNCE: 300ms delay for better performance
                ajax: {
                    url: '@Url.Action("GetServices", "InsuranceTariff")',
                    dataType: 'json',
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    data: function(params) {
                        return {
                            serviceCategoryId: categoryId,
                            search: params.term,
                            page: params.page || 1,
                            pageSize: 20 // ğŸš€ PAGING: Server-side paging for performance
                        };
                    },
                    processResults: function(data, params) {
                        console.log('ğŸ¥ MEDICAL: Services response:', data);
                        
                        if (data.success && data.data && Array.isArray(data.data)) {
                            console.log('ğŸ¥ MEDICAL: Processing services data:', data.data.length, 'services');
                            
                            // ğŸš€ PERFORMANCE: Process results for Select2
                            var results = data.data.map(function(item) {
                                return {
                                    id: item.id,
                                    text: item.name,
                                    description: item.description || ''
                                };
                            });

                            return {
                                results: results,
                                pagination: {
                                    more: data.hasMore || false
                                }
                            };
                        } else {
                            return { results: [] };
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Error loading services:', error);
                        $('#ServiceId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø¯Ù…Ø§Øª</option>');
                    }
                },
                templateResult: function(service) {
                    if (service.loading) {
                        return service.text;
                    }
                    
                    // ğŸš€ UX: Enhanced display with description
                    var $result = $(
                        '<div class="service-option">' +
                        '<div class="service-name">' + service.text + '</div>' +
                        (service.description ? '<div class="service-description">' + service.description + '</div>' : '') +
                        '</div>'
                    );
                    
                    return $result;
                },
                templateSelection: function(service) {
                    return service.text || service.text;
                }
            });

            // ğŸš€ PERFORMANCE: Load initial data if categoryId is provided
            if (categoryId) {
                $('#ServiceId').trigger('change');
            }

        // ğŸš€ PERFORMANCE: Load Insurance Providers with Select2 Remote + Debounce
        function loadInsuranceProviders() {
            return new Promise(function(resolve, reject) {
                console.log('ğŸ¥ MEDICAL: Loading insurance providers...');

                // ğŸš€ PERFORMANCE: Initialize Select2 with Remote Data + Debounce
                $('#InsuranceProviderId').select2({
                    placeholder: 'Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                    allowClear: true,
                    minimumInputLength: 1,
                    delay: 300, // ğŸš€ DEBOUNCE: 300ms delay for better performance
                    ajax: {
                        url: '@Url.Action("GetInsuranceProviders", "InsuranceTariff")',
                        dataType: 'json',
                    cache: false,
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        data: function(params) {
                            return {
                                search: params.term,
                                page: params.page || 1,
                                pageSize: 10 // ğŸš€ PAGING: Server-side paging for performance
                            };
                        },
                        processResults: function(data, params) {
                            console.log('ğŸ¥ MEDICAL: Insurance providers response:', data);
                            
                            if (data.success && data.data && Array.isArray(data.data)) {
                                console.log('ğŸ¥ MEDICAL: Processing insurance providers data:', data.data.length, 'providers');
                                
                                // ğŸš€ PERFORMANCE: Process results for Select2
                                var results = data.data.map(function(item) {
                                    return {
                                        id: item.id,
                                        text: item.name,
                                        description: item.description || ''
                                    };
                                });

                                return {
                                    results: results,
                                    pagination: {
                                        more: data.hasMore || false
                                    }
                                };
                            } else {
                                return { results: [] };
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('ğŸ¥ MEDICAL: Error loading insurance providers:', error);
                            reject(error);
                        }
                    },
                    templateResult: function(provider) {
                        if (provider.loading) {
                            return provider.text;
                        }
                        
                        // ğŸš€ UX: Enhanced display with description
                        var $result = $(
                            '<div class="provider-option">' +
                            '<div class="provider-name">' + provider.text + '</div>' +
                            (provider.description ? '<div class="provider-description">' + provider.description + '</div>' : '') +
                            '</div>'
                        );
                        
                        return $result;
                    },
                    templateSelection: function(provider) {
                        return provider.text || provider.text;
                    }
                });

                // ğŸš€ PERFORMANCE: Resolve immediately for Select2 initialization
                resolve([]);
            });
        }

        // ğŸš€ PERFORMANCE: Load Insurance Plans with Select2 Remote + Debounce
        function loadInsurancePlans(providerId) {
            console.log('ğŸ¥ MEDICAL: Loading insurance plans for provider:', providerId);

            // ğŸš€ PERFORMANCE: Initialize Select2 with Remote Data + Debounce
            $('#InsurancePlanId').select2({
                placeholder: 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
                                allowClear: true,
                minimumInputLength: 1,
                delay: 300, // ğŸš€ DEBOUNCE: 300ms delay for better performance
                ajax: {
                    url: '@Url.Action("GetInsurancePlans", "InsuranceTariff")',
                    dataType: 'json',
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    data: function(params) {
                        return {
                            providerId: providerId,
                            search: params.term,
                            page: params.page || 1,
                            pageSize: 15 // ğŸš€ PAGING: Server-side paging for performance
                        };
                    },
                    processResults: function(data, params) {
                        console.log('ğŸ¥ MEDICAL: Insurance plans response:', data);
                        
                        if (data.success && data.data && Array.isArray(data.data)) {
                            console.log('ğŸ¥ MEDICAL: Processing insurance plans data:', data.data.length, 'plans');
                            
                            // ğŸš€ PERFORMANCE: Process results for Select2
                            var results = data.data.map(function(item) {
                                return {
                                    id: item.id,
                                    text: item.name,
                                    planCode: item.planCode || '',
                                    coveragePercent: item.coveragePercent || 0
                                };
                            });

                            return {
                                results: results,
                                pagination: {
                                    more: data.hasMore || false
                                }
                            };
                        } else {
                            return { results: [] };
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Error loading insurance plans:', error);
                        $('#InsurancePlanId').html('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</option>');
                    }
                },
                templateResult: function(plan) {
                    if (plan.loading) {
                        return plan.text;
                    }
                    
                    // ğŸš€ UX: Enhanced display with plan details
                    var $result = $(
                        '<div class="plan-option">' +
                        '<div class="plan-name">' + plan.text + '</div>' +
                        (plan.planCode ? '<div class="plan-code">Ú©Ø¯: ' + plan.planCode + '</div>' : '') +
                        (plan.coveragePercent ? '<div class="plan-coverage">Ù¾ÙˆØ´Ø´: ' + plan.coveragePercent + '%</div>' : '') +
                        '</div>'
                    );
                    
                    return $result;
                },
                templateSelection: function(plan) {
                    return plan.text || plan.text;
                }
            });

            // ğŸš€ PERFORMANCE: Load initial data if providerId is provided
            if (providerId) {
                $('#InsurancePlanId').trigger('change');
            }
            
        // ğŸ¥ MEDICAL: Clear Functions
        function clearServiceCategories() {
            $('#ServiceCategoryId').html('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Øª</option>').prop('disabled', false);
        }

        function clearServices() {
            $('#ServiceId').html('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª</option>').prop('disabled', false);
        }

        function clearInsurancePlans() {
            $('#InsurancePlanId').html('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</option>').prop('disabled', false);
        }

        // ğŸ¥ MEDICAL: Form Validation
        function setupFormValidation() {
            $('#insuranceTariffForm').on('submit', function(e) {
                var isValid = true;
                var errors = [];

                // Required field validation
                if (!$('#DepartmentId').val()) {
                    errors.push('Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                if (!$('#ServiceId').val()) {
                    errors.push('Ø®Ø¯Ù…Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                if (!$('#InsuranceProviderId').val()) {
                    errors.push('Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                if (!$('#InsurancePlanId').val()) {
                    errors.push('Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯:\n' + errors.join('\n'));
                }
            });
        }

        // ğŸ¥ MEDICAL: Currency Formatting
        function setupCurrencyFormatting() {
            $('.currency').on('input', function() {
                var value = $(this).val().replace(/[^\d]/g, '');
                if (value) {
                    var formatted = parseInt(value).toLocaleString('fa-IR');
                    $(this).val(formatted);
                }
            });
        }

        // ğŸ¥ MEDICAL: Date Validation
        function setupDateValidation() {
            $('.persian-date').on('blur', function() {
                var date = $(this).val();
                if (date && !isValidPersianDate(date)) {
                    $(this).addClass('error');
                    alert('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù…Ø«Ø§Ù„: 1403/01/01');
                        } else {
                    $(this).removeClass('error');
                    }
                });
            }
            
        function isValidPersianDate(dateString) {
            var pattern = /^\d{4}\/\d{2}\/\d{2}$/;
            return pattern.test(dateString);
        }

        // ğŸ¥ MEDICAL: Form Protection
        function setupFormProtection() {
            var formChanged = false;

            $('input, select, textarea').on('change', function() {
                formChanged = true;
            });

            window.addEventListener('beforeunload', function(e) {
                if (formChanged) {
                    e.preventDefault();
                    e.returnValue = 'ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ';
                }
            });

            $('#insuranceTariffForm').on('submit', function() {
                formChanged = false;
            });
        }

        // ğŸ¥ MEDICAL: Accessibility
        function setupAccessibility() {
            // Add ARIA labels
            $('.medical-form-input, .medical-form-select, .medical-form-textarea').attr('aria-describedby', function() {
                return $(this).attr('id') + '-help';
            });

            // Setup keyboard navigation
            $('.medical-form-input, .medical-form-select, .medical-form-textarea').on('keydown', function(e) {
                if (e.key === 'Enter' && $(this).is('input, select')) {
                    e.preventDefault();
                    var next = $(this).closest('.medical-form-group').next().find('input, select, textarea').first();
                    if (next.length) {
                        next.focus();
                    }
                    }
                });
            }


        // ğŸš€ UX: Progress Indicator Management
        function updateProgress(step) {
            $('.progress-step').each(function() {
                var stepNumber = parseInt($(this).data('step'));
                $(this).removeClass('active completed');

                if (stepNumber < step) {
                    $(this).addClass('completed');
                } else if (stepNumber === step) {
                    $(this).addClass('active');
                }
            });
        }

        // ğŸš€ UX: Form Validation Feedback
        function showFormFeedback(type, message) {
            var feedbackClass = type === 'success' ? 'form-success' : 'form-error';
            var feedbackHtml = '<div class="' + feedbackClass + '">' + message + '</div>';

            // Remove existing feedback
            $('.form-success, .form-error').remove();

            // Add new feedback
            $('.medical-form').prepend(feedbackHtml);

            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.form-success, .form-error').fadeOut(500, function() {
                    $(this).remove();
                });
            }, 5000);
        }

        // ğŸ¥ MEDICAL: Advanced Auto-calculation System
        function setupAutoCalculation() {
            console.log('ğŸ¥ MEDICAL: Setting up advanced auto-calculation system');

            // Real-time calculation triggers - only when both ServiceId and PlanId are available
            $('#ServiceId, #InsurancePlanId, #TariffPrice, #PatientShare, #InsurerShare, #SupplementaryCoveragePercent').on('change input', function() {
                // ğŸš€ UX: Only trigger calculation if both required fields are filled
                var serviceId = $('#ServiceId').val();
                var planId = $('#InsurancePlanId').val();

                // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
                console.log('ğŸ¥ MEDICAL: Field changed - ServiceId:', serviceId, 'PlanId:', planId);

                if (serviceId && planId) {
                    debounceCalculation();
                    updateProgress(2); // Update progress when user interacts
                        } else {
                    console.log('ğŸ¥ MEDICAL: Skipping calculation - missing required fields. ServiceId:', serviceId, 'PlanId:', planId);

                    // ğŸš€ UX: Show helpful message to user
                    if (!serviceId && planId) {
                        showCalculationResult('info', 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    } else if (serviceId && !planId) {
                        showCalculationResult('info', 'Ù„Ø·ÙØ§Ù‹ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    } else if (!serviceId && !planId) {
                        showCalculationResult('info', 'Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ùˆ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    }
                }
            });

            // Manual calculation button
            $('#calculateButton').on('click', function() {
                performCalculation(true);
            });

            // Auto-calculation on form load if data exists
            if ($('#ServiceId').val() && $('#InsurancePlanId').val()) {
                console.log('ğŸ¥ MEDICAL: Auto-calculation triggered on form load');
                setTimeout(function() {
                    performCalculation(false);
                }, 1000);
            }
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Performance: Debounced calculation Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡
        var calculationTimeout;
        var lastCalculationData = null;
        var isCalculating = false;

        function debounceCalculation() {
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(function() {
                // Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ø§Øª ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ
                var currentData = getCurrentFormData();
                if (!isDataChanged(lastCalculationData, currentData)) {
                    console.log('ğŸ¥ MEDICAL: No data changes detected, skipping calculation');
                                return;
                            }

                console.log('ğŸ¥ MEDICAL: Data changes detected, performing calculation');
                performCalculation(false);
                lastCalculationData = currentData;
            }, 300); // Ú©Ø§Ù‡Ø´ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ØªØ±
        }

        // ğŸš€ Helper Functions: Utility Functions Ø¨Ø±Ø§ÛŒ JavaScript
        function generateCorrelationId() {
            return 'calc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function logCalculationError(correlationId, errorType, errorMessage) {
            console.error(`ğŸ¥ MEDICAL: Calculation Error - CorrelationId: ${correlationId}, Type: ${errorType}, Message: ${errorMessage}`);
        }

        function logCalculationSuccess(correlationId, duration, data) {
            console.log(`ğŸ¥ MEDICAL: Calculation Success - CorrelationId: ${correlationId}, Duration: ${duration}ms`, data);
        }

        // ğŸš€ Performance: Memory Usage Monitoring
        function getMemoryUsage() {
            if (performance.memory) {
                return {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576 * 100) / 100,
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576 * 100) / 100,
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576 * 100) / 100
                };
            }
            return null;
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø¨Ø§ Cache Ùˆ Validation
        function getCurrentFormData() {
            const formData = {
                serviceId: $('#ServiceId').val(),
                planId: $('#InsurancePlanId').val(),
                tariffPrice: convertPersianToEnglish($('#TariffPrice').val()),
                patientShare: convertPersianToEnglish($('#PatientShare').val()),
                insurerShare: convertPersianToEnglish($('#InsurerShare').val()),
                supplementaryPercent: $('#SupplementaryCoveragePercent').val(),
                departmentId: $('#DepartmentId').val(),
                serviceCategoryId: $('#ServiceCategoryId').val()
            };

            // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
            console.log('ğŸ¥ MEDICAL: Raw form data:', {
                serviceId: $('#ServiceId').val(),
                planId: $('#InsurancePlanId').val(),
                tariffPrice: $('#TariffPrice').val(),
                patientShare: $('#PatientShare').val(),
                insurerShare: $('#InsurerShare').val(),
                supplementaryPercent: $('#SupplementaryCoveragePercent').val(),
                departmentId: $('#DepartmentId').val(),
                serviceCategoryId: $('#ServiceCategoryId').val()
            });

            // ğŸš€ Validation: Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            if (!formData.serviceId || formData.serviceId === '') {
                console.warn('ğŸ¥ MEDICAL: ServiceId is empty');
            }
            if (!formData.planId || formData.planId === '') {
                console.warn('ğŸ¥ MEDICAL: PlanId is empty');
            }

            return formData;
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Deep Comparison
        function isDataChanged(oldData, newData) {
            if (!oldData) return true;

            // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
            console.log('ğŸ¥ MEDICAL: Data comparison - Old:', oldData, 'New:', newData);

            // ğŸš€ Performance: Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø§ÙˆÙ„
            const keyFields = ['serviceId', 'planId'];
            for (const field of keyFields) {
                if (oldData[field] !== newData[field]) {
                    console.log(`ğŸ¥ MEDICAL: Key field changed - ${field}: ${oldData[field]} -> ${newData[field]}`);
                    return true;
                }
            }

            // ğŸš€ Performance: Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§ØªÛŒ
            const calculationFields = ['tariffPrice', 'patientShare', 'insurerShare', 'supplementaryPercent'];
            for (const field of calculationFields) {
                const oldValue = parseFloat(oldData[field]) || 0;
                const newValue = parseFloat(newData[field]) || 0;
                if (Math.abs(oldValue - newValue) > 0.01) { // tolerance for floating point
                    console.log(`ğŸ¥ MEDICAL: Calculation field changed - ${field}: ${oldValue} -> ${newValue}`);
                    return true;
                }
            }

            return false;
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Main calculation function Ø¨Ø§ Performance Monitoring Ùˆ Error Handling
        function performCalculation(showLoading = true) {
            // ğŸš€ Performance: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù‡Ù…Ø²Ù…Ø§Ù†
            if (isCalculating) {
                console.log('ğŸ¥ MEDICAL: Calculation already in progress, skipping');
                return;
            }

            isCalculating = true;
            const calculationStartTime = performance.now();
            const correlationId = generateCorrelationId();

            // ğŸš€ Performance: Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Validation
            const formData = getCurrentFormData();
            const serviceId = formData.serviceId;
            const planId = formData.planId;
            const currentTariffPrice = parseFloat(formData.tariffPrice) || 0;
            const currentPatientShare = parseFloat(formData.patientShare) || 0;
            const currentInsurerShare = parseFloat(formData.insurerShare) || 0;
            const supplementaryPercent = parseFloat(formData.supplementaryPercent) || 0;

            // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
            console.log('ğŸ¥ MEDICAL: Form data extracted:', {
                serviceId: serviceId,
                planId: planId,
                currentTariffPrice: currentTariffPrice,
                currentPatientShare: currentPatientShare,
                currentInsurerShare: currentInsurerShare,
                supplementaryPercent: supplementaryPercent
            });

            console.log(`ğŸ¥ MEDICAL: Performing calculation - CorrelationId: ${correlationId}, ServiceId: ${serviceId}, PlanId: ${planId}`);

            // ğŸš€ Validation: Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
            if (!serviceId || !planId) {
                const errorMsg = serviceId ? 'Ù„Ø·ÙØ§Ù‹ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' : 'Ù„Ø·ÙØ§Ù‹ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                console.log('ğŸ¥ MEDICAL: Validation failed - ServiceId:', serviceId, 'PlanId:', planId);
                if (showLoading) {
                    showCalculationResult('warning', errorMsg);
                }
                logCalculationError(correlationId, 'Validation Error', errorMsg);
                isCalculating = false;
                return;
            }

            // ğŸš€ UX: Show loading state Ø¨Ø§ Animation
            if (showLoading) {
                $('#calculateButton').addClass('loading').prop('disabled', true);
                showCalculationResult('info', 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...');
            }

            // Prepare calculation data
            var calculationData = {
                serviceId: serviceId,
                insurancePlanId: planId,
                providerId: $('#InsuranceProviderId').val(), // ğŸš€ FIX: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† providerId
                currentTariffPrice: currentTariffPrice,
                currentPatientShare: currentPatientShare,
                currentInsurerShare: currentInsurerShare,
                supplementaryCoveragePercent: supplementaryPercent,
                calculationType: 'comprehensive'
            };

            // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡
            console.log('ğŸ¥ MEDICAL: Calculation data prepared:', calculationData);

            // ğŸ” Debug logging Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù…
            console.log('ğŸ¥ MEDICAL: Form field values:', {
                serviceId: $('#ServiceId').val(),
                planId: $('#InsurancePlanId').val(),
                providerId: $('#InsuranceProviderId').val(),
                tariffPrice: $('#TariffPrice').val(),
                patientShare: $('#PatientShare').val(),
                insurerShare: $('#InsurerShare').val(),
                supplementaryPercent: $('#SupplementaryCoveragePercent').val()
            });

            // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: AJAX Call Ø¨Ø§ Performance Monitoring Ùˆ Enhanced Error Handling
            $.ajax({
                url: '@Url.Action("CalculateAdvancedTariff", "InsuranceTariff")',
                type: 'POST',
                dataType: 'json',
                cache: false,
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                timeout: 15000, // 15 Ø«Ø§Ù†ÛŒÙ‡ timeout
                data: {
                    serviceId: serviceId,
                    insurancePlanId: planId,
                    providerId: $('#InsuranceProviderId').val(),
                    currentTariffPrice: currentTariffPrice,
                    currentPatientShare: currentPatientShare,
                    currentInsurerShare: currentInsurerShare,
                    supplementaryCoveragePercent: supplementaryPercent,
                    calculationType: 'comprehensive',
                    correlationId: correlationId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                beforeSend: function(xhr) {
                    // ğŸš€ Performance: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† correlation ID Ø¨Ù‡ header
                    xhr.setRequestHeader('X-Correlation-ID', correlationId);
                    xhr.setRequestHeader('X-Request-Type', 'TariffCalculation');
                },
                success: function(response) {
                    const calculationDuration = performance.now() - calculationStartTime;
                    const memoryUsage = getMemoryUsage();

                    console.log(`ğŸ¥ MEDICAL: Advanced calculation response - CorrelationId: ${correlationId}, Duration: ${calculationDuration.toFixed(2)}ms`, response);

                    if (response.success && response.data) {
                        updateFormWithCalculatedValues(response.data);
                        showCalculationResult('success', `Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ - ${new Date().toLocaleTimeString('fa-IR')} (${calculationDuration.toFixed(0)}ms)`);
                        showFormFeedback('success', 'Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø±ÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                        updateProgress(3); // Move to next step

                        // ğŸš€ Performance: Log calculation details with enhanced metrics
                        logCalculationDetails(response.data, calculationDuration, memoryUsage);
                        logCalculationSuccess(correlationId, calculationDuration, response.data);
                        } else {
                        const errorMsg = `Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡: ${response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'}`;
                        showCalculationResult('danger', errorMsg);
                        showFormFeedback('error', errorMsg);
                        logCalculationError(correlationId, 'Server Error', response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                        }
                    },
                    error: function(xhr, status, error) {
                    const calculationDuration = performance.now() - calculationStartTime;
                    const memoryUsage = getMemoryUsage();

                    console.error(`ğŸ¥ MEDICAL: Calculation error - CorrelationId: ${correlationId}, Status: ${status}, Error: ${error}, Duration: ${calculationDuration.toFixed(2)}ms`);

                    let errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
                    let errorType = 'Network Error';

                    if (status === 'timeout') {
                        errorMessage = 'Ø²Ù…Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯';
                        errorType = 'Timeout Error';
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ': ' + xhr.responseJSON.message;
                        errorType = 'Server Error';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø±ÙˆØ±';
                        errorType = 'Server Error';
                    } else if (xhr.status === 404) {
                        errorMessage = 'Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                        errorType = 'Not Found Error';
                    } else if (xhr.status === 0) {
                        errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±';
                        errorType = 'Connection Error';
                    }

                    showCalculationResult('danger', errorMessage);
                    showFormFeedback('error', errorMessage);
                    logCalculationError(correlationId, errorType, errorMessage);
                },
                complete: function() {
                    isCalculating = false;
                    if (showLoading) {
                        $('#calculateButton').removeClass('loading').prop('disabled', false);
                    }
                    }
                });
            }
            
        // Update form fields with calculated values
        function updateFormWithCalculatedValues(data) {
            console.log('ğŸ¥ MEDICAL: Updating form with calculated values:', data);

            // Update tariff price if calculated
            if (data.tariffPrice !== undefined && data.tariffPrice !== null) {
                $('#TariffPrice').val(formatCurrency(data.tariffPrice));
                $('#TariffPrice').trigger('change');
            }

            // Update patient share if calculated
            if (data.patientShare !== undefined && data.patientShare !== null) {
                $('#PatientShare').val(formatCurrency(data.patientShare));
                $('#PatientShare').trigger('change');
            }

            // Update insurer share if calculated
            if (data.insurerShare !== undefined && data.insurerShare !== null) {
                $('#InsurerShare').val(formatCurrency(data.insurerShare));
                $('#InsurerShare').trigger('change');
            }

            // Update supplementary coverage if calculated
            if (data.supplementaryCoveragePercent !== undefined && data.supplementaryCoveragePercent !== null) {
                $('#SupplementaryCoveragePercent').val(data.supplementaryCoveragePercent);
                $('#SupplementaryCoveragePercent').trigger('change');
            }

            // Update calculation summary
            updateCalculationSummary(data);
        }

        // Update calculation summary display
        function updateCalculationSummary(data) {
            var summaryHtml = '<div class="calculation-summary">';
            summaryHtml += '<h6>Ø®Ù„Ø§ØµÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡:</h6>';
            summaryHtml += '<ul class="list-unstyled">';

            if (data.tariffPrice) {
                summaryHtml += '<li><strong>Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡:</strong> ' + formatCurrency(data.tariffPrice) + ' ØªÙˆÙ…Ø§Ù†</li>';
            }
            if (data.patientShare) {
                summaryHtml += '<li><strong>Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±:</strong> ' + formatCurrency(data.patientShare) + ' ØªÙˆÙ…Ø§Ù†</li>';
            }
            if (data.insurerShare) {
                summaryHtml += '<li><strong>Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡:</strong> ' + formatCurrency(data.insurerShare) + ' ØªÙˆÙ…Ø§Ù†</li>';
            }
            if (data.supplementaryCoveragePercent) {
                summaryHtml += '<li><strong>Ù¾ÙˆØ´Ø´ ØªÚ©Ù…ÛŒÙ„ÛŒ:</strong> ' + data.supplementaryCoveragePercent + '%</li>';
            }
            if (data.totalCoveragePercent) {
                summaryHtml += '<li><strong>Ù¾ÙˆØ´Ø´ Ú©Ù„:</strong> ' + data.totalCoveragePercent + '%</li>';
            }

            summaryHtml += '</ul>';
            summaryHtml += '</div>';

            $('#calculationSummary').html(summaryHtml);
        }

        // Show calculation result
        function showCalculationResult(type, message) {
            var alertClass = 'alert-' + type;
            var icon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : type === 'danger' ? 'âŒ' : 'â„¹ï¸';

            $('#calculationResult').html('<div class="alert ' + alertClass + '">' + icon + ' ' + message + '</div>');
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Log calculation details Ø¨Ø§ Performance Metrics
        // ğŸš€ Performance: Log calculation details with enhanced metrics
        function logCalculationDetails(data, duration, memoryUsage) {
            const performanceMetrics = {
                timestamp: new Date().toISOString(),
                serviceId: $('#ServiceId').val(),
                insurancePlanId: $('#InsurancePlanId').val(),
                calculatedValues: data,
                user: '@User.Identity.Name',
                performance: {
                    duration: duration ? duration.toFixed(2) + 'ms' : 'N/A',
                    memoryUsage: memoryUsage || (performance.memory ? {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + 'MB'
                    } : 'N/A'),
                    connectionType: navigator.connection ? navigator.connection.effectiveType : 'unknown',
                    userAgent: navigator.userAgent,
                    formData: getCurrentFormData()
                }
            };

            console.log('ğŸ¥ MEDICAL: Calculation Details:', performanceMetrics);

            // ğŸš€ REAL-TIME: No localStorage caching - always fresh data

            // ğŸš€ Performance: Ø§Ø±Ø³Ø§Ù„ Performance Metrics Ø¨Ù‡ Server (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            if (duration && duration > 1000) { // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ú©Ù†Ø¯
                sendPerformanceMetrics(performanceMetrics);
            }
        }

        // ğŸš€ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø±Ø³Ø§Ù„ Performance Metrics
        function sendPerformanceMetrics(metrics) {
            $.ajax({
                url: '@Url.Action("LogPerformanceMetrics", "InsuranceTariff")',
                type: 'POST',
                data: {
                    metrics: JSON.stringify(metrics),
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                timeout: 5000,
                success: function() {
                    console.log('ğŸ¥ MEDICAL: Performance metrics logged successfully');
                },
                error: function() {
                    console.warn('ğŸ¥ MEDICAL: Failed to log performance metrics');
                }
            });
        }

        // ğŸš€ FIX: Safe Select2 initialization
        function safeSelect2Init(selector, options) {
            try {
                // Destroy existing Select2 if present
                if ($(selector).hasClass('select2-hidden-accessible')) {
                    $(selector).select2('destroy');
                }
                
                // Initialize Select2 with error handling
                $(selector).select2(options);
                console.log('ğŸš€ FIX: Select2 initialized successfully for:', selector);
            } catch (error) {
                console.error('ğŸš€ FIX: Error initializing Select2 for', selector, ':', error);
                // Fallback to regular select
                $(selector).removeClass('select2-hidden-accessible');
            }
        }

        // ğŸš€ FIX: Single formatCurrency function (removed duplicate)
        // Note: formatCurrency is already defined above, this duplicate is removed

        // ğŸš€ TESTING: Form Testing Functions
        function runFormTests() {
            console.log('ğŸ§ª TESTING: Starting form tests...');

            // Test 1: Form Initialization
            testFormInitialization();

            // Test 2: Cascading Dropdowns
            testCascadingDropdowns();

            // Test 3: Auto-calculation
            testAutoCalculation();

            // Test 4: Form Validation
            testFormValidation();

            // Test 5: UX Features
            testUXFeatures();

            console.log('ğŸ§ª TESTING: All tests completed');
        }

        function testFormInitialization() {
            console.log('ğŸ§ª TESTING: Form Initialization');

            // Check if all required elements exist
            var requiredElements = [
                '#DepartmentId', '#ServiceCategoryId', '#ServiceId',
                '#InsuranceProviderId', '#InsurancePlanId',
                '#TariffPrice', '#PatientShare', '#InsurerShare'
            ];

            requiredElements.forEach(function(selector) {
                if ($(selector).length === 0) {
                    console.error('âŒ TEST FAILED: Element not found:', selector);
                } else {
                    console.log('âœ… TEST PASSED: Element found:', selector);
                }
            });
        }

        function testCascadingDropdowns() {
            console.log('ğŸ§ª TESTING: Cascading Dropdowns');

            // Test department selection
            if ($('#DepartmentId').length > 0) {
                console.log('âœ… TEST PASSED: Department dropdown exists');
                        } else {
                console.error('âŒ TEST FAILED: Department dropdown not found');
            }
        }

        function testAutoCalculation() {
            console.log('ğŸ§ª TESTING: Auto-calculation');

            // Test calculation button
            if ($('#calculateButton').length > 0) {
                console.log('âœ… TEST PASSED: Calculate button exists');
            } else {
                console.error('âŒ TEST FAILED: Calculate button not found');
            }
        }

        function testFormValidation() {
            console.log('ğŸ§ª TESTING: Form Validation');

            // Test required fields
            var requiredFields = ['#DepartmentId', '#ServiceId', '#InsuranceProviderId', '#InsurancePlanId'];

            requiredFields.forEach(function(selector) {
                var field = $(selector);
                if (field.length > 0) {
                    console.log('âœ… TEST PASSED: Required field exists:', selector);
                } else {
                    console.error('âŒ TEST FAILED: Required field not found:', selector);
                }
            });
        }

        function testUXFeatures() {
            console.log('ğŸ§ª TESTING: UX Features');

            // Test loading overlay (removed - no longer needed)
            console.log('âœ… TEST PASSED: Loading overlay test skipped (feature removed)');

            // Test progress indicator
            if ($('.progress-indicator').length > 0) {
                console.log('âœ… TEST PASSED: Progress indicator exists');
            } else {
                console.error('âŒ TEST FAILED: Progress indicator not found');
            }
        }

        // ğŸš€ Performance: Parallel loading of initial data
        function loadInitialDataParallel() {
            console.log('ğŸš€ PERFORMANCE: Starting parallel data loading...');
            const startTime = performance.now();

            // Load all initial data in parallel
            const promises = [
                loadInsuranceProviders(),
                loadDepartments()
            ];

            Promise.all(promises)
                .then(function(results) {
                    const duration = performance.now() - startTime;
                    console.log(`ğŸš€ PERFORMANCE: Parallel loading completed in ${duration.toFixed(2)}ms`);

                    // ğŸš€ CACHING: Populate dropdowns with loaded data
                    if (results[0]) { // Insurance Providers
                        populateDropdown('#InsuranceProviderId', results[0], 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡');
                    }
                    if (results[1]) { // Departments
                        populateDropdown('#DepartmentId', results[1], 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†');
                    }

                    // Initialize other components after data is loaded
                    setupCascadingDropdowns();
                    setupAutoCalculation();
                    setupFormValidation();
                    setupAccessibility();

                    // ğŸš€ TESTING: Run tests in development mode
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        setTimeout(function() {
                            runFormTests();
                        }, 1000);
                    }
                })
                .catch(function(error) {
                    console.error('ğŸš€ PERFORMANCE: Error in parallel loading:', error);
                    // Fallback to sequential loading
                    loadInsuranceProviders();
                    loadDepartments();
                });
        }

        // ğŸš€ Performance: Load departments in parallel with caching
        function loadDepartments() {
            return new Promise(function(resolve, reject) {
                // ğŸš€ REAL-TIME: No cache - always fetch fresh data

                // ğŸš€ PERFORMANCE: Fetch fresh data
                $.ajax({
                    url: '@Url.Action("GetDepartments", "Department")',
                    type: 'GET',
                    dataType: 'json',
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    success: function(response) {
                        if (response && response.success && response.data) {
                            console.log('ğŸš€ PERFORMANCE: Departments loaded successfully');

                            // ğŸš€ REAL-TIME: No caching - data is always fresh

                            resolve(response.data);
                        } else {
                            console.warn('ğŸš€ PERFORMANCE: No departments data received');
                            resolve([]);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸš€ PERFORMANCE: Error loading departments:', error);
                        reject(error);
                    }
                });
            });
        }

        // ğŸš€ REAL-TIME: Helper function to populate dropdown with fresh data
        function populateDropdown(selector, data, defaultText) {
            if (data && Array.isArray(data) && data.length > 0) {
                var options = '<option value="">' + defaultText + '</option>';
                data.forEach(function(item) {
                    options += '<option value="' + item.Value + '">' + item.Text + '</option>';
                });
                $(selector).html(options).prop('disabled', false);
                console.log('ğŸš€ REAL-TIME: Dropdown populated with fresh data:', selector);
            } else {
                $(selector).html('<option value="">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>').prop('disabled', false);
            }
        }

        // ğŸš€ FIX: Setup Persian number conversion for currency fields
        function setupPersianNumberConversion() {
            $('[data_persian_numbers="true"]').on('input keyup paste', function() {
                var $this = $(this);
                var value = $this.val();
                if (value) {
                    // Convert Persian numbers to English in real-time
                    var englishValue = convertPersianToEnglish(value);
                    // Only update if the value actually changed
                    if (englishValue !== value) {
                        $this.val(englishValue);
                    }
                    $this.data('english-value', englishValue);
                }
            });

            // Convert to English before form submission
            $('form').on('submit', function() {
                $('[data_persian_numbers="true"]').each(function() {
                    var $this = $(this);
                    var persianValue = $this.val();
                    if (persianValue) {
                        var englishValue = convertPersianToEnglish(persianValue);
                        $this.val(englishValue);
                    }
                });
            });
        }

        // ğŸš€ FIX: Allow all number input including Persian numbers
        function setupNumberInputHandling() {
            // Remove any existing keypress handlers to avoid conflicts
            $('[data_persian_numbers="true"]').off('keypress');

            // Allow all input and let the conversion handle it
            $('[data_persian_numbers="true"]').on('keypress', function(e) {
                // Allow all keys - let the conversion function handle the rest
                return true;
            });
        }


        // ğŸš€ FIX: Convert Persian numbers to English for validation
        function convertPersianToEnglish(str) {
            if (!str) return str;
            return str.toString()
                .replace(/[Û°-Û¹]/g, function(d) { return 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d); })
                .replace(/[Ù -Ù©]/g, function(d) { return 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d); })
                .replace(/[,\s]/g, ''); // Remove commas and spaces
        }

        // ğŸš€ FIX: Format currency for display
        function formatCurrency(value) {
            if (!value || isNaN(value)) return '';
            var num = parseFloat(value);
            return num.toLocaleString('fa-IR');
        }

        // ğŸš€ FIX: Parse currency from display format
        function parseCurrency(value) {
            if (!value) return 0;
            var cleanValue = convertPersianToEnglish(value.toString().replace(/[,\s]/g, ''));
            return parseFloat(cleanValue) || 0;
        }

        // ğŸš€ LAZY LOADING: Virtual scrolling for large lists
        function setupVirtualScrolling(selector, data, pageSize = 50) {
            let currentPage = 0;
            const totalPages = Math.ceil(data.length / pageSize);

            function renderPage(page) {
                const start = page * pageSize;
                const end = Math.min(start + pageSize, data.length);
                const pageData = data.slice(start, end);

                let options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª</option>';
                pageData.forEach(function(item) {
                    options += '<option value="' + item.Value + '">' + item.Text + '</option>';
                });

                $(selector).html(options);

                // Add "Load More" option if not last page
                if (page < totalPages - 1) {
                    $(selector).append('<option value="load_more" disabled>--- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± ---</option>');
                }
            }

            // Initial render
            renderPage(0);

            // Handle "Load More" click
            $(selector).on('change', function() {
                if ($(this).val() === 'load_more') {
                    currentPage++;
                    if (currentPage < totalPages) {
                        renderPage(currentPage);
                    }
                }
            });

            console.log('ğŸš€ LAZY LOADING: Virtual scrolling setup for', selector, 'with', data.length, 'items');
        }

        // ğŸ¥ MEDICAL: Initialize form with testing
        $(document).ready(function() {
            console.log('ğŸ¥ MEDICAL: Initializing Insurance Tariff Create Form');

            // ğŸš€ FIX: Prevent multiple initializations
            if (window.tariffFormInitialized) {
                console.log('ğŸ¥ MEDICAL: Form already initialized, skipping...');
                return;
            }
            window.tariffFormInitialized = true;

            // ğŸš€ Performance: Use parallel loading instead of sequential
            loadInitialDataParallel();
        });
    </script>
}
