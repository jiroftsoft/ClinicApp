@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffIndexPageViewModel
@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-money-bill-wave text-primary"></i>
                        Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                    </h1>
                    <p class="text-muted mb-0">Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø®Ø¯Ù…Ø§Øª Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</p>
                </div>
                <div>
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TotalTariffs</h3>
                                    <p class="card-text">Ú©Ù„ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</p>
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomPrice</h3>
                                    <p class="card-text">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ù‚ÛŒÙ…Øª Ø®Ø§Øµ</p>
                                    <i class="fas fa-tag fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomPatientShare</h3>
                                    <p class="card-text">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± Ø®Ø§Øµ</p>
                                    <i class="fas fa-user fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomInsurerShare</h3>
                                    <p class="card-text">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ Ø®Ø§Øµ</p>
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i>
                        ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="post" action="@Url.Action("LoadTariffs")">
                        @Html.AntiForgeryToken()
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SearchTerm">Ø¬Ø³ØªØ¬Ùˆ</label>
                                    <input type="text" id="SearchTerm" name="SearchTerm" class="form-control" 
                                           value="@Model.Filter.SearchTerm" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø®Ø¯Ù…Ø§ØªØŒ Ø·Ø±Ø­â€ŒÙ‡Ø§...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="ProviderId">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡</label>
                                    @Html.DropDownList("InsuranceProviderId", Model.Filter.InsuranceProviderSelectList, 
                                        "Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="PlanId">Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</label>
                                    @Html.DropDownList("InsurancePlanId", Model.Filter.InsurancePlanSelectList, 
                                        "Ù‡Ù…Ù‡ Ø·Ø±Ø­â€ŒÙ‡Ø§", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="ServiceId">Ø®Ø¯Ù…Øª</label>
                                    @Html.DropDownList("ServiceId", Model.Filter.ServiceSelectList, 
                                        "Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª", new { @class = "form-control" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    Ø¬Ø³ØªØ¬Ùˆ
                                </button>
                                <button type="button" id="clearFilter" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i>
                        Ù„ÛŒØ³Øª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                    </h5>
                </div>
                <div class="card-body">
                    <div id="tariffsList">
                        @Html.Partial("_InsuranceTariffListPartial", Model.Tariffs)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filter form submission
            $('#filterForm').on('submit', function(e) {
                e.preventDefault();
                loadTariffs();
            });

            // Clear filter
            $('#clearFilter').on('click', function() {
                $('#filterForm')[0].reset();
                loadTariffs();
            });

            // Load tariffs function
            function loadTariffs() {
                console.log('ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§...');
                var formData = $('#filterForm').serialize();
                console.log('ğŸ“‹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…:', formData);
                
                $.ajax({
                    url: '@Url.Action("LoadTariffs")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        console.log('ğŸ“Š Ù¾Ø§Ø³Ø® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§:', response);
                        $('#tariffsList').html(response);
                        console.log('âœ… ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù†Ø¯');
                        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
                        updateFilterDropdowns();
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù„ÛŒØ³Øª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡');
                    }
                });
            }

            // Update filter dropdowns
            function updateFilterDropdowns() {
                console.log('ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§...');
                
                // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡
                $.ajax({
                    url: '@Url.Action("GetInsuranceProviders")',
                    type: 'GET',
                    cache: false,
                    success: function(response) {
                        console.log('ğŸ“Š Ù¾Ø§Ø³Ø® Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡:', response);
                        console.log('ğŸ” response.success:', response.success, 'type:', typeof response.success);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response - Ù…Ù…Ú©Ù† Ø§Ø³Øª response string Ø¨Ø§Ø´Ø¯
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('ğŸ” parsed data:', data);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // Ø­Ø°Ù Select2 Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                            if ($('#InsuranceProviderId').hasClass('select2-hidden-accessible')) {
                                $('#InsuranceProviderId').select2('destroy');
                            }
                            
                            $('#InsuranceProviderId').html(options);
                            
                            // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Select2
                            $('#InsuranceProviderId').select2({
                                placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('âœ… Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù†Ø¯:', data.data.length, 'Ù…ÙˆØ±Ø¯');
                        } else {
                            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡ - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });

                // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                $.ajax({
                    url: '@Url.Action("GetInsurancePlans")',
                    type: 'GET',
                    cache: false,
                    success: function(response) {
                        console.log('ğŸ“Š Ù¾Ø§Ø³Ø® Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡:', response);
                        console.log('ğŸ” response.success:', response.success, 'type:', typeof response.success);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response - Ù…Ù…Ú©Ù† Ø§Ø³Øª response string Ø¨Ø§Ø´Ø¯
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('ğŸ” parsed data:', data);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">Ù‡Ù…Ù‡ Ø·Ø±Ø­â€ŒÙ‡Ø§</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // Ø­Ø°Ù Select2 Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                            if ($('#InsurancePlanId').hasClass('select2-hidden-accessible')) {
                                $('#InsurancePlanId').select2('destroy');
                            }
                            
                            $('#InsurancePlanId').html(options);
                            
                            // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Select2
                            $('#InsurancePlanId').select2({
                                placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('âœ… Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù†Ø¯:', data.data.length, 'Ù…ÙˆØ±Ø¯');
                        } else {
                            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });

                // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø®Ø¯Ù…Ø§Øª
                $.ajax({
                    url: '@Url.Action("GetServices")',
                    type: 'GET',
                    data: { serviceCategoryId: 0 },
                    cache: false,
                    success: function(response) {
                        console.log('ğŸ“Š Ù¾Ø§Ø³Ø® Ø®Ø¯Ù…Ø§Øª:', response);
                        console.log('ğŸ” response.success:', response.success, 'type:', typeof response.success);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response - Ù…Ù…Ú©Ù† Ø§Ø³Øª response string Ø¨Ø§Ø´Ø¯
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('ğŸ” parsed data:', data);
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // Ø­Ø°Ù Select2 Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                            if ($('#ServiceId').hasClass('select2-hidden-accessible')) {
                                $('#ServiceId').select2('destroy');
                            }
                            
                            $('#ServiceId').html(options);
                            
                            // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Select2
                            $('#ServiceId').select2({
                                placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('âœ… Ø®Ø¯Ù…Ø§Øª Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù†Ø¯:', data.data.length, 'Ù…ÙˆØ±Ø¯');
                        } else {
                            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø®Ø¯Ù…Ø§Øª - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø®Ø¯Ù…Ø§Øª:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });
            }

            // Initialize filters and load data on page load
            updateFilterDropdowns();
            loadTariffs();
        });
    </script>
}
