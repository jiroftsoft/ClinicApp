@using ClinicApp.Models.Entities.Insurance
@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffIndexPageViewModel
@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@* ğŸ”§ CRITICAL FIX: Helper Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÙˆÙ„ *@
@helper Rial(object value) {
    @($"{value ?? 0:N0} Ø±ÛŒØ§Ù„")
}

<!-- ğŸš€ SEO: Meta Tags -->
@section MetaTags {
    <meta name="description" content="Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ - Ø³ÛŒØ³ØªÙ… Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§" />
    <meta name="keywords" content="ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡, Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡, Ú©Ù„ÛŒÙ†ÛŒÚ©, Ø¨ÛŒÙ…Ù‡" />
    <meta name="robots" content="noindex, nofollow" />
}

@section Styles {
    <style>
        /* ğŸ¥ MEDICAL: Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ù…Ø§Ù†ÛŒ */
        .medical-card {
            border: 1px solid #e3f2fd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .medical-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .medical-header {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 20px;
        }
        
        .medical-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        .medical-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .medical-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            border: none;
            padding: 16px;
        }
        
        .medical-table td {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .medical-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medical-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .medical-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .medical-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-edit {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .medical-filter {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .medical-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #1976d2;
        }
        
        .pagination-btn.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }
        
        .medical-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .medical-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .medical-empty i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 16px;
        }
    </style>
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-2">
                            <i class="fas fa-money-bill-wave"></i>
                            Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                        </h1>
                        <p class="mb-0 opacity-75">Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø®Ø¯Ù…Ø§Øª Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</p>
                    </div>
                    <div>
                        <a href="@Url.Action("Create", new { 
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId
                        })" class="btn btn-light">
                            <i class="fas fa-plus"></i>
                            ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-stats">
                <h5 class="mb-3">
                    <i class="fas fa-chart-bar text-primary"></i>
                    Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="total">@Model.Statistics.TotalTariffs</div>
                            <div class="stat-label">Ú©Ù„ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="active">@Model.Statistics.ActiveTariffs</div>
                            <div class="stat-label">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="inactive">@Model.Statistics.InactiveTariffs</div>
                            <div class="stat-label">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="services">@Model.Statistics.TotalServices</div>
                            <div class="stat-label">Ø®Ø¯Ù…Ø§Øª ØªØ­Øª Ù¾ÙˆØ´Ø´</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-filter">
                <h5 class="mb-3">
                    <i class="fas fa-filter text-primary"></i>
                    ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ
                </h5>
                @using (Html.BeginForm("Index", "InsuranceTariff", FormMethod.Get, new { @class = "row g-3" }))
                {
                    <div class="col-md-3">
                        <label class="form-label">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</label>
                        @Html.DropDownListFor(m => m.Filter.DepartmentId, Model.Filter.Departments, "Ù‡Ù…Ù‡ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§", new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡</label>
                        @if (Model.Filter.InsuranceProviders != null && Model.Filter.InsuranceProviders.Any())
                        {
                            @Html.DropDownListFor(m => m.Filter.InsuranceProviderId, Model.Filter.InsuranceProviders, "Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†", new { @class = "form-select" })
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> 
                                @Model.Filter.InsuranceProviders.Count() Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯
                            </small>
                        }
                        else
                        {
                            <select class="form-select" disabled>
                                <option>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...</option>
                            </select>
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù‡Ø³ØªÙ†Ø¯
                            </small>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                    <i class="fas fa-sync-alt"></i> ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="loadInsuranceProviders()">
                                    <i class="fas fa-download"></i> Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ø³ØªÛŒ
                                </button>
                            </div>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡</label>
                        @Html.DropDownListFor(m => m.Filter.InsuranceType, new SelectList(new object[]
                        {
                            new { Value = "", Text = "Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹" },
                            new { Value = (int)InsuranceType.Primary, Text = "Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡" },
                            new { Value = (int)InsuranceType.Supplementary, Text = "Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }
                        }, "Value", "Text"), new { @class = "form-select" })
                        <small class="text-info">
                            <i class="fas fa-info-circle"></i> 
                            Ù‡Ù…Ù‡ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ (Ù¾Ø§ÛŒÙ‡ Ùˆ ØªÚ©Ù…ÛŒÙ„ÛŒ) Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                        </small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ÙˆØ¶Ø¹ÛŒØª</label>
                        @Html.DropDownListFor(m => m.Filter.IsActive, new SelectList(new[]
                        {
                            new { Value = "", Text = "Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§" },
                            new { Value = "true", Text = "ÙØ¹Ø§Ù„" },
                            new { Value = "false", Text = "ØºÛŒØ±ÙØ¹Ø§Ù„" }
                        }, "Value", "Text"), new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø¬Ø³ØªØ¬Ùˆ</label>
                        <div class="input-group">
                            @Html.TextBoxFor(m => m.Filter.SearchTerm, new { @class = "form-control", placeholder = "Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§..." })
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                Ø±ÛŒØ³Øª ÙÛŒÙ„ØªØ±Ù‡Ø§
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Tariffs Table -->
    <div class="row">
        <div class="col-12">
            <div class="medical-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Ø®Ø¯Ù…Øª</th>
                            <th scope="col">Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</th>
                            <th scope="col">Ù‚ÛŒÙ…Øª ØªØ¹Ø±ÙÙ‡</th>
                            <th scope="col">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±</th>
                            <th scope="col">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡</th>
                            <th scope="col">ÙˆØ¶Ø¹ÛŒØª</th>
                            <th scope="col">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                            <th scope="col">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Tariffs.Any())
                        {
                            foreach (var tariff in Model.Tariffs)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong>@tariff.ServiceName</strong>
                                            @if (!string.IsNullOrEmpty(tariff.ServiceCategoryName))
                                            {
                                                <br><small class="text-muted">@tariff.ServiceCategoryName</small>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@tariff.InsurancePlanName</strong>
                                            <br><small class="text-muted">@tariff.InsuranceProviderName</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-primary">@Rial(tariff.TariffPrice)</span>
                                    </td>
                                    <td>
                                        <span class="text-success">@Rial(tariff.PatientShare)</span>
                                    </td>
                                    <td>
                                        <span class="text-info">@Rial(tariff.InsurerShare)</span>
                                    </td>
                                    <td>
                                        <span class="status-badge @(tariff.IsActive ? "status-active" : "status-inactive")" 
                                              role="status" 
                                              aria-label="ÙˆØ¶Ø¹ÛŒØª: @(tariff.IsActive ? "ÙØ¹Ø§Ù„" : "ØºÛŒØ±ÙØ¹Ø§Ù„")">
                                            @(tariff.IsActive ? "ÙØ¹Ø§Ù„" : "ØºÛŒØ±ÙØ¹Ø§Ù„")
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@tariff.CreatedAt.ToString("yyyy/MM/dd")</small>
                                    </td>
                                    <td>
                                        <div class="medical-actions">
                                            <a href="@Url.Action("Details", new { id = tariff.InsuranceTariffId })" class="medical-btn btn-view">
                                                <i class="fas fa-eye"></i>
                                                Ù…Ø´Ø§Ù‡Ø¯Ù‡
                                            </a>
                                            <a href="@Url.Action("Edit", new { id = tariff.InsuranceTariffId })" class="medical-btn btn-edit">
                                                <i class="fas fa-edit"></i>
                                                ÙˆÛŒØ±Ø§ÛŒØ´
                                            </a>
                                            @using (Html.BeginForm("Delete", "InsuranceTariff", FormMethod.Post, new { @class = "d-inline" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("id", tariff.InsuranceTariffId)
                                                <button type="submit" class="medical-btn btn-delete" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ØªØ¹Ø±ÙÙ‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ');">
                                                    <i class="fas fa-trash"></i>
                                                    Ø­Ø°Ù
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="medical-empty">
                                    <i class="fas fa-inbox"></i>
                                    <h5>Ù‡ÛŒÚ† ØªØ¹Ø±ÙÙ‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h5>
                                    <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.</p>
                                    <a href="@Url.Action("Create")" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (Model.Tariffs.Any() && Model.Pagination.TotalPages > 1)
    {
        <div class="row">
            <div class="col-12">
                <div class="medical-pagination">
                    @if (Model.Pagination.HasPreviousPage)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = Model.Pagination.PageNumber - 1,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                            Ù‚Ø¨Ù„ÛŒ
                        </a>
                    }
                    
                    @for (int i = 1; i <= Model.Pagination.TotalPages; i++)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = i,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn @(i == Model.Pagination.PageNumber ? "active" : "")">
                            @i
                        </a>
                    }
                    
                    @if (Model.Pagination.HasNextPage)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = Model.Pagination.PageNumber + 1,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn">
                            Ø¨Ø¹Ø¯ÛŒ
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('ğŸ¥ MEDICAL: Insurance Tariff Index page loaded');
            
            // ğŸ”§ CRITICAL FIX: Ú©Ø§Ù‡Ø´ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ
            $('.medical-table tbody').css('opacity', '0').animate({ opacity: 1 }, 200);
            
            // ğŸš€ UX: Enhanced interactions
            $('.medical-btn').hover(
                function() { $(this).addClass('shadow-sm'); },
                function() { $(this).removeClass('shadow-sm'); }
            );
            
            // ğŸ”§ CRITICAL FIX: Auto-refresh statistics with semantic keys
            var statsTimer;
            function loadStats() {
                $.get('@Url.Action("GetStatistics")', function(data) {
                    if (data && data.success && data.data) {
                        $('[data-stat="total"]').text(data.data.totalTariffs || 0);
                        $('[data-stat="active"]').text(data.data.activeTariffs || 0);
                        $('[data-stat="inactive"]').text(data.data.inactiveTariffs || 0);
                        $('[data-stat="services"]').text(data.data.totalServices || 0);
                    }
                }).fail(function(xhr, status, error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¢Ù…Ø§Ø±:', error);
                });
            }
            
            // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø±
            statsTimer = setInterval(loadStats, 30000);
            
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ØªØ§ÛŒÙ…Ø± Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡
            $(window).on('beforeunload', function() {
                if (statsTimer) clearInterval(statsTimer);
            });
            
            // ğŸš€ CRITICAL FIX: Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨ÛŒÙ…Ù‡
            window.loadInsuranceProviders = function() {
                var $providerSelect = $('select[name="Filter.InsuranceProviderId"]');
                var $loadingText = $providerSelect.siblings('small');
                
                $loadingText.html('<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...');
                
                $.ajax({
                    url: '@Url.Action("GetInsuranceProviders", "InsuranceTariff")',
                    type: 'GET',
                    data: { search: '', page: 1, pageSize: 100 },
                    success: function(response) {
                        if (response.success && response.data && response.data.length > 0) {
                            $providerSelect.empty();
                            $providerSelect.append('<option value="">Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†</option>');
                            
                            $.each(response.data, function(index, item) {
                                $providerSelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                            });
                            
                            $providerSelect.prop('disabled', false);
                            $loadingText.html('<i class="fas fa-check-circle text-success"></i> ' + response.data.length + ' Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯');
                            
                            // Hide retry buttons
                            $providerSelect.siblings('.mt-2').hide();
                        } else {
                            $loadingText.html('<i class="fas fa-exclamation-triangle text-danger"></i> Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†');
                        }
                    },
                    error: function(xhr, status, error) {
                        $loadingText.html('<i class="fas fa-exclamation-triangle text-danger"></i> Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ: ' + error);
                    }
                });
            };
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            loadStats();
        });
    </script>
}
