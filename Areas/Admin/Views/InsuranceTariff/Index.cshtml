@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffIndexPageViewModel
@{
    ViewBag.Title = "مدیریت تعرفه‌های بیمه";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-money-bill-wave text-primary"></i>
                        مدیریت تعرفه‌های بیمه
                    </h1>
                    <p class="text-muted mb-0">مدیریت تعرفه‌های خاص خدمات برای طرح‌های بیمه</p>
                </div>
                <div>
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        تعرفه جدید
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i>
                        آمار کلی
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TotalTariffs</h3>
                                    <p class="card-text">کل تعرفه‌های بیمه</p>
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomPrice</h3>
                                    <p class="card-text">تعرفه‌های با قیمت خاص</p>
                                    <i class="fas fa-tag fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomPatientShare</h3>
                                    <p class="card-text">تعرفه‌های با سهم بیمار خاص</p>
                                    <i class="fas fa-user fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 class="card-title">@Model.Statistics.TariffsWithCustomInsurerShare</h3>
                                    <p class="card-text">تعرفه‌های با سهم بیمه خاص</p>
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i>
                        فیلتر و جستجو
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="post" action="@Url.Action("LoadTariffs")">
                        @Html.AntiForgeryToken()
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SearchTerm">جستجو</label>
                                    <input type="text" id="SearchTerm" name="SearchTerm" class="form-control" 
                                           value="@Model.Filter.SearchTerm" placeholder="جستجو در خدمات، طرح‌ها...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="ProviderId">ارائه‌دهنده بیمه</label>
                                    @Html.DropDownList("InsuranceProviderId", Model.Filter.InsuranceProviderSelectList, 
                                        "همه ارائه‌دهندگان", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="PlanId">طرح بیمه</label>
                                    @Html.DropDownList("InsurancePlanId", Model.Filter.InsurancePlanSelectList, 
                                        "همه طرح‌ها", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="ServiceId">خدمت</label>
                                    @Html.DropDownList("ServiceId", Model.Filter.ServiceSelectList, 
                                        "همه خدمات", new { @class = "form-control" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    جستجو
                                </button>
                                <button type="button" id="clearFilter" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    پاک کردن
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i>
                        لیست تعرفه‌های بیمه
                    </h5>
                </div>
                <div class="card-body">
                    <div id="tariffsList">
                        @Html.Partial("_InsuranceTariffListPartial", Model.Tariffs)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filter form submission
            $('#filterForm').on('submit', function(e) {
                e.preventDefault();
                loadTariffs();
            });

            // Clear filter
            $('#clearFilter').on('click', function() {
                $('#filterForm')[0].reset();
                loadTariffs();
            });

            // Load tariffs function
            function loadTariffs() {
                console.log('🔄 شروع بارگیری تعرفه‌ها...');
                var formData = $('#filterForm').serialize();
                console.log('📋 داده‌های فرم:', formData);
                
                $.ajax({
                    url: '@Url.Action("LoadTariffs")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        console.log('📊 پاسخ بارگیری تعرفه‌ها:', response);
                        $('#tariffsList').html(response);
                        console.log('✅ تعرفه‌ها بارگیری شدند');
                        // به‌روزرسانی فیلترها
                        updateFilterDropdowns();
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ خطای AJAX در بارگیری تعرفه‌ها:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        alert('خطا در بارگیری لیست تعرفه‌های بیمه');
                    }
                });
            }

            // Update filter dropdowns
            function updateFilterDropdowns() {
                console.log('🔄 شروع بارگیری فیلترها...');
                
                // بارگیری ارائه‌دهندگان بیمه
                $.ajax({
                    url: '@Url.Action("GetInsuranceProviders")',
                    type: 'GET',
                    cache: false,
                    success: function(response) {
                        console.log('📊 پاسخ ارائه‌دهندگان بیمه:', response);
                        console.log('🔍 response.success:', response.success, 'type:', typeof response.success);
                        
                        // بررسی دقیق response - ممکن است response string باشد
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('❌ خطا در parse کردن JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('🔍 parsed data:', data);
                        
                        // بررسی دقیق response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">همه ارائه‌دهندگان</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // حذف Select2 قبلی اگر وجود دارد
                            if ($('#InsuranceProviderId').hasClass('select2-hidden-accessible')) {
                                $('#InsuranceProviderId').select2('destroy');
                            }
                            
                            $('#InsuranceProviderId').html(options);
                            
                            // فعال‌سازی Select2
                            $('#InsuranceProviderId').select2({
                                placeholder: 'انتخاب ارائه‌دهنده بیمه',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('✅ ارائه‌دهندگان بیمه بارگیری شدند:', data.data.length, 'مورد');
                        } else {
                            console.error('❌ خطا در بارگیری ارائه‌دهندگان بیمه - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ خطای AJAX در بارگیری ارائه‌دهندگان بیمه:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });

                // بارگیری طرح‌های بیمه
                $.ajax({
                    url: '@Url.Action("GetInsurancePlans")',
                    type: 'GET',
                    cache: false,
                    success: function(response) {
                        console.log('📊 پاسخ طرح‌های بیمه:', response);
                        console.log('🔍 response.success:', response.success, 'type:', typeof response.success);
                        
                        // بررسی دقیق response - ممکن است response string باشد
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('❌ خطا در parse کردن JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('🔍 parsed data:', data);
                        
                        // بررسی دقیق response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">همه طرح‌ها</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // حذف Select2 قبلی اگر وجود دارد
                            if ($('#InsurancePlanId').hasClass('select2-hidden-accessible')) {
                                $('#InsurancePlanId').select2('destroy');
                            }
                            
                            $('#InsurancePlanId').html(options);
                            
                            // فعال‌سازی Select2
                            $('#InsurancePlanId').select2({
                                placeholder: 'انتخاب طرح بیمه',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('✅ طرح‌های بیمه بارگیری شدند:', data.data.length, 'مورد');
                        } else {
                            console.error('❌ خطا در بارگیری طرح‌های بیمه - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ خطای AJAX در بارگیری طرح‌های بیمه:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });

                // بارگیری خدمات
                $.ajax({
                    url: '@Url.Action("GetServices")',
                    type: 'GET',
                    data: { serviceCategoryId: 0 },
                    cache: false,
                    success: function(response) {
                        console.log('📊 پاسخ خدمات:', response);
                        console.log('🔍 response.success:', response.success, 'type:', typeof response.success);
                        
                        // بررسی دقیق response - ممکن است response string باشد
                        var data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('❌ خطا در parse کردن JSON:', e);
                                return;
                            }
                        }
                        
                        console.log('🔍 parsed data:', data);
                        
                        // بررسی دقیق response
                        if (data && data.success === true && data.data) {
                            var options = '<option value="">همه خدمات</option>';
                            $.each(data.data, function(index, item) {
                                options += '<option value="' + item.id + '">' + item.name + '</option>';
                            });
                            
                            // حذف Select2 قبلی اگر وجود دارد
                            if ($('#ServiceId').hasClass('select2-hidden-accessible')) {
                                $('#ServiceId').select2('destroy');
                            }
                            
                            $('#ServiceId').html(options);
                            
                            // فعال‌سازی Select2
                            $('#ServiceId').select2({
                                placeholder: 'انتخاب خدمت',
                                allowClear: true,
                                dir: 'rtl',
                                width: '100%'
                            });
                            
                            console.log('✅ خدمات بارگیری شدند:', data.data.length, 'مورد');
                        } else {
                            console.error('❌ خطا در بارگیری خدمات - data:', data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ خطای AJAX در بارگیری خدمات:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                    }
                });
            }

            // Initialize filters and load data on page load
            updateFilterDropdowns();
            loadTariffs();
        });
    </script>
}
