@using ClinicApp.Models.Entities.Insurance
@model ClinicApp.ViewModels.Insurance.InsuranceTariff.InsuranceTariffIndexPageViewModel
@{
    ViewBag.Title = "مدیریت تعرفه‌های بیمه";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@* 🔧 CRITICAL FIX: Helper برای نمایش پول *@
@helper Rial(object value) {
    @($"{value ?? 0:N0} ریال")
}

<!-- 🚀 SEO: Meta Tags -->
@section MetaTags {
    <meta name="description" content="مدیریت تعرفه‌های بیمه - سیستم کلینیک شفا" />
    <meta name="keywords" content="تعرفه بیمه, مدیریت تعرفه, کلینیک, بیمه" />
    <meta name="robots" content="noindex, nofollow" />
}

@section Styles {
    <style>
        /* 🏥 MEDICAL: استایل‌های درمانی */
        .medical-card {
            border: 1px solid #e3f2fd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .medical-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .medical-header {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 20px;
        }
        
        .medical-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        .medical-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .medical-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            border: none;
            padding: 16px;
        }
        
        .medical-table td {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .medical-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medical-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .medical-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .medical-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-edit {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .medical-filter {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .medical-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #1976d2;
        }
        
        .pagination-btn.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }
        
        .medical-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .medical-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .medical-empty i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 16px;
        }
    </style>
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-2">
                            <i class="fas fa-money-bill-wave"></i>
                            مدیریت تعرفه‌های بیمه
                        </h1>
                        <p class="mb-0 opacity-75">مدیریت تعرفه‌های خاص خدمات برای طرح‌های بیمه</p>
                    </div>
                    <div>
                        <a href="@Url.Action("Create", new { 
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId
                        })" class="btn btn-light">
                            <i class="fas fa-plus"></i>
                            تعرفه جدید
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-stats">
                <h5 class="mb-3">
                    <i class="fas fa-chart-bar text-primary"></i>
                    آمار کلی
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="total">@Model.Statistics.TotalTariffs</div>
                            <div class="stat-label">کل تعرفه‌های بیمه</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="active">@Model.Statistics.ActiveTariffs</div>
                            <div class="stat-label">تعرفه‌های فعال</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="inactive">@Model.Statistics.InactiveTariffs</div>
                            <div class="stat-label">تعرفه‌های غیرفعال</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" data-stat="services">@Model.Statistics.TotalServices</div>
                            <div class="stat-label">خدمات تحت پوشش</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="medical-filter">
                <h5 class="mb-3">
                    <i class="fas fa-filter text-primary"></i>
                    فیلتر و جستجو
                </h5>
                @using (Html.BeginForm("Index", "InsuranceTariff", FormMethod.Get, new { @class = "row g-3" }))
                {
                    <div class="col-md-3">
                        <label class="form-label">دپارتمان</label>
                        @Html.DropDownListFor(m => m.Filter.DepartmentId, Model.Filter.Departments, "همه دپارتمان‌ها", new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ارائه‌دهنده بیمه</label>
                        @if (Model.Filter.InsuranceProviders != null && Model.Filter.InsuranceProviders.Any())
                        {
                            @Html.DropDownListFor(m => m.Filter.InsuranceProviderId, Model.Filter.InsuranceProviders, "همه ارائه‌دهندگان", new { @class = "form-select" })
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> 
                                @Model.Filter.InsuranceProviders.Count() ارائه‌دهنده بارگیری شد
                            </small>
                        }
                        else
                        {
                            <select class="form-select" disabled>
                                <option>در حال بارگیری...</option>
                            </select>
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ارائه‌دهندگان بیمه در حال بارگیری هستند
                            </small>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                    <i class="fas fa-sync-alt"></i> تلاش مجدد
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="loadInsuranceProviders()">
                                    <i class="fas fa-download"></i> بارگیری دستی
                                </button>
                            </div>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">نوع بیمه</label>
                        @Html.DropDownListFor(m => m.Filter.InsuranceType, new SelectList(new object[]
                        {
                            new { Value = "", Text = "همه انواع" },
                            new { Value = (int)InsuranceType.Primary, Text = "بیمه پایه" },
                            new { Value = (int)InsuranceType.Supplementary, Text = "بیمه تکمیلی" }
                        }, "Value", "Text"), new { @class = "form-select" })
                        <small class="text-info">
                            <i class="fas fa-info-circle"></i> 
                            همه تعرفه‌های بیمه (پایه و تکمیلی) در این صفحه نمایش داده می‌شوند
                        </small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">وضعیت</label>
                        @Html.DropDownListFor(m => m.Filter.IsActive, new SelectList(new[]
                        {
                            new { Value = "", Text = "همه وضعیت‌ها" },
                            new { Value = "true", Text = "فعال" },
                            new { Value = "false", Text = "غیرفعال" }
                        }, "Value", "Text"), new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">جستجو</label>
                        <div class="input-group">
                            @Html.TextBoxFor(m => m.Filter.SearchTerm, new { @class = "form-control", placeholder = "جستجو در تعرفه‌ها..." })
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                اعمال فیلتر
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                ریست فیلترها
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Tariffs Table -->
    <div class="row">
        <div class="col-12">
            <div class="medical-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th scope="col">خدمت</th>
                            <th scope="col">طرح بیمه</th>
                            <th scope="col">قیمت تعرفه</th>
                            <th scope="col">سهم بیمار</th>
                            <th scope="col">سهم بیمه</th>
                            <th scope="col">وضعیت</th>
                            <th scope="col">تاریخ ایجاد</th>
                            <th scope="col">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Tariffs.Any())
                        {
                            foreach (var tariff in Model.Tariffs)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong>@tariff.ServiceName</strong>
                                            @if (!string.IsNullOrEmpty(tariff.ServiceCategoryName))
                                            {
                                                <br><small class="text-muted">@tariff.ServiceCategoryName</small>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@tariff.InsurancePlanName</strong>
                                            <br><small class="text-muted">@tariff.InsuranceProviderName</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-primary">@Rial(tariff.TariffPrice)</span>
                                    </td>
                                    <td>
                                        <span class="text-success">@Rial(tariff.PatientShare)</span>
                                    </td>
                                    <td>
                                        <span class="text-info">@Rial(tariff.InsurerShare)</span>
                                    </td>
                                    <td>
                                        <span class="status-badge @(tariff.IsActive ? "status-active" : "status-inactive")" 
                                              role="status" 
                                              aria-label="وضعیت: @(tariff.IsActive ? "فعال" : "غیرفعال")">
                                            @(tariff.IsActive ? "فعال" : "غیرفعال")
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@tariff.CreatedAt.ToString("yyyy/MM/dd")</small>
                                    </td>
                                    <td>
                                        <div class="medical-actions">
                                            <a href="@Url.Action("Details", new { id = tariff.InsuranceTariffId })" class="medical-btn btn-view">
                                                <i class="fas fa-eye"></i>
                                                مشاهده
                                            </a>
                                            <a href="@Url.Action("Edit", new { id = tariff.InsuranceTariffId })" class="medical-btn btn-edit">
                                                <i class="fas fa-edit"></i>
                                                ویرایش
                                            </a>
                                            @using (Html.BeginForm("Delete", "InsuranceTariff", FormMethod.Post, new { @class = "d-inline" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("id", tariff.InsuranceTariffId)
                                                <button type="submit" class="medical-btn btn-delete" onclick="return confirm('آیا مطمئن هستید که می‌خواهید این تعرفه را حذف کنید؟');">
                                                    <i class="fas fa-trash"></i>
                                                    حذف
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="medical-empty">
                                    <i class="fas fa-inbox"></i>
                                    <h5>هیچ تعرفه‌ای یافت نشد</h5>
                                    <p>برای شروع، یک تعرفه جدید ایجاد کنید.</p>
                                    <a href="@Url.Action("Create")" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        ایجاد تعرفه جدید
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (Model.Tariffs.Any() && Model.Pagination.TotalPages > 1)
    {
        <div class="row">
            <div class="col-12">
                <div class="medical-pagination">
                    @if (Model.Pagination.HasPreviousPage)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = Model.Pagination.PageNumber - 1,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                            قبلی
                        </a>
                    }
                    
                    @for (int i = 1; i <= Model.Pagination.TotalPages; i++)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = i,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn @(i == Model.Pagination.PageNumber ? "active" : "")">
                            @i
                        </a>
                    }
                    
                    @if (Model.Pagination.HasNextPage)
                    {
                        <a href="@Url.Action("Index", new { 
                            page = Model.Pagination.PageNumber + 1,
                            DepartmentId = Model.Filter.DepartmentId,
                            InsuranceProviderId = Model.Filter.InsuranceProviderId,
                            InsuranceType = Model.Filter.InsuranceType,
                            IsActive = Model.Filter.IsActive,
                            SearchTerm = Model.Filter.SearchTerm
                        })" class="pagination-btn">
                            بعدی
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('🏥 MEDICAL: Insurance Tariff Index page loaded');
            
            // 🔧 CRITICAL FIX: کاهش انیمیشن‌های غیرضروری
            $('.medical-table tbody').css('opacity', '0').animate({ opacity: 1 }, 200);
            
            // 🚀 UX: Enhanced interactions
            $('.medical-btn').hover(
                function() { $(this).addClass('shadow-sm'); },
                function() { $(this).removeClass('shadow-sm'); }
            );
            
            // 🔧 CRITICAL FIX: Auto-refresh statistics with semantic keys
            var statsTimer;
            function loadStats() {
                $.get('@Url.Action("GetStatistics")', function(data) {
                    if (data && data.success && data.data) {
                        $('[data-stat="total"]').text(data.data.totalTariffs || 0);
                        $('[data-stat="active"]').text(data.data.activeTariffs || 0);
                        $('[data-stat="inactive"]').text(data.data.inactiveTariffs || 0);
                        $('[data-stat="services"]').text(data.data.totalServices || 0);
                    }
                }).fail(function(xhr, status, error) {
                    console.error('خطا در بارگیری آمار:', error);
                });
            }
            
            // شروع تایمر
            statsTimer = setInterval(loadStats, 30000);
            
            // پاک‌سازی تایمر هنگام خروج از صفحه
            $(window).on('beforeunload', function() {
                if (statsTimer) clearInterval(statsTimer);
            });
            
            // 🚀 CRITICAL FIX: بارگیری دستی ارائه‌دهندگان بیمه
            window.loadInsuranceProviders = function() {
                var $providerSelect = $('select[name="Filter.InsuranceProviderId"]');
                var $loadingText = $providerSelect.siblings('small');
                
                $loadingText.html('<i class="fas fa-spinner fa-spin"></i> در حال بارگیری...');
                
                $.ajax({
                    url: '@Url.Action("GetInsuranceProviders", "InsuranceTariff")',
                    type: 'GET',
                    data: { search: '', page: 1, pageSize: 100 },
                    success: function(response) {
                        if (response.success && response.data && response.data.length > 0) {
                            $providerSelect.empty();
                            $providerSelect.append('<option value="">همه ارائه‌دهندگان</option>');
                            
                            $.each(response.data, function(index, item) {
                                $providerSelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                            });
                            
                            $providerSelect.prop('disabled', false);
                            $loadingText.html('<i class="fas fa-check-circle text-success"></i> ' + response.data.length + ' ارائه‌دهنده بارگیری شد');
                            
                            // Hide retry buttons
                            $providerSelect.siblings('.mt-2').hide();
                        } else {
                            $loadingText.html('<i class="fas fa-exclamation-triangle text-danger"></i> خطا در بارگیری ارائه‌دهندگان');
                        }
                    },
                    error: function(xhr, status, error) {
                        $loadingText.html('<i class="fas fa-exclamation-triangle text-danger"></i> خطا در بارگیری: ' + error);
                    }
                });
            };
            
            // بارگذاری اولیه
            loadStats();
        });
    </script>
}
