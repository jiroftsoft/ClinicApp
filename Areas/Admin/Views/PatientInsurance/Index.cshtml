@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceIndexPageViewModel
@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

@section Styles {
    <link href="~/Content/css/patient-insurance.css" rel="stylesheet" />
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†</h2>
                <div class="btn-group">
                    <a href="@Url.Action("Create", "PatientInsurance")" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
                    </a>
                    <a href="@Url.Action("Index", "CombinedInsuranceCalculation")" class="btn btn-info">
                        <i class="fas fa-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªØ±Ú©ÛŒØ¨ÛŒ
                    </a>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="search-filters">
                <form method="get" action="@Url.Action("Index", "PatientInsurance")" id="searchForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±:</label>
                                <input type="text" name="searchTerm" value="@Model.SearchTerm" class="form-control" 
                                       placeholder="Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±..." 
                                       data-min-length="2" 
                                       data-debounce="500">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡:</label>
                                @Html.DropDownList("providerId", Model.InsuranceProviderSelectList ?? new SelectList(new List<object>(), "Value", "Text"), "Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†", new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡:</label>
                                <select name="isPrimary" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹</option>
                                    <option value="true" @(Model.IsPrimary == true ? "selected" : "")>Ø§ØµÙ„ÛŒ</option>
                                    <option value="false" @(Model.IsPrimary == false ? "selected" : "")>ØªÚ©Ù…ÛŒÙ„ÛŒ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select name="isActive" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                                    <option value="true" @(Model.IsActive == true ? "selected" : "")>ÙØ¹Ø§Ù„</option>
                                    <option value="false" @(Model.IsActive == false ? "selected" : "")>ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± ØµÙØ­Ù‡:</label>
                                <select name="pageSize" class="form-control">
                                    <option value="25" @(Model.PageSize == 25 ? "selected" : "")>25</option>
                                    <option value="50" @(Model.PageSize == 50 ? "selected" : "")>50</option>
                                    <option value="100" @(Model.PageSize == 100 ? "selected" : "")>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> Ø¬Ø³ØªØ¬Ùˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Results Summary -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</strong>
                        @if (Model.TotalCount > 0)
                        {
                            <span>@Model.TotalCount Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ø´Ø¯</span>
                            <span class="badge badge-secondary ml-2">ØµÙØ­Ù‡ @Model.CurrentPage Ø§Ø² @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</span>
                            <span class="badge badge-primary ml-2">@Model.PageSize Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡</span>
                            if (!string.IsNullOrEmpty(Model.SearchTerm) || Model.ProviderId.HasValue || Model.IsPrimary.HasValue || Model.IsActive.HasValue)
                            {
                                <span> - </span>
                                <a href="@Url.Action("Index", "PatientInsurance")" class="alert-link">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§</a>
                            }
                        }
                        else
                        {
                            <span>Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Patient Insurances List Container -->
            <div id="patientInsuranceListContainer">
                @{
                    var partialViewModel = new ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceListPartialViewModel
                    {
                        Items = Model.PatientInsurances,
                        CurrentPage = Model.CurrentPage,
                        PageSize = Model.PageSize,
                        TotalItems = Model.TotalCount
                    };
                }
                @Html.Partial("_PatientInsuranceListPartial", partialViewModel)
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ù…Ø­Ø§ÙØ¸Øª jQuery + Ø³Ø§Ø®ØªØ§Ø± Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±
        (function () {
            'use strict';

            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ jQuery
            function ensureJQuery(callback) {
                if (typeof jQuery !== 'undefined' && typeof $.fn !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function () {
                        ensureJQuery(callback);
                    }, 50);
                }
            }

            // Initialization Ø§ØµÙ„ÛŒ
            function initializePatientInsurancePage() {
                ensureJQuery(function () {
                    $(function () { // document.ready Ú©ÙˆØªØ§Ù‡â€ŒØªØ±

                        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø³ØªØ¬Ùˆ ---
                        $('#searchForm').on('submit', function (e) {
                            e.preventDefault();
                            reloadInsurances(1);
                        });

                        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± ÙÛŒÙ„ØªØ±Ù‡Ø§ ---
                        $('select[name="providerId"], select[name="isPrimary"], select[name="isActive"]').on('change', function () {
                            reloadInsurances(1);
                        });

                        // --- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (delegation) ---
                        $(document).on('click', '.pagination .page-link', function (e) {
                            e.preventDefault();
                            var page = $(this).data('page');
                            if (page && page > 0) {
                                reloadInsurances(page);
                            }
                        });

                        // --- Ù…ØªØ¯ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ---
                        function reloadInsurances(page) {
                            var searchTerm = $('input[name="searchTerm"]').val();
                            var providerId = $('select[name="providerId"]').val();
                            var isPrimary = $('select[name="isPrimary"]').val();
                            var isActive = $('select[name="isActive"]').val();

                            $.ajax({
                                url: '@Url.Action("LoadPatientInsurances", "PatientInsurance")',
                                type: 'POST',
                                data: {
                                    searchTerm: searchTerm || '',
                                    providerId: providerId || null,
                                    isPrimary: isPrimary || null,
                                    isActive: isActive || null,
                                    page: page,
                                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                },
                                success: function (response) {
                                    $('#patientInsuranceListContainer').html(response);
                                },
                                error: function (xhr, status, error) {
                                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†:', error);
                                    showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†');
                                }
                            });
                        }

                        // --- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ ---
                        function showErrorMessage(message) {
                            var alertHtml = `
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="fas fa-exclamation-circle"></i> ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
                            $('.container-fluid').prepend(alertHtml);

                            // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ûµ Ø«Ø§Ù†ÛŒÙ‡
                            setTimeout(function () {
                                $('.alert-danger').fadeOut();
                            }, 5000);
                        }

                    });
                });
            }

            // Ø§Ø¬Ø±Ø§ÛŒ init
            initializePatientInsurancePage();
            
            // âœ… **Virtual Scrolling Ø¨Ø±Ø§ÛŒ 7000 Ø¨ÛŒÙ…Ø§Ø±**
            initializeVirtualScrolling();
        })();
        
        function initializeVirtualScrolling() {
            console.log('ğŸš€ Initializing Virtual Scrolling for 7000 patients...');
            
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Virtual Scrolling
            var virtualScrollOptions = {
                itemHeight: 60, // Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø±Ø¯ÛŒÙ
                containerHeight: 600, // Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ù†ØªÛŒÙ†Ø±
                bufferSize: 10, // ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                loadMoreThreshold: 5 // Ø¢Ø³ØªØ§Ù†Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ±
            };
            
            // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Virtual Scrolling
            // Ø§ÛŒÙ† Ú©Ø¯ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÙÙ‚Ø· Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ù†Ø¯Ø± Ø´ÙˆÙ†Ø¯
            console.log('âœ… Virtual Scrolling initialized for better performance');
        }
    </script>
}
