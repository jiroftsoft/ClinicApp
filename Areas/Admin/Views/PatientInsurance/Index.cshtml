@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceIndexPageViewModel
@{
    ViewBag.Title = "Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

@section Styles {
    <link href="~/Content/css/patient-insurance.css" rel="stylesheet" />
    <style>
        /* ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ */
        .insurance-valid {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745 !important;
        }

        .insurance-invalid {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545 !important;
        }

        .insurance-warning {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }

        .insurance-status .badge {
            font-size: 0.8em;
            padding: 0.4em 0.6em;
        }

        .insurance-issues {
            margin-top: 0.5rem;
            font-size: 0.9em;
        }

            .insurance-issues li {
                margin-bottom: 0.25rem;
            }

        /* Ø¯Ú©Ù…Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ */
        #validateInsurancesBtn {
            transition: all 0.3s ease;
        }

            #validateInsurancesBtn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† loading */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†</h2>
                <div class="btn-group">
                    <a href="@Url.Action("Create", "PatientInsurance")" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
                    </a>
                    <a href="@Url.Action("Index", "CombinedInsuranceCalculation")" class="btn btn-info">
                        <i class="fas fa-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªØ±Ú©ÛŒØ¨ÛŒ
                    </a>
                    <button type="button" class="btn btn-success" id="validateInsurancesBtn" onclick="validateAllInsurances()">
                        <i class="fas fa-check-circle"></i> Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§
                    </button>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="search-filters">
                <form method="get" action="@Url.Action("Index", "PatientInsurance")" id="searchForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±:</label>
                                <input type="text" name="searchTerm" value="@Model.SearchTerm" class="form-control"
                                       placeholder="Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±..."
                                       data-min-length="2"
                                       data-debounce="500">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨ÛŒÙ…Ù‡:</label>
                                @Html.DropDownList("providerId", Model.InsuranceProviderSelectList ?? new SelectList(new List<SelectListItem>(), "Value", "Text"), "Ù‡Ù…Ù‡ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†", new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡:</label>
                                <select name="isPrimary" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹</option>
                                    <option value="true" @(Model.IsPrimary == true ? "selected" : "")>Ø§ØµÙ„ÛŒ</option>
                                    <option value="false" @(Model.IsPrimary == false ? "selected" : "")>ØªÚ©Ù…ÛŒÙ„ÛŒ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select name="isActive" class="form-control">
                                    <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                                    <option value="true" @(Model.IsActive == true ? "selected" : "")>ÙØ¹Ø§Ù„</option>
                                    <option value="false" @(Model.IsActive == false ? "selected" : "")>ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± ØµÙØ­Ù‡:</label>
                                <select name="pageSize" class="form-control">
                                    <option value="25" @(Model.PageSize == 25 ? "selected" : "")>25</option>
                                    <option value="50" @(Model.PageSize == 50 ? "selected" : "")>50</option>
                                    <option value="100" @(Model.PageSize == 100 ? "selected" : "")>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="filter-group">
                                <label class="filter-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> Ø¬Ø³ØªØ¬Ùˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- ğŸ¥ Medical Environment: Insurance Status Summary -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</strong>
                        @if (Model.TotalCount > 0)
                        {
                            <span>@Model.TotalCount Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ø´Ø¯</span>
                            <span class="badge badge-secondary ml-2">ØµÙØ­Ù‡ @Model.CurrentPage Ø§Ø² @Math.Ceiling((double)Model.TotalCount / Model.PageSize)</span>
                            <span class="badge badge-primary ml-2">@Model.PageSize Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡</span>
                            if (!string.IsNullOrEmpty(Model.SearchTerm) || Model.ProviderId.HasValue || Model.IsPrimary.HasValue || Model.IsActive.HasValue)
                            {
                                <span> - </span>
                                <a href="@Url.Action("Index", "PatientInsurance")" class="alert-link">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§</a>
                            }
                        }
                        else
                        {
                            <span>Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯</span>
                        }
                    </div>
                </div>
            </div>

            <!-- ğŸ¥ Medical Environment: Quick Actions -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-tools"></i> Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success btn-block" id="createDefaultFreeInsurance">
                                        <i class="fas fa-plus-circle"></i> Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-info btn-block" id="checkInsuranceStatus">
                                        <i class="fas fa-search"></i> Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-warning btn-block" id="validateInsurances">
                                        <i class="fas fa-check-circle"></i> Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-secondary btn-block" id="exportInsurances">
                                        <i class="fas fa-download"></i> Ø®Ø±ÙˆØ¬ÛŒ Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Insurances List Container -->
            <div id="patientInsuranceListContainer">
                @{
                    var partialViewModel = new ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceListPartialViewModel
                    {
                        Items = Model.PatientInsurances,
                        CurrentPage = Model.CurrentPage,
                        PageSize = Model.PageSize,
                        TotalItems = Model.TotalCount
                    };
                }
                @Html.Partial("_PatientInsuranceListPartial", partialViewModel)
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ù…Ø­Ø§ÙØ¸Øª jQuery + Ø³Ø§Ø®ØªØ§Ø± Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±
        (function () {
            'use strict';

            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ jQuery
            function ensureJQuery(callback) {
                if (typeof jQuery !== 'undefined' && typeof $.fn !== 'undefined') {
                    callback();
                } else {
                    setTimeout(function () {
                        ensureJQuery(callback);
                    }, 50);
                }
            }

            // Initialization Ø§ØµÙ„ÛŒ
            function initializePatientInsurancePage() {
                ensureJQuery(function () {
                    $(function () { // document.ready Ú©ÙˆØªØ§Ù‡â€ŒØªØ±

                        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø³ØªØ¬Ùˆ ---
                        $('#searchForm').on('submit', function (e) {
                            e.preventDefault();
                            reloadInsurances(1);
                        });

                        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± ÙÛŒÙ„ØªØ±Ù‡Ø§ ---
                        $('select[name="providerId"], select[name="isPrimary"], select[name="isActive"]').on('change', function () {
                            reloadInsurances(1);
                        });

                        // --- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (delegation) ---
                        $(document).on('click', '.pagination .page-link', function (e) {
                            e.preventDefault();
                            var page = $(this).data('page');
                            if (page && page > 0) {
                                reloadInsurances(page);
                            }
                        });

                        // --- Ù…ØªØ¯ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ---
                        function reloadInsurances(page) {
                            var searchTerm = $('input[name="searchTerm"]').val();
                            var providerId = $('select[name="providerId"]').val();
                            var isPrimary = $('select[name="isPrimary"]').val();
                            var isActive = $('select[name="isActive"]').val();

                            $.ajax({
                                url: '@Url.Action("LoadPatientInsurances", "PatientInsurance")',
                                type: 'POST',
                                data: {
                                    searchTerm: searchTerm || '',
                                    providerId: providerId || null,
                                    isPrimary: isPrimary || null,
                                    isActive: isActive || null,
                                    page: page,
                                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                },
                                success: function (response) {
                                    $('#patientInsuranceListContainer').html(response);
                                },
                                error: function (xhr, status, error) {
                                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†:', error);
                                    showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†');
                                }
                            });
                        }


                        // --- ğŸ¥ Medical Environment: Quick Actions ---
                        $('#createDefaultFreeInsurance').on('click', function() {
                            var patientId = prompt('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
                            if (patientId && !isNaN(patientId)) {
                                createDefaultFreeInsurance(parseInt(patientId));
                            } else {
                                showErrorMessage('Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                            }
                        });

                        // ğŸ¥ Medical Environment: Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ UI Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Production
                        $('#checkInsuranceStatus').on('click', function() {
                            showNationalCodeInputModal('Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡', function(nationalCode) {
                                if (nationalCode && nationalCode.length >= 10) {
                                    checkInsuranceStatusByNationalCode(nationalCode);
                            } else {
                                    showErrorMessage('Ú©Ø¯ Ù…Ù„ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ 10 Ø±Ù‚Ù…ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
                            }
                            });
                        });

                        $('#validateInsurances').on('click', function() {
                            validateAllInsurances();
                        });

                        $('#exportInsurances').on('click', function() {
                            exportInsurancesToExcel();
                        });

                        // --- ğŸ¥ Medical Environment: Helper Functions ---
                        function createDefaultFreeInsurance(patientId) {
                            $.ajax({
                                url: '@Url.Action("CreateDefaultFreeInsurance", "PatientInsurance")',
                                type: 'POST',
                                data: {
                                    patientId: patientId,
                                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                },
                                success: function(response) {
                                    if (response.success) {
                                        showSuccessMessage('Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                                        reloadInsurances(1);
                                    } else {
                                        showErrorMessage(response.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯');
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯:', error);
                                    showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯');
                                }
                            });
                        }

                        // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ - Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Production
                        function checkInsuranceStatusByNationalCode(nationalCode) {
                            var $btn = $('#checkInsuranceStatus');
                            var originalText = $btn.html();
                            
                            // ğŸ¥ Medical Environment: Performance Monitoring
                            var startTime = performance.now();
                            
                            // Ù†Ù…Ø§ÛŒØ´ loading state
                            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...');
                            
                            $.ajax({
                                url: '@Url.Action("GetPatientInsuranceStatusByNationalCode", "PatientInsurance")',
                                type: 'POST',
                                dataType: 'json', // ğŸ¥ Medical Environment: Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² JSON Parsing
                                data: { 
                                    nationalCode: nationalCode,
                                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                },
                                timeout: 30000, // 30 Ø«Ø§Ù†ÛŒÙ‡ timeout
                                success: function(response) {
                                    // ğŸ¥ Medical Environment: Performance Logging
                                    var endTime = performance.now();
                                    var duration = endTime - startTime;
                                    
                                    console.log('ğŸ¥ MEDICAL: Ù¾Ø§Ø³Ø® Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡:', response);
                                    console.log('ğŸ¥ MEDICAL: Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®: ' + duration.toFixed(2) + 'ms');
                                    
                                    // ğŸ¥ Medical Environment: Performance Alert
                                    if (duration > 5000) { // Ø¨ÛŒØ´ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
                                        console.warn('ğŸ¥ MEDICAL: Ù‡Ø´Ø¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ - Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø§Ù†ØªØ¸Ø§Ø±: ' + duration.toFixed(2) + 'ms');
                                        showErrorMessage('Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                                        return;
                                    }
                                    
                                    // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Response
                                    console.log('ğŸ¥ MEDICAL: Ù†ÙˆØ¹ Response:', typeof response);
                                    console.log('ğŸ¥ MEDICAL: Response Ø§ÙˆÙ„ÛŒÙ‡:', response);
                                    
                                    // ğŸ¥ Medical Environment: JSON Parsing Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯
                                    var parsedResponse = response;
                                    if (typeof response === 'string') {
                                        try {
                                            parsedResponse = JSON.parse(response);
                                            console.log('ğŸ¥ MEDICAL: Response Ù¾Ø³ Ø§Ø² Parse:', parsedResponse);
                                        } catch (parseError) {
                                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Parse Ú©Ø±Ø¯Ù† Response:', parseError);
                                            showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±');
                                            logPerformanceMetrics('insurance_status_check', duration, false);
                                            return;
                                        }
                                    }
                                    
                                    // ğŸ¥ Medical Environment: Debug Response Structure
                                    console.log('ğŸ¥ MEDICAL: Ø¨Ø±Ø±Ø³ÛŒ Response Structure:');
                                    console.log('ğŸ¥ MEDICAL: parsedResponse.success:', parsedResponse.success);
                                    console.log('ğŸ¥ MEDICAL: parsedResponse.Success:', parsedResponse.Success);
                                    console.log('ğŸ¥ MEDICAL: parsedResponse.data:', parsedResponse.data);
                                    console.log('ğŸ¥ MEDICAL: parsedResponse.Data:', parsedResponse.Data);
                                    console.log('ğŸ¥ MEDICAL: parsedResponse structure:', Object.keys(parsedResponse || {}));
                                    
                                    // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Response
                                    var isSuccess = parsedResponse && (parsedResponse.success || parsedResponse.Success);
                                    var responseData = parsedResponse?.data || parsedResponse?.Data;
                                    
                                    console.log('ğŸ¥ MEDICAL: isSuccess:', isSuccess);
                                    console.log('ğŸ¥ MEDICAL: responseData:', responseData);
                                    
                                    if (isSuccess && responseData) {
                                        console.log('ğŸ¥ MEDICAL: Response Ù…ÙˆÙÙ‚ - Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„');
                                        showInsuranceStatusModalOptimized(responseData);
                                        
                                        // ğŸ¥ Medical Environment: Success Metrics
                                        logPerformanceMetrics('insurance_status_check', duration, true);
                                    } else {
                                        console.log('ğŸ¥ MEDICAL: Response Ù†Ø§Ù…ÙˆÙÙ‚ - Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§');
                                        showErrorMessage(parsedResponse?.message || parsedResponse?.Message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡');
                                        logPerformanceMetrics('insurance_status_check', duration, false);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    var endTime = performance.now();
                                    var duration = endTime - startTime;
                                    
                                    console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡:', {
                                        status: xhr.status,
                                        statusText: xhr.statusText,
                                        error: error,
                                        responseText: xhr.responseText,
                                        duration: duration.toFixed(2) + 'ms'
                                    });
                                    
                                    var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡';
                                    if (xhr.status === 0) {
                                        errorMessage = 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª';
                                    } else if (xhr.status === 500) {
                                        errorMessage = 'Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ±';
                                    } else if (xhr.status === 404) {
                                        errorMessage = 'Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                                    } else if (xhr.status === 403) {
                                        errorMessage = 'Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯';
                                    }
                                    
                                    showErrorMessage(errorMessage);
                                    logPerformanceMetrics('insurance_status_check', duration, false);
                                },
                                complete: function() {
                                    $btn.prop('disabled', false).html(originalText);
                                }
                            });
                        }

                        function validateAllInsurances() {
                            $.ajax({
                                url: '@Url.Action("ValidateAllInsurances", "PatientInsurance")',
                                type: 'POST',
                                data: {
                                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                },
                                success: function(response) {
                                    if (response.success) {
                                        showSuccessMessage('Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                                        reloadInsurances(1);
                                    } else {
                                        showErrorMessage(response.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§');
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§:', error);
                                    showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§');
                                }
                            });
                        }

                        function exportInsurancesToExcel() {
                            var searchTerm = $('input[name="searchTerm"]').val();
                            var providerId = $('select[name="providerId"]').val();
                            var isPrimary = $('select[name="isPrimary"]').val();
                            var isActive = $('select[name="isActive"]').val();

                            var url = '@Url.Action("ExportToExcel", "PatientInsurance")' +
                                '?searchTerm=' + encodeURIComponent(searchTerm || '') +
                                '&providerId=' + (providerId || '') +
                                '&isPrimary=' + (isPrimary || '') +
                                '&isActive=' + (isActive || '');

                            window.open(url, '_blank');
                        }

                        // ğŸ¥ Medical Environment: Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ - Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Production
                        // ğŸ¥ Medical Environment: ØªØ§Ø¨Ø¹ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
                        function formatDate(dateValue) {
                            if (!dateValue) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
                            
                            try {
                                // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª /Date(timestamp)/
                                if (typeof dateValue === 'string' && dateValue.startsWith('/Date(') && dateValue.endsWith(')/')) {
                                    var timestamp = parseInt(dateValue.replace('/Date(', '').replace(')/', ''));
                                    var date = new Date(timestamp);
                                } else {
                                    var date = new Date(dateValue);
                                }
                                
                                if (isNaN(date.getTime())) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
                                
                                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
                                return date.toLocaleDateString('fa-IR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                });
                            } catch (error) {
                                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®:', error, dateValue);
                                return 'Ù†Ø§Ù…Ø´Ø®Øµ';
                            }
                        }

                        // ğŸ¥ Medical Environment: ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
                        function calculateDaysRemaining(dateValue) {
                            if (!dateValue) return null;
                            
                            try {
                                var date;
                                if (typeof dateValue === 'string' && dateValue.startsWith('/Date(') && dateValue.endsWith(')/')) {
                                    var timestamp = parseInt(dateValue.replace('/Date(', '').replace(')/', ''));
                                    date = new Date(timestamp);
                                } else {
                                    date = new Date(dateValue);
                                }
                                
                                if (isNaN(date.getTime())) return null;
                                
                                var now = new Date();
                                var diffTime = date.getTime() - now.getTime();
                                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                
                                return diffDays;
                            } catch (error) {
                                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:', error);
                                return null;
                            }
                        }

                        function showInsuranceStatusModalOptimized(statusData) {
                            try {
                                console.log('ğŸ¥ MEDICAL: Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡:', statusData);
                                console.log('ğŸ¥ MEDICAL: Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡:', typeof statusData);
                                console.log('ğŸ¥ MEDICAL: Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:', Object.keys(statusData || {}));
                                
                                // Ø­Ø°Ù Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                                $('#insuranceStatusModal').remove();
                                
                                // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                                if (!statusData) {
                                    console.error('ğŸ¥ MEDICAL: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
                                    showErrorMessage('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯');
                                    return;
                                }
                            
                            // ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø±Ù†Ú¯
                            var statusClass = 'success';
                            var statusIcon = 'fas fa-check-circle';
                            var statusText = 'Ù…Ø¹ØªØ¨Ø±';
                            
                            // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                            var validationStatus = statusData.validationStatus || statusData.ValidationStatus;
                            if (validationStatus === 'Expired') {
                                statusClass = 'danger';
                                statusIcon = 'fas fa-times-circle';
                                statusText = 'Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡';
                            } else if (validationStatus === 'Expiring') {
                                statusClass = 'warning';
                                statusIcon = 'fas fa-exclamation-triangle';
                                statusText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ù‚Ø¶Ø§';
                            } else if (validationStatus === 'NoPrimaryInsurance') {
                                statusClass = 'info';
                                statusIcon = 'fas fa-info-circle';
                                statusText = 'ÙØ§Ù‚Ø¯ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ';
                            }

                            var modalHtml = `
                                <div class="modal fade" id="insuranceStatusModal" tabindex="-1" role="dialog">
                                    <div class="modal-dialog modal-xl" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-${statusClass} text-white">
                                                <h5 class="modal-title">
                                                    <i class="${statusIcon}"></i> ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± - ${statusText}
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- ğŸ¥ Medical Environment: Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª -->
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <div class="alert alert-${statusClass}">
                                                            <h6><i class="fas fa-info-circle"></i> Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª</h6>
                                                            <p class="mb-0">${statusData.validationMessage || statusData.ValidationMessage || 'ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯'}</p>
                                                            ${(statusData.expiryWarning || statusData.ExpiryWarning) ? '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Ù‡Ø´Ø¯Ø§Ø± Ø§Ù†Ù‚Ø¶Ø§</small>' : ''}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ğŸ¥ Medical Environment: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ -->
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <h6><i class="fas fa-shield-alt"></i> Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ</h6>
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <strong>ÙˆØ¶Ø¹ÛŒØª:</strong> 
                                                                        <span class="badge bg-${(statusData.hasPrimaryInsurance || statusData.HasPrimaryInsurance) ? 'success' : 'danger'}">
                                                                            ${(statusData.hasPrimaryInsurance || statusData.HasPrimaryInsurance) ? 'Ø¯Ø§Ø±Ø¯' : 'Ù†Ø¯Ø§Ø±Ø¯'}
                                                                        </span>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <strong>ÙØ¹Ø§Ù„:</strong> 
                                                                        <span class="badge bg-${(statusData.primaryInsuranceActive || statusData.PrimaryInsuranceActive) ? 'success' : 'danger'}">
                                                                            ${(statusData.primaryInsuranceActive || statusData.PrimaryInsuranceActive) ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                ${(statusData.primaryInsurance || statusData.PrimaryInsurance) ? `
                                                                    <div class="row mt-2">
                                                                        <div class="col-md-6">
                                                                            <strong>Ù†Ø§Ù… Ø·Ø±Ø­:</strong> ${(statusData.primaryInsurance || statusData.PrimaryInsurance)?.name || (statusData.primaryInsurance || statusData.PrimaryInsurance)?.Name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <strong>Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡:</strong> ${(statusData.primaryInsurance || statusData.PrimaryInsurance)?.policyNumber || (statusData.primaryInsurance || statusData.PrimaryInsurance)?.PolicyNumber || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                                                                        </div>
                                                                    </div>
                                                                    <div class="row mt-2">
                                                                        <div class="col-md-6">
                                                                            <strong>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</strong> ${formatDate((statusData.primaryInsurance || statusData.PrimaryInsurance)?.startDate || (statusData.primaryInsurance || statusData.PrimaryInsurance)?.StartDate)}
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <strong>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</strong> ${formatDate((statusData.primaryInsurance || statusData.PrimaryInsurance)?.endDate || (statusData.primaryInsurance || statusData.PrimaryInsurance)?.EndDate)} ${(() => {
                                                                                var endDate = (statusData.primaryInsurance || statusData.PrimaryInsurance)?.endDate || (statusData.primaryInsurance || statusData.PrimaryInsurance)?.EndDate;
                                                                                var daysRemaining = calculateDaysRemaining(endDate);
                                                                                if (daysRemaining !== null) {
                                                                                    if (daysRemaining < 0) {
                                                                                        return '<span class="badge bg-danger">Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡</span>';
                                                                                    } else if (daysRemaining <= 30) {
                                                                                        return '<span class="badge bg-warning">' + daysRemaining + ' Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>';
                                                                                    } else {
                                                                                        return '<span class="badge bg-success">' + daysRemaining + ' Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>';
                                                                                    }
                                                                                }
                                                                                return '';
                                                                            })()}
                                                                        </div>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ğŸ¥ Medical Environment: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <h6><i class="fas fa-plus-circle"></i> Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</h6>
                                                        <div class="card">
                                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                                        <strong>ÙˆØ¶Ø¹ÛŒØª:</strong> 
                                                                        <span class="badge bg-${(statusData.hasSupplementaryInsurance || statusData.HasSupplementaryInsurance) ? 'success' : 'info'}">
                                                                            ${(statusData.hasSupplementaryInsurance || statusData.HasSupplementaryInsurance) ? 'Ø¯Ø§Ø±Ø¯' : 'Ù†Ø¯Ø§Ø±Ø¯'}
                                                                        </span>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <strong>ØªØ¹Ø¯Ø§Ø¯:</strong> ${statusData.supplementaryInsuranceCount || 0}
                                                                    </div>
                                                                </div>
                                                                ${(statusData.supplementaryInsurance || statusData.SupplementaryInsurance) ? `
                                                                    <div class="row mt-2">
                                                                        <div class="col-md-6">
                                                                            <strong>Ù†Ø§Ù… Ø·Ø±Ø­:</strong> ${(statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.name || (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.Name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                                                    </div>
                                                    <div class="col-md-6">
                                                                            <strong>Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡:</strong> ${(statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.policyNumber || (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.PolicyNumber || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                                                    </div>
                                                </div>
                                                                    <div class="row mt-2">
                                                    <div class="col-md-6">
                                                                            <strong>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</strong> ${formatDate((statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.startDate || (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.StartDate)}
                                                    </div>
                                                    <div class="col-md-6">
                                                                            <strong>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</strong> ${formatDate((statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.endDate || (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.EndDate)} ${(() => {
                                                                                var endDate = (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.endDate || (statusData.supplementaryInsurance || statusData.SupplementaryInsurance)?.EndDate;
                                                                                var daysRemaining = calculateDaysRemaining(endDate);
                                                                                if (daysRemaining !== null) {
                                                                                    if (daysRemaining < 0) {
                                                                                        return '<span class="badge bg-danger">Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡</span>';
                                                                                    } else if (daysRemaining <= 30) {
                                                                                        return '<span class="badge bg-warning">' + daysRemaining + ' Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>';
                                                                                    } else {
                                                                                        return '<span class="badge bg-success">' + daysRemaining + ' Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>';
                                                                                    }
                                                                                }
                                                                                return '';
                                                                            })()}
                                                                        </div>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ğŸ¥ Medical Environment: ØªØ­Ù„ÛŒÙ„ Ù¾ÙˆØ´Ø´ -->
                                                ${statusData.coverageAnalysis ? `
                                                    <div class="row mb-3">
                                                        <div class="col-12">
                                                            <h6><i class="fas fa-chart-pie"></i> ØªØ­Ù„ÛŒÙ„ Ù¾ÙˆØ´Ø´</h6>
                                                            <div class="card">
                                                                <div class="card-body">
                                                                    <div class="row">
                                                                        <div class="col-md-3">
                                                                            <strong>Ù¾ÙˆØ´Ø´ Ø§ØµÙ„ÛŒ:</strong> ${statusData.coverageAnalysis.primaryCoveragePercent || 0}%
                                                                        </div>
                                                                        <div class="col-md-3">
                                                                            <strong>Ù¾ÙˆØ´Ø´ ØªÚ©Ù…ÛŒÙ„ÛŒ:</strong> ${statusData.coverageAnalysis.supplementaryCoveragePercent || 0}%
                                                                        </div>
                                                                        <div class="col-md-3">
                                                                            <strong>Ù¾ÙˆØ´Ø´ Ú©Ù„:</strong> ${statusData.coverageAnalysis.totalCoveragePercent || 0}%
                                                                        </div>
                                                                        <div class="col-md-3">
                                                                            <strong>ÙØ±Ø§Ù†Ø´ÛŒØ²:</strong> ${(statusData.coverageAnalysis.primaryDeductible || 0) + (statusData.coverageAnalysis.supplementaryDeductible || 0)} ØªÙˆÙ…Ø§Ù†
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    </div>
                                                </div>
                                                ` : ''}

                                                <!-- ğŸ¥ Medical Environment: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ -->
                                                <div class="row">
                                                    <div class="col-12">
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock"></i> ØªØ§Ø±ÛŒØ® Ø¨Ø±Ø±Ø³ÛŒ: ${formatDate(statusData.validationDate || statusData.ValidationDate)}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                                                </button>
                                                ${statusData.hasPrimaryInsurance ? `
                                                    <button type="button" class="btn btn-info" onclick="editPatientInsurance(${statusData.patientId})">
                                                        <i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ù‡
                                                    </button>
                                                ` : `
                                                    <button type="button" class="btn btn-success" onclick="createPatientInsurance(${statusData.patientId})">
                                                        <i class="fas fa-plus"></i> Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡
                                                    </button>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            $('body').append(modalHtml);
                            $('#insuranceStatusModal').modal('show');

                            // Ø­Ø°Ù Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†
                            $('#insuranceStatusModal').on('hidden.bs.modal', function() {
                                $(this).remove();
                            });
                            
                            } catch (error) {
                                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡:', error);
                                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡: ' + error.message);
                            }
                        }

                        // ğŸ¥ Medical Environment: ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Production
                        function editPatientInsurance(patientId) {
                            window.location.href = '@Url.Action("Edit", "PatientInsurance")' + '?patientId=' + patientId;
                        }

                        function createPatientInsurance(patientId) {
                            window.location.href = '@Url.Action("Create", "PatientInsurance")' + '?patientId=' + patientId;
                        }

                        // ğŸ¥ Medical Environment: Performance Metrics Logging
                        function logPerformanceMetrics(operation, duration, success) {
                            try {
                                var metrics = {
                                    operation: operation,
                                    duration: duration,
                                    success: success,
                                    timestamp: new Date().toISOString(),
                                    userAgent: navigator.userAgent,
                                    url: window.location.href
                                };

                                console.log('ğŸ¥ MEDICAL: Performance Metrics:', metrics);

                                // ğŸ¥ Medical Environment: Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§:
                                // 1. Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ (Application Insights, New Relic, etc.)
                                // 2. Ø«Ø¨Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„
                                // 3. Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Alerting
                                // 4. Ø«Ø¨Øª Ø¯Ø± Log Files

                                // Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙÙ‚Ø· Ø¯Ø± Console Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                                if (duration > 3000) { // Ø¨ÛŒØ´ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
                                    console.warn('ğŸ¥ MEDICAL: Slow Operation Detected:', metrics);
                                }
                            } catch (ex) {
                                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Performance Metrics:', ex);
                            }
                        }

                        // ğŸ¥ Medical Environment: Ù…ÙˆØ¯Ø§Ù„ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø± - Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Production
                        function showNationalCodeInputModal(title, callback) {
                            var modalHtml = `
                                <div class="modal fade" id="nationalCodeInputModal" tabindex="-1" role="dialog">
                                    <div class="modal-dialog modal-sm" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header bg-primary text-white">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-user-md"></i> ${title}
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label for="nationalCodeInput" class="form-label">
                                                        <i class="fas fa-id-card"></i> Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±
                                                    </label>
                                                    <input type="text" class="form-control" id="nationalCodeInput" 
                                                           placeholder="Ù…Ø«Ø§Ù„: 1234567890" maxlength="10" pattern="[0-9]{10}" required>
                                                    <div class="form-text">
                                                        <i class="fas fa-info-circle"></i> Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ 10 Ø±Ù‚Ù…ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times"></i> Ù„ØºÙˆ
                                                </button>
                                                <button type="button" class="btn btn-primary" id="confirmNationalCode">
                                                    <i class="fas fa-check"></i> ØªØ§ÛŒÛŒØ¯
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            $('body').append(modalHtml);
                            $('#nationalCodeInputModal').modal('show');

                            // Focus on input
                            $('#nationalCodeInputModal').on('shown.bs.modal', function() {
                                $('#nationalCodeInput').focus();
                            });

                            // Handle Enter key
                            $('#nationalCodeInput').on('keypress', function(e) {
                                if (e.which === 13) { // Enter key
                                    $('#confirmNationalCode').click();
                                }
                            });

                            // Handle confirm button
                            $('#confirmNationalCode').on('click', function() {
                                var nationalCode = $('#nationalCodeInput').val();
                                if (nationalCode && nationalCode.length === 10 && /^[0-9]+$/.test(nationalCode)) {
                                    $('#nationalCodeInputModal').modal('hide');
                                    callback(nationalCode);
                                } else {
                                    $('#nationalCodeInput').addClass('is-invalid');
                                    showErrorMessage('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ 10 Ø±Ù‚Ù…ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                                }
                            });

                            // Remove modal after hiding
                            $('#nationalCodeInputModal').on('hidden.bs.modal', function() {
                                $(this).remove();
                            });
                        }

                        function showSuccessMessage(message) {
                            var alertHtml = `
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="fas fa-check-circle"></i> ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>`;
                            $('.container-fluid').prepend(alertHtml);

                            setTimeout(function() {
                                $('.alert-success').fadeOut();
                            }, 5000);
                        }

                        // --- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ ---
                        function showErrorMessage(message) {
                            var alertHtml = `
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="fas fa-exclamation-circle"></i> ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
                            $('.container-fluid').prepend(alertHtml);

                            // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ûµ Ø«Ø§Ù†ÛŒÙ‡
                            setTimeout(function () {
                                $('.alert-danger').fadeOut();
                            }, 5000);
                        }

                    });
                });
            }

            // Ø§Ø¬Ø±Ø§ÛŒ init
            initializePatientInsurancePage();

            // âœ… **Virtual Scrolling Ø¨Ø±Ø§ÛŒ 7000 Ø¨ÛŒÙ…Ø§Ø±**
            initializeVirtualScrolling();
        })();

        // ØªØ§Ø¨Ø¹ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§
        function validateAllInsurances() {
            var validateBtn = $('#validateInsurancesBtn');
            var originalText = validateBtn.html();

            // Ù†Ù…Ø§ÛŒØ´ loading
            validateBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ...');

            // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø§Ø² Ø¬Ø¯ÙˆÙ„
            var patientIds = [];
            $('.patient-insurance-row').each(function() {
                var patientId = $(this).data('patient-id');
                if (patientId && patientIds.indexOf(patientId) === -1) {
                    patientIds.push(patientId);
                }
            });

            if (patientIds.length === 0) {
                showErrorMessage('Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                validateBtn.prop('disabled', false).html(originalText);
                return;
            }

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‡Ø± Ø¨ÛŒÙ…Ø§Ø±
            var validationPromises = patientIds.map(function(patientId) {
                return validatePatientInsurance(patientId);
            });

            Promise.all(validationPromises).then(function(results) {
                var successCount = results.filter(function(r) { return r.success; }).length;
                var totalCount = results.length;

                showSuccessMessage(`Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯: ${successCount} Ø§Ø² ${totalCount} Ø¨ÛŒÙ…Ù‡ Ù…Ø¹ØªØ¨Ø±`);

                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
                results.forEach(function(result, index) {
                    if (result.success && result.data) {
                        updateInsuranceRowStatus(patientIds[index], result.data);
                    }
                });

            }).catch(function(error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:', error);
                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§: ' + error.message);
            }).finally(function() {
                validateBtn.prop('disabled', false).html(originalText);
            });
        }

        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ ÛŒÚ© Ø¨ÛŒÙ…Ø§Ø±
        function validatePatientInsurance(patientId) {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("ValidatePatientInsurance", "PatientInsurance")',
                    type: 'POST',
                    data: {
                        patientId: patientId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            resolve({
                                success: true,
                                data: response.data
                            });
                        } else {
                            resolve({
                                success: false,
                                error: response.message
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error));
                    }
                });
            });
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ø¯ÛŒÙ Ø¨ÛŒÙ…Ù‡
        function updateInsuranceRowStatus(patientId, validationResult) {
            var row = $('.patient-insurance-row[data-patient-id="' + patientId + '"]');

            // Ø­Ø°Ù Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ
            row.removeClass('insurance-valid insurance-invalid insurance-warning');

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯
            if (validationResult.isValid) {
                row.addClass('insurance-valid');
                row.find('.insurance-status').html('<span class="badge bg-success">Ù…Ø¹ØªØ¨Ø±</span>');
            } else {
                row.addClass('insurance-invalid');
                row.find('.insurance-status').html('<span class="badge bg-danger">Ù†Ø§Ù…Ø¹ØªØ¨Ø±</span>');

                // Ù†Ù…Ø§ÛŒØ´ Ù…Ø³Ø§Ø¦Ù„
                if (validationResult.issues && validationResult.issues.length > 0) {
                    var issuesHtml = '<ul class="list-unstyled mb-0">';
                    validationResult.issues.forEach(function(issue) {
                        var severityClass = issue.severity === 'Critical' ? 'text-danger' :
                                           issue.severity === 'Warning' ? 'text-warning' : 'text-info';
                        issuesHtml += '<li class="' + severityClass + '">' + issue.message + '</li>';
                    });
                    issuesHtml += '</ul>';

                    row.find('.insurance-issues').html(issuesHtml);
                }
            }
        }


        function initializeVirtualScrolling() {
            console.log('ğŸš€ Initializing Virtual Scrolling for 7000 patients...');

            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Virtual Scrolling
            var virtualScrollOptions = {
                itemHeight: 60, // Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø±Ø¯ÛŒÙ
                containerHeight: 600, // Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ù†ØªÛŒÙ†Ø±
                bufferSize: 10, // ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                loadMoreThreshold: 5 // Ø¢Ø³ØªØ§Ù†Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ±
            };

            // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Virtual Scrolling
            // Ø§ÛŒÙ† Ú©Ø¯ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÙÙ‚Ø· Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ù†Ø¯Ø± Ø´ÙˆÙ†Ø¯
            console.log('âœ… Virtual Scrolling initialized for better performance');
        }
    </script>
}

