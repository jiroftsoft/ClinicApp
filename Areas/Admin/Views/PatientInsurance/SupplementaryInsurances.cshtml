@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceIndexPageViewModel
@{
    ViewBag.Title = "Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø±";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <style>
        /* ğŸ¥ Medical Environment Styles - Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø¯Ø±Ù…Ø§Ù†ÛŒ */
        .supplementary-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .supplementary-card:hover {
            box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.25);
            transform: translateY(-2px);
        }
        
        .supplementary-card .card-body {
            padding: 1.5rem;
        }
        
        .medical-icon {
            color: #1cc88a;
            font-size: 1.2rem;
        }
        
        .coverage-badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.8rem;
        }
        
        .calculation-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 1rem 3rem rgba(0,0,0,0.3);
        }
        
        /* ğŸ“± Responsive Design */
        @@media (max-width: 768px) {
            .supplementary-card {
                margin-bottom: 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
        
        /* ğŸ¨ Medical Theme Colors */
        .medical-primary { color: #1cc88a; }
        .medical-secondary { color: #36b9cc; }
        .medical-warning { color: #f6c23e; }
        .medical-danger { color: #e74a3b; }
        
        /* ğŸ”’ Security Indicators */
        .security-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #1cc88a;
            font-size: 1.1rem;
        }
        
        /* ğŸš€ Performance Optimizations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-shield-alt medical-primary"></i>
                            Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø±
                            <span class="badge badge-info ml-2" id="insuranceCount">0</span>
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary btn-sm" onclick="showAddSupplementaryInsuranceModal()">
                                <i class="fas fa-plus"></i>
                                Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                            </button>
                            <button type="button" class="btn btn-success btn-sm ml-2" onclick="refreshSupplementaryInsurances()">
                                <i class="fas fa-sync-alt"></i>
                                Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.PatientInsurances != null && Model.PatientInsurances.Any())
                    {
                        <div class="row" id="supplementary-insurances-list">
                            @foreach (var insurance in Model.PatientInsurances)
                            {
                                <div class="col-md-6 col-lg-4 mb-3 fade-in" data-insurance-item>
                                    <div class="card supplementary-card border-left-info">
                                        <div class="security-indicator">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title medical-primary">
                                                        <i class="fas fa-shield-alt medical-icon"></i>
                                                        @(insurance.SupplementaryInsuranceProviderName ?? insurance.InsuranceProviderName)
                                                    </h6>
                                                    <p class="card-text mb-2">
                                                        <small class="text-muted">
                                                            <i class="fas fa-id-card"></i>
                                                            Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡: @(insurance.SupplementaryPolicyNumber ?? insurance.PolicyNumber)
                                                        </small>
                                                    </p>
                                                    <p class="card-text mb-2">
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar"></i>
                                                            Ø§Ø²: @insurance.StartDate.ToString("yyyy/MM/dd")
                                                            @if (insurance.EndDate.HasValue)
                                                            {
                                                                <span>ØªØ§: @insurance.EndDate.Value.ToString("yyyy/MM/dd")</span>
                                                            }
                                                        </small>
                                                    </p>
                                                </div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="dropdown-menu dropdown-menu-right">
                                                        <a class="dropdown-item" href="#" onclick="editSupplementaryInsurance(@insurance.PatientInsuranceId)">
                                                            <i class="fas fa-edit medical-primary"></i> ÙˆÛŒØ±Ø§ÛŒØ´
                                                        </a>
                                                        <a class="dropdown-item" href="#" onclick="calculateSupplementaryInsurance(@insurance.PatientInsuranceId)">
                                                            <i class="fas fa-calculator medical-secondary"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡
                                                        </a>
                                                        <a class="dropdown-item" href="#" onclick="viewSupplementaryInsuranceDetails(@insurance.PatientInsuranceId)">
                                                            <i class="fas fa-eye medical-primary"></i> Ø¬Ø²Ø¦ÛŒØ§Øª
                                                        </a>
                                                        <div class="dropdown-divider"></div>
                                                        <a class="dropdown-item text-danger" href="#" onclick="deleteSupplementaryInsurance(@insurance.PatientInsuranceId)">
                                                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <span class="badge status-badge badge-@(insurance.IsActive ? "success" : "secondary")">
                                                    <i class="fas fa-@(insurance.IsActive ? "check-circle" : "times-circle")"></i>
                                                    @(insurance.IsActive ? "ÙØ¹Ø§Ù„" : "ØºÛŒØ±ÙØ¹Ø§Ù„")
                                                </span>
                                                <span class="badge coverage-badge badge-info">
                                                    <i class="fas fa-percentage"></i>
                                                    @insurance.CoveragePercent%
                                                </span>
                                                @* MaxPayment removed from PatientInsuranceIndexItemViewModel as it's not part of the entity *@
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h5>
                            <p class="text-muted">Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¬Ø¯ÛŒØ¯ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
<div class="modal fade" id="addSupplementaryInsuranceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt text-primary"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addSupplementaryInsuranceForm">
                    @Html.AntiForgeryToken()
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplementaryProviderId">ØµÙ†Ø¯ÙˆÙ‚ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
                                <select class="form-control" id="supplementaryProviderId" name="SupplementaryInsuranceProviderId" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Ø§Ø¨ØªØ¯Ø§ ØµÙ†Ø¯ÙˆÙ‚ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplementaryPlanId">Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
                                <select class="form-control" id="supplementaryPlanId" name="SupplementaryInsurancePlanId" required disabled>
                                    <option value="">Ø§Ø¨ØªØ¯Ø§ ØµÙ†Ø¯ÙˆÙ‚ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ ØµÙ†Ø¯ÙˆÙ‚ØŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplementaryReferralNumber">Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹Ø±ÙÛŒ Ù†Ø§Ù…Ù‡</label>
                                <input type="text" class="form-control" id="supplementaryReferralNumber" name="SupplementaryPolicyNumber">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹Ø±ÙÛŒ Ù†Ø§Ù…Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplementaryCardNumber">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡</label>
                                <input type="text" class="form-control" id="supplementaryCardNumber" name="CardNumber" maxlength="50">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplementaryPriority">Ø§ÙˆÙ„ÙˆÛŒØª Ø¨ÛŒÙ…Ù‡</label>
                                <select class="form-control" id="supplementaryPriority" name="Priority" required>
                                    <option value="2" selected>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§ÙˆÙ„</option>
                                    <option value="3">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¯ÙˆÙ…</option>
                                    <option value="4">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø³ÙˆÙ…</option>
                                    <option value="5">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ú†Ù‡Ø§Ø±Ù…</option>
                                    <option value="6">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù¾Ù†Ø¬Ù…</option>
                                    <option value="7">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø´Ø´Ù…</option>
                                    <option value="8">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù‡ÙØªÙ…</option>
                                    <option value="9">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù‡Ø´ØªÙ…</option>
                                    <option value="10">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†Ù‡Ù…</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="supplementaryIsActive" name="IsActive" value="true" checked>
                                    <label class="form-check-label" for="supplementaryIsActive">
                                        Ø¨ÛŒÙ…Ù‡ ÙØ¹Ø§Ù„
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Ù†Ú©ØªÙ‡:</strong> Ø§ÛŒÙ† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø³Øª Ùˆ Ù†Ù‡ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ. ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†ÛŒØ§Ø² Ù†ÛŒØ³Øª.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
                    <input type="hidden" name="IsPrimary" value="false" />
                    <input type="hidden" name="PatientId" id="supplementaryPatientId" value="@ViewBag.PatientId" />
                    <input type="hidden" name="IsActive" value="false" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="button" class="btn btn-primary" onclick="saveSupplementaryInsurance()">
                    <i class="fas fa-save"></i>
                    Ø°Ø®ÛŒØ±Ù‡
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
<div class="modal fade" id="calculateSupplementaryInsuranceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calculator text-success"></i>
                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="calculateSupplementaryInsuranceForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="PatientInsuranceId" id="calcPatientInsuranceId" />
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calculationServiceId">Ø®Ø¯Ù…Øª</label>
                                <select class="form-control" id="calculationServiceId" name="ServiceId" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calculationServiceAmount">Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Øª</label>
                                <input type="number" class="form-control" id="calculationServiceAmount" name="ServiceAmount" min="0" step="1000" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calculationPrimaryCoverage">Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ</label>
                                <input type="number" class="form-control" id="calculationPrimaryCoverage" name="PrimaryCoverage" min="0" step="1000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calculationDate">ØªØ§Ø±ÛŒØ® Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
                                <input type="text" class="form-control persian-datepicker" id="calculationDate" name="CalculationDate" required>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="calculationResult" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡:</h6>
                        <div id="calculationDetails"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ø¨Ø³ØªÙ†</button>
                <button type="button" class="btn btn-success" onclick="performCalculation()">
                    <i class="fas fa-calculator"></i>
                    Ù…Ø­Ø§Ø³Ø¨Ù‡
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ğŸ¥ Medical Environment JavaScript - Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø¯Ø±Ù…Ø§Ù†ÛŒ
        
        // Escape HTML Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² XSS
        function escapeHtml(s) { 
            return String(s)
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;')
                .replace(/'/g,'&#039;'); 
        }
        
        $(document).ready(function() {
            console.log('ğŸ¥ MEDICAL: ØµÙØ­Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            
            // Initialize Persian DatePicker
            if ($.fn.persianDatepicker) {
                $('.persian-datepicker').persianDatepicker({
                    format: 'YYYY/MM/DD',
                    observer: true,
                    timePicker: {
                        enabled: false
                    }
                });
            } else {
                console.warn('persianDatepicker not loaded');
            }

            // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Performance
            Promise.all([
                loadSupplementaryInsuranceProviders(),
                loadServicesForCalculation(),
                updateInsuranceCount()
            ]).then(function() {
                console.log('ğŸ¥ MEDICAL: ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            }).catch(function(error) {
                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', error);
                showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡');
            });
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listeners
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Auto-refresh Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ (ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ù†ÛŒØ³Øª)
            setInterval(function() {
                if (!$('.modal.show').length && !document.activeElement.closest('form')) {
                    // TODO: ÙÙ‚Ø· Ù„ÛŒØ³Øª Ø±Ø§ Ø¨Ø§ Ajax ØªØ§Ø²Ù‡ Ú©Ù†ØŒ Ù†Ù‡ Ú©Ù„ ØµÙØ­Ù‡
                    // refreshSupplementaryInsurancesPartial();
                }
            }, 300000); // 5 minutes
            
            // Keyboard shortcuts
            $(document).keydown(function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshSupplementaryInsurances();
                }
            });
        }
        
        function updateInsuranceCount() {
            var count = $('#supplementary-insurances-list [data-insurance-item]').length;
            $('#insuranceCount').text(count);
            console.log('ğŸ¥ MEDICAL: ØªØ¹Ø¯Ø§Ø¯ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯:', count);
        }

        function showAddSupplementaryInsuranceModal() {
            console.log('ğŸ¥ MEDICAL: Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ...');
            
            // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„
            loadSupplementaryInsuranceProviders().then(function() {
                $('#addSupplementaryInsuranceModal').modal('show');
                console.log('ğŸ¥ MEDICAL: Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
            }).catch(function(error) {
                console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡:', error);
                showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡: ' + error);
            });
        }

        // Event handlers Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
        $(document).ready(function() {
            // Event handler Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
            $('#addSupplementaryInsuranceModal').on('hidden.bs.modal', function() {
                console.log('ğŸ¥ MEDICAL: Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯');
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                $('#addSupplementaryInsuranceForm')[0].reset();
            });
            
            // Event handler Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ù†ØµØ±Ø§Ù
            $('#addSupplementaryInsuranceModal .btn-secondary').on('click', function() {
                console.log('ğŸ¥ MEDICAL: Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ù†ØµØ±Ø§Ù');
                $('#addSupplementaryInsuranceModal').modal('hide');
            });
            
            // Event handler Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ X
            $('#addSupplementaryInsuranceModal .close').on('click', function() {
                console.log('ğŸ¥ MEDICAL: Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ X');
                $('#addSupplementaryInsuranceModal').modal('hide');
            });
            
            // Event handler Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØµÙ†Ø¯ÙˆÙ‚ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
            $('#supplementaryProviderId').on('change', function() {
                var providerId = $(this).val();
                console.log('ğŸ¥ MEDICAL: ØµÙ†Ø¯ÙˆÙ‚ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:', providerId);
                
                if (providerId) {
                    // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØµÙ†Ø¯ÙˆÙ‚
                    loadSupplementaryInsurancePlansByProvider(providerId);
                } else {
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø·Ø±Ø­â€ŒÙ‡Ø§
                    $('#supplementaryPlanId').html('<option value="">Ø§Ø¨ØªØ¯Ø§ ØµÙ†Ø¯ÙˆÙ‚ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>').prop('disabled', true);
                }
            });
            
            // Event handler Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
            $('#supplementaryPlanId').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var providerName = selectedOption.data('provider');
                var coveragePercent = selectedOption.data('coverage');
                var planId = $(this).val();
                
                console.log('ğŸ¥ MEDICAL: Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:', {
                    planId: planId,
                    providerName: providerName,
                    coveragePercent: coveragePercent
                });
                
                // ØªÙ†Ø¸ÛŒÙ… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø®ÙÛŒ
                if (planId) {
                    // ØªÙ†Ø¸ÛŒÙ… SupplementaryInsurancePlanId
                    $('#supplementaryPlanId').attr('name', 'SupplementaryInsurancePlanId');
                    
                    console.log('ğŸ¥ MEDICAL: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø®ÙÛŒ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù†Ø¯:', {
                        SupplementaryInsurancePlanId: planId
                    });
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø·Ø±Ø­ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                if ($(this).val()) {
                    console.log('ğŸ¥ MEDICAL: Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡:', providerName, 'Ù¾ÙˆØ´Ø´:', coveragePercent + '%');
                }
            });
        });

        function loadSupplementaryInsuranceProviders() {
            console.log('ğŸ¥ MEDICAL: Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ...');
            
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetSupplementaryInsuranceProviders", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    timeout: 10000, // 10 seconds timeout
                    dataType: 'json',
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Response received:', response);
                        
                        if (response && response.success) {
                            console.log('ğŸ¥ MEDICAL: ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', response.data ? response.data.length : 0);
                            
                            var options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                            if (response.data && Array.isArray(response.data)) {
                                $.each(response.data, function(index, provider) {
                                    options += '<option value="' + provider.id + '" data-code="' + escapeHtml(provider.code) + '">' + escapeHtml(provider.name) + '</option>';
                                });
                            }
                            $('#supplementaryProviderId').html(options);
                            
                            // Ø§Ú¯Ø± ÙÙ‚Ø· ÛŒÚ© ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
                            if (response.data && response.data.length === 1) {
                                $('#supplementaryProviderId').val(response.data[0].id).trigger('change');
                                console.log('ğŸ¥ MEDICAL: ØµÙ†Ø¯ÙˆÙ‚ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:', response.data[0].name);
                            }
                            
                            resolve();
                        } else {
                            var errorMessage = response ? response.message : 'Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±';
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡', errorMessage);
                            showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡: ' + errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ (Status: ' + xhr.status + ')');
                        reject(error);
                    }
                });
            });
        }
        
        function loadSupplementaryInsurancePlansByProvider(providerId) {
            console.log('ğŸ¥ MEDICAL: Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØµÙ†Ø¯ÙˆÙ‚:', providerId);
            
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetSupplementaryInsurancePlansByProvider", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    data: { providerId: providerId },
                    timeout: 10000, // 10 seconds timeout
                    dataType: 'json',
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Response received:', response);
                        
                        if (response && response.success) {
                            console.log('ğŸ¥ MEDICAL: Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', response.data ? response.data.length : 0);
                            
                            var options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                            if (response.data && Array.isArray(response.data)) {
                                $.each(response.data, function(index, plan) {
                                    options += '<option value="' + plan.id + '" data-provider="' + escapeHtml(plan.providerName) + '" data-coverage="' + plan.coveragePercent + '">' + escapeHtml(plan.name) + '</option>';
                                });
                            }
                            $('#supplementaryPlanId').html(options).prop('disabled', false);
                            
                            // Ø§Ú¯Ø± ÙÙ‚Ø· ÛŒÚ© Ø·Ø±Ø­ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
                            if (response.data && response.data.length === 1) {
                                $('#supplementaryPlanId').val(response.data[0].id).trigger('change');
                                console.log('ğŸ¥ MEDICAL: Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:', response.data[0].name);
                            }
                            
                            resolve();
                        } else {
                            var errorMessage = response ? response.message : 'Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±';
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', errorMessage);
                            showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ: ' + errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ (Status: ' + xhr.status + ')');
                        reject(error);
                    }
                });
            });
        }
        

        function loadServicesForCalculation() {
            $.ajax({
                url: '@Url.Action("GetActiveServices", "ServiceManagement", new { area = "Admin" })',
                type: 'GET',
                data: { serviceCategoryId: 0 }, // Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª
                success: function(response) {
                    if (response.success) {
                        var options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                        $.each(response.data, function(index, service) {
                            options += '<option value="' + service.id + '">' + service.name + '</option>';
                        });
                        $('#calculationServiceId').html(options);
                    }
                },
                error: function() {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø®Ø¯Ù…Ø§Øª');
                }
            });
        }

        function saveSupplementaryInsurance() {
            console.log('ğŸ¥ MEDICAL: Ø´Ø±ÙˆØ¹ Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ...');
            
            var form = $('#addSupplementaryInsuranceForm');
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
            if (!form[0].checkValidity()) {
                console.error('ğŸ¥ MEDICAL: ÙØ±Ù… Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                form[0].reportValidity();
                return;
            }
            
            
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯ÙˆØ¨Ø§Ø± Ú©Ù„ÛŒÚ©
            var $btn = $('#addSupplementaryInsuranceModal .btn.btn-primary').prop('disabled', true);
            
            var formData = form.serialize(); // ğŸ”¹ ÙÙ‚Ø· Ù‡Ù…ÛŒÙ†
            
            console.log('ğŸ¥ MEDICAL: Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', formData);
            
            $.ajax({
                url: '@Url.Action("AddSupplementaryInsurance", "PatientInsurance", new { area = "Admin" })',
                type: 'POST',
                data: formData,
                dataType: 'json',
                headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').first().val() },
                complete: function(){ $btn.prop('disabled', false); },
                success: function(response) {
                    console.log('ğŸ¥ MEDICAL: Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', response);
                    
                    if (response && response.success) {
                        console.log('ğŸ¥ MEDICAL: Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                        showMedicalSuccess('Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                        $('#addSupplementaryInsuranceModal').modal('hide');
                        
                        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                        form[0].reset();
                        
                        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØµÙØ­Ù‡
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        var errorMessage = response ? response.message : 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ';
                        console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ:', errorMessage);
                        
                        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                        if (response && response.errors) {
                            var errorDetails = Object.keys(response.errors).map(function(key) {
                                return key + ': ' + response.errors[key].join(', ');
                            }).join('; ');
                            console.error('ğŸ¥ MEDICAL: Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:', errorDetails);
                            showMedicalError('Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: ' + errorDetails);
                        } else {
                            showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ: ' + errorMessage);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    
                    var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
                    if (xhr.responseText) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.message) {
                                errorMessage = response.message;
                            }
                        } catch (e) {
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± ØªØ¬Ø²ÛŒÙ‡ Ù¾Ø§Ø³Ø® Ø®Ø·Ø§:', e);
                        }
                    }
                    
                    showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ: ' + errorMessage);
                }
            });
        }

        function calculateSupplementaryInsurance(patientInsuranceId) {
            $('#calcPatientInsuranceId').val(patientInsuranceId);
            $('#calculateSupplementaryInsuranceModal').modal('show');
        }

        function performCalculation() {
            console.log('ğŸ¥ MEDICAL: Ø´Ø±ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ...');
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
            var serviceId = $('#calculationServiceId').val();
            var serviceAmount = $('#calculationServiceAmount').val();
            var primaryCoverage = $('#calculationPrimaryCoverage').val();
            
            if (!serviceId || !serviceAmount || !primaryCoverage) {
                showMedicalError('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }
            
            if (parseFloat(serviceAmount) <= 0) {
                showMedicalError('Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            if (parseFloat(primaryCoverage) < 0) {
                showMedicalError('Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            showLoadingIndicator();
            
            var form = $('#calculateSupplementaryInsuranceForm');
            var formData = form.serialize();
            
            $.ajax({
                url: '@Url.Action("CalculateSupplementaryInsurance", "PatientInsurance", new { area = "Admin" })',
                type: 'POST',
                data: formData,
                timeout: 15000, // 15 seconds timeout
                success: function(response) {
                    hideLoadingIndicator();
                    
                    if (response.success) {
                        console.log('ğŸ¥ MEDICAL: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…ÙˆÙÙ‚', response.data);
                        showCalculationResult(response.data);
                        showMedicalSuccess('Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                    } else {
                        console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', response.message);
                        showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    hideLoadingIndicator();
                    console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', error);
                    
                    // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø®Ø·Ø§
                    var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ';
                    if (xhr.status === 401) {
                        errorMessage = 'Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² - Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² - Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù†ÛŒØ³ØªÛŒØ¯';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± - Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯';
                    } else if (xhr.status === 0) {
                        errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± - Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯';
                    }
                    
                    showMedicalError(errorMessage);
                }
            });
        }

        function showCalculationResult(data) {
            var resultHtml = '<div class="row">';
            resultHtml += '<div class="col-md-6"><strong>Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ:</strong> ' + data.supplementaryCoverage + ' ØªÙˆÙ…Ø§Ù†</div>';
            resultHtml += '<div class="col-md-6"><strong>Ø³Ù‡Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨ÛŒÙ…Ø§Ø±:</strong> ' + data.finalPatientShare + ' ØªÙˆÙ…Ø§Ù†</div>';
            resultHtml += '</div>';
            resultHtml += '<div class="row mt-2">';
            resultHtml += '<div class="col-md-6"><strong>Ú©Ù„ Ù¾ÙˆØ´Ø´:</strong> ' + data.totalCoverage + ' ØªÙˆÙ…Ø§Ù†</div>';
            resultHtml += '<div class="col-md-6"><strong>Ø¯Ø±ØµØ¯ Ú©Ù„ Ù¾ÙˆØ´Ø´:</strong> ' + data.totalCoveragePercent + '%</div>';
            resultHtml += '</div>';
            
            $('#calculationDetails').html(resultHtml);
            $('#calculationResult').show();
        }

        function editSupplementaryInsurance(patientInsuranceId) {
            // Implementation for editing supplementary insurance
            console.log('Edit supplementary insurance:', patientInsuranceId);
        }

        function deleteSupplementaryInsurance(patientInsuranceId) {
            console.log('ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', patientInsuranceId);
            
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\nØ§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) {
                showLoadingIndicator();
                
                $.ajax({
                    url: '@Url.Action("Delete", "PatientInsurance", new { area = "Admin" })',
                    type: 'POST',
                    data: { 
                        id: patientInsuranceId, 
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() 
                    },
                    timeout: 10000,
                    success: function(response) {
                        hideLoadingIndicator();
                        
                        if (response.success) {
                            console.log('ğŸ¥ MEDICAL: Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                            showMedicalSuccess('Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                            location.reload();
                        } else {
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', response.message);
                            showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoadingIndicator();
                        console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ÛŒ AJAX Ø¯Ø± Ø­Ø°Ù Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', error);
                        showMedicalError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ');
                    }
                });
            }
        }
        
        // ğŸ¥ Medical Environment Helper Functions
        function showLoadingIndicator() {
            console.log('ğŸ¥ MEDICAL: Ù†Ù…Ø§ÛŒØ´ loading indicator');
            
            if ($('#loadingOverlay').length === 0) {
                $('body').append(`
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="loading-content">
                            <i class="fas fa-spinner fa-spin fa-3x medical-primary"></i>
                            <h5 class="mt-3 mb-2">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</h5>
                            <p class="text-muted">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
                            <div class="progress mt-3" style="width: 200px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                `);
            }
        }
        
        function hideLoadingIndicator() {
            console.log('ğŸ¥ MEDICAL: Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† loading indicator');
            
            $('#loadingOverlay').fadeOut(300, function() {
                $(this).remove();
            });
        }
        
        function showMedicalError(message) {
            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§', message);
            
            if (typeof toastr !== 'undefined') {
                toastr.error(message, 'Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ù…Ø§Ù†ÛŒ', {
                    timeOut: 8000,
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-top-right',
                    showMethod: 'slideDown',
                    hideMethod: 'slideUp'
                });
            } else {
                alert('ğŸ¥ Ø®Ø·Ø§: ' + message);
            }
        }
        
        function showMedicalSuccess(message) {
            console.log('ğŸ¥ MEDICAL: Ù…ÙˆÙÙ‚ÛŒØª', message);
            
            if (typeof toastr !== 'undefined') {
                toastr.success(message, 'Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚', {
                    timeOut: 5000,
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-top-right'
                });
            } else {
                alert('ğŸ¥ Ù…ÙˆÙÙ‚ÛŒØª: ' + message);
            }
        }
        
        function showMedicalWarning(message) {
            console.log('ğŸ¥ MEDICAL: Ù‡Ø´Ø¯Ø§Ø±', message);
            
            if (typeof toastr !== 'undefined') {
                toastr.warning(message, 'Ù‡Ø´Ø¯Ø§Ø±', {
                    timeOut: 8000,
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-top-right'
                });
            } else {
                alert('ğŸ¥ Ù‡Ø´Ø¯Ø§Ø±: ' + message);
            }
        }
        
        function refreshSupplementaryInsurances() {
            console.log('ğŸ¥ MEDICAL: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ...');
            location.reload();
        }
        
        function viewSupplementaryInsuranceDetails(patientInsuranceId) {
            console.log('ğŸ¥ MEDICAL: Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ', patientInsuranceId);
            // TODO: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª
            showMedicalSuccess('Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
        }
    </script>
}
