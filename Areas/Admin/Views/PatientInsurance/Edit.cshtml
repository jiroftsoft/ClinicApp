@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceCreateEditViewModel
@{
    ViewBag.Title = "ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/patient-insurance.css" rel="stylesheet" />
    <link href="~/Content/css/patient-insurance-enhanced.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2-bootstrap4.min.css" rel="stylesheet" />
    
    <!-- ğŸ¥ Medical Environment Specific Styles for Edit -->
    <style>
        .medical-edit-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
        }
        
        .medical-insurance-info h5 {
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .patient-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .patient-name-badge {
            background: #4caf50;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .insurance-plan-badge {
            background: #ff9800;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .medical-form-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .medical-form-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .medical-save-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .medical-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
        }
        
        .medical-details-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        .medical-details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
        }
        
        /* ğŸ¥ Medical Environment: Edit Mode Styles */
        .edit-mode-indicator {
            background: #ff9800;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .patient-avatar-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        .patient-details-complete {
            padding: 1rem 0;
        }
        
        .patient-details-complete h5 {
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .patient-details-complete .row {
            margin-bottom: 0.5rem;
        }
        
        .patient-details-complete strong {
            color: #424242;
            font-weight: 600;
        }
        
        .medical-cancel-btn {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(117, 117, 117, 0.3);
        }
        
        .medical-cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(117, 117, 117, 0.4);
        }
        
        .medical-form-help {
            margin-top: 1.5rem;
        }
        
        .medical-form-help .alert {
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #2196f3;
        }
        
        .medical-form-help .alert ul {
            margin: 0.5rem 0 0 1rem;
        }
        
        .medical-form-help .alert li {
            margin-bottom: 0.25rem;
            color: #1976d2;
        }
        
        /* Loading States for Edit */
        .medical-loading {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
        }
        
        .medical-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4caf50;
            border-radius: 50%;
            animation: medical-spin 1s linear infinite;
        }
        
        @@keyframes medical-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced Form Controls for Edit */
        .medical-form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .medical-form-control:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            background: #f8fff8;
        }
        
        .medical-form-control.is-invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 0.2rem rgba(244, 67, 54, 0.25);
        }
        
        /* Responsive Design for Edit */
        @@media (max-width: 768px) {
            .medical-edit-header {
                padding: 1rem;
            }
            
            .medical-form-container {
                padding: 1rem;
            }
            
            .medical-form-actions .d-flex {
                flex-direction: column;
            }
            
            .medical-save-btn,
            .medical-details-btn,
            .medical-cancel-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
}

<div class="container-fluid">
    <!-- ğŸ¥ Medical Environment: Edit Header -->
    <div class="medical-edit-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="medical-insurance-info">
                    <h5 class="mb-2">
                                <i class="fas fa-edit mr-2"></i>
                        ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±
                    </h5>
                                    <div class="patient-details">
                        <span class="patient-name-badge">
                            <i class="fas fa-user mr-1"></i>
                            @Model.PatientName
                        </span>
                        <span class="insurance-plan-badge">
                            <i class="fas fa-shield-alt mr-1"></i>
                            @Model.InsurancePlanName
                        </span>
                                    </div>
                                </div>
                            </div>
            <div class="col-md-4 text-end">
                <div class="medical-status-indicators">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check-circle me-1"></i>
                        ÙØ¹Ø§Ù„
                                        </span>
                    <span class="badge bg-info">
                        <i class="fas fa-calendar me-1"></i>
                        @Model.StartDateShamsi
                                        </span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            
    <!-- ğŸ¥ Medical Environment: Edit Form -->
    <div class="medical-form-container">
                        @using (Html.BeginForm("EditAjax", "PatientInsurance", FormMethod.Post, new { 
                            @class = "needs-validation medical-form", 
                            novalidate = "novalidate",
                            id = "patientInsuranceEditForm",
                            data_medical_form = "patient-insurance-edit"
                        }))
                        {
                            @Html.AntiForgeryToken()
                            <!-- ğŸ¥ Medical Environment: Essential Hidden Fields Only -->
            @Html.HiddenFor(m => m.PatientInsuranceId)
            @Html.HiddenFor(m => m.PatientId)
            @Html.HiddenFor(m => m.IsPrimary)
            @Html.HiddenFor(m => m.IsActive)

                            @Html.Partial("_PatientInsuranceForm", Model)

                            <!-- ğŸ¥ Medical Environment: Change Tracking -->
                            <div class="change-tracking" id="changeTracking" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="fas fa-history"></i> ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
                                </h6>
                                <div id="changeList">
                                    <!-- Changes will be tracked here -->
                                </div>
                            </div>

                            <!-- ğŸ¥ Medical Environment Form Actions -->
                            <div class="form-actions medical-form-actions">
                                <div class="d-flex justify-content-center gap-3 flex-wrap">
                                    <button type="submit" class="btn btn-success btn-lg medical-save-btn" id="saveEditButton">
                                        <i class="fas fa-save me-2"></i> Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                                    </button>
                                    <a href="@Url.Action("Details", "PatientInsurance", new { id = Model.PatientInsuranceId })" class="btn btn-info btn-lg medical-details-btn">
                                        <i class="fas fa-eye me-2"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                                    </a>
                                    <a href="@Url.Action("Index", "PatientInsurance")" class="btn btn-secondary btn-lg medical-cancel-btn">
                                        <i class="fas fa-times me-2"></i> Ø§Ù†ØµØ±Ø§Ù
                                    </a>
                                </div>
                                
                                <!-- ğŸ¥ Medical Environment Loading Indicator -->
                                <div class="text-center mt-3" id="editLoadingIndicator" style="display: none;">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="sr-only">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±...</p>
                                </div>
                                
                                <!-- Medical Environment Form Help -->
                                <div class="form-help medical-form-help">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´:</strong>
                                        <ul class="mb-0 mt-2">
                            <li>ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ùˆ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª</li>
                            <li>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯</li>
                            <li>ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨ÛŒÙ…Ù‡ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù‡Ø³ØªÙ†Ø¯</li>
                            <li>Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø± ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
    </div>
</div>

@section Scripts {
    <script src="~/Content/plugins/select2/js/select2.min.js"></script>
    <script src="~/Content/plugins/select2/js/fa.js"></script>
    <script src="~/Scripts/app/patient-insurance-enhanced.js"></script>
    
    <script>
        // ğŸ¥ Medical Environment: Safe Model Data Injection
        const modelData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
        
        $(document).ready(function() {
            console.log('ğŸ¥ Medical Environment: Initializing Patient Insurance Edit Form');
                        
            // Initialize Enhanced Patient Insurance for Edit
            if (typeof PatientInsuranceEnhanced !== 'undefined') {
                PatientInsuranceEnhanced.initializeEditForm();
            }
            
            // ğŸ¥ Medical Environment: Edit Form Specific Initialization
            initializeEditForm();
            
            // ğŸ¥ Medical Environment: Insurance Provider Change Handlers
            // initializeInsuranceProviderChangeHandlers(); // Ø­Ø°Ù Ø´Ø¯Ù‡ - Event Handlers Ø¯Ø± patient-insurance-enhanced.js ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
                        
            // ğŸ¥ Medical Environment: Change Tracking
            initializeChangeTracking();
                        
            // ğŸ¥ Medical Environment: Form Submission
            initializeFormSubmission();
        });

        // ğŸ¥ Medical Environment: Initialize Insurance Provider Change Handlers
        function initializeInsuranceProviderChangeHandlers() {
            console.log('ğŸ¥ Medical Environment: Initializing Insurance Provider Change Handlers');
            
            // ğŸ¥ Medical Environment: Primary Insurance Provider Change Handler
            $('#InsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#InsurancePlanId');
                
                console.log('ğŸ¥ Medical Environment: Primary insurance provider changed:', providerId);
                
                if (providerId) {
                    // Clear current plan selection
                    $planSelect.empty().append('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡...</option>').prop('disabled', true);
                    
                    // Load insurance plans for the selected provider
                    loadInsurancePlans(providerId, $planSelect, 'primary').then(function() {
                        console.log('ğŸ¥ Medical Environment: Primary insurance plans loaded successfully');
                        $planSelect.prop('disabled', false);
                    }).catch(function(error) {
                        console.error('ğŸ¥ Medical Environment: Error loading primary insurance plans:', error);
                        $planSelect.empty().append('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</option>').prop('disabled', true);
                    });
                } else {
                    // Clear plan selection if no provider selected
                    $planSelect.empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>').prop('disabled', true);
                }
            });
            
            // ğŸ¥ Medical Environment: Supplementary Insurance Provider Change Handler
            $('#SupplementaryInsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#SupplementaryInsurancePlanId');
                
                console.log('ğŸ¥ Medical Environment: Supplementary insurance provider changed:', providerId);
                
                if (providerId) {
                    // Clear current plan selection
                    $planSelect.empty().append('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡...</option>').prop('disabled', true);
                    
                    // Load insurance plans for the selected provider
                    loadInsurancePlans(providerId, $planSelect, 'supplementary').then(function() {
                        console.log('ğŸ¥ Medical Environment: Supplementary insurance plans loaded successfully');
                        $planSelect.prop('disabled', false);
                    }).catch(function(error) {
                        console.error('ğŸ¥ Medical Environment: Error loading supplementary insurance plans:', error);
                        $planSelect.empty().append('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</option>').prop('disabled', true);
                    });
                } else {
                    // Clear plan selection if no provider selected
                    $planSelect.empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>').prop('disabled', true);
                }
            });
        }

        // ğŸ¥ Medical Environment: Initialize Edit Form
        function initializeEditForm() {
            console.log('ğŸ¥ Medical Environment: Initializing Edit Form with Model Data');
            
            // ğŸ¥ Medical Environment: Load Patient Information First
            loadPatientInformation();
            
            // Initialize Enhanced Patient Insurance
            if (typeof PatientInsuranceEnhanced !== 'undefined') {
                PatientInsuranceEnhanced.initializeInsuranceSelection();
            }
            
            // ğŸ¥ Medical Environment: Load data every time for real-time medical environment
            function loadFormData() {
                console.log('ğŸ¥ MEDICAL: Loading form data for real-time medical environment...');
                
                // ğŸ¥ Medical Environment: Load both primary and supplementary insurance providers in parallel for real-time medical environment
                Promise.all([
                    loadPrimaryInsuranceProviders(),
                    loadSupplementaryInsuranceProviders()
                ]).then(function(results) {
                    console.log('ğŸ¥ MEDICAL: Both providers loaded successfully');
                    
                    // ğŸ¥ Medical Environment: Set primary insurance provider immediately
                    if (modelData.InsuranceProviderId && modelData.InsuranceProviderId !== 0) {
                        console.log('ğŸ¥ MEDICAL: Setting primary provider:', modelData.InsuranceProviderId);
                        $('#InsuranceProviderId').val(modelData.InsuranceProviderId).trigger('change');
                        
                        // Load primary insurance plans immediately
                        loadInsurancePlans(modelData.InsuranceProviderId, $('#InsurancePlanId'), 'primary').then(function() {
                            if (modelData.InsurancePlanId && modelData.InsurancePlanId !== 0) {
                                $('#InsurancePlanId').val(modelData.InsurancePlanId).trigger('change');
                            }
                            showInsuranceStatus('primary', 'loaded');
                        });
                    } else {
                        showInsuranceStatus('primary', 'empty');
                    }
                    
                    // ğŸ¥ Medical Environment: Set supplementary insurance provider immediately
                    if (modelData.SupplementaryInsuranceProviderId && modelData.SupplementaryInsuranceProviderId !== 0) {
                        console.log('ğŸ¥ MEDICAL: Setting supplementary provider:', modelData.SupplementaryInsuranceProviderId);
                        $('#SupplementaryInsuranceProviderId').val(modelData.SupplementaryInsuranceProviderId).trigger('change');
                        
                        // Load supplementary insurance plans immediately
                        loadInsurancePlans(modelData.SupplementaryInsuranceProviderId, $('#SupplementaryInsurancePlanId'), 'supplementary').then(function() {
                            if (modelData.SupplementaryInsurancePlanId && modelData.SupplementaryInsurancePlanId !== 0) {
                                $('#SupplementaryInsurancePlanId').val(modelData.SupplementaryInsurancePlanId).trigger('change');
                            }
                            showInsuranceStatus('supplementary', 'loaded');
                        });
                    } else {
                        showInsuranceStatus('supplementary', 'empty');
                    }
                }).catch(function(error) {
                    console.error('ğŸ¥ MEDICAL: Error loading providers:', error);
                    showInsuranceStatus('primary', 'error');
                    showInsuranceStatus('supplementary', 'error');
                });
            }
            
            // ğŸ¥ Medical Environment: Load data immediately for real-time medical environment
            loadFormData();
            
            // ğŸ¥ Medical Environment: Reload data on page focus for real-time updates
            $(window).on('focus', function() {
                console.log('ğŸ¥ MEDICAL: Page focused, reloading data for real-time medical environment...');
                // ğŸ¥ Medical Environment: Reset form state for real-time medical environment
                $('#InsuranceProviderId').val('').trigger('change');
                $('#InsurancePlanId').val('').trigger('change');
                $('#SupplementaryInsuranceProviderId').val('').trigger('change');
                $('#SupplementaryInsurancePlanId').val('').trigger('change');
                loadFormData();
            });
            
            // ğŸ¥ Medical Environment: Real-time data refresh every 30 seconds for medical environment
            setInterval(function() {
                console.log('ğŸ¥ MEDICAL: Real-time data refresh for medical environment...');
                loadFormData();
            }, 30000); // 30 seconds for real-time medical environment
            
            // ğŸ¥ Medical Environment: Set form values immediately for real-time medical environment
            console.log('ğŸ¥ MEDICAL: Setting form values immediately...');
            
            // Set policy numbers
            if (modelData.PolicyNumber) {
                $('#PolicyNumber').val(modelData.PolicyNumber);
                console.log('ğŸ¥ MEDICAL: Policy number set:', modelData.PolicyNumber);
            }
            
            if (modelData.SupplementaryPolicyNumber) {
                $('#SupplementaryPolicyNumber').val(modelData.SupplementaryPolicyNumber);
                console.log('ğŸ¥ MEDICAL: Supplementary policy number set:', modelData.SupplementaryPolicyNumber);
            }
            
            // Set dates
            if (modelData.StartDateShamsi) {
                $('#StartDateShamsi').val(modelData.StartDateShamsi);
                console.log('ğŸ¥ MEDICAL: Start date set:', modelData.StartDateShamsi);
            }
            
            if (modelData.EndDateShamsi) {
                $('#EndDateShamsi').val(modelData.EndDateShamsi);
                console.log('ğŸ¥ MEDICAL: End date set:', modelData.EndDateShamsi);
            }
            
            // Set model values for debugging
            console.log('ğŸ¥ MEDICAL: Model values:', {
                InsuranceProviderId: modelData.InsuranceProviderId,
                InsurancePlanId: modelData.InsurancePlanId,
                SupplementaryInsuranceProviderId: modelData.SupplementaryInsuranceProviderId,
                SupplementaryInsurancePlanId: modelData.SupplementaryInsurancePlanId,
                PolicyNumber: modelData.PolicyNumber,
                SupplementaryPolicyNumber: modelData.SupplementaryPolicyNumber
            });
            
            // Initialize change tracking after all values are set
            initializeChangeTracking();
        }

        // ğŸ¥ Medical Environment: Load Patient Information
        function loadPatientInformation() {
            console.log('ğŸ¥ Medical Environment: Loading patient information...');
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± header
            var patientInfo = {
                name: modelData.PatientName,
                nationalCode: modelData.PatientNationalCode,
                phone: modelData.PatientPhone,
                birthDate: modelData.PatientBirthDate
            };
            
            console.log('ğŸ¥ Medical Environment: Patient info loaded:', patientInfo);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
            updatePatientDisplay(patientInfo);
        }

        // ğŸ¥ Medical Environment: Update Patient Display
        function updatePatientDisplay(patientInfo) {
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± header
            if (patientInfo.name) {
                $('.patient-name-badge').html('<i class="fas fa-user me-1"></i>' + patientInfo.name);
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø±
            if (patientInfo.nationalCode) {
                $('#selectedPatientNationalCode').text(patientInfo.nationalCode);
            }
            
            if (patientInfo.phone) {
                $('#selectedPatientPhone').text(patientInfo.phone);
            }
            
            if (patientInfo.birthDate) {
                $('#selectedPatientBirthDate').text(patientInfo.birthDate);
            }
            
            console.log('ğŸ¥ Medical Environment: Patient display updated');
        }

        // ğŸ¥ Medical Environment: Show Insurance Status
        function showInsuranceStatus(type, status) {
            var statusElement = $('#' + type + 'InsuranceStatus');
            var statusText = '';
            var statusClass = '';
            
            switch (status) {
                case 'loaded':
                    statusText = 'âœ… ' + (type === 'primary' ? 'Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡' : 'Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ') + ' Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯';
                    statusClass = 'text-success';
                    break;
                case 'empty':
                    statusText = 'âš ï¸ ' + (type === 'primary' ? 'Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡' : 'Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ') + ' ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡';
                    statusClass = 'text-warning';
                    break;
                case 'error':
                    statusText = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ' + (type === 'primary' ? 'Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡' : 'Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ');
                    statusClass = 'text-danger';
                    break;
                default:
                    statusText = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';
                    statusClass = 'text-info';
            }
            
            if (statusElement.length) {
                statusElement.html('<small class="' + statusClass + '">' + statusText + '</small>');
            } else {
                // Ø§ÛŒØ¬Ø§Ø¯ element Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                var statusHtml = '<div id="' + type + 'InsuranceStatus" class="mt-2"><small class="' + statusClass + '">' + statusText + '</small></div>';
                $('#' + type + 'InsuranceContent').append(statusHtml);
            }
            
            console.log('ğŸ¥ Medical Environment: ' + type + ' insurance status:', status);
        }

        // ğŸ¥ Medical Environment: Load Primary Insurance Providers
        function loadPrimaryInsuranceProviders() {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetPrimaryInsuranceProviders", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // ğŸ¥ Medical Environment: Disable cache for real-time data
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Primary Providers Response:', response);
                        
                        if (response && response.success) {
                            var $select = $('#InsuranceProviderId');
                            $select.empty();
                            $select.append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(provider) {
                                    $select.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                                });
                            }
                            
                            $select.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù† Ù¾Ø§ÛŒÙ‡';
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù† Ù¾Ø§ÛŒÙ‡:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: AJAX Error in Primary Providers:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }

        // ğŸ¥ Medical Environment: Load Supplementary Insurance Providers
        function loadSupplementaryInsuranceProviders() {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetSupplementaryInsuranceProviders", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // ğŸ¥ Medical Environment: Disable cache for real-time data
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Supplementary Providers Response:', response);
                        
                        if (response && response.success) {
                            var $select = $('#SupplementaryInsuranceProviderId');
                            $select.empty();
                            $select.append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(provider) {
                                    $select.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                                });
                            }
                            
                            $select.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù† ØªÚ©Ù…ÛŒÙ„ÛŒ';
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù† ØªÚ©Ù…ÛŒÙ„ÛŒ:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: AJAX Error in Supplementary Providers:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }

        // ğŸ¥ Medical Environment: Load Insurance Plans
        function loadInsurancePlans(providerId, $planSelect, type) {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetInsurancePlansByProvider", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // ğŸ¥ Medical Environment: Disable cache for real-time data
                    data: { providerId: providerId, type: type },
                    success: function(response) {
                        console.log('ğŸ¥ MEDICAL: Insurance Plans Response:', response);
                        
                        if (response && response.success) {
                            $planSelect.empty();
                            $planSelect.append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(plan) {
                                    $planSelect.append('<option value="' + plan.id + '">' + plan.name + '</option>');
                                });
                                
                                // Auto-select if only one plan is available
                                if (response.data.length === 1) {
                                    $planSelect.val(response.data[0].id).trigger('change');
                                }
                            }
                            
                            $planSelect.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡';
                            console.error('ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL: AJAX Error in Insurance Plans:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error,
                            providerId: providerId,
                            type: type
                        });
                        
                        var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }
            
            // ğŸ¥ Medical Environment: Change Tracking
            function initializeChangeTracking() {
                    var originalValues = {};
            var $form = $('#patientInsuranceEditForm');
                    
            // Store original values after a delay to ensure all fields are loaded
            setTimeout(function() {
                $form.find('input, select, textarea').each(function() {
                        var $field = $(this);
                    var fieldName = $field.attr('name');
                        if (fieldName) {
                            originalValues[fieldName] = $field.val();
                        }
                    });
                
                console.log('ğŸ¥ Medical Environment: Original values stored:', originalValues);
                    
                    // Track changes
                $form.find('input, select, textarea').on('change', function() {
                        var $field = $(this);
                    var fieldName = $field.attr('name');
                        var currentValue = $field.val();
                        var originalValue = originalValues[fieldName];
                        
                    console.log('ğŸ¥ Medical Environment: Field changed:', fieldName, 'from', originalValue, 'to', currentValue);
                    
                    if (currentValue !== originalValue) {
                            trackChange(fieldName, originalValue, currentValue);
                    } else {
                        removeChange(fieldName);
                        }
                    
                    updateChangeTracking();
                    });
            }, 1500); // Wait for all fields to be loaded
        }
                    
        // ğŸ¥ Medical Environment: XSS Protection - HTML Escape Function
        function escapeHtml(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ğŸ¥ Medical Environment: Track Individual Changes (XSS Protected)
        function trackChange(fieldName, originalValue, currentValue) {
            var changeId = 'change_' + fieldName;
            var $changeItem = $('#' + changeId);
            
            // ğŸ¥ Medical Environment: Escape values to prevent XSS
            var escapedOriginalValue = escapeHtml(originalValue || 'Ø®Ø§Ù„ÛŒ');
            var escapedCurrentValue = escapeHtml(currentValue || 'Ø®Ø§Ù„ÛŒ');
            var escapedFieldName = escapeHtml(getFieldDisplayName(fieldName));
            
            if ($changeItem.length === 0) {
                var changeHtml = `
                    <div class="change-item" id="${changeId}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="change-field">${escapedFieldName}</span>
                            <div class="change-values">
                                <span class="original-value">${escapedOriginalValue}</span>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <span class="new-value">${escapedCurrentValue}</span>
                            </div>
                        </div>
                    </div>
                `;
                $('#changeList').append(changeHtml);
            } else {
                $changeItem.find('.original-value').text(originalValue || 'Ø®Ø§Ù„ÛŒ');
                $changeItem.find('.new-value').text(currentValue || 'Ø®Ø§Ù„ÛŒ');
            }
        }

        // ğŸ¥ Medical Environment: Remove Change
        function removeChange(fieldName) {
            var changeId = 'change_' + fieldName;
            $('#' + changeId).remove();
        }

        // ğŸ¥ Medical Environment: Update Change Tracking Display
        function updateChangeTracking() {
            var $changeTracking = $('#changeTracking');
            var $changeList = $('#changeList');
            
            if ($changeList.children().length > 0) {
                $changeTracking.show();
            } else {
                $changeTracking.hide();
            }
        }

        // ğŸ¥ Medical Environment: Get Field Display Name
        function getFieldDisplayName(fieldName) {
            var fieldNames = {
                'InsuranceProviderId': 'Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡',
                'PrimaryInsuranceProviderId': 'Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡',
                'InsurancePlanId': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡',
                'PrimaryInsurancePlanId': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡',
                'SupplementaryInsuranceProviderId': 'Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ',
                'SupplementaryInsurancePlanId': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ',
                'PolicyNumber': 'Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡',
                'SupplementaryPolicyNumber': 'Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ',
                            'StartDateShamsi': 'ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹',
                'EndDateShamsi': 'ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†'
            };
            
            return fieldNames[fieldName] || fieldName;
        }

        // ğŸ¥ Medical Environment: Form Submission
        function initializeFormSubmission() {
            $('#patientInsuranceEditForm').on('submit', function(e) {
                e.preventDefault();
                
                var $form = $(this);
                var $submitBtn = $('#saveEditButton');
                var $loadingIndicator = $('#editLoadingIndicator');
                
                // Validate form before submission
                if (!validateEditForm()) {
                    showErrorMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                // Show loading state
                $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
                $loadingIndicator.show();
                $form.addClass('medical-loading');
                
                // ğŸ¥ Medical Environment: Use FormData to avoid manual field mapping
                var formDataObj = new FormData($form[0]); // Includes all form fields and CSRF token
                
                // ğŸ¥ Medical Environment: Validate form before submission
                if (!validateEditForm()) {
                    showErrorMessage('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯');
                    $submitBtn.prop('disabled', false).html('<i class="fas fa-save me-1"></i>Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª');
                    $loadingIndicator.hide();
                    $form.removeClass('medical-loading');
                    return;
                }
                
                // Submit form
                        $.ajax({
                    url: $form.attr('action'),
                            type: 'POST',
                    data: formDataObj,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                            success: function(response) {
                        console.log('ğŸ¥ Medical Environment: Form submission response:', response);
                        console.log('ğŸ¥ Medical Environment: Response type:', typeof response);
                        
                        // ğŸ¥ Medical Environment: Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('ğŸ¥ Medical Environment: Parsed response:', parsedResponse);
                            } catch (e) {
                                console.error('ğŸ¥ Medical Environment: JSON parse error:', e);
                                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±');
                                return;
                            }
                        }
                        
                        console.log('ğŸ¥ Medical Environment: Parsed response success:', parsedResponse?.success);
                        console.log('ğŸ¥ Medical Environment: Parsed response message:', parsedResponse?.message);
                        
                        if (parsedResponse && parsedResponse.success === true) {
                            console.log('ğŸ¥ Medical Environment: Success response received');
                            showSuccessMessage('ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                            
                            // Redirect to details page after a short delay
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Details", "PatientInsurance", new { id = Model.PatientInsuranceId })';
                            }, 1500);
                        } else {
                            console.log('ğŸ¥ Medical Environment: Error response received:', parsedResponse);
                            showErrorMessage(parsedResponse?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª');
                        }
                            },
                            error: function(xhr, status, error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª:', error);
                        console.error('Response:', xhr.responseText);
                        showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                    },
                    complete: function() {
                        // Hide loading state
                        $submitBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª');
                        $loadingIndicator.hide();
                        $form.removeClass('medical-loading');
                    }
                });
            });
        }

        // ğŸ¥ Medical Environment: Validate Edit Form
        function validateEditForm() {
            var isValid = true;
            var $form = $('#patientInsuranceEditForm');
            var errors = [];
            
            console.log('ğŸ¥ Medical Environment: Validating edit form...');
            
            // Validate required fields
            var requiredFields = [
                'InsuranceProviderId',
                'InsurancePlanId',
                'StartDateShamsi'
            ];
            
            requiredFields.forEach(function(fieldName) {
                var $field = $form.find('[name="' + fieldName + '"]');
                if ($field.length && !$field.val()) {
                    $field.addClass('is-invalid');
                    isValid = false;
                    errors.push('ÙÛŒÙ„Ø¯ ' + getFieldDisplayName(fieldName) + ' Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    console.log('ğŸ¥ Medical Environment: Required field validation failed:', fieldName);
                } else {
                    $field.removeClass('is-invalid');
                }
            });
            
            // Validate supplementary insurance if provided
            var supplementaryProvider = $('#SupplementaryInsuranceProviderId').val();
            var supplementaryPlan = $('#SupplementaryInsurancePlanId').val();
            
            if (supplementaryProvider && !supplementaryPlan) {
                $('#SupplementaryInsurancePlanId').addClass('is-invalid');
                isValid = false;
                errors.push('Ø§Ú¯Ø± Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†ÛŒØ² Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                console.log('ğŸ¥ Medical Environment: Supplementary provider without plan');
            } else {
                $('#SupplementaryInsurancePlanId').removeClass('is-invalid');
            }
            
            if (!supplementaryProvider && supplementaryPlan) {
                $('#SupplementaryInsuranceProviderId').addClass('is-invalid');
                isValid = false;
                errors.push('Ø§Ú¯Ø± Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†ÛŒØ² Ø¨Ø§ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                console.log('ğŸ¥ Medical Environment: Supplementary plan without provider');
            } else {
                $('#SupplementaryInsuranceProviderId').removeClass('is-invalid');
            }
            
            // ğŸ¥ Medical Environment: Show validation errors
            if (!isValid) {
                var errorMessage = 'Ù„Ø·ÙØ§Ù‹ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯:\n' + errors.join('\n');
                showErrorMessage(errorMessage);
                console.log('ğŸ¥ Medical Environment: Validation errors:', errors);
            } else {
                console.log('ğŸ¥ Medical Environment: Form validation passed');
            }
            
            return isValid;
            }

        // ğŸ¥ Medical Environment: Get Field Display Name
        function getFieldDisplayName(fieldName) {
            var displayNames = {
                'InsuranceProviderId': 'Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡',
                'InsurancePlanId': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡',
                'SupplementaryInsuranceProviderId': 'Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ',
                'SupplementaryInsurancePlanId': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ',
                'StartDateShamsi': 'ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹',
                'EndDateShamsi': 'ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†',
                'PolicyNumber': 'Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡',
                'SupplementaryPolicyNumber': 'Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹Ø±ÙÛŒ Ù†Ø§Ù…Ù‡'
            };
            
            return displayNames[fieldName] || fieldName;
        }
            
            // ğŸ¥ Medical Environment: Show Success Message
        function showSuccessMessage(message) {
                var alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                $('.medical-form-container').prepend(alertHtml);
                
                setTimeout(function() {
                    $('.alert-success').fadeOut();
                }, 5000);
            }
            
            // ğŸ¥ Medical Environment: Show Error Message
        function showErrorMessage(message) {
                var alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                $('.medical-form-container').prepend(alertHtml);
                
                setTimeout(function() {
                    $('.alert-danger').fadeOut();
                }, 5000);
            }
    </script>
}
