@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceCreateEditViewModel
@{
    ViewBag.Title = "Ÿà€åÿ±ÿß€åÿ¥ ÿ®€åŸÖŸá ÿ®€åŸÖÿßÿ±";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/patient-insurance.css" rel="stylesheet" />
    <link href="~/Content/css/patient-insurance-enhanced.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2-bootstrap4.min.css" rel="stylesheet" />
    
    <!-- üè• Medical Environment Specific Styles for Edit -->
    <style>
        .medical-edit-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
        }
        
        .medical-insurance-info h5 {
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .patient-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .patient-name-badge {
            background: #4caf50;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .insurance-plan-badge {
            background: #ff9800;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .medical-form-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .medical-form-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .medical-save-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .medical-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
        }
        
        .medical-details-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        .medical-details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
        }
        
        /* üè• Medical Environment: Edit Mode Styles */
        .edit-mode-indicator {
            background: #ff9800;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .patient-avatar-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        .patient-details-complete {
            padding: 1rem 0;
        }
        
        .patient-details-complete h5 {
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .patient-details-complete .row {
            margin-bottom: 0.5rem;
        }
        
        .patient-details-complete strong {
            color: #424242;
            font-weight: 600;
        }
        
        .medical-cancel-btn {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(117, 117, 117, 0.3);
        }
        
        .medical-cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(117, 117, 117, 0.4);
        }
        
        .medical-form-help {
            margin-top: 1.5rem;
        }
        
        .medical-form-help .alert {
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #2196f3;
        }
        
        .medical-form-help .alert ul {
            margin: 0.5rem 0 0 1rem;
        }
        
        .medical-form-help .alert li {
            margin-bottom: 0.25rem;
            color: #1976d2;
        }
        
        /* Loading States for Edit */
        .medical-loading {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
        }
        
        .medical-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4caf50;
            border-radius: 50%;
            animation: medical-spin 1s linear infinite;
        }
        
        @@keyframes medical-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced Form Controls for Edit */
        .medical-form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .medical-form-control:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            background: #f8fff8;
        }
        
        .medical-form-control.is-invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 0.2rem rgba(244, 67, 54, 0.25);
        }
        
        /* Responsive Design for Edit */
        @@media (max-width: 768px) {
            .medical-edit-header {
                padding: 1rem;
            }
            
            .medical-form-container {
                padding: 1rem;
            }
            
            .medical-form-actions .d-flex {
                flex-direction: column;
            }
            
            .medical-save-btn,
            .medical-details-btn,
            .medical-cancel-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
}

<div class="container-fluid">
    <!-- üè• Medical Environment: Edit Header -->
    <div class="medical-edit-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="medical-insurance-info">
                    <h5 class="mb-2">
                                <i class="fas fa-edit mr-2"></i>
                        Ÿà€åÿ±ÿß€åÿ¥ ÿ®€åŸÖŸá ÿ®€åŸÖÿßÿ±
                    </h5>
                                    <div class="patient-details">
                        <span class="patient-name-badge">
                            <i class="fas fa-user mr-1"></i>
                            @Model.PatientName
                        </span>
                        <span class="insurance-plan-badge">
                            <i class="fas fa-shield-alt mr-1"></i>
                            @Model.InsurancePlanName
                        </span>
                                    </div>
                                </div>
                            </div>
            <div class="col-md-4 text-end">
                <div class="medical-status-indicators">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check-circle me-1"></i>
                        ŸÅÿπÿßŸÑ
                                        </span>
                    <span class="badge bg-info">
                        <i class="fas fa-calendar me-1"></i>
                        @Model.StartDateShamsi
                                        </span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            
    <!-- üè• Medical Environment: Edit Form -->
    <div class="medical-form-container">
                        @using (Html.BeginForm("EditAjax", "PatientInsurance", FormMethod.Post, new { 
                            @class = "needs-validation medical-form", 
                            novalidate = "novalidate",
                            id = "patientInsuranceEditForm",
                            data_medical_form = "patient-insurance-edit"
                        }))
                        {
                            @Html.AntiForgeryToken()
                            <!-- üè• Medical Environment: Essential Hidden Fields Only -->
            @Html.HiddenFor(m => m.PatientInsuranceId)
            @Html.HiddenFor(m => m.PatientId)
            @Html.HiddenFor(m => m.IsPrimary)
            @Html.HiddenFor(m => m.IsActive)

                            @Html.Partial("_PatientInsuranceForm", Model)

                            <!-- üè• Medical Environment: Change Tracking -->
                            <div class="change-tracking" id="changeTracking" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="fas fa-history"></i> ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØŸá
                                </h6>
                                <div id="changeList">
                                    <!-- Changes will be tracked here -->
                                </div>
                            </div>

                            <!-- üè• Medical Environment Form Actions -->
                            <div class="form-actions medical-form-actions">
                                <div class="d-flex justify-content-center gap-3 flex-wrap">
                                    <button type="submit" class="btn btn-success btn-lg medical-save-btn" id="saveEditButton">
                                        <i class="fas fa-save me-2"></i> ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™
                                    </button>
                                    <a href="@Url.Action("Details", "PatientInsurance", new { id = Model.PatientInsuranceId })" class="btn btn-info btn-lg medical-details-btn">
                                        <i class="fas fa-eye me-2"></i> ŸÖÿ¥ÿßŸáÿØŸá ÿ¨ÿ≤ÿ¶€åÿßÿ™
                                    </a>
                                    <a href="@Url.Action("Index", "PatientInsurance")" class="btn btn-secondary btn-lg medical-cancel-btn">
                                        <i class="fas fa-times me-2"></i> ÿßŸÜÿµÿ±ÿßŸÅ
                                    </a>
                                </div>
                                
                                <!-- üè• Medical Environment Loading Indicator -->
                                <div class="text-center mt-3" id="editLoadingIndicator" style="display: none;">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="sr-only">ÿØÿ± ÿ≠ÿßŸÑ ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™...</span>
                                    </div>
                                    <p class="mt-2 text-muted">ÿØÿ± ÿ≠ÿßŸÑ ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿ®€åŸÖŸá ÿ®€åŸÖÿßÿ±...</p>
                                </div>
                                
                                <!-- Medical Environment Form Help -->
                                <div class="form-help medical-form-help">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>ÿ±ÿßŸáŸÜŸÖÿß€å Ÿà€åÿ±ÿß€åÿ¥:</strong>
                                        <ul class="mb-0 mt-2">
                            <li>ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿØÿ± ŸÅ€åŸÑÿØŸáÿß€å ÿ®€åŸÖŸá Ÿæÿß€åŸá Ÿà ÿ™⁄©ŸÖ€åŸÑ€å ŸÇÿßÿ®ŸÑ Ÿà€åÿ±ÿß€åÿ¥ ÿßÿ≥ÿ™</li>
                            <li>ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å ÿßÿÆÿ™€åÿßÿ±€å ÿßÿ≥ÿ™ Ÿà ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ŸÜ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØ</li>
                            <li>ÿ™ÿßÿ±€åÿÆ‚ÄåŸáÿß€å ÿ¥ÿ±Ÿàÿπ Ÿà Ÿæÿß€åÿßŸÜ ÿ®€åŸÖŸá ŸÇÿßÿ®ŸÑ ÿ™ÿ∫€å€åÿ± Ÿáÿ≥ÿ™ŸÜÿØ</li>
                            <li>ÿ¥ŸÖÿßÿ±Ÿá ÿ®€åŸÖŸá‚ÄåŸÜÿßŸÖŸá ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ⁄©ÿØ ŸÖŸÑ€å ÿ®€åŸÖÿßÿ± ÿ™ŸÜÿ∏€åŸÖ ŸÖ€å‚Äåÿ¥ŸàÿØ</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
    </div>
</div>

@section Scripts {
    <script src="~/Content/plugins/select2/js/select2.min.js"></script>
    <script src="~/Content/plugins/select2/js/fa.js"></script>
    <script src="~/Scripts/app/patient-insurance-enhanced.js"></script>
    
    <script>
        // üè• Medical Environment: Safe Model Data Injection
        const modelData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
        
        $(document).ready(function() {
            console.log('üè• Medical Environment: Initializing Patient Insurance Edit Form');
                        
            // Initialize Enhanced Patient Insurance for Edit
            if (typeof PatientInsuranceEnhanced !== 'undefined') {
                PatientInsuranceEnhanced.initializeEditForm();
            }
            
            // üè• Medical Environment: Edit Form Specific Initialization
            initializeEditForm();
            
            // üè• Medical Environment: Insurance Provider Change Handlers
            // initializeInsuranceProviderChangeHandlers(); // ÿ≠ÿ∞ŸÅ ÿ¥ÿØŸá - Event Handlers ÿØÿ± patient-insurance-enhanced.js ÿ™ÿπÿ±€åŸÅ ÿ¥ÿØŸá‚ÄåÿßŸÜÿØ
                        
            // üè• Medical Environment: Change Tracking
            initializeChangeTracking();
                        
            // üè• Medical Environment: Form Submission
            initializeFormSubmission();
        });

        // üè• Medical Environment: Initialize Insurance Provider Change Handlers
        function initializeInsuranceProviderChangeHandlers() {
            console.log('üè• Medical Environment: Initializing Insurance Provider Change Handlers');
            
            // üè• Medical Environment: Primary Insurance Provider Change Handler
            $('#InsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#InsurancePlanId');
                
                console.log('üè• Medical Environment: Primary insurance provider changed:', providerId);
                
                if (providerId) {
                    // Clear current plan selection
                    $planSelect.empty().append('<option value="">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá...</option>').prop('disabled', true);
                    
                    // Load insurance plans for the selected provider
                    loadInsurancePlans(providerId, $planSelect, 'primary').then(function() {
                        console.log('üè• Medical Environment: Primary insurance plans loaded successfully');
                        $planSelect.prop('disabled', false);
                    }).catch(function(error) {
                        console.error('üè• Medical Environment: Error loading primary insurance plans:', error);
                        $planSelect.empty().append('<option value="">ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá</option>').prop('disabled', true);
                    });
                } else {
                    // Clear plan selection if no provider selected
                    $planSelect.empty().append('<option value="">ÿßÿ®ÿ™ÿØÿß ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>').prop('disabled', true);
                }
            });
            
            // üè• Medical Environment: Supplementary Insurance Provider Change Handler
            $('#SupplementaryInsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#SupplementaryInsurancePlanId');
                
                console.log('üè• Medical Environment: Supplementary insurance provider changed:', providerId);
                
                if (providerId) {
                    // Clear current plan selection
                    $planSelect.empty().append('<option value="">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá...</option>').prop('disabled', true);
                    
                    // Load insurance plans for the selected provider
                    loadInsurancePlans(providerId, $planSelect, 'supplementary').then(function() {
                        console.log('üè• Medical Environment: Supplementary insurance plans loaded successfully');
                        $planSelect.prop('disabled', false);
                    }).catch(function(error) {
                        console.error('üè• Medical Environment: Error loading supplementary insurance plans:', error);
                        $planSelect.empty().append('<option value="">ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá</option>').prop('disabled', true);
                    });
                } else {
                    // Clear plan selection if no provider selected
                    $planSelect.empty().append('<option value="">ÿßÿ®ÿ™ÿØÿß ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option>').prop('disabled', true);
                }
            });
        }

        // üè• Medical Environment: Initialize Edit Form
        function initializeEditForm() {
            console.log('üè• Medical Environment: Initializing Edit Form with Model Data');
            
            // üè• Medical Environment: Load Patient Information First
            loadPatientInformation();
            
            // Initialize Enhanced Patient Insurance
            if (typeof PatientInsuranceEnhanced !== 'undefined') {
                PatientInsuranceEnhanced.initializeInsuranceSelection();
            }
            
            // üè• Medical Environment: Load data every time for real-time medical environment
            function loadFormData() {
                console.log('üè• MEDICAL: Loading form data for real-time medical environment...');
                
                // üè• Medical Environment: Load both primary and supplementary insurance providers in parallel for real-time medical environment
                Promise.all([
                    loadPrimaryInsuranceProviders(),
                    loadSupplementaryInsuranceProviders()
                ]).then(function(results) {
                    console.log('üè• MEDICAL: Both providers loaded successfully');
                    
                    // üè• Medical Environment: Set primary insurance provider immediately
                    if (modelData.InsuranceProviderId && modelData.InsuranceProviderId !== 0) {
                        console.log('üè• MEDICAL: Setting primary provider:', modelData.InsuranceProviderId);
                        $('#InsuranceProviderId').val(modelData.InsuranceProviderId).trigger('change');
                        
                        // Load primary insurance plans immediately
                        loadInsurancePlans(modelData.InsuranceProviderId, $('#InsurancePlanId'), 'primary').then(function() {
                            if (modelData.InsurancePlanId && modelData.InsurancePlanId !== 0) {
                                $('#InsurancePlanId').val(modelData.InsurancePlanId).trigger('change');
                            }
                            showInsuranceStatus('primary', 'loaded');
                        });
                    } else {
                        showInsuranceStatus('primary', 'empty');
                    }
                    
                    // üè• Medical Environment: Set supplementary insurance provider immediately
                    if (modelData.SupplementaryInsuranceProviderId && modelData.SupplementaryInsuranceProviderId !== 0) {
                        console.log('üè• MEDICAL: Setting supplementary provider:', modelData.SupplementaryInsuranceProviderId);
                        $('#SupplementaryInsuranceProviderId').val(modelData.SupplementaryInsuranceProviderId).trigger('change');
                        
                        // Load supplementary insurance plans immediately
                        loadInsurancePlans(modelData.SupplementaryInsuranceProviderId, $('#SupplementaryInsurancePlanId'), 'supplementary').then(function() {
                            if (modelData.SupplementaryInsurancePlanId && modelData.SupplementaryInsurancePlanId !== 0) {
                                $('#SupplementaryInsurancePlanId').val(modelData.SupplementaryInsurancePlanId).trigger('change');
                            }
                            showInsuranceStatus('supplementary', 'loaded');
                        });
                    } else {
                        showInsuranceStatus('supplementary', 'empty');
                    }
                }).catch(function(error) {
                    console.error('üè• MEDICAL: Error loading providers:', error);
                    showInsuranceStatus('primary', 'error');
                    showInsuranceStatus('supplementary', 'error');
                });
            }
            
            // üè• Medical Environment: Load data immediately for real-time medical environment
            loadFormData();
            
            // üè• Medical Environment: Reload data on page focus for real-time updates
            $(window).on('focus', function() {
                console.log('üè• MEDICAL: Page focused, reloading data for real-time medical environment...');
                // üè• Medical Environment: Reset form state for real-time medical environment
                $('#InsuranceProviderId').val('').trigger('change');
                $('#InsurancePlanId').val('').trigger('change');
                $('#SupplementaryInsuranceProviderId').val('').trigger('change');
                $('#SupplementaryInsurancePlanId').val('').trigger('change');
                loadFormData();
            });
            
            // üè• Medical Environment: Real-time data refresh every 30 seconds for medical environment
            setInterval(function() {
                console.log('üè• MEDICAL: Real-time data refresh for medical environment...');
                loadFormData();
            }, 30000); // 30 seconds for real-time medical environment
            
            // üè• Medical Environment: Set form values immediately for real-time medical environment
            console.log('üè• MEDICAL: Setting form values immediately...');
            
            // Set policy numbers
            if (modelData.PolicyNumber) {
                $('#PolicyNumber').val(modelData.PolicyNumber);
                console.log('üè• MEDICAL: Policy number set:', modelData.PolicyNumber);
            }
            
            if (modelData.SupplementaryPolicyNumber) {
                $('#SupplementaryPolicyNumber').val(modelData.SupplementaryPolicyNumber);
                console.log('üè• MEDICAL: Supplementary policy number set:', modelData.SupplementaryPolicyNumber);
            }
            
            // Set dates
            if (modelData.StartDateShamsi) {
                $('#StartDateShamsi').val(modelData.StartDateShamsi);
                console.log('üè• MEDICAL: Start date set:', modelData.StartDateShamsi);
            }
            
            if (modelData.EndDateShamsi) {
                $('#EndDateShamsi').val(modelData.EndDateShamsi);
                console.log('üè• MEDICAL: End date set:', modelData.EndDateShamsi);
            }
            
            // Set model values for debugging
            console.log('üè• MEDICAL: Model values:', {
                InsuranceProviderId: modelData.InsuranceProviderId,
                InsurancePlanId: modelData.InsurancePlanId,
                SupplementaryInsuranceProviderId: modelData.SupplementaryInsuranceProviderId,
                SupplementaryInsurancePlanId: modelData.SupplementaryInsurancePlanId,
                PolicyNumber: modelData.PolicyNumber,
                SupplementaryPolicyNumber: modelData.SupplementaryPolicyNumber
            });
            
            // Initialize change tracking after all values are set
            initializeChangeTracking();
        }

        // üè• Medical Environment: Load Patient Information
        function loadPatientInformation() {
            console.log('üè• Medical Environment: Loading patient information...');
            
            // ŸÜŸÖÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ®€åŸÖÿßÿ± ÿØÿ± header
            var patientInfo = {
                name: modelData.PatientName,
                nationalCode: modelData.PatientNationalCode,
                phone: modelData.PatientPhone,
                birthDate: modelData.PatientBirthDate
            };
            
            console.log('üè• Medical Environment: Patient info loaded:', patientInfo);
            
            // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ŸÜŸÖÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ®€åŸÖÿßÿ±
            updatePatientDisplay(patientInfo);
        }

        // üè• Medical Environment: Update Patient Display
        function updatePatientDisplay(patientInfo) {
            // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ŸÜŸÖÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ®€åŸÖÿßÿ± ÿØÿ± header
            if (patientInfo.name) {
                $('.patient-name-badge').html('<i class="fas fa-user me-1"></i>' + patientInfo.name);
            }
            
            // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™⁄©ŸÖ€åŸÑ€å ÿ®€åŸÖÿßÿ±
            if (patientInfo.nationalCode) {
                $('#selectedPatientNationalCode').text(patientInfo.nationalCode);
            }
            
            if (patientInfo.phone) {
                $('#selectedPatientPhone').text(patientInfo.phone);
            }
            
            if (patientInfo.birthDate) {
                $('#selectedPatientBirthDate').text(patientInfo.birthDate);
            }
            
            console.log('üè• Medical Environment: Patient display updated');
        }

        // üè• Medical Environment: Show Insurance Status
        function showInsuranceStatus(type, status) {
            var statusElement = $('#' + type + 'InsuranceStatus');
            var statusText = '';
            var statusClass = '';
            
            switch (status) {
                case 'loaded':
                    statusText = '‚úÖ ' + (type === 'primary' ? 'ÿ®€åŸÖŸá Ÿæÿß€åŸá' : 'ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å') + ' ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ';
                    statusClass = 'text-success';
                    break;
                case 'empty':
                    statusText = '‚ö†Ô∏è ' + (type === 'primary' ? 'ÿ®€åŸÖŸá Ÿæÿß€åŸá' : 'ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å') + ' ÿ™ÿπÿ±€åŸÅ ŸÜÿ¥ÿØŸá';
                    statusClass = 'text-warning';
                    break;
                case 'error':
                    statusText = '‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ' + (type === 'primary' ? 'ÿ®€åŸÖŸá Ÿæÿß€åŸá' : 'ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å');
                    statusClass = 'text-danger';
                    break;
                default:
                    statusText = '‚è≥ ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...';
                    statusClass = 'text-info';
            }
            
            if (statusElement.length) {
                statusElement.html('<small class="' + statusClass + '">' + statusText + '</small>');
            } else {
                // ÿß€åÿ¨ÿßÿØ element ÿß⁄Øÿ± Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ
                var statusHtml = '<div id="' + type + 'InsuranceStatus" class="mt-2"><small class="' + statusClass + '">' + statusText + '</small></div>';
                $('#' + type + 'InsuranceContent').append(statusHtml);
            }
            
            console.log('üè• Medical Environment: ' + type + ' insurance status:', status);
        }

        // üè• Medical Environment: Load Primary Insurance Providers
        function loadPrimaryInsuranceProviders() {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetPrimaryInsuranceProviders", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // üè• Medical Environment: Disable cache for real-time data
                    success: function(response) {
                        console.log('üè• MEDICAL: Primary Providers Response:', response);
                        
                        if (response && response.success) {
                            var $select = $('#InsuranceProviderId');
                            $select.empty();
                            $select.append('<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± Ÿæÿß€åŸá</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(provider) {
                                    $select.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                                });
                            }
                            
                            $select.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ±ÿßŸÜ Ÿæÿß€åŸá';
                            console.error('üè• MEDICAL: ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ±ÿßŸÜ Ÿæÿß€åŸá:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('üè• MEDICAL: AJAX Error in Primary Providers:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }

        // üè• Medical Environment: Load Supplementary Insurance Providers
        function loadSupplementaryInsuranceProviders() {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetSupplementaryInsuranceProviders", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // üè• Medical Environment: Disable cache for real-time data
                    success: function(response) {
                        console.log('üè• MEDICAL: Supplementary Providers Response:', response);
                        
                        if (response && response.success) {
                            var $select = $('#SupplementaryInsuranceProviderId');
                            $select.empty();
                            $select.append('<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å (ÿßÿÆÿ™€åÿßÿ±€å)</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(provider) {
                                    $select.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                                });
                            }
                            
                            $select.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ±ÿßŸÜ ÿ™⁄©ŸÖ€åŸÑ€å';
                            console.error('üè• MEDICAL: ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ±ÿßŸÜ ÿ™⁄©ŸÖ€åŸÑ€å:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('üè• MEDICAL: AJAX Error in Supplementary Providers:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }

        // üè• Medical Environment: Load Insurance Plans
        function loadInsurancePlans(providerId, $planSelect, type) {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '@Url.Action("GetInsurancePlansByProvider", "PatientInsurance", new { area = "Admin" })',
                    type: 'GET',
                    dataType: 'json',
                    cache: false, // üè• Medical Environment: Disable cache for real-time data
                    data: { providerId: providerId, type: type },
                    success: function(response) {
                        console.log('üè• MEDICAL: Insurance Plans Response:', response);
                        
                        if (response && response.success) {
                            $planSelect.empty();
                            $planSelect.append('<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá</option>');
                            
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(plan) {
                                    $planSelect.append('<option value="' + plan.id + '">' + plan.name + '</option>');
                                });
                                
                                // Auto-select if only one plan is available
                                if (response.data.length === 1) {
                                    $planSelect.val(response.data[0].id).trigger('change');
                                }
                            }
                            
                            $planSelect.prop('disabled', false);
                            resolve();
                        } else {
                            var errorMessage = (response && response.message) ? response.message : 'ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá';
                            console.error('üè• MEDICAL: ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ∑ÿ±ÿ≠‚ÄåŸáÿß€å ÿ®€åŸÖŸá:', errorMessage);
                            reject(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('üè• MEDICAL: AJAX Error in Insurance Plans:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error,
                            providerId: providerId,
                            type: type
                        });
                        
                        var errorMessage = 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±: ' + (xhr.statusText || error);
                        reject(errorMessage);
                    }
                });
            });
        }
            
            // üè• Medical Environment: Change Tracking
            function initializeChangeTracking() {
                    var originalValues = {};
            var $form = $('#patientInsuranceEditForm');
                    
            // Store original values after a delay to ensure all fields are loaded
            setTimeout(function() {
                $form.find('input, select, textarea').each(function() {
                        var $field = $(this);
                    var fieldName = $field.attr('name');
                        if (fieldName) {
                            originalValues[fieldName] = $field.val();
                        }
                    });
                
                console.log('üè• Medical Environment: Original values stored:', originalValues);
                    
                    // Track changes
                $form.find('input, select, textarea').on('change', function() {
                        var $field = $(this);
                    var fieldName = $field.attr('name');
                        var currentValue = $field.val();
                        var originalValue = originalValues[fieldName];
                        
                    console.log('üè• Medical Environment: Field changed:', fieldName, 'from', originalValue, 'to', currentValue);
                    
                    if (currentValue !== originalValue) {
                            trackChange(fieldName, originalValue, currentValue);
                    } else {
                        removeChange(fieldName);
                        }
                    
                    updateChangeTracking();
                    });
            }, 1500); // Wait for all fields to be loaded
        }
                    
        // üè• Medical Environment: XSS Protection - HTML Escape Function
        function escapeHtml(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // üè• Medical Environment: Track Individual Changes (XSS Protected)
        function trackChange(fieldName, originalValue, currentValue) {
            var changeId = 'change_' + fieldName;
            var $changeItem = $('#' + changeId);
            
            // üè• Medical Environment: Escape values to prevent XSS
            var escapedOriginalValue = escapeHtml(originalValue || 'ÿÆÿßŸÑ€å');
            var escapedCurrentValue = escapeHtml(currentValue || 'ÿÆÿßŸÑ€å');
            var escapedFieldName = escapeHtml(getFieldDisplayName(fieldName));
            
            if ($changeItem.length === 0) {
                var changeHtml = `
                    <div class="change-item" id="${changeId}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="change-field">${escapedFieldName}</span>
                            <div class="change-values">
                                <span class="original-value">${escapedOriginalValue}</span>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <span class="new-value">${escapedCurrentValue}</span>
                            </div>
                        </div>
                    </div>
                `;
                $('#changeList').append(changeHtml);
            } else {
                $changeItem.find('.original-value').text(originalValue || 'ÿÆÿßŸÑ€å');
                $changeItem.find('.new-value').text(currentValue || 'ÿÆÿßŸÑ€å');
            }
        }

        // üè• Medical Environment: Remove Change
        function removeChange(fieldName) {
            var changeId = 'change_' + fieldName;
            $('#' + changeId).remove();
        }

        // üè• Medical Environment: Update Change Tracking Display
        function updateChangeTracking() {
            var $changeTracking = $('#changeTracking');
            var $changeList = $('#changeList');
            
            if ($changeList.children().length > 0) {
                $changeTracking.show();
            } else {
                $changeTracking.hide();
            }
        }

        // üè• Medical Environment: Get Field Display Name
        function getFieldDisplayName(fieldName) {
            var fieldNames = {
                'InsuranceProviderId': 'ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± Ÿæÿß€åŸá',
                'PrimaryInsuranceProviderId': 'ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± Ÿæÿß€åŸá',
                'InsurancePlanId': 'ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá Ÿæÿß€åŸá',
                'PrimaryInsurancePlanId': 'ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá Ÿæÿß€åŸá',
                'SupplementaryInsuranceProviderId': 'ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å',
                'SupplementaryInsurancePlanId': 'ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å',
                'PolicyNumber': 'ÿ¥ŸÖÿßÿ±Ÿá ÿ®€åŸÖŸá‚ÄåŸÜÿßŸÖŸá',
                'SupplementaryPolicyNumber': 'ÿ¥ŸÖÿßÿ±Ÿá ÿ®€åŸÖŸá‚ÄåŸÜÿßŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å',
                            'StartDateShamsi': 'ÿ™ÿßÿ±€åÿÆ ÿ¥ÿ±Ÿàÿπ',
                'EndDateShamsi': 'ÿ™ÿßÿ±€åÿÆ Ÿæÿß€åÿßŸÜ'
            };
            
            return fieldNames[fieldName] || fieldName;
        }

        // üè• Medical Environment: Form Submission
        function initializeFormSubmission() {
            $('#patientInsuranceEditForm').on('submit', function(e) {
                e.preventDefault();
                
                var $form = $(this);
                var $submitBtn = $('#saveEditButton');
                var $loadingIndicator = $('#editLoadingIndicator');
                
                // Validate form before submission
                if (!validateEditForm()) {
                    showErrorMessage('ŸÑÿ∑ŸÅÿßŸã ÿ™ŸÖÿßŸÖ ŸÅ€åŸÑÿØŸáÿß€å ÿßŸÑÿ≤ÿßŸÖ€å ÿ±ÿß Ÿæÿ± ⁄©ŸÜ€åÿØ');
                    return;
                }
                
                // Show loading state
                $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>ÿØÿ± ÿ≠ÿßŸÑ ÿ∞ÿÆ€åÿ±Ÿá...');
                $loadingIndicator.show();
                $form.addClass('medical-loading');
                
                // üè• Medical Environment: Use FormData to avoid manual field mapping
                var formDataObj = new FormData($form[0]); // Includes all form fields and CSRF token
                
                // üè• Medical Environment: Validate form before submission
                if (!validateEditForm()) {
                    showErrorMessage('ŸÑÿ∑ŸÅÿßŸã ŸÅ€åŸÑÿØŸáÿß€å ÿßŸÑÿ≤ÿßŸÖ€å ÿ±ÿß ÿ™⁄©ŸÖ€åŸÑ ⁄©ŸÜ€åÿØ');
                    $submitBtn.prop('disabled', false).html('<i class="fas fa-save me-1"></i>ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™');
                    $loadingIndicator.hide();
                    $form.removeClass('medical-loading');
                    return;
                }
                
                // Submit form
                        $.ajax({
                    url: $form.attr('action'),
                            type: 'POST',
                    data: formDataObj,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                            success: function(response) {
                        console.log('üè• Medical Environment: Form submission response:', response);
                        console.log('üè• Medical Environment: Response type:', typeof response);
                        
                        // üè• Medical Environment: Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('üè• Medical Environment: Parsed response:', parsedResponse);
                            } catch (e) {
                                console.error('üè• Medical Environment: JSON parse error:', e);
                                showErrorMessage('ÿÆÿ∑ÿß ÿØÿ± Ÿæÿ±ÿØÿßÿ≤ÿ¥ Ÿæÿßÿ≥ÿÆ ÿ≥ÿ±Ÿàÿ±');
                                return;
                            }
                        }
                        
                        console.log('üè• Medical Environment: Parsed response success:', parsedResponse?.success);
                        console.log('üè• Medical Environment: Parsed response message:', parsedResponse?.message);
                        
                        if (parsedResponse && parsedResponse.success === true) {
                            console.log('üè• Medical Environment: Success response received');
                            showSuccessMessage('ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿ®€åŸÖŸá ÿ®€åŸÖÿßÿ± ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ');
                            
                            // Redirect to details page after a short delay
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Details", "PatientInsurance", new { id = Model.PatientInsuranceId })';
                            }, 1500);
                        } else {
                            console.log('üè• Medical Environment: Error response received:', parsedResponse);
                            showErrorMessage(parsedResponse?.message || 'ÿÆÿ∑ÿß ÿØÿ± ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™');
                        }
                            },
                            error: function(xhr, status, error) {
                        console.error('ÿÆÿ∑ÿß ÿØÿ± ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™:', error);
                        console.error('Response:', xhr.responseText);
                        showErrorMessage('ÿÆÿ∑ÿß ÿØÿ± ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿ®€åŸÖŸá ÿ®€åŸÖÿßÿ±');
                    },
                    complete: function() {
                        // Hide loading state
                        $submitBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™');
                        $loadingIndicator.hide();
                        $form.removeClass('medical-loading');
                    }
                });
            });
        }

        // üè• Medical Environment: Validate Edit Form
        function validateEditForm() {
            var isValid = true;
            var $form = $('#patientInsuranceEditForm');
            var errors = [];
            
            console.log('üè• Medical Environment: Validating edit form...');
            
            // Validate required fields
            var requiredFields = [
                'InsuranceProviderId',
                'InsurancePlanId',
                'StartDateShamsi'
            ];
            
            requiredFields.forEach(function(fieldName) {
                var $field = $form.find('[name="' + fieldName + '"]');
                if ($field.length && !$field.val()) {
                    $field.addClass('is-invalid');
                    isValid = false;
                    errors.push('ŸÅ€åŸÑÿØ ' + getFieldDisplayName(fieldName) + ' ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™');
                    console.log('üè• Medical Environment: Required field validation failed:', fieldName);
                } else {
                    $field.removeClass('is-invalid');
                }
            });
            
            // Validate supplementary insurance if provided
            var supplementaryProvider = $('#SupplementaryInsuranceProviderId').val();
            var supplementaryPlan = $('#SupplementaryInsurancePlanId').val();
            
            if (supplementaryProvider && !supplementaryPlan) {
                $('#SupplementaryInsurancePlanId').addClass('is-invalid');
                isValid = false;
                errors.push('ÿß⁄Øÿ± ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸáÿå ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å ŸÜ€åÿ≤ ÿ®ÿß€åÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ŸàÿØ');
                console.log('üè• Medical Environment: Supplementary provider without plan');
            } else {
                $('#SupplementaryInsurancePlanId').removeClass('is-invalid');
            }
            
            if (!supplementaryProvider && supplementaryPlan) {
                $('#SupplementaryInsuranceProviderId').addClass('is-invalid');
                isValid = false;
                errors.push('ÿß⁄Øÿ± ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸáÿå ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å ŸÜ€åÿ≤ ÿ®ÿß€åÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ŸàÿØ');
                console.log('üè• Medical Environment: Supplementary plan without provider');
            } else {
                $('#SupplementaryInsuranceProviderId').removeClass('is-invalid');
            }
            
            // üè• Medical Environment: Show validation errors
            if (!isValid) {
                var errorMessage = 'ŸÑÿ∑ŸÅÿßŸã ŸÖŸàÿßÿ±ÿØ ÿ≤€åÿ± ÿ±ÿß ÿ™⁄©ŸÖ€åŸÑ ⁄©ŸÜ€åÿØ:\n' + errors.join('\n');
                showErrorMessage(errorMessage);
                console.log('üè• Medical Environment: Validation errors:', errors);
            } else {
                console.log('üè• Medical Environment: Form validation passed');
            }
            
            return isValid;
            }

        // üè• Medical Environment: Get Field Display Name
        function getFieldDisplayName(fieldName) {
            var displayNames = {
                'InsuranceProviderId': 'ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± Ÿæÿß€åŸá',
                'InsurancePlanId': 'ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá Ÿæÿß€åŸá',
                'SupplementaryInsuranceProviderId': 'ÿ®€åŸÖŸá‚Äå⁄Øÿ∞ÿßÿ± ÿ™⁄©ŸÖ€åŸÑ€å',
                'SupplementaryInsurancePlanId': 'ÿ∑ÿ±ÿ≠ ÿ®€åŸÖŸá ÿ™⁄©ŸÖ€åŸÑ€å',
                'StartDateShamsi': 'ÿ™ÿßÿ±€åÿÆ ÿ¥ÿ±Ÿàÿπ',
                'EndDateShamsi': 'ÿ™ÿßÿ±€åÿÆ Ÿæÿß€åÿßŸÜ',
                'PolicyNumber': 'ÿ¥ŸÖÿßÿ±Ÿá ÿ®€åŸÖŸá',
                'SupplementaryPolicyNumber': 'ÿ¥ŸÖÿßÿ±Ÿá ŸÖÿπÿ±ŸÅ€å ŸÜÿßŸÖŸá'
            };
            
            return displayNames[fieldName] || fieldName;
        }
            
            // üè• Medical Environment: Show Success Message
        function showSuccessMessage(message) {
                var alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                $('.medical-form-container').prepend(alertHtml);
                
                setTimeout(function() {
                    $('.alert-success').fadeOut();
                }, 5000);
            }
            
            // üè• Medical Environment: Show Error Message
        function showErrorMessage(message) {
                var alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                $('.medical-form-container').prepend(alertHtml);
                
                setTimeout(function() {
                    $('.alert-danger').fadeOut();
                }, 5000);
            }
    </script>
}
