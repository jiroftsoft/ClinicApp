@model ClinicApp.ViewModels.Insurance.PatientInsurance.PatientInsuranceCreateEditViewModel
@{
    ViewBag.Title = "Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/patient-insurance.css" rel="stylesheet" />
    <link href="~/Content/css/patient-insurance-enhanced.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/select2/css/select2-bootstrap4.min.css" rel="stylesheet" />
    
    <!-- ğŸ¥ Medical Environment - Advanced Admin Styles -->
    <style>
        /* ğŸ¥ Advanced Admin Layout */
        .admin-insurance-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .admin-form-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1400px;
        }
        
        .admin-form-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .admin-form-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .admin-form-header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .admin-form-body {
            padding: 3rem;
        }
        
        .medical-form-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .medical-form-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
        }
        
        .medical-section-title {
            color: #2c5aa0;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .medical-section-title i {
            font-size: 1.8rem;
            color: #2c5aa0;
        }
        
        /* ğŸ¥ Advanced Patient Selection */
        .patient-selection-container {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .patient-selection-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196f3, #9c27b0, #ff9800);
        }
        
        /* ğŸ¥ Advanced Select2 Patient Selection */
        .patient-select2-advanced {
            width: 100% !important;
        }
        
        .select2-container--default .select2-selection--single {
            height: 60px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 12px !important;
            padding: 0.5rem !important;
            background: white !important;
            transition: all 0.3s ease !important;
        }
        
        .select2-container--default .select2-selection--single:focus {
            border-color: #2196f3 !important;
            box-shadow: 0 0 0 0.3rem rgba(33, 150, 243, 0.25) !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 50px !important;
            padding-left: 0 !important;
            color: #333 !important;
            font-size: 1.1rem !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #999 !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 50px !important;
            right: 15px !important;
        }
        
        .select2-dropdown {
            border: 2px solid #e0e0e0 !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }
        
        .select2-results__option {
            padding: 1rem 1.5rem !important;
            border-bottom: 1px solid #f0f0f0 !important;
            transition: all 0.2s ease !important;
        }
        
        .select2-results__option:hover {
            background: #f8f9fa !important;
            transform: translateX(5px) !important;
        }
        
        .select2-results__option--highlighted {
            background: #2196f3 !important;
            color: white !important;
        }
        
        .select2-results__option--selected {
            background: #4caf50 !important;
            color: white !important;
        }
        
        /* ğŸ¥ Patient Info Display */
        .selected-patient-info {
            margin-top: 1.5rem;
            animation: slideInUp 0.3s ease;
        }
        
        .patient-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        .patient-details-complete {
            padding: 1rem 0;
        }
        
        .patient-details-complete h5 {
            color: #2c5aa0;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .patient-details-complete .row {
            margin-bottom: 0.5rem;
        }
        
        .patient-details-complete strong {
            color: #333;
            font-weight: 600;
        }
        
        .patient-details-complete span {
            color: #666;
        }
        
        /* ğŸ¥ Select2 Template Styles */
        .patient-select2-result {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
        }
        
        .patient-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #9c27b0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .patient-info-small {
            flex: 1;
        }
        
        .patient-name-small {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .patient-details-small {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        .patient-details-complete .row {
            margin-bottom: 0.75rem;
        }
        
        .patient-details-complete .row:last-child {
            margin-bottom: 0;
        }
        
        .patient-search-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .patient-search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .patient-search-input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 0.3rem rgba(33, 150, 243, 0.25);
            outline: none;
        }
        
        .patient-search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #2196f3;
            font-size: 1.2rem;
        }
        
        .patient-results {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .patient-result-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .patient-result-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }
        
        .patient-result-item:last-child {
            border-bottom: none;
        }
        
        .patient-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #9c27b0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .patient-info {
            flex: 1;
        }
        
        .patient-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .patient-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .selected-patient {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
        }
        
        .selected-patient.show {
            display: block;
            animation: slideInUp 0.3s ease;
        }
        
        @@keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .required-indicator {
            color: #dc3545;
            font-weight: bold;
        }
        
        .medical-form-control {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .medical-form-control:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }
        
        .medical-info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .medical-validation-alert {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .medical-validation-list {
            list-style: none;
            padding: 0;
        }
        
        .medical-validation-list li {
            padding: 0.25rem 0;
            color: #721c24;
        }
        
        .medical-validation-message {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* ğŸ¥ Advanced Insurance Selection */
        .insurance-selection-container {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
            border: 2px solid #ff9800;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .insurance-type-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .insurance-tab {
            flex: 1;
            padding: 1rem 2rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }
        
        .insurance-tab.active {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            border-color: #4caf50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .insurance-tab:hover:not(.active) {
            background: #f8f9fa;
            border-color: #ff9800;
        }
        
        .insurance-content {
            display: none;
        }
        
        .insurance-content.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .btn-medical-primary {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            border: none;
            color: white;
            font-weight: 700;
            padding: 1rem 3rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-medical-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(44, 90, 160, 0.4);
        }
        
        .btn-medical-secondary {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            border: none;
            color: white;
            font-weight: 700;
            padding: 1rem 3rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-medical-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }
        
        .medical-form-group {
            margin-bottom: 1.5rem;
        }
        
        .medical-form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .medical-info-text {
            color: #1976d2;
            font-size: 0.9rem;
        }
        
        .medical-info-text ul {
            margin: 0.5rem 0 0 1rem;
        }
        
        .medical-info-text li {
            margin-bottom: 0.25rem;
        }
        
        /* Loading States */
        .medical-loading {
            position: relative;
            opacity: 0.6;
            pointer-events: none;
        }
        
        .medical-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2c5aa0;
            border-radius: 50%;
            animation: medical-spin 1s linear infinite;
        }
        
        @@keyframes medical-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @@media (max-width: 768px) {
            .medical-form-section {
                padding: 1rem;
            }
            
            .btn-medical-primary {
                width: 100%;
                margin-bottom: 1rem;
            }
        }
    </style>
}

<div class="admin-insurance-container">
    <div class="admin-form-wrapper">
        <!-- ğŸ¥ Advanced Admin Header -->
        <div class="admin-form-header">
            <h1>
                <i class="fas fa-user-md mr-3"></i>
                Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
            </h1>
            <p>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† - Ù…Ø­ÛŒØ· Ø§Ø¯Ù…ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
        </div>
        
        <!-- ğŸ¥ Advanced Admin Body -->
        <div class="admin-form-body">
            
            @using (Html.BeginForm("CreateAjax", "PatientInsurance", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate", id = "patientInsuranceCreateForm" }))
            {
                @Html.AntiForgeryToken()
                
                <!-- Hidden fields for form data - ONLY ONE NAME PER PROPERTY -->
                @Html.HiddenFor(m => m.StartDate)
                @Html.HiddenFor(m => m.EndDate)
                @Html.HiddenFor(m => m.InsuranceProviderId)
                @Html.HiddenFor(m => m.InsurancePlanId)
                @Html.HiddenFor(m => m.SupplementaryInsuranceProviderId)
                @Html.HiddenFor(m => m.SupplementaryInsurancePlanId)
                @* @Html.HiddenFor(m => m.IsActive) - Ø­Ø°Ù Ø´Ø¯: CheckBoxFor Ø®ÙˆØ¯ hidden Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ *@
                @Html.HiddenFor(m => m.Priority)
                <!-- IsPrimary will be handled by CheckBoxFor only -->

            <!-- ğŸ¥ Step 1: Advanced Patient Selection -->
            <div class="medical-form-section">
                <h4 class="medical-section-title">
                    <i class="fas fa-user-plus"></i>
                    Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±
                    <span class="required-indicator">*</span>
                </h4>
                
                <div class="patient-selection-container">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±:</label>
                        @Html.DropDownListFor(m => m.PatientId, new List<SelectListItem>(), "Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø±...", new { 
                            @class = "form-control patient-select2-advanced", 
                            required = "required",
                            id = "PatientIdSelect",
                            data_placeholder = "Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†: Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒØŒ Ú©Ø¯ Ù…Ù„ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†...",
                            data_allow_clear = "true"
                        })
                        <!-- Hidden input for form submission -->
                        <!-- PatientId will be handled by Select2 DropDownListFor only -->
                        @Html.ValidationMessageFor(m => m.PatientId, "", new { @class = "text-danger" })
                    </div>
                    
                    <!-- Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ -->
                    <div class="selected-patient-info" id="selectedPatientInfo" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-check"></i> Ø¨ÛŒÙ…Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="patient-avatar-large">
                                            <i class="fas fa-user"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="patient-details-complete">
                                            <h5 class="patient-name" id="selectedPatientName">Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> <span id="selectedPatientFullName">-</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> <span id="selectedPatientNationalCode">-</span>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <strong>Ù†Ø§Ù… Ù¾Ø¯Ø±:</strong> <span id="selectedPatientFatherName">-</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†:</strong> <span id="selectedPatientPhone">-</span>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ùˆ Ø³Ù†:</strong> <span id="selectedPatientBirthDate">-</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Ø¬Ù†Ø³ÛŒØª:</strong> <span id="selectedPatientGender">-</span>
                                                </div>
                                            </div>
                                            <div class="row mt-2" id="additionalPatientInfo" style="display: none;">
                                                <div class="col-md-12">
                                                    <strong>Ø¢Ø¯Ø±Ø³:</strong> <span id="selectedPatientAddress">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ¥ Step 2: Advanced Insurance Selection -->
            <div class="medical-form-section patient-insurance-form">
                <h4 class="medical-section-title">
                    <i class="fas fa-shield-alt"></i>
                    Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡
                    <span class="required-indicator">*</span>
                </h4>
                
                <div class="insurance-selection-container">
                    <!-- Insurance Status Containers -->
                    <div class="row mb-3">
                        <div class="col-md-6" id="primaryInsuranceStatus"></div>
                        <div class="col-md-6" id="supplementaryInsuranceStatus"></div>
                    </div>
                    
                    <div class="insurance-type-tabs">
                        <div class="insurance-tab active" data-type="primary">
                            <i class="fas fa-star mr-2"></i>
                            Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ (Ø§ØµÙ„ÛŒ)
                        </div>
                        <div class="insurance-tab" data-type="supplementary">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                        </div>
                    </div>
                    
                    <!-- Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ -->
                    <div class="insurance-content active" id="primaryInsuranceContent">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group" style="min-height: 80px;">
                                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡:</label>
                        <select id="PrimaryInsuranceProviderId" 
                                class="form-control medical-form-control" 
                                required="required"
                                data-medical-field="insurance-provider"
                                style="width: 100%; min-width: 100%;">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡</option>
                        </select>
                        @Html.ValidationMessageFor(m => m.InsuranceProviderId, "", new { @class = "text-danger", id = "InsuranceProviderId-error" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group" style="min-height: 80px;">
                                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡:</label>
                        <select id="PrimaryInsurancePlanId" 
                                class="form-control medical-form-control" 
                                required="required"
                                data-medical-field="insurance-plan"
                                style="width: 100%; min-width: 100%;"
                                disabled>
                            <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                        @Html.ValidationMessageFor(m => m.InsurancePlanId, "", new { @class = "text-danger", id = "InsurancePlanId-error" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡:</label>
                                    <input type="text" 
                                           id="PolicyNumber" 
                                           name="PolicyNumber" 
                                           class="form-control medical-form-control" 
                                           placeholder="Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Ú©Ø¯ Ù…Ù„ÛŒ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯"
                                           data-medical-field="policy-number">
                                    @Html.ValidationMessageFor(m => m.PolicyNumber, "", new { @class = "text-danger", id = "PolicyNumber-error" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ (ØªÚ©Ù…ÛŒÙ„ÛŒ):</label>
                                    <input type="text" 
                                           id="SupplementaryPolicyNumber" 
                                           name="SupplementaryPolicyNumber" 
                                           class="form-control medical-form-control" 
                                           placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ"
                                           data-medical-field="supplementary-policy-number">
                                    @Html.ValidationMessageFor(m => m.SupplementaryPolicyNumber, "", new { @class = "text-danger", id = "SupplementaryPolicyNumber-error" })
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) -->
                    <div class="insurance-content" id="supplementaryInsuranceContent">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Ù†Ú©ØªÙ‡:</strong> Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group" style="min-height: 80px;">
                                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ:</label>
                        <select id="SupplementaryInsuranceProviderIdSelect" 
                                class="form-control medical-form-control" 
                                data-medical-field="supplementary-insurance-provider"
                                data-optional="true"
                                style="width: 100%; min-width: 100%;">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>
                        </select>
                        @Html.ValidationMessageFor(m => m.SupplementaryInsuranceProviderId, "", new { @class = "text-danger", id = "SupplementaryInsuranceProviderId-error" })
                                </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group" style="min-height: 80px;">
                                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ:</label>
                        <select id="SupplementaryInsurancePlanIdSelect" 
                                           class="form-control medical-form-control" 
                                data-medical-field="supplementary-insurance-plan"
                                data-optional="true"
                                style="width: 100%; min-width: 100%;"
                                disabled>
                            <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                        @Html.ValidationMessageFor(m => m.SupplementaryInsurancePlanId, "", new { @class = "text-danger", id = "SupplementaryInsurancePlanId-error" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ¥ Step 3: Insurance Details -->
            <div class="medical-form-section">
                <h4 class="medical-section-title">
                    <i class="fas fa-calendar-alt"></i>
                    Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒÙ…Ù‡
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø±:</label>
                            <div class="position-relative">
                            @Html.TextBoxFor(m => m.StartDateShamsi, new { 
                                    @class = "form-control persian-datepicker medical-form-control pr-5", 
                                placeholder = "ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø± (Ø´Ù…Ø³ÛŒ)", 
                                required = "required",
                                id = "StartDateShamsi"
                            })
                                <span class="position-absolute" style="right:10px;top:50%;transform:translateY(-50%);pointer-events:none;">ğŸ“…</span>
                            </div>
                            @Html.ValidationMessageFor(m => m.StartDateShamsi, "", new { @class = "text-danger", id = "StartDateShamsi-error" })
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø§Ø¹ØªØ¨Ø§Ø±:</label>
                            <div class="position-relative">
                            @Html.TextBoxFor(m => m.EndDateShamsi, new { 
                                    @class = "form-control persian-datepicker medical-form-control pr-5", 
                                    placeholder = "ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø§Ø¹ØªØ¨Ø§Ø± (Ø´Ù…Ø³ÛŒ) - Ø§Ø®ØªÛŒØ§Ø±ÛŒ", 
                                id = "EndDateShamsi"
                            })
                                <span class="position-absolute" style="right:10px;top:50%;transform:translateY(-50%);pointer-events:none;">ğŸ“…</span>
                            </div>
                            @Html.ValidationMessageFor(m => m.EndDateShamsi, "", new { @class = "text-danger", id = "EndDateShamsi-error" })
                        </div>
                    </div>
                </div>
                
    <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-check">
                                @Html.CheckBoxFor(m => m.IsPrimary, new { 
                                    @class = "form-check-input",
                                    id = "IsPrimary"
                                })
                                <label class="form-check-label" for="IsPrimary">
                                    Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-check">
                                @Html.CheckBoxFor(m => m.IsActive, new { 
                                    @class = "form-check-input",
                                    id = "IsActive"
                                })
                                <label class="form-check-label" for="IsActive">
                                    Ø¨ÛŒÙ…Ù‡ ÙØ¹Ø§Ù„
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ¥ Form Actions -->
            <div class="text-center mt-5">

                    <button type="submit" class="btn btn-medical-primary btn-lg mr-3" id="saveButton">
                        <i class="fas fa-save mr-2"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±
                    </button>
                    <button type="button" class="btn btn-medical-secondary btn-lg mr-3" id="createDefaultFreeInsuranceBtn">
                        <i class="fas fa-plus-circle mr-2"></i> Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯
                    </button>
                    <button type="button" class="btn btn-info btn-lg mr-3" id="validatePatientInsuranceBtn">
                        <i class="fas fa-check-circle mr-2"></i> Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±
                                </button>
                                <a href="@Url.Action("Index", "PatientInsurance")" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> Ø§Ù†ØµØ±Ø§Ù
                                </a>
                            
                    <!-- Loading Indicator -->
                            <div class="text-center mt-3" id="loadingIndicator" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...</span>
                                </div>
                                <p class="mt-2 text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±...</p>
                            </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="~/Content/plugins/persian-datepicker/persian-datepicker.min.css" rel="stylesheet" />
    <style>
        /* Enhanced Fallback Date Input Styling */
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .persian-date-input {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .persian-date-input:focus {
            background-color: #fff;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .persian-date-input[placeholder*="Ù…Ø«Ø§Ù„"] {
            background-color: #f8f9fa;
        }
        
        .persian-date-input[placeholder*="Ù…Ø«Ø§Ù„"]:focus {
            background-color: #fff;
        }
        
        /* Persian Date Input Icons - Removed pseudo-element for input compatibility */
        
        /* Enhanced validation styling */
        .persian-date-input.is-invalid {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        
        .persian-date-input.is-valid {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        
        /* Fix dropdown resize issues */
        .insurance-content {
            min-height: 200px; /* Prevent height collapse */
        }
        
        .insurance-content.active {
            display: block !important;
        }
        
        .insurance-content:not(.active) {
            display: none !important;
        }
        
        /* Ensure dropdown maintains width */
        .form-control.medical-form-control {
            min-width: 100%;
            width: 100% !important;
        }
        
        /* Fix Select2 width issues */
        .select2-container {
            width: 100% !important;
            min-width: 100% !important;
        }
        
        .select2-container .select2-selection--single {
            width: 100% !important;
            min-width: 100% !important;
        }
        
        /* Prevent dropdown from shrinking */
        .insurance-content .form-group {
            min-height: 60px;
        }
        
        .insurance-content .form-control {
            transition: none !important;
        }
    </style>
    <script src="~/Content/plugins/select2/js/select2.full.min.js"></script>
    <!-- Persian DatePicker removed due to compatibility issues -->
    <script src="~/Scripts/app/patient-select2.js"></script>
    <script src="~/Scripts/app/patient-insurance-enhanced.js"></script>
    
    <!-- ğŸ¥ Medical Environment Specific JavaScript -->
    <script>
        $(document).ready(function() {
            // ğŸ¥ Advanced Medical Environment Initialization
            console.log('ğŸ¥ Medical Environment: Initializing Create Form');
            
            // Initialize Enhanced Patient Insurance (Complete)
            if (typeof PatientInsuranceEnhanced !== 'undefined') {
                console.log('ğŸ¥ Medical Environment: Using Enhanced Scripts');
                PatientInsuranceEnhanced.initializeCreateForm();
            } else {
                console.log('ğŸ¥ Medical Environment: Using Fallback Scripts');
                // Initialize Advanced Patient Selection (Fallback)
            initializeAdvancedPatientSelection();
            initializeAdvancedInsuranceSelection();
            initializeAutoPolicyNumber();
            initializeFormValidation();
                // initializeFormSubmission(); // Ø­Ø°Ù Ø´Ø¯ - ÙÙ‚Ø· AJAX Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                initializeEnhancedFormSubmission();
                initializeDefaultFreeInsuranceButton();
                initializePatientInsuranceValidationButton();
            }
            
            // âœ… Ø­Ø°Ù Ø´Ø¯: Ø¯ÙˆØ¨Ø§Ø±Ù‡â€ŒÚ©Ø§Ø±ÛŒ Ø¯Ø± initialize
            // console.log('ğŸ¥ Medical Environment: Initializing Patient Selection Fallback');
            // initializeAdvancedPatientSelection();
            
            // Initialize Persian DatePickers
            initializePersianDatePickers();
            
            // ğŸš¨ CRITICAL FIX: Add event listeners for real-time sync
            $(document).on('change', '#PrimaryInsuranceProviderId, #PrimaryInsurancePlanId, #SupplementaryInsuranceProviderIdSelect, #SupplementaryInsurancePlanIdSelect', function() {
                console.log('ğŸ¥ Medical Environment: Real-time sync triggered by:', this.id);
                syncAllHiddenFields();
            });
            
            // ğŸš¨ CRITICAL FIX: Add event listener for PatientIdSelect
            $(document).on('change', '#PatientIdSelect', function() {
                console.log('ğŸ¥ Medical Environment: PatientIdSelect changed, syncing hidden fields');
                syncAllHiddenFields();
            });
            
            // ğŸš¨ CRITICAL FIX: Add event listener for tab changes
            $(document).on('click', '.insurance-tab', function() {
                console.log('ğŸ¥ Medical Environment: Insurance tab changed, syncing hidden fields');
                setTimeout(function() {
                    syncAllHiddenFields();
                }, 100);
            });
            
            // ğŸš¨ CRITICAL FIX: Add event listener for form focus
            $(document).on('focus', '#patientInsuranceCreateForm input, #patientInsuranceCreateForm select', function() {
                console.log('ğŸ¥ Medical Environment: Form field focused, syncing hidden fields');
                syncAllHiddenFields();
            });
            
            // ğŸš¨ CRITICAL FIX: Add event listener for form blur
            $(document).on('blur', '#patientInsuranceCreateForm input, #patientInsuranceCreateForm select', function() {
                console.log('ğŸ¥ Medical Environment: Form field blurred, syncing hidden fields');
                syncAllHiddenFields();
            });
        });
        
        /**
         * ğŸ¥ Initialize Persian DatePickers
         */
        function initializePersianDatePickers() {
            console.log('ğŸ¥ Medical Environment: Initializing Persian DatePickers');
            
            // Skip Persian DatePicker completely due to step property issues
            console.log('ğŸ¥ Medical Environment: Skipping Persian DatePicker due to compatibility issues, using enhanced fallback');
            initializeEnhancedFallbackDateInputs();
        }
        
        /**
         * ğŸ¥ Initialize Enhanced Fallback Date Inputs
         */
        function initializeEnhancedFallbackDateInputs() {
            console.log('ğŸ¥ Medical Environment: Initializing Enhanced Fallback Date Inputs');
            
            // Use regular text inputs with enhanced Persian date features
            $('#StartDateShamsi, #EndDateShamsi').attr('type', 'text').addClass('form-control');
            
            // Add enhanced placeholders
            $('#StartDateShamsi').attr('placeholder', 'Ù…Ø«Ø§Ù„: 1403/01/01');
            $('#EndDateShamsi').attr('placeholder', 'Ù…Ø«Ø§Ù„: 1403/12/29');
            
            // Add enhanced styling
            $('#StartDateShamsi, #EndDateShamsi').addClass('persian-date-input');
            
            // Add manual date validation with enhanced feedback
            $('#StartDateShamsi, #EndDateShamsi').on('blur', function() {
                var value = $(this).val();
                var $this = $(this);
                
                if (value && !isValidPersianDate(value)) {
                    $this.addClass('is-invalid');
                    showErrorMessage('ØªØ§Ø±ÛŒØ® ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. ÙØ±Ù…Øª ØµØ­ÛŒØ­: 1403/01/01');
                } else {
                    $this.removeClass('is-invalid');
                    // Update hidden field if valid
                    if (value && isValidPersianDate(value)) {
                        var altFieldId = $this.attr('id') === 'StartDateShamsi' ? '#StartDate' : '#EndDate';
                        // Date conversion will be handled on server-side
                    }
                }
            });
            
            // Add enhanced input formatting
            $('#StartDateShamsi, #EndDateShamsi').on('input', function() {
                var value = $(this).val();
                // Remove non-numeric characters except /
                value = value.replace(/[^\d\/]/g, '');
                $(this).val(value);
            });
            
            // Add keyboard shortcuts (simplified for Persian keyboard compatibility)
            $('#StartDateShamsi, #EndDateShamsi').on('keydown', function(e) {
                // Allow: backspace, delete, tab, escape, enter, arrow keys
                if ([46, 8, 9, 27, 13, 37, 38, 39, 40].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)) {
                    return;
                }
                // Allow numbers, numpad numbers, and slash (multiple slash codes for different keyboards)
                if ((e.keyCode >= 48 && e.keyCode <= 57) || 
                    (e.keyCode >= 96 && e.keyCode <= 105) ||
                    e.keyCode === 191 || e.keyCode === 111 || e.keyCode === 220) {
                    return;
                }
                // Block other characters
                e.preventDefault();
            });
            
            console.log('ğŸ¥ Medical Environment: Enhanced Fallback Date Inputs initialized successfully');
        }
        
        // initializeFallbackDateInputs() removed - using initializeEnhancedFallbackDateInputs() instead
        
        /**
         * ğŸ¥ Initialize Fallback Insurance Selection
         */
        function initializeFallbackInsuranceSelection() {
            console.log('ğŸ¥ Medical Environment: Initializing Fallback Insurance Selection');
            
            // Load primary insurance providers
            $.ajax({
                url: '/Admin/PatientInsurance/GetPrimaryInsuranceProviders',
                type: 'GET',
                success: function(response) {
                    var isSuccess = (response && response.Success) || (response && response.success);
                    var data = (response && response.Data) || (response && response.data);
                    
                    if (isSuccess && data) {
                        var $providerSelect = $('#PrimaryInsuranceProviderId');
                        $providerSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡</option>');
                        
                        data.forEach(function(provider) {
                            $providerSelect.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                        });
                        
                        $providerSelect.prop('disabled', false);
                        console.log('ğŸ¥ Medical Environment: Primary insurance providers loaded in fallback');
                    }
                },
                error: function() {
                    console.error('ğŸ¥ Medical Environment: Error loading primary insurance providers in fallback');
                }
            });
            
            // Load supplementary insurance providers
            $.ajax({
                url: '/Admin/PatientInsurance/GetSupplementaryInsuranceProviders',
                type: 'GET',
                success: function(response) {
                    var isSuccess = (response && response.Success) || (response && response.success);
                    var data = (response && response.Data) || (response && response.data);
                    
                    if (isSuccess && data) {
                        var $suppProviderSelect = $('#SupplementaryInsuranceProviderIdSelect');
                        $suppProviderSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>');
                        
                        data.forEach(function(provider) {
                            $suppProviderSelect.append('<option value="' + provider.id + '">' + provider.name + '</option>');
                        });
                        
                        $suppProviderSelect.prop('disabled', false);
                        console.log('ğŸ¥ Medical Environment: Supplementary insurance providers loaded in fallback');
                    }
                },
                error: function() {
                    console.error('ğŸ¥ Medical Environment: Error loading supplementary insurance providers in fallback');
                }
            });
            
            // Handle primary insurance provider change
            $('#PrimaryInsuranceProviderId').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#PrimaryInsurancePlanId');
                
                if (providerId) {
                    $.ajax({
                        url: '/Admin/PatientInsurance/GetInsurancePlansByProvider',
                        type: 'GET',
                        data: { providerId: providerId, type: 'primary' },
                        success: function(response) {
                            var isSuccess = (response && response.Success) || (response && response.success);
                            var data = (response && response.Data) || (response && response.data);
                            
                            if (isSuccess && data) {
                                $planSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡</option>');
                                
                                data.forEach(function(plan) {
                                    $planSelect.append('<option value="' + plan.id + '">' + plan.name + '</option>');
                                });
                                
                                $planSelect.prop('disabled', false);
                                
                                // Auto-select if only one plan
                                if (data.length === 1) {
                                    $planSelect.val(data[0].id);
                                }
                            }
                        },
                        error: function() {
                            $planSelect.empty().append('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</option>').prop('disabled', true);
                        }
                    });
                } else {
                    $planSelect.empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>').prop('disabled', true);
                }
            });
            
            // Handle supplementary insurance provider change
            $('#SupplementaryInsuranceProviderIdSelect').on('change', function() {
                var providerId = $(this).val();
                var $planSelect = $('#SupplementaryInsurancePlanIdSelect');
                
                if (providerId) {
                    $.ajax({
                        url: '/Admin/PatientInsurance/GetInsurancePlansByProvider',
                        type: 'GET',
                        data: { providerId: providerId, type: 'supplementary' },
                        success: function(response) {
                            var isSuccess = (response && response.Success) || (response && response.success);
                            var data = (response && response.Data) || (response && response.data);
                            
                            if (isSuccess && data) {
                                $planSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</option>');
                                
                                data.forEach(function(plan) {
                                    $planSelect.append('<option value="' + plan.id + '">' + plan.name + '</option>');
                                });
                                
                                $planSelect.prop('disabled', false);
                                
                                // Auto-select if only one plan
                                if (data.length === 1) {
                                    $planSelect.val(data[0].id);
                                }
                            }
                        },
                        error: function() {
                            $planSelect.empty().append('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡</option>').prop('disabled', true);
                        }
                    });
                } else {
                    $planSelect.empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>').prop('disabled', true);
                }
            });
        }
        
        /**
         * ğŸ¥ Validate Persian Date Format
         */
        function isValidPersianDate(dateString) {
            if (!dateString) return true;
            
            // Simple validation for YYYY/MM/DD format
            var pattern = /^\d{4}\/\d{1,2}\/\d{1,2}$/;
            if (!pattern.test(dateString)) return false;
            
            var parts = dateString.split('/');
            var year = parseInt(parts[0]);
            var month = parseInt(parts[1]);
            var day = parseInt(parts[2]);
            
            // Enhanced validation
            if (year < 1300 || year > 1500) return false;
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            
            // Persian calendar month days validation
            var monthDays = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            // ğŸš¨ CRITICAL FIX: Leap year calculation removed - use server-side validation
            // if (month === 12 && isLeapYear(year)) monthDays[11] = 30;
            
            return day <= monthDays[month - 1];
        }
        
        /**
         * ğŸš¨ CRITICAL FIX: Persian leap year calculation removed
         * This was incorrect and dangerous. Use server-side conversion instead.
         */
        
        /**
         * ğŸ¥ Convert Persian date to Gregorian date (improved approximation)
         */
        /**
         * ğŸš¨ CRITICAL FIX: Persian to Gregorian conversion removed
         * This was incorrect and dangerous. Use server-side conversion instead.
         * Server will handle conversion using proper PersianCalendar library.
         */
        
        /**
         * ğŸ¥ JSON Response Helper Functions
         */
        function getResponseSuccess(response) {
            return (response && response.success) || (response && response.Success);
        }
        
        function getResponseData(response) {
            return (response && response.data) || (response && response.Data);
        }
        
        function getResponseMessage(response) {
            return (response && response.message) || (response && response.Message);
        }
        
        function getResponseErrors(response) {
            // Check for both camelCase and PascalCase error properties
            if (response && response.errors) {
                return response.errors;
            }
            if (response && response.Errors) {
                return response.Errors;
            }
            if (response && response.validationErrors) {
                return response.validationErrors;
            }
            if (response && response.ValidationErrors) {
                return response.ValidationErrors;
            }
            return null;
        }
        
        /**
         * ğŸ¥ Sync dates before form submission
         */
        function syncDatesBeforeSubmit() {
            console.log('ğŸ¥ Medical Environment: === SYNCING DATES BEFORE SUBMISSION ===');
            
            var startDate = $('#StartDateShamsi').val();
            var endDate = $('#EndDateShamsi').val();
            
            console.log('ğŸ¥ Medical Environment: StartDateShamsi value:', startDate);
            console.log('ğŸ¥ Medical Environment: EndDateShamsi value:', endDate);
            
            // ğŸš¨ CRITICAL FIX: Date conversion removed - server will handle conversion
            // Only validate Persian date format, don't convert
            if (startDate && isValidPersianDate(startDate)) {
                console.log('ğŸ¥ Medical Environment: StartDateShamsi is valid:', startDate);
                // Server will convert StartDateShamsi to StartDate
            } else {
                console.warn('ğŸ¥ Medical Environment: StartDateShamsi is invalid or empty:', startDate);
            }
            
            if (endDate && isValidPersianDate(endDate)) {
                console.log('ğŸ¥ Medical Environment: EndDateShamsi is valid:', endDate);
                // Server will convert EndDateShamsi to EndDate
            } else {
                console.log('ğŸ¥ Medical Environment: EndDateShamsi is empty or invalid (optional):', endDate);
            }
            
            // Also sync hidden fields for insurance providers
            var primaryProviderId = $('#PrimaryInsuranceProviderId').val();
            var primaryPlanId = $('#PrimaryInsurancePlanId').val();
            var suppProviderId = $('#SupplementaryInsuranceProviderIdSelect').val();
            var suppPlanId = $('#SupplementaryInsurancePlanIdSelect').val();
            
            if (primaryProviderId) {
                $('#InsuranceProviderId').val(primaryProviderId);
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId synced:', primaryProviderId);
            }
            
            if (suppProviderId) {
                $('#SupplementaryInsuranceProviderId').val(suppProviderId);
                console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId synced:', suppProviderId);
            }
            
            if (suppPlanId) {
                $('#SupplementaryInsurancePlanId').val(suppPlanId);
                console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId synced:', suppPlanId);
            }
        }
        
        /**
         * ğŸ¥ Helper function to extract name from text
         */
        function extractNameFromText(text) {
            if (!text) return 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
            
            // Ø­Ø°Ù Ú©Ø¯ Ù…Ù„ÛŒ Ø§Ø² Ø¯Ø§Ø®Ù„ Ù¾Ø±Ø§Ù†ØªØ²
            var name = text.replace(/\([^)]*\)/g, '').trim();
            
            // Ø§Ú¯Ø± ÙÙ‚Ø· ÙØ§ØµÙ„Ù‡ ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù†Ø§Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            if (!name || name.length < 2) {
                return 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
            }
            
            return name;
        }
        
        /**
         * ğŸ¥ Helper function to calculate age from birth date
         */
        function calculateAge(birthDate) {
            if (!birthDate || birthDate === 'null' || birthDate === 'undefined' || birthDate === null || birthDate === undefined) {
                return '-';
            }
            
            try {
                var birth = new Date(birthDate);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
                if (isNaN(birth.getTime())) {
                    console.log('ğŸ¥ Medical Environment: Invalid birth date:', birthDate);
                    return '-';
                }
                
                var today = new Date();
                var age = today.getFullYear() - birth.getFullYear();
                var monthDiff = today.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø³Ù†
                if (isNaN(age) || age < 0 || age > 150) {
                    console.log('ğŸ¥ Medical Environment: Invalid age calculated:', age, 'for birth date:', birthDate);
                    return '-';
                }
                
                return age + ' Ø³Ø§Ù„';
            } catch (e) {
                console.error('ğŸ¥ Medical Environment: Error calculating age:', e, 'for birth date:', birthDate);
                return '-';
            }
        }
        
        /**
         * ğŸ¥ Helper function to format Persian date
         */
        function formatPersianDate(dateString) {
            if (!dateString || dateString === 'null' || dateString === 'undefined' || dateString === null || dateString === undefined) {
                return '-';
            }
            
            try {
                var date = new Date(dateString);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
                if (isNaN(date.getTime())) {
                    console.log('ğŸ¥ Medical Environment: Invalid date for formatting:', dateString);
                    return '-';
                }
                
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ±
                if (isNaN(year) || isNaN(month) || isNaN(day)) {
                    console.log('ğŸ¥ Medical Environment: Invalid date components:', {year: year, month: month, day: day});
                    return '-';
                }
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (ØªÙ‚Ø±ÛŒØ¨ÛŒ)
                var persianYear = year - 621;
                return persianYear + '/' + month + '/' + day;
            } catch (e) {
                console.error('ğŸ¥ Medical Environment: Error formatting Persian date:', e, 'for date:', dateString);
                return '-';
            }
        }
        
        /**
         * ğŸ¥ Advanced Patient Selection with Select2
         */
        function initializeAdvancedPatientSelection() {
            console.log('ğŸ¥ Medical Environment: Initializing Advanced Patient Selection');
            console.log('ğŸ¥ Medical Environment: PatientIdSelect element exists:', $('#PatientIdSelect').length > 0);
            console.log('ğŸ¥ Medical Environment: PatientIdSelect element:', $('#PatientIdSelect')[0]);
            console.log('ğŸ¥ Medical Environment: PatientId hidden element exists:', $('#PatientId').length > 0);
            console.log('ğŸ¥ Medical Environment: PatientId hidden element:', $('#PatientId')[0]);
            
            // Initialize Select2 for patient selection
            $('#PatientIdSelect').select2({
                theme: 'bootstrap4',
                placeholder: 'Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†: Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒØŒ Ú©Ø¯ Ù…Ù„ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†...',
                allowClear: true,
                minimumInputLength: 2,
                language: {
                    inputTooShort: function() {
                        return 'Ø­Ø¯Ø§Ù‚Ù„ Û² Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
                    },
                    noResults: function() {
                        return 'Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯';
                    },
                    searching: function() {
                        return 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
                    }
                },
                ajax: {
                    url: '@Url.Action("SearchPatients", "PatientInsurance", new { area = "Admin" })',
                    dataType: 'json',
                    delay: 300,
                    data: function(params) {
                        return {
                            q: params.term,
                            page: params.page || 1,
                            pageSize: 20
                        };
                    },
                    error: function(xhr, status, error) {
                        console.error('ğŸ¥ MEDICAL DEBUG: AJAX Error:', {
                            xhr: xhr,
                            status: status,
                            error: error,
                            responseText: xhr.responseText,
                            statusCode: xhr.status
                        });
                        
                        // Show user-friendly error message
                        showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                    },
                    processResults: function(data, params) {
                        params.page = params.page || 1;
                        
                        // console.log('ğŸ¥ MEDICAL DEBUG: Response data:', data); // Ø­Ø°Ù Ø´Ø¯: Ù„Ø§Ú¯ Ø§Ø¶Ø§ÙÛŒ
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ data
                        if (!data) {
                            console.error('ğŸ¥ MEDICAL DEBUG: No data received');
                            return {
                                results: [],
                                pagination: {
                                    more: false
                                }
                            };
                        }
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± response - endpoint Ù…ÙˆØ¬ÙˆØ¯ results Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                        var patients = [];
                        if (data.results && Array.isArray(data.results)) {
                            patients = data.results;
                        } else if (Array.isArray(data)) {
                            patients = data;
                        }
                        
                        // console.log('ğŸ¥ MEDICAL DEBUG: Patients found:', patients.length); // Ø­Ø°Ù Ø´Ø¯: Ù„Ø§Ú¯ Ø§Ø¶Ø§ÙÛŒ
                        
                        return {
                            results: patients.map(function(patient) {
                                // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ
                                var displayName = '';
                                if (patient.firstName && patient.lastName) {
                                    displayName = patient.firstName + ' ' + patient.lastName;
                                } else if (patient.text) {
                                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù… Ø§Ø² text Ú©Ù‡ Ø´Ø§Ù…Ù„ Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ù…Ù„ÛŒ Ø§Ø³Øª
                                    displayName = patient.text.replace(/\([^)]*\)/g, '').trim();
                                    if (!displayName || displayName.length < 2) {
                                        displayName = 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
                                    }
                                } else {
                                    displayName = 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
                                }
                                
                                return {
                                    id: patient.id,
                                    text: patient.text || (displayName + ' (' + patient.nationalCode + ')'),
                                    patient: {
                                        id: patient.id,
                                        name: displayName,
                                        text: patient.text,
                                        nationalCode: patient.nationalCode,
                                        phone: patient.phoneNumber,
                                        phoneNumber: patient.phoneNumber,
                                        firstName: patient.firstName,
                                        lastName: patient.lastName,
                                        fatherName: patient.fatherName || 'Ù†Ø§Ù…Ø´Ø®Øµ',
                                        birthDate: patient.birthDate,
                                        birthDateShamsi: patient.birthDateShamsi,
                                        gender: patient.gender,
                                        address: patient.address
                                    }
                                };
                            }),
                            pagination: {
                                more: data.pagination ? data.pagination.more : false
                            }
                        };
                    },
                    cache: true
                },
                success: function(data) {
                    // console.log('ğŸ¥ MEDICAL DEBUG: AJAX Success:', data); // Ø­Ø°Ù Ø´Ø¯: Ù„Ø§Ú¯ Ø§Ø¶Ø§ÙÛŒ
                },
                templateResult: function(patient) {
                    if (patient.loading) {
                        return 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
                    }
                    
                    if (!patient.patient) {
                        return patient.text;
                    }
                    
                    var $container = $(
                        '<div class="patient-select2-result">' +
                            '<div class="patient-avatar-small">' + (patient.patient.name.charAt(0) || '?') + '</div>' +
                            '<div class="patient-info-small">' +
                                '<div class="patient-name-small">' + patient.patient.name + '</div>' +
                                '<div class="patient-details-small">' +
                                    'Ú©Ø¯ Ù…Ù„ÛŒ: ' + (patient.patient.nationalCode || '') + 
                                    (patient.patient.phoneNumber ? ' | ØªÙ„ÙÙ†: ' + patient.patient.phoneNumber : '') +
                                    (patient.patient.birthDate ? ' | Ø³Ù†: ' + calculateAge(patient.patient.birthDate) : '') +
                                '</div>' +
                            '</div>' +
                        '</div>'
                    );
                    
                    return $container;
                },
                templateSelection: function(patient) {
                    return patient.text || patient.name;
                }
            });
            
            // Handle patient selection
            $('#PatientIdSelect').on('select2:select', function(e) {
                console.log('ğŸ¥ Medical Environment: Patient selected:', e.params.data);
                var data = e.params.data;
                var patient = data.patient;
                
                if (patient) {
                    console.log('ğŸ¥ Medical Environment: Patient data found:', patient);
                    
                    // Update hidden field for form submission
                    $('#PatientId').val(patient.id);
                    console.log('ğŸ¥ Medical Environment: Updated PatientId hidden field:', $('#PatientId').val());
                    
                    showSelectedPatientInfo(patient);
                    
                    // Auto-fill policy number with national code
                    console.log('ğŸ¥ Medical Environment: Auto-filling policy numbers with national code:', patient.nationalCode);
                    console.log('ğŸ¥ Medical Environment: PolicyNumber element exists:', $('#PolicyNumber').length > 0);
                    console.log('ğŸ¥ Medical Environment: PolicyNumber element:', $('#PolicyNumber')[0]);
                    console.log('ğŸ¥ Medical Environment: SupplementaryPolicyNumber element exists:', $('#SupplementaryPolicyNumber').length > 0);
                    console.log('ğŸ¥ Medical Environment: SupplementaryPolicyNumber element:', $('#SupplementaryPolicyNumber')[0]);
                    
                    $('#PolicyNumber').val(patient.nationalCode);
                    
                    // ğŸ¥ Medical Environment: Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø± Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    // Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ÛŒØ¯ ØªÙˆØ³Ø· Ù…Ù†Ø´ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯
                    console.log('ğŸ¥ Medical Environment: SupplementaryPolicyNumber will NOT be auto-filled - manual entry required');
                    $('#SupplementaryPolicyNumber').val('');
                    
                    // Verify policy numbers were set
                    console.log('ğŸ¥ Medical Environment: PolicyNumber value after setting:', $('#PolicyNumber').val());
                    console.log('ğŸ¥ Medical Environment: SupplementaryPolicyNumber value after setting (should be empty):', $('#SupplementaryPolicyNumber').val());
                    
                    // Force UI update
                    $('#PolicyNumber').trigger('input');
                    $('#SupplementaryPolicyNumber').trigger('input');
                    
                    // Visual feedback for primary policy number only
                    $('#PolicyNumber').addClass('bg-success text-white').delay(2000).queue(function() {
                        $(this).removeClass('bg-success text-white').dequeue();
                    });
                    
                    // ğŸ¥ Medical Environment: Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ visual feedback Ù†Ø¯Ø§Ø±Ø¯
                    console.log('ğŸ¥ Medical Environment: No visual feedback for SupplementaryPolicyNumber - manual entry required');
                    
                    // Check patient insurance status with new validation service
                    checkPatientInsuranceStatus();
                } else {
                    console.warn('ğŸ¥ Medical Environment: No patient data found in selection');
                }
            });
            
            // Handle patient clearing
            $('#PatientIdSelect').on('select2:clear', function(e) {
                console.log('ğŸ¥ Medical Environment: Patient cleared');
                $('#PatientId').val('0'); // Reset hidden field
                $('#selectedPatientInfo').hide();
                $('#PolicyNumber').val('');
                $('#SupplementaryPolicyNumber').val('');
            });
            
            function showSelectedPatientInfo(patient) {
                console.log('ğŸ¥ Medical Environment: Patient data:', patient);
                
                // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² helper function
                var fullName = '';
                var firstName = patient.firstName || '';
                var lastName = patient.lastName || '';
                
                // Ø¨Ø±Ø±Ø³ÛŒ null Ùˆ undefined
                if (firstName && firstName !== 'null' && firstName !== 'undefined') {
                    if (lastName && lastName !== 'null' && lastName !== 'undefined') {
                        fullName = firstName + ' ' + lastName;
                    } else {
                        fullName = firstName;
                    }
                } else if (patient.name && patient.name !== 'null' && patient.name !== 'undefined') {
                    fullName = patient.name;
                } else if (patient.text) {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù… Ø§Ø² text Ú©Ù‡ Ø´Ø§Ù…Ù„ Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ù…Ù„ÛŒ Ø§Ø³Øª
                    fullName = patient.text.replace(/\([^)]*\)/g, '').trim();
                    if (!fullName || fullName.length < 2) {
                        fullName = 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
                    }
                } else {
                    fullName = 'Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ';
                }
                
                console.log('ğŸ¥ Medical Environment: Full name:', fullName);
                $('#selectedPatientName').text(fullName);
                $('#selectedPatientFullName').text(fullName);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø³Ø§ÛŒØ± Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                $('#selectedPatientNationalCode').text(patient.nationalCode || '-');
                $('#selectedPatientFatherName').text(patient.fatherName || 'Ù†Ø§Ù…Ø´Ø®Øµ');
                $('#selectedPatientPhone').text(patient.phone || patient.phoneNumber || '-');
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ± (Ø´Ù…Ø³ÛŒ Ùˆ Ø³Ù†)
                var ageText = '-';
                if (patient.birthDateShamsi && patient.age) {
                    ageText = patient.birthDateShamsi + ' (' + patient.age + ' Ø³Ø§Ù„)';
                } else if (patient.birthDateShamsi) {
                    ageText = patient.birthDateShamsi;
                } else if (patient.birthDate && patient.birthDate !== 'null' && patient.birthDate !== 'undefined') {
                    // Fallback: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² JavaScript (Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ±)
                    try {
                        var persianDate = formatPersianDate(patient.birthDate);
                        var age = calculateAge(patient.birthDate);
                        if (age && age !== 'undefined') {
                    ageText = persianDate + ' (' + age + ')';
                        } else {
                            ageText = persianDate;
                        }
                    } catch (e) {
                        console.error('ğŸ¥ Medical Environment: Error calculating age:', e);
                        ageText = patient.birthDate;
                    }
                }
                console.log('ğŸ¥ Medical Environment: Birth date (server):', patient.birthDateShamsi, 'Age (server):', patient.age, 'Age text:', ageText);
                $('#selectedPatientBirthDate').text(ageText);
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¬Ù†Ø³ÛŒØª
                var genderText = '-';
                if (patient.gender !== null && patient.gender !== undefined) {
                    genderText = patient.gender == 1 ? 'Ù…Ø±Ø¯' : 'Ø²Ù†';
                }
                $('#selectedPatientGender').text(genderText);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ
                $('#selectedPatientAddress').text(patient.address || '-');
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
                if (patient.address) {
                    $('#additionalPatientInfo').show();
                } else {
                    $('#additionalPatientInfo').hide();
                }
                
                $('#selectedPatientInfo').show();
            }
        }
        
        /**
         * ğŸ¥ Advanced Insurance Selection
         */
        function initializeAdvancedInsuranceSelection() {
            // ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡
            $('.insurance-tab').on('click', function() {
                var type = $(this).data('type');
                console.log('ğŸ¥ Medical Environment: Switching to tab:', type);
                
                // Ø­ÙØ¸ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                var currentPrimaryProvider = $('#PrimaryInsuranceProviderId').val();
                var currentPrimaryPlan = $('#PrimaryInsurancePlanId').val();
                var currentSupplementaryProvider = $('#SupplementaryInsuranceProviderIdSelect').val();
                var currentSupplementaryPlan = $('#SupplementaryInsurancePlanIdSelect').val();
                
                console.log('ğŸ¥ Medical Environment: Preserving selections - Primary Provider:', currentPrimaryProvider, 'Primary Plan:', currentPrimaryPlan);
                console.log('ğŸ¥ Medical Environment: Preserving selections - Supplementary Provider:', currentSupplementaryProvider, 'Supplementary Plan:', currentSupplementaryPlan);
                
                // ØªØºÛŒÛŒØ± ØªØ¨ ÙØ¹Ø§Ù„
                $('.insurance-tab').removeClass('active');
                $(this).addClass('active');
                
                // ØªØºÛŒÛŒØ± Ù…Ø­ØªÙˆØ§
                $('.insurance-content').removeClass('active');
                $('#' + type + 'InsuranceContent').addClass('active');
                
                // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡ Ùˆ required attributes
                if (type === 'primary') {
                    $('#IsPrimary').prop('checked', true);
                    $('#PrimaryInsuranceProviderId, #PrimaryInsurancePlanId').attr('required', true);
                    $('#SupplementaryInsuranceProviderIdSelect, #SupplementaryInsurancePlanIdSelect').removeAttr('required');
                    
                    // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                    setTimeout(function() {
                        if (currentPrimaryProvider) {
                            console.log('ğŸ¥ Medical Environment: Restoring primary provider selection:', currentPrimaryProvider);
                            $('#PrimaryInsuranceProviderId').val(currentPrimaryProvider).trigger('change');
                        }
                    }, 100);
                } else {
                    $('#IsPrimary').prop('checked', false);
                    $('#PrimaryInsuranceProviderId, #PrimaryInsurancePlanId').removeAttr('required');
                    $('#SupplementaryInsuranceProviderIdSelect, #SupplementaryInsurancePlanIdSelect').attr('required', true);
                    
                    // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                    setTimeout(function() {
                        if (currentSupplementaryProvider) {
                            console.log('ğŸ¥ Medical Environment: Restoring supplementary provider selection:', currentSupplementaryProvider);
                            $('#SupplementaryInsuranceProviderIdSelect').val(currentSupplementaryProvider).trigger('change');
                        }
                    }, 100);
                }
                
                // Fix dropdown width after tab switch
                setTimeout(function() {
                    // Re-apply width to prevent shrinking
                    $('.insurance-content.active .form-control').each(function() {
                        var $this = $(this);
                        $this.css('width', '100%');
                        $this.css('min-width', '100%');
                        $this.css('max-width', '100%');
                    });
                    
                    // Fix Select2 if it exists
                    if ($.fn.select2) {
                        $('.insurance-content.active .form-control').each(function() {
                            var $this = $(this);
                            if ($this.hasClass('select2-hidden-accessible')) {
                                $this.select2('destroy');
                                $this.select2({
                                    theme: 'bootstrap4',
                                    width: '100%',
                                    placeholder: $this.attr('placeholder') || 'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'
                                });
                            }
                        });
                    }
                    
                    // Force reflow to ensure proper rendering
                    $('.insurance-content.active')[0].offsetHeight;
                    
                    console.log('ğŸ¥ Medical Environment: Fixed dropdown widths after tab switch');
                }, 100);
                
                // Additional fix after a longer delay
                setTimeout(function() {
                    $('.insurance-content.active .form-control').each(function() {
                        var $this = $(this);
                        $this.css('width', '100%');
                        $this.css('min-width', '100%');
                    });
                    console.log('ğŸ¥ Medical Environment: Applied additional width fix');
                }, 300);
            });
            
            // Initialize Enhanced Insurance Selection
            if (typeof PatientInsuranceEnhanced !== 'undefined' && PatientInsuranceEnhanced.initializeInsuranceSelection) {
                PatientInsuranceEnhanced.initializeInsuranceSelection();
            } else {
                console.warn('ğŸ¥ Medical Environment: PatientInsuranceEnhanced not available, using fallback');
                initializeFallbackInsuranceSelection();
            }
        }
        
        /**
         * ğŸ¥ Auto Policy Number
         */
        function initializeAutoPolicyNumber() {
            // Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Ú©Ø¯ Ù…Ù„ÛŒ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯
            // Ø§ÛŒÙ† Ú©Ø§Ø± Ø¯Ø± showSelectedPatient Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }
        
        /**
         * ğŸ¥ Form Validation
         */
        function initializeFormValidation() {
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ real-time
            $('.medical-form-control').on('blur', function() {
                validateField($(this));
            });
            
            function validateField($field) {
                var value = $field.val().trim();
                var isValid = true;
                
                if ($field.prop('required') && !value) {
                    isValid = false;
                }
                
                if (isValid) {
                    $field.removeClass('is-invalid').addClass('is-valid');
                } else {
                    $field.removeClass('is-valid').addClass('is-invalid');
                }
                
                return isValid;
            }
        }
        
        /**
         * ğŸ¥ Form Submission
         */
        function initializeFormSubmission() {
            $('form').on('submit', function(e) {
                var $form = $(this);
                var $saveButton = $('#saveButton');
                var $loadingIndicator = $('#loadingIndicator');
                
                // Ù†Ù…Ø§ÛŒØ´ loading
                $saveButton.prop('disabled', true);
                $loadingIndicator.show();
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
                var isValid = true;
                $('.medical-form-control[required]').each(function() {
                    if (!$(this).val().trim()) {
                        isValid = false;
                        $(this).addClass('is-invalid');
                    }
                });
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                var supplementaryProvider = $('#SupplementaryInsuranceProviderIdSelect').val();
                var supplementaryPlan = $('#SupplementaryInsurancePlanIdSelect').val();
                
                if (supplementaryProvider && !supplementaryPlan) {
                    $('#SupplementaryInsurancePlanIdSelect').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!supplementaryProvider && supplementaryPlan) {
                    $('#SupplementaryInsuranceProviderIdSelect').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    $saveButton.prop('disabled', false);
                    $loadingIndicator.hide();
                    alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                }
            });
        }
        
        // âœ… Ø­Ø°Ù Ø´Ø¯: ØªØ§Ø¨Ø¹ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡ initializeMedicalFormEnhancements
        
        /**
         * ğŸ¥ Initialize Medical Environment Form Submission
         */
        // âœ… Ø­Ø°Ù Ø´Ø¯: ØªØ§Ø¨Ø¹ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡ initializeMedicalFormSubmission
        
        // ğŸ¥ Medical Environment: Ø­Ø°Ù event handler Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
        function removeOldFormHandlers() {
            $('#patientInsuranceCreateForm').off('submit');
            console.log('ğŸ¥ Medical Environment: Old form handlers removed');
        }
        
        /**
         * ğŸš¨ CRITICAL FIX: Sync all hidden fields before form submission
         */
        function syncAllHiddenFields() {
            console.log('ğŸ¥ Medical Environment: === SYNCING ALL HIDDEN FIELDS ===');
            
            // Sync PatientId
            var patientId = $('#PatientIdSelect').val();
            if (patientId && patientId !== '' && patientId !== '0') {
                $('#PatientId').val(patientId);
                console.log('ğŸ¥ Medical Environment: âœ… PatientId synced:', patientId);
            }
            
            // Sync InsuranceProviderId
            var primaryProviderId = $('#PrimaryInsuranceProviderId').val();
            var supplementaryProviderId = $('#SupplementaryInsuranceProviderIdSelect').val();
            var finalProviderId = primaryProviderId || supplementaryProviderId;
            
            if (finalProviderId && finalProviderId !== '' && finalProviderId !== '0') {
                $('#InsuranceProviderId').val(finalProviderId);
                console.log('ğŸ¥ Medical Environment: âœ… InsuranceProviderId synced:', finalProviderId);
            }
            
            // Sync InsurancePlanId
            var primaryPlanId = $('#PrimaryInsurancePlanId').val();
            var supplementaryPlanId = $('#SupplementaryInsurancePlanIdSelect').val();
            var finalPlanId = primaryPlanId || supplementaryPlanId;
            
            if (finalPlanId && finalPlanId !== '' && finalPlanId !== '0') {
                $('#InsurancePlanId').val(finalPlanId);
                console.log('ğŸ¥ Medical Environment: âœ… InsurancePlanId synced:', finalPlanId);
            }
            
            // Sync Supplementary fields
            if (supplementaryProviderId && supplementaryProviderId !== '' && supplementaryProviderId !== '0') {
                $('#SupplementaryInsuranceProviderId').val(supplementaryProviderId);
                console.log('ğŸ¥ Medical Environment: âœ… SupplementaryInsuranceProviderId synced:', supplementaryProviderId);
            }
            
            if (supplementaryPlanId && supplementaryPlanId !== '' && supplementaryPlanId !== '0') {
                $('#SupplementaryInsurancePlanId').val(supplementaryPlanId);
                console.log('ğŸ¥ Medical Environment: âœ… SupplementaryInsurancePlanId synced:', supplementaryPlanId);
            }
            
            // Final validation
            console.log('ğŸ¥ Medical Environment: === FINAL HIDDEN FIELD VALUES ===');
            console.log('ğŸ¥ Medical Environment: PatientId:', $('#PatientId').val());
            console.log('ğŸ¥ Medical Environment: InsuranceProviderId:', $('#InsuranceProviderId').val());
            console.log('ğŸ¥ Medical Environment: InsurancePlanId:', $('#InsurancePlanId').val());
            console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId:', $('#SupplementaryInsuranceProviderId').val());
            console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId:', $('#SupplementaryInsurancePlanId').val());
        }

        /**
         * ğŸ¥ Enhanced Form Submission with AJAX
         */
        function initializeEnhancedFormSubmission() {
            // ğŸ¥ Medical Environment: Ø­Ø°Ù event handler Ù‚Ø¯ÛŒÙ…ÛŒ
            removeOldFormHandlers();
            
            $('#patientInsuranceCreateForm').on('submit', function(e) {
                e.preventDefault();
                
                var $form = $(this);
                var $saveButton = $('#saveButton');
                var $loadingIndicator = $('#loadingIndicator');
                
                // ğŸš¨ CRITICAL FIX: Sync all hidden fields BEFORE any processing
                console.log('ğŸ¥ Medical Environment: === SYNCING HIDDEN FIELDS BEFORE SUBMISSION ===');
                syncAllHiddenFields();
                
                // Show loading state
                $saveButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
                $loadingIndicator.show();
                $form.addClass('medical-loading');
                
                // Dates will be converted on server-side using ConvertPersianDatesToGregorian()
                
                // Use the already converted dates from hidden fields
                var startDateValue = $('#StartDate').val();
                var endDateValue = $('#EndDate').val();
                
                // Update hidden fields with current values
                $('#StartDate').val(startDateValue && startDateValue !== '' ? startDateValue : '');
                $('#EndDate').val(endDateValue && endDateValue !== '' ? endDateValue : '');
                
                // Debug: Check hidden fields before sync
                console.log('ğŸ¥ Medical Environment: === HIDDEN FIELDS BEFORE SYNC ===');
                console.log('ğŸ¥ Medical Environment: StartDate before sync:', $('#StartDate').val());
                console.log('ğŸ¥ Medical Environment: EndDate before sync:', $('#EndDate').val());
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId before sync:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId before sync:', $('#SupplementaryInsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId before sync:', $('#SupplementaryInsurancePlanId').val());
                
                // ğŸ¥ MEDICAL DEBUG: Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ
                console.log('ğŸ¥ MEDICAL: === COMPLETE FORM DATA ANALYSIS ===');
                
                // Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù…
                const formDataObject = new FormData($form[0]);
                const allFields = {};
                
                // Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù…
                for (let [key, value] of formDataObject.entries()) {
                    allFields[key] = value;
                    console.log(`ğŸ¥ MEDICAL: ${key}: ${value}`);
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®Ø§Øµ
                console.log('ğŸ¥ MEDICAL: === SPECIFIC FIELD ANALYSIS ===');
                console.log('ğŸ¥ MEDICAL: PatientId:', $('#PatientIdSelect').val());
                console.log('ğŸ¥ MEDICAL: InsuranceProviderId:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ MEDICAL: InsurancePlanId:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ MEDICAL: PolicyNumber:', $('#PolicyNumber').val());
                console.log('ğŸ¥ MEDICAL: StartDate:', $('#StartDate').val());
                console.log('ğŸ¥ MEDICAL: EndDate:', $('#EndDate').val());
                console.log('ğŸ¥ MEDICAL: StartDateShamsi:', $('#StartDateShamsi').val());
                console.log('ğŸ¥ MEDICAL: EndDateShamsi:', $('#EndDateShamsi').val());
                console.log('ğŸ¥ MEDICAL: IsPrimary:', $('#IsPrimary').is(':checked'));
                console.log('ğŸ¥ MEDICAL: IsActive:', $('#IsActive').is(':checked'));
                console.log('ğŸ¥ MEDICAL: CoveragePercent:', $('#CoveragePercent').val());
                console.log('ğŸ¥ MEDICAL: Priority:', $('#Priority').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsuranceProviderId:', $('#SupplementaryInsuranceProviderId').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsurancePlanId:', $('#SupplementaryInsurancePlanId').val());
                
                // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¨ ÙØ¹Ø§Ù„
                const activeTabType = $('.insurance-tab.active').data('type');
                console.log('ğŸ¥ MEDICAL: Active Tab:', activeTabType);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Select2
                console.log('ğŸ¥ MEDICAL: === SELECT2 VALUES ===');
                console.log('ğŸ¥ MEDICAL: PrimaryInsuranceProviderId:', $('#PrimaryInsuranceProviderId').val());
                console.log('ğŸ¥ MEDICAL: PrimaryInsurancePlanId:', $('#PrimaryInsurancePlanId').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsuranceProviderIdSelect:', $('#SupplementaryInsuranceProviderIdSelect').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsurancePlanIdSelect:', $('#SupplementaryInsurancePlanIdSelect').val());
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Hidden Fields
                console.log('ğŸ¥ MEDICAL: === HIDDEN FIELDS ===');
                $('input[type="hidden"]').each(function() {
                    console.log(`ğŸ¥ MEDICAL: Hidden ${$(this).attr('name')}: ${$(this).val()}`);
                });
                
                console.log('ğŸ¥ MEDICAL: === END FORM DATA ANALYSIS ===');
                
                // Debug: Log all form values before creating formData
                console.log('ğŸ¥ Medical Environment: === COMPREHENSIVE FORM DATA DEBUG ===');
                console.log('ğŸ¥ Medical Environment: === BASIC FIELDS ===');
                console.log('ğŸ¥ Medical Environment: PatientId:', $('#PatientIdSelect').val(), 'Type:', typeof $('#PatientIdSelect').val());
                console.log('ğŸ¥ Medical Environment: IsPrimary:', $('#IsPrimary').prop('checked'), 'Type:', typeof $('#IsPrimary').prop('checked'));
                console.log('ğŸ¥ Medical Environment: IsActive:', $('#IsActive').prop('checked'), 'Type:', typeof $('#IsActive').prop('checked'));
                
                console.log('ğŸ¥ Medical Environment: === INSURANCE PROVIDER FIELDS ===');
                console.log('ğŸ¥ Medical Environment: PrimaryInsuranceProviderId:', $('#PrimaryInsuranceProviderId').val(), 'Type:', typeof $('#PrimaryInsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: PrimaryInsurancePlanId:', $('#PrimaryInsurancePlanId').val(), 'Type:', typeof $('#PrimaryInsurancePlanId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId:', $('#SupplementaryInsuranceProviderIdSelect').val(), 'Type:', typeof $('#SupplementaryInsuranceProviderIdSelect').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId:', $('#SupplementaryInsurancePlanIdSelect').val(), 'Type:', typeof $('#SupplementaryInsurancePlanIdSelect').val());
                
                console.log('ğŸ¥ Medical Environment: === POLICY NUMBER FIELDS ===');
                console.log('ğŸ¥ Medical Environment: PolicyNumber:', $('#PolicyNumber').val(), 'Type:', typeof $('#PolicyNumber').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryPolicyNumber:', $('#SupplementaryPolicyNumber').val(), 'Type:', typeof $('#SupplementaryPolicyNumber').val());
                
                console.log('ğŸ¥ Medical Environment: === DATE FIELDS ===');
                console.log('ğŸ¥ Medical Environment: StartDateShamsi:', $('#StartDateShamsi').val(), 'Type:', typeof $('#StartDateShamsi').val());
                console.log('ğŸ¥ Medical Environment: EndDateShamsi:', $('#EndDateShamsi').val(), 'Type:', typeof $('#EndDateShamsi').val());
                console.log('ğŸ¥ Medical Environment: StartDate (hidden):', $('#StartDate').val(), 'Type:', typeof $('#StartDate').val());
                console.log('ğŸ¥ Medical Environment: EndDate (hidden):', $('#EndDate').val(), 'Type:', typeof $('#EndDate').val());
                
                console.log('ğŸ¥ Medical Environment: === HIDDEN FIELDS ===');
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId (hidden):', $('#InsuranceProviderId').val(), 'Type:', typeof $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId (hidden):', $('#SupplementaryInsuranceProviderId').val(), 'Type:', typeof $('#SupplementaryInsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId (hidden):', $('#SupplementaryInsurancePlanId').val(), 'Type:', typeof $('#SupplementaryInsurancePlanId').val());
                
                console.log('ğŸ¥ Medical Environment: === FORM STRUCTURE DEBUG ===');
                console.log('ğŸ¥ Medical Environment: Form action:', $form.attr('action'));
                console.log('ğŸ¥ Medical Environment: Form method:', $form.attr('method'));
                console.log('ğŸ¥ Medical Environment: Form ID:', $form.attr('id'));
                
                console.log('ğŸ¥ Medical Environment: === ELEMENT EXISTENCE CHECK ===');
                console.log('ğŸ¥ Medical Environment: #PatientIdSelect exists:', $('#PatientIdSelect').length > 0);
                console.log('ğŸ¥ Medical Environment: #PrimaryInsuranceProviderId exists:', $('#PrimaryInsuranceProviderId').length > 0);
                console.log('ğŸ¥ Medical Environment: #PrimaryInsurancePlanId exists:', $('#PrimaryInsurancePlanId').length > 0);
                console.log('ğŸ¥ Medical Environment: #PolicyNumber exists:', $('#PolicyNumber').length > 0);
                console.log('ğŸ¥ Medical Environment: #StartDateShamsi exists:', $('#StartDateShamsi').length > 0);
                console.log('ğŸ¥ Medical Environment: #StartDate exists:', $('#StartDate').length > 0);
                console.log('ğŸ¥ Medical Environment: #IsPrimary exists:', $('#IsPrimary').length > 0);
                console.log('ğŸ¥ Medical Environment: #IsActive exists:', $('#IsActive').length > 0);
                
                // Debug: Check form serialization
                console.log('ğŸ¥ Medical Environment: === FORM SERIALIZATION DEBUG ===');
                var formSerialized = $form.serialize();
                console.log('ğŸ¥ Medical Environment: Form serialized data:', formSerialized);
                
                var formFieldsArray = $form.serializeArray();
                console.log('ğŸ¥ Medical Environment: Form fields array data:', formFieldsArray);
                
                // Update hidden fields with current values
                $('#PatientId').val($('#PatientIdSelect').val());
                
                // Set InsuranceProviderId based on active tab and selected provider
                var activeTabElement = $('.insurance-tab.active');
                var insuranceProviderId = '';
                
                // ğŸ¥ Medical Environment: Improved logic for determining active tab
                var isPrimaryTab = (activeTabElement.length > 0 && activeTabElement.data('type') === 'primary');
                var isSupplementaryTab = (activeTabElement.length > 0 && activeTabElement.data('type') === 'supplementary');
                
                if (isPrimaryTab) {
                    insuranceProviderId = $('#PrimaryInsuranceProviderId').val();
                    console.log('ğŸ¥ Medical Environment: Using PRIMARY provider:', insuranceProviderId);
                } else if (isSupplementaryTab) {
                    insuranceProviderId = $('#SupplementaryInsuranceProviderIdSelect').val();
                    console.log('ğŸ¥ Medical Environment: Using SUPPLEMENTARY provider:', insuranceProviderId);
                } else {
                    // Fallback: try to determine from available selections
                    var primaryProvider = $('#PrimaryInsuranceProviderId').val();
                    var supplementaryProvider = $('#SupplementaryInsuranceProviderIdSelect').val();
                    
                    if (primaryProvider && primaryProvider !== '' && primaryProvider !== '0') {
                        insuranceProviderId = primaryProvider;
                        console.log('ğŸ¥ Medical Environment: Fallback to PRIMARY provider:', insuranceProviderId);
                    } else if (supplementaryProvider && supplementaryProvider !== '' && supplementaryProvider !== '0') {
                        insuranceProviderId = supplementaryProvider;
                        console.log('ğŸ¥ Medical Environment: Fallback to SUPPLEMENTARY provider:', insuranceProviderId);
                    }
                }
                
                // Ensure InsuranceProviderId is not empty
                if (!insuranceProviderId || insuranceProviderId === '' || insuranceProviderId === '0') {
                    console.error('ğŸ¥ Medical Environment: InsuranceProviderId is empty or invalid:', insuranceProviderId);
                    alert('Ù„Ø·ÙØ§Ù‹ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // ğŸš¨ CRITICAL FIX: Validate InsuranceProviderId is numeric and positive
                console.log('ğŸ¥ Medical Environment: Validating InsuranceProviderId:', insuranceProviderId);
                var providerIdNum = parseInt(insuranceProviderId, 10);
                if (isNaN(providerIdNum) || providerIdNum <= 0) {
                    console.error('ğŸ¥ Medical Environment: InsuranceProviderId is not a valid positive number:', insuranceProviderId);
                    alert('Ø®Ø·Ø§: Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // Convert to integer to ensure proper type
                insuranceProviderId = providerIdNum;
                
                $('#InsuranceProviderId').val(insuranceProviderId);
                $('#PolicyNumber').val($('#PolicyNumber').val());
                $('#SupplementaryPolicyNumber').val($('#SupplementaryPolicyNumber').val());
                
                // Set InsurancePlanId based on active tab and selected plan
                var insurancePlanId = '';
                
                if (isPrimaryTab) {
                    insurancePlanId = $('#PrimaryInsurancePlanId').val();
                    console.log('ğŸ¥ Medical Environment: Using PRIMARY plan:', insurancePlanId);
                } else if (isSupplementaryTab) {
                    insurancePlanId = $('#SupplementaryInsurancePlanIdSelect').val();
                    console.log('ğŸ¥ Medical Environment: Using SUPPLEMENTARY plan:', insurancePlanId);
                } else {
                    // Fallback: try to determine from available selections
                    var primaryPlan = $('#PrimaryInsurancePlanId').val();
                    var supplementaryPlan = $('#SupplementaryInsurancePlanIdSelect').val();
                    
                    if (primaryPlan && primaryPlan !== '' && primaryPlan !== '0') {
                        insurancePlanId = primaryPlan;
                        console.log('ğŸ¥ Medical Environment: Fallback to PRIMARY plan:', insurancePlanId);
                    } else if (supplementaryPlan && supplementaryPlan !== '' && supplementaryPlan !== '0') {
                        insurancePlanId = supplementaryPlan;
                        console.log('ğŸ¥ Medical Environment: Fallback to SUPPLEMENTARY plan:', insurancePlanId);
                    }
                }
                
                // Ensure InsurancePlanId is not empty
                if (!insurancePlanId || insurancePlanId === '' || insurancePlanId === '0') {
                    console.error('ğŸ¥ Medical Environment: InsurancePlanId is empty or invalid:', insurancePlanId);
                    alert('Ù„Ø·ÙØ§Ù‹ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // ğŸš¨ CRITICAL FIX: Validate InsurancePlanId is numeric and positive
                console.log('ğŸ¥ Medical Environment: Validating InsurancePlanId:', insurancePlanId);
                var planIdNum = parseInt(insurancePlanId, 10);
                if (isNaN(planIdNum) || planIdNum <= 0) {
                    console.error('ğŸ¥ Medical Environment: InsurancePlanId is not a valid positive number:', insurancePlanId);
                    alert('Ø®Ø·Ø§: Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // Convert to integer to ensure proper type
                insurancePlanId = planIdNum;
                
                $('#InsurancePlanId').val(insurancePlanId);
                
                // Debug logging for InsuranceProviderId and InsurancePlanId
                console.log('ğŸ¥ Medical Environment: === FINAL SELECTION DEBUG ===');
                console.log('ğŸ¥ Medical Environment: Active tab type:', activeTabElement.length > 0 ? activeTabElement.data('type') : 'none');
                console.log('ğŸ¥ Medical Environment: Is Primary Tab:', isPrimaryTab);
                console.log('ğŸ¥ Medical Environment: Is Supplementary Tab:', isSupplementaryTab);
                console.log('ğŸ¥ Medical Environment: Final InsuranceProviderId:', insuranceProviderId, 'Type:', typeof insuranceProviderId);
                console.log('ğŸ¥ Medical Environment: Final InsurancePlanId:', insurancePlanId, 'Type:', typeof insurancePlanId);
                console.log('ğŸ¥ Medical Environment: PrimaryInsuranceProviderId value:', $('#PrimaryInsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsuranceProviderId value:', $('#SupplementaryInsuranceProviderIdSelect').val());
                console.log('ğŸ¥ Medical Environment: PrimaryInsurancePlanId value:', $('#PrimaryInsurancePlanId').val());
                console.log('ğŸ¥ Medical Environment: SupplementaryInsurancePlanId value:', $('#SupplementaryInsurancePlanIdSelect').val());
                console.log('ğŸ¥ Medical Environment: Hidden InsuranceProviderId value:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: Hidden InsurancePlanId value:', $('#InsurancePlanId').val());
                
                // IsPrimary checkbox handling - ASP.NET MVC creates a hidden input with value "false"
                // We need to remove the hidden input and set the checkbox value correctly
                // ğŸš¨ CRITICAL: Don't remove hidden input - it's needed for Model Binding
                // $('#IsPrimary[type="hidden"]').remove();
                
                // ğŸ¥ Medical Environment: Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡
                var isPrimary = false;
                var priority = 2; // Default: Supplementary
                
                // ğŸ¥ Medical Environment: Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„ - Active Tab
                if (isPrimaryTab) {
                    // Ø§Ú¯Ø± Ø¯Ø± ØªØ¨ Ø§ØµÙ„ÛŒ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø§Ø³Øª
                    isPrimary = true;
                    priority = 1; // InsurancePriority.Primary
                    console.log('ğŸ¥ Medical Environment: IsPrimary set to TRUE based on active tab');
                } 
                // ğŸ¥ Medical Environment: Ø§ÙˆÙ„ÙˆÛŒØª Ø¯ÙˆÙ… - Checkbox State
                else if ($('#IsPrimary').is(':checked')) {
                    // Ø§Ú¯Ø± checkbox ØªÛŒÚ© Ø®ÙˆØ±Ø¯Ù‡ØŒ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø§Ø³Øª
                    isPrimary = true;
                    priority = 1; // InsurancePriority.Primary
                    console.log('ğŸ¥ Medical Environment: IsPrimary set to TRUE based on checkbox state');
                } 
                // ğŸ¥ Medical Environment: Ø§ÙˆÙ„ÙˆÛŒØª Ø³ÙˆÙ… - Default to Supplementary
                else {
                    // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ø³Øª
                    isPrimary = false;
                    priority = 2; // InsurancePriority.Supplementary
                    console.log('ğŸ¥ Medical Environment: IsPrimary set to FALSE - Supplementary insurance');
                }
                
                // ğŸ¥ Medical Environment: Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                var supplementaryProviderId = $('#SupplementaryInsuranceProviderIdSelect').val();
                var supplementaryPlanId = $('#SupplementaryInsurancePlanIdSelect').val();
                
                // ğŸ¥ Medical Environment: Ø§Ú¯Ø± Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                if (!isPrimary && (!supplementaryProviderId || supplementaryProviderId === '' || supplementaryProviderId === '0')) {
                    console.log('ğŸ¥ Medical Environment: No supplementary insurance selected, defaulting to primary');
                    isPrimary = true;
                    priority = 1; // InsurancePriority.Primary
                }
                
                // ğŸ¥ Medical Environment: Ø§Ú¯Ø± Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ Ø¨Ù‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                if (isPrimary && (!insuranceProviderId || insuranceProviderId === '' || insuranceProviderId === '0')) {
                    console.log('ğŸ¥ Medical Environment: No primary insurance selected, defaulting to supplementary');
                    isPrimary = false;
                    priority = 2; // InsurancePriority.Supplementary
                }
                
                console.log('ğŸ¥ Medical Environment: Active Tab:', activeTabElement.length > 0 ? activeTabElement.data('type') : 'none');
                console.log('ğŸ¥ Medical Environment: IsPrimary Tab:', isPrimaryTab);
                console.log('ğŸ¥ Medical Environment: Final IsPrimary:', isPrimary);
                console.log('ğŸ¥ Medical Environment: Final Priority:', priority);
                
                // ğŸš¨ CRITICAL FIX: Set checkbox state correctly (not with .val())
                $('#IsPrimary').prop('checked', isPrimary);
                console.log('ğŸ¥ Medical Environment: IsPrimary checkbox set to:', isPrimary);
                
                // ğŸš¨ CRITICAL FIX: Final validation before submission
                console.log('ğŸ¥ Medical Environment: === FINAL VALIDATION ===');
                console.log('ğŸ¥ Medical Environment: Final InsuranceProviderId:', insuranceProviderId, 'Type:', typeof insuranceProviderId);
                console.log('ğŸ¥ Medical Environment: Final InsurancePlanId:', insurancePlanId, 'Type:', typeof insurancePlanId);
                console.log('ğŸ¥ Medical Environment: Final IsPrimary:', isPrimary);
                
                // ğŸš¨ CRITICAL DEBUG: Log all form values before submission
                console.log('ğŸ¥ Medical Environment: === COMPLETE FORM DEBUG ===');
                console.log('ğŸ¥ Medical Environment: All form inputs:');
                $form.find('input, select, textarea').each(function() {
                    var $this = $(this);
                    var name = $this.attr('name');
                    var value = $this.val();
                    var type = $this.attr('type');
                    if (name && (name.includes('Insurance') || name.includes('Patient') || name.includes('Policy'))) {
                        console.log('ğŸ¥ Medical Environment: Form Field:', name, '=', value, 'Type:', type);
                    }
                });
                
                // Final validation - ensure we have valid IDs
                if (!insuranceProviderId || insuranceProviderId <= 0) {
                    console.error('ğŸ¥ Medical Environment: Final validation failed - Invalid InsuranceProviderId:', insuranceProviderId);
                    alert('Ø®Ø·Ø§: Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                if (!insurancePlanId || insurancePlanId <= 0) {
                    console.error('ğŸ¥ Medical Environment: Final validation failed - Invalid InsurancePlanId:', insurancePlanId);
                    alert('Ø®Ø·Ø§: Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // ğŸš¨ CRITICAL FIX: Sync hidden fields with selected values
                console.log('ğŸ¥ Medical Environment: === SYNCING HIDDEN FIELDS ===');
                console.log('ğŸ¥ Medical Environment: Before sync - InsuranceProviderId:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: Before sync - InsurancePlanId:', $('#InsurancePlanId').val());
                
                // ğŸš¨ CRITICAL FIX: Ensure hidden fields are properly set
                $('#InsuranceProviderId').val(insuranceProviderId);
                $('#InsurancePlanId').val(insurancePlanId);
                $('#SupplementaryInsuranceProviderId').val(supplementaryProviderId);
                $('#SupplementaryInsurancePlanId').val(supplementaryPlanId);
                
                // ğŸš¨ CRITICAL FIX: Force update hidden fields with current values
                var finalProviderId = $('#PrimaryInsuranceProviderId').val() || $('#SupplementaryInsuranceProviderIdSelect').val();
                var finalPlanId = $('#PrimaryInsurancePlanId').val() || $('#SupplementaryInsurancePlanIdSelect').val();
                
                if (finalProviderId && finalProviderId !== '' && finalProviderId !== '0') {
                    $('#InsuranceProviderId').val(finalProviderId);
                    console.log('ğŸ¥ Medical Environment: âœ… FINAL FIX: InsuranceProviderId synced:', finalProviderId);
                }
                
                if (finalPlanId && finalPlanId !== '' && finalPlanId !== '0') {
                    $('#InsurancePlanId').val(finalPlanId);
                    console.log('ğŸ¥ Medical Environment: âœ… FINAL FIX: InsurancePlanId synced:', finalPlanId);
                }
                
                // ğŸš¨ CRITICAL FIX: Final validation of hidden fields
                console.log('ğŸ¥ Medical Environment: === FINAL HIDDEN FIELD VALIDATION ===');
                console.log('ğŸ¥ Medical Environment: Final InsuranceProviderId:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: Final InsurancePlanId:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ Medical Environment: Final PatientId:', $('#PatientId').val());
                
                // ğŸš¨ CRITICAL FIX: Ensure values are not empty or zero
                if (!$('#InsuranceProviderId').val() || $('#InsuranceProviderId').val() === '0') {
                    console.error('ğŸ¥ Medical Environment: âŒ CRITICAL ERROR: InsuranceProviderId is empty or zero!');
                    alert('Ø®Ø·Ø§: Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                if (!$('#InsurancePlanId').val() || $('#InsurancePlanId').val() === '0') {
                    console.error('ğŸ¥ Medical Environment: âŒ CRITICAL ERROR: InsurancePlanId is empty or zero!');
                    alert('Ø®Ø·Ø§: Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                
                // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…
                console.log('ğŸ¥ Medical Environment: === FINAL VALUES AFTER SETTING ===');
                console.log('ğŸ¥ Medical Environment: Final InsuranceProviderId:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: Final InsurancePlanId:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ Medical Environment: Final PatientId:', $('#PatientIdSelect').val());
                console.log('ğŸ¥ Medical Environment: Final PolicyNumber:', $('#PolicyNumber').val());
                console.log('ğŸ¥ Medical Environment: Final IsPrimary:', $('#IsPrimary').prop('checked'));
                console.log('ğŸ¥ Medical Environment: Final IsActive:', $('#IsActive').prop('checked'));
                console.log('ğŸ¥ Medical Environment: Final Priority:', $('#Priority').val());
                
                // ğŸš¨ CRITICAL FIX: Don't use .val() on checkboxes - use .prop('checked')
                // $('#IsPrimary').val() - WRONG! Use .prop('checked') instead
                // $('#IsActive').val() - WRONG! Use .prop('checked') instead
                $('#Priority').val(priority);
                
                // ğŸš¨ CRITICAL FIX: Final sync before serialization
                console.log('ğŸ¥ Medical Environment: === FINAL SYNC BEFORE SERIALIZATION ===');
                syncAllHiddenFields();
                
                // Use form serialization for proper Model Binding
                var formData = $form.serialize();
                
                // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ AJAX
                console.log('ğŸ¥ Medical Environment: === AJAX SUBMISSION ANALYSIS ===');
                console.log('ğŸ¥ Medical Environment: Form serialized data:', formData);
                console.log('ğŸ¥ Medical Environment: AJAX URL:', '@Url.Action("CreateAjax", "PatientInsurance")');
                console.log('ğŸ¥ Medical Environment: Content-Type will be: application/x-www-form-urlencoded');
                
                // ğŸ¥ Medical Environment: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Model Binding
                console.log('ğŸ¥ Medical Environment: === CRITICAL VALUES FOR MODEL BINDING ===');
                console.log('ğŸ¥ Medical Environment: PatientId:', $('#PatientIdSelect').val());
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ Medical Environment: InsurancePlanId:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ Medical Environment: PolicyNumber:', $('#PolicyNumber').val());
                console.log('ğŸ¥ Medical Environment: StartDate:', $('#StartDate').val());
                console.log('ğŸ¥ Medical Environment: EndDate:', $('#EndDate').val());
                console.log('ğŸ¥ Medical Environment: IsPrimary:', $('#IsPrimary').val());
                console.log('ğŸ¥ Medical Environment: IsActive:', $('#IsActive').val());
                console.log('ğŸ¥ Medical Environment: Priority:', $('#Priority').val());
                
                console.log('ğŸ¥ Medical Environment: Form serialized data:', formData);
                
                // Debug: Log final formData
                console.log('ğŸ¥ Medical Environment: === FINAL FORM DATA ===');
                console.log('ğŸ¥ Medical Environment: formData object:', formData);
                console.log('ğŸ¥ Medical Environment: formData keys:', Object.keys(formData));
                console.log('ğŸ¥ Medical Environment: formData values:', Object.values(formData));
                
                // Debug: Compare form values with form serialization
                console.log('ğŸ¥ Medical Environment: === COMPARISON DEBUG ===');
                console.log('ğŸ¥ Medical Environment: PatientId:', $('#PatientIdSelect').val(), 'vs form serialized PatientId:', $form.find('[name="PatientId"]').val());
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId:', $('#InsuranceProviderId').val(), 'vs form serialized InsuranceProviderId:', $form.find('[name="InsuranceProviderId"]').val());
                console.log('ğŸ¥ Medical Environment: PolicyNumber:', $('#PolicyNumber').val(), 'vs form serialized PolicyNumber:', $form.find('[name="PolicyNumber"]').val());
                console.log('ğŸ¥ Medical Environment: StartDate:', $('#StartDate').val(), 'vs form serialized StartDate:', $form.find('[name="StartDate"]').val());
                
                // Debug: Check for null/undefined values
                console.log('ğŸ¥ Medical Environment: === NULL/UNDEFINED CHECK ===');
                Object.keys(formData).forEach(function(key) {
                    var value = formData[key];
                    if (value === null || value === undefined || value === '') {
                        console.warn('ğŸ¥ Medical Environment: NULL/EMPTY VALUE FOUND:', key, '=', value);
                    } else {
                        console.log('ğŸ¥ Medical Environment: VALID VALUE:', key, '=', value, 'Type:', typeof value);
                    }
                });
                
                // Debug: Check critical fields for Model Binding
                console.log('ğŸ¥ Medical Environment: === CRITICAL FIELDS FOR MODEL BINDING ===');
                console.log('ğŸ¥ Medical Environment: PatientId (required):', formData.PatientId, 'Type:', typeof formData.PatientId);
                console.log('ğŸ¥ Medical Environment: InsuranceProviderId (required):', formData.InsuranceProviderId, 'Type:', typeof formData.InsuranceProviderId);
                console.log('ğŸ¥ Medical Environment: InsurancePlanId (required):', formData.InsurancePlanId, 'Type:', typeof formData.InsurancePlanId);
                console.log('ğŸ¥ Medical Environment: PolicyNumber (required):', formData.PolicyNumber, 'Type:', typeof formData.PolicyNumber);
                console.log('ğŸ¥ Medical Environment: StartDate (required):', formData.StartDate, 'Type:', typeof formData.StartDate);
                console.log('ğŸ¥ Medical Environment: IsPrimary:', formData.IsPrimary, 'Type:', typeof formData.IsPrimary);
                console.log('ğŸ¥ Medical Environment: IsActive:', formData.IsActive, 'Type:', typeof formData.IsActive);
                console.log('ğŸ¥ Medical Environment: Priority:', formData.Priority, 'Type:', typeof formData.Priority);
                
                // Enhanced validation before submission
                var validationErrors = [];
                
                // Get current values for validation
                var patientId = $('#PatientIdSelect').val();
                var patientIdSelect = $('#PatientIdSelect').val();
                var insuranceProviderId = $('#PrimaryInsuranceProviderId').val();
                var insurancePlanId = $('#PrimaryInsurancePlanId').val();
                var policyNumber = $('#PolicyNumber').val();
                var startDate = $('#StartDate').val();
                var supplementaryProviderId = $('#SupplementaryInsuranceProviderIdSelect').val();
                var supplementaryPlanId = $('#SupplementaryInsurancePlanIdSelect').val();
                
                console.log('ğŸ¥ Medical Environment: Validation - PatientId:', patientId, 'PatientIdSelect:', patientIdSelect);
                
                // Validate required fields
                if (!patientId || patientId === '' || patientId === '0') {
                    validationErrors.push('Ø¨ÛŒÙ…Ø§Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#PatientIdSelect').addClass('is-invalid');
                } else {
                    $('#PatientIdSelect').removeClass('is-invalid');
                }
                
                if (!insuranceProviderId || insuranceProviderId === '') {
                    validationErrors.push('Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#PrimaryInsuranceProviderId').addClass('is-invalid');
                } else {
                    $('#PrimaryInsuranceProviderId').removeClass('is-invalid');
                }
                
                if (!insurancePlanId || insurancePlanId === '') {
                    validationErrors.push('Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#PrimaryInsurancePlanId').addClass('is-invalid');
                } else {
                    $('#PrimaryInsurancePlanId').removeClass('is-invalid');
                }
                
                if (!policyNumber || policyNumber === '') {
                    validationErrors.push('Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#PolicyNumber').addClass('is-invalid');
                } else {
                    $('#PolicyNumber').removeClass('is-invalid');
                }
                
                if (!startDate || startDate === '') {
                    validationErrors.push('ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#StartDateShamsi').addClass('is-invalid');
                } else {
                    $('#StartDateShamsi').removeClass('is-invalid');
                }
                
                // Validate supplementary insurance fields if provided
                if (supplementaryProviderId && !supplementaryPlanId) {
                    validationErrors.push('Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒØŒ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†ÛŒØ² Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#SupplementaryInsurancePlanIdSelect').addClass('is-invalid');
                } else {
                    $('#SupplementaryInsurancePlanId').removeClass('is-invalid');
                }
                
                if (supplementaryPlanId && !supplementaryProviderId) {
                    validationErrors.push('Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒØŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ Ù†ÛŒØ² Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                    $('#SupplementaryInsuranceProviderIdSelect').addClass('is-invalid');
                } else {
                    $('#SupplementaryInsuranceProviderId').removeClass('is-invalid');
                }
                
                // Show validation errors if any
                if (validationErrors.length > 0) {
                    e.preventDefault();
                    $saveButton.prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                    $loadingIndicator.hide();
                    $form.removeClass('medical-loading');
                    
                    // Show detailed validation errors
                    var errorMessage = 'Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:\n' + validationErrors.join('\n');
                    showErrorMessage(errorMessage);
                    
                    // Scroll to first invalid field
                    var firstInvalidField = $form.find('.is-invalid').first();
                    if (firstInvalidField.length > 0) {
                        $('html, body').animate({
                            scrollTop: firstInvalidField.offset().top - 100
                        }, 500);
                        firstInvalidField.focus();
                    }
                    
                    return false;
                }
                
                // No need for data type validation since we're using form serialization
                
                console.log('ğŸ¥ Medical Environment: === VALIDATION PASSED ===');
                console.log('ğŸ¥ Medical Environment: Form serialized data:', formData);
                
                // Debug: Log AJAX request details
                console.log('ğŸ¥ Medical Environment: === AJAX REQUEST DEBUG ===');
                // ğŸ¥ MEDICAL DEBUG: Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ AJAX Request
                console.log('ğŸ¥ MEDICAL: === AJAX REQUEST DEBUG ===');
                console.log('ğŸ¥ MEDICAL: AJAX URL:', '@Url.Action("CreateAjax", "PatientInsurance")');
                console.log('ğŸ¥ MEDICAL: AJAX Method: POST');
                console.log('ğŸ¥ MEDICAL: AJAX Data Type: Form Serialization (for Model Binding)');
                console.log('ğŸ¥ MEDICAL: Form Data Length:', formData.length, 'characters');
                console.log('ğŸ¥ MEDICAL: Form Data Preview:', formData.substring(0, 200) + '...');
                
                // ğŸ¥ MEDICAL DEBUG: Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¯Ø± AJAX
                console.log('ğŸ¥ MEDICAL: === AJAX FORM DATA ANALYSIS ===');
                const ajaxFormArray = $form.serializeArray();
                ajaxFormArray.forEach(function(field) {
                    console.log(`ğŸ¥ MEDICAL: AJAX Field ${field.name}: ${field.value}`);
                });
                
                // ğŸ¥ MEDICAL DEBUG: Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®Ø§Øµ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
                console.log('ğŸ¥ MEDICAL: === PRE-AJAX FIELD CHECK ===');
                console.log('ğŸ¥ MEDICAL: PatientId before AJAX:', $('#PatientIdSelect').val());
                console.log('ğŸ¥ MEDICAL: InsuranceProviderId before AJAX:', $('#InsuranceProviderId').val());
                console.log('ğŸ¥ MEDICAL: InsurancePlanId before AJAX:', $('#InsurancePlanId').val());
                console.log('ğŸ¥ MEDICAL: PolicyNumber before AJAX:', $('#PolicyNumber').val());
                console.log('ğŸ¥ MEDICAL: IsPrimary before AJAX:', $('#IsPrimary').is(':checked'));
                console.log('ğŸ¥ MEDICAL: IsActive before AJAX:', $('#IsActive').is(':checked'));
                console.log('ğŸ¥ MEDICAL: StartDate before AJAX:', $('#StartDate').val());
                console.log('ğŸ¥ MEDICAL: EndDate before AJAX:', $('#EndDate').val());
                console.log('ğŸ¥ MEDICAL: StartDateShamsi before AJAX:', $('#StartDateShamsi').val());
                console.log('ğŸ¥ MEDICAL: EndDateShamsi before AJAX:', $('#EndDateShamsi').val());
                console.log('ğŸ¥ MEDICAL: CoveragePercent before AJAX:', $('#CoveragePercent').val());
                console.log('ğŸ¥ MEDICAL: Priority before AJAX:', $('#Priority').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsuranceProviderId before AJAX:', $('#SupplementaryInsuranceProviderId').val());
                console.log('ğŸ¥ MEDICAL: SupplementaryInsurancePlanId before AJAX:', $('#SupplementaryInsurancePlanId').val());
                
                console.log('ğŸ¥ MEDICAL: === END AJAX REQUEST DEBUG ===');
                
                // Submit form using Form Serialization for proper Model Binding
                $.ajax({
                    url: '@Url.Action("CreateAjax", "PatientInsurance")',
                    type: 'POST',
                    data: formData, // This is now a serialized string
                    dataType: 'json', // Expect JSON response
                    success: function(response) {
                        // ğŸ¥ MEDICAL DEBUG: Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ AJAX Response
                        console.log('ğŸ¥ MEDICAL: === AJAX SUCCESS RESPONSE ===');
                        console.log('ğŸ¥ MEDICAL: Response type:', typeof response);
                        console.log('ğŸ¥ MEDICAL: Response:', response);
                        console.log('ğŸ¥ MEDICAL: Response.success:', response ? response.success : 'undefined');
                        console.log('ğŸ¥ MEDICAL: Response.message:', response ? response.message : 'undefined');
                        console.log('ğŸ¥ MEDICAL: Response.Success:', response ? response.Success : 'undefined');
                        console.log('ğŸ¥ MEDICAL: Response.Message:', response ? response.Message : 'undefined');
                        
                        // ğŸ¥ MEDICAL DEBUG: Ø¨Ø±Ø±Ø³ÛŒ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ response
                        if (response) {
                            console.log('ğŸ¥ MEDICAL: === RESPONSE FIELD ANALYSIS ===');
                            for (let key in response) {
                                console.log(`ğŸ¥ MEDICAL: Response.${key}:`, response[key]);
                            }
                            console.log('ğŸ¥ MEDICAL: === END RESPONSE FIELD ANALYSIS ===');
                        }
                        
                        console.log('ğŸ¥ Medical Environment: === AJAX SUCCESS RESPONSE ===');
                        console.log('ğŸ¥ Medical Environment: Response type:', typeof response);
                        console.log('ğŸ¥ Medical Environment: Response:', response);
                        console.log('ğŸ¥ Medical Environment: Response.success:', response ? response.success : 'undefined');
                        console.log('ğŸ¥ Medical Environment: Response.message:', response ? response.message : 'undefined');
                        console.log('ğŸ¥ Medical Environment: Response.Success:', response ? response.Success : 'undefined');
                        console.log('ğŸ¥ Medical Environment: Response.Message:', response ? response.Message : 'undefined');
                        
                        // Handle both success and Success (case-insensitive)
                        var isSuccess = getResponseSuccess(response);
                        var message = getResponseMessage(response);
                        var data = getResponseData(response);
                        var errors = getResponseErrors(response);
                        
                        if (isSuccess) {
                            showSuccessMessage('Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                            
                            // Redirect to details page after a short delay
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Index", "PatientInsurance")';
                            }, 2000);
                        } else {
                            var errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±';
                            if (message) {
                                errorMessage += ': ' + message;
                            } else if (errors && errors.length > 0) {
                                errorMessage += ': ' + errors.join(', ');
                            } else {
                                errorMessage += ': Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ';
                            }
                            showErrorMessage(errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        // ğŸ¥ MEDICAL DEBUG: Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ AJAX Error
                        console.error('ğŸ¥ MEDICAL: === AJAX ERROR RESPONSE ===');
                        console.error('ğŸ¥ MEDICAL: Error:', error);
                        console.error('ğŸ¥ MEDICAL: Status:', status);
                        console.error('ğŸ¥ MEDICAL: XHR Status:', xhr.status);
                        console.error('ğŸ¥ MEDICAL: XHR Status Text:', xhr.statusText);
                        console.error('ğŸ¥ MEDICAL: XHR Response Text:', xhr.responseText);
                        console.error('ğŸ¥ MEDICAL: XHR Response Headers:', xhr.getAllResponseHeaders());
                        
                        // ğŸ¥ MEDICAL DEBUG: Ø¨Ø±Ø±Ø³ÛŒ response text Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø®Ø§Øµ
                        if (xhr.responseText) {
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                console.error('ğŸ¥ MEDICAL: Parsed Error Response:', errorResponse);
                            } catch (e) {
                                console.error('ğŸ¥ MEDICAL: Could not parse error response as JSON:', xhr.responseText);
                            }
                        }
                        
                        console.error('ğŸ¥ Medical Environment: === AJAX ERROR RESPONSE ===');
                        console.error('ğŸ¥ Medical Environment: Error:', error);
                        console.error('ğŸ¥ Medical Environment: Status:', status);
                        console.error('ğŸ¥ Medical Environment: Status Code:', xhr.status);
                        console.error('ğŸ¥ Medical Environment: Status Text:', xhr.statusText);
                        console.error('ğŸ¥ Medical Environment: Response Text:', xhr.responseText);
                        console.error('ğŸ¥ Medical Environment: Response Headers:', xhr.getAllResponseHeaders());
                        console.error('ğŸ¥ Medical Environment: Form Data Sent:', formData);
                        console.error('ğŸ¥ Medical Environment: AJAX URL:', '@Url.Action("CreateAjax", "PatientInsurance")');
                        
                        // Try to parse error response
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            console.error('ğŸ¥ Medical Environment: Parsed Error Response:', errorResponse);
                        } catch (e) {
                            console.error('ğŸ¥ Medical Environment: Could not parse error response as JSON');
                        }
                        
                        showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                    },
                    complete: function() {
                        // Hide loading state
                        $saveButton.prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                        $loadingIndicator.hide();
                        $form.removeClass('medical-loading');
                    }
                });
            });
        }
        
        /**
         * ğŸ¥ Initialize Medical Environment Real-time Validation
         */
        function initializeMedicalRealTimeValidation() {
            // Real-time validation for policy number
            $('#PolicyNumber').on('input', function() {
                var policyNumber = $(this).val();
                if (policyNumber.length > 0) {
                    validatePolicyNumberFormat(policyNumber);
                }
            });
            
            // Real-time validation for dates
            $('.persian-datepicker').on('change', function() {
                var dateValue = $(this).val();
                if (dateValue) {
                    validateDateRange();
                }
            });
        }
        
        /**
         * ğŸ¥ Validate Medical Form
         */
        function validateMedicalForm($form) {
            var isValid = true;
            
            // Check required fields
            $form.find('[required]').each(function() {
                if (!$(this).val()) {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            // Check policy number format
            var policyNumber = $('#PolicyNumber').val();
            if (policyNumber && !validatePolicyNumberFormat(policyNumber)) {
                isValid = false;
            }
            
            // Check date range
            if (!validateDateRange()) {
                isValid = false;
            }
            
            return isValid;
        }
        
        /**
         * ğŸ¥ Validate Policy Number Format
         */
        function validatePolicyNumberFormat(policyNumber) {
            var regex = /^[A-Za-z0-9\-_]+$/;
            var $field = $('#PolicyNumber');
            
            if (!regex.test(policyNumber)) {
                $field.addClass('is-invalid');
                showMedicalValidationMessage($field, 'Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡ ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ØŒ Ø®Ø· ØªÛŒØ±Ù‡ Ùˆ Ø²ÛŒØ±Ø®Ø· Ø¨Ø§Ø´Ø¯');
                return false;
            } else {
                $field.removeClass('is-invalid');
                hideMedicalValidationMessage($field);
                return true;
            }
        }
        
        /**
         * ğŸ¥ Validate Date Range
         */
        function validateDateRange() {
            var startDateShamsi = $('#StartDateShamsi').val();
            var endDateShamsi = $('#EndDateShamsi').val();
            var isValid = true;
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø´Ù…Ø³ÛŒ
            if (!startDateShamsi || !isValidPersianDate(startDateShamsi)) {
                $('#StartDateShamsi').addClass('is-invalid');
                showMedicalValidationMessage($('#StartDateShamsi'), 'ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ (Ø´Ù…Ø³ÛŒ) Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                isValid = false;
            } else {
                $('#StartDateShamsi').removeClass('is-invalid');
                hideMedicalValidationMessage($('#StartDateShamsi'));
            }
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø´Ù…Ø³ÛŒ (Ø§Ú¯Ø± Ù¾Ø± Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
            if (endDateShamsi && !isValidPersianDate(endDateShamsi)) {
                $('#EndDateShamsi').addClass('is-invalid');
                showMedicalValidationMessage($('#EndDateShamsi'), 'ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† (Ø´Ù…Ø³ÛŒ) Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                isValid = false;
            } else {
                $('#EndDateShamsi').removeClass('is-invalid');
                hideMedicalValidationMessage($('#EndDateShamsi'));
            }
            
            // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® (ÙÙ‚Ø· Ø§Ú¯Ø± Ù‡Ø± Ø¯Ùˆ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ù†Ø¯)
            if (startDateShamsi && endDateShamsi && isValidPersianDate(startDateShamsi) && isValidPersianDate(endDateShamsi)) {
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
                var startGregorian = persianToGregorian(startDateShamsi);
                var endGregorian = persianToGregorian(endDateShamsi);
                
                if (startGregorian >= endGregorian) {
                    $('#EndDateShamsi').addClass('is-invalid');
                    showMedicalValidationMessage($('#EndDateShamsi'), 'ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯');
                    isValid = false;
                } else {
                    $('#EndDateShamsi').removeClass('is-invalid');
                    hideMedicalValidationMessage($('#EndDateShamsi'));
                }
            }
            
            return isValid;
        }
        
        /**
         * ğŸ¥ Validate Persian Date Format
         */
        function isValidPersianDate(dateString) {
            if (!dateString) return false;
            
            // ÙØ±Ù…Øª: YYYY/MM/DD
            var persianDateRegex = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;
            var match = dateString.match(persianDateRegex);
            
            if (!match) return false;
            
            var year = parseInt(match[1]);
            var month = parseInt(match[2]);
            var day = parseInt(match[3]);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
            if (year < 1300 || year > 1500) return false;
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            
            return true;
        }
        
        /**
         * ğŸ¥ Convert Persian Date to Gregorian (Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
         */
        function persianToGregorian(persianDate) {
            // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆØ¯
            // ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø³Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            var parts = persianDate.split('/');
            var year = parseInt(parts[0]);
            var month = parseInt(parts[1]);
            var day = parseInt(parts[2]);
            
            // ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ø§ÙÛŒ Ø§Ø³Øª)
            return new Date(year + 621, month - 1, day);
        }
        
        /**
         * ğŸ¥ Show Medical Validation Message
         */
        function showMedicalValidationMessage($field, message) {
            var $message = $field.siblings('.medical-validation-message');
            if ($message.length === 0) {
                $message = $('<div class="medical-validation-message text-danger"></div>');
                $field.after($message);
            }
            $message.text(message).show();
        }
        
        /**
         * ğŸ¥ Hide Medical Validation Message
         */
        function hideMedicalValidationMessage($field) {
            $field.siblings('.medical-validation-message').hide();
        }
        
        /**
         * ğŸ¥ Get Medical Tooltip
         */
        function getMedicalTooltip(field) {
            var tooltips = {
                'patient-selection': 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¨ÛŒÙ…Ù‡',
                'policy-number': 'Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ Ø¨ÛŒÙ…Ø§Ø±',
                'insurance-plan': 'Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±',
                'start-date': 'ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ø¹ØªØ¨Ø§Ø± Ø¨ÛŒÙ…Ù‡',
                'end-date': 'ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø§Ø¹ØªØ¨Ø§Ø± Ø¨ÛŒÙ…Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)',
                'is-primary': 'Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø§Ø³ØªØŸ'
            };
            return tooltips[field] || '';
        }

        /**
         * ğŸ¥ Check Patient Insurance Status with New Validation Service
         */
        function checkPatientInsuranceStatus() {
            var patientId = $('#PatientIdSelect').val();
            if (patientId && patientId > 0) {
                $.ajax({
                    url: '@Url.Action("GetPatientInsuranceStatus", "PatientInsurance")',
                    type: 'GET',
                    data: { patientId: patientId },
                    success: function(response) {
                        var isSuccess = getResponseSuccess(response);
                        var data = getResponseData(response);
                        
                        if (isSuccess) {
                            updateInsuranceStatusDisplay(data);
                        } else {
                            showInsuranceStatusError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±:', error);
                        showInsuranceStatusError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                    }
                });
            }
        }

        /**
         * ğŸ¥ Validate Patient Insurance with New Service
         */
        function validatePatientInsuranceWithNewService() {
            var patientId = $('#PatientIdSelect').val();
            if (patientId && patientId > 0) {
                $.ajax({
                    url: '@Url.Action("ValidatePatientInsurance", "PatientInsurance")',
                    type: 'POST',
                    data: { 
                        patientId: patientId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        var isSuccess = getResponseSuccess(response);
                        var data = getResponseData(response);
                        var message = getResponseMessage(response);
                        
                        if (isSuccess) {
                            showValidationResult(data);
                        } else {
                            showMedicalErrorMessage(message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±:', error);
                        showMedicalErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±');
                    }
                });
            }
        }

        /**
         * ğŸ¥ Show Validation Result
         */
        function showValidationResult(validationResult) {
            var resultHtml = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-check-circle"></i> Ù†ØªÛŒØ¬Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ù‡</h6>
                    <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${validationResult.isValid ? 'Ù…Ø¹ØªØ¨Ø±' : 'Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}</p>
                    <p><strong>ØªØ§Ø±ÛŒØ® Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ:</strong> ${validationResult.validationDate}</p>
            `;
            
            if (validationResult.issues && validationResult.issues.length > 0) {
                resultHtml += '<p><strong>Ù…Ø³Ø§Ø¦Ù„:</strong></p><ul>';
                validationResult.issues.forEach(function(issue) {
                    resultHtml += `<li>${issue.message}</li>`;
                });
                resultHtml += '</ul>';
            }
            
            if (validationResult.recommendations && validationResult.recommendations.length > 0) {
                resultHtml += '<p><strong>ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§:</strong></p><ul>';
                validationResult.recommendations.forEach(function(rec) {
                    resultHtml += `<li>${rec}</li>`;
                });
                resultHtml += '</ul>';
            }
            
            resultHtml += '</div>';
            
            $('.patient-selection-container').after(resultHtml);
        }

        /**
         * ğŸ¥ Update Insurance Status Display
         */
        function updateInsuranceStatusDisplay(statusData) {
            // Update Primary Insurance Status
            var primaryStatusHtml = '';
            if (statusData.hasPrimaryInsurance) {
                primaryStatusHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</strong> ${statusData.primaryInsuranceCount} Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ
                    </div>`;
            } else {
                primaryStatusHtml = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</strong>
                    </div>`;
            }
            $('#primaryInsuranceStatus').html(primaryStatusHtml);

            // Update Supplementary Insurance Status
            var supplementaryStatusHtml = '';
            if (statusData.hasSupplementaryInsurance) {
                supplementaryStatusHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</strong> ${statusData.supplementaryInsuranceCount} Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                    </div>`;
            } else {
                supplementaryStatusHtml = `
                    <div class="alert alert-secondary">
                        <i class="fas fa-minus-circle"></i>
                        <strong>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</strong>
                    </div>`;
            }
            $('#supplementaryInsuranceStatus').html(supplementaryStatusHtml);

            // Update form based on status
            if (statusData.hasPrimaryInsurance && !statusData.hasSupplementaryInsurance) {
                // Patient has primary but no supplementary - suggest supplementary
                $('#IsPrimary').prop('checked', false);
                showMedicalInfoMessage('Ø§ÛŒÙ† Ø¨ÛŒÙ…Ø§Ø± Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø¯Ø§Ø±Ø¯. Ø¨ÛŒÙ…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø«Ø¨Øª Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.');
            } else if (!statusData.hasPrimaryInsurance) {
                // Patient has no primary insurance - suggest primary
                $('#IsPrimary').prop('checked', true);
                showMedicalInfoMessage('Ø§ÛŒÙ† Ø¨ÛŒÙ…Ø§Ø± Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ù†Ø¯Ø§Ø±Ø¯. Ø¨ÛŒÙ…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ø«Ø¨Øª Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.');
            }
        }

        /**
         * ğŸ¥ Show Insurance Status Error
         */
        function showInsuranceStatusError(message) {
            var errorHtml = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Ø®Ø·Ø§:</strong> ${message}
                </div>`;
            $('#primaryInsuranceStatus').html(errorHtml);
            $('#supplementaryInsuranceStatus').html(errorHtml);
        }

        /**
         * ğŸ¥ Initialize Default Free Insurance Button
         */
        function initializeDefaultFreeInsuranceButton() {
            $('#createDefaultFreeInsuranceBtn').on('click', function() {
                var patientId = $('#PatientIdSelect').val();
                if (!patientId || patientId <= 0) {
                    showMedicalErrorMessage('Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    return;
                }

                if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨ÛŒÙ…Ø§Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ')) {
                    createDefaultFreeInsurance(patientId);
                }
            });
        }

        /**
         * ğŸ¥ Initialize Patient Insurance Validation Button
         */
        function initializePatientInsuranceValidationButton() {
            $('#validatePatientInsuranceBtn').on('click', function() {
                var patientId = $('#PatientIdSelect').val();
                if (!patientId || patientId <= 0) {
                    showMedicalErrorMessage('Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    return;
                }

                validatePatientInsuranceWithNewService();
            });
        }

        /**
         * ğŸ¥ Create Default Free Insurance
         */
        function createDefaultFreeInsurance(patientId) {
            var $button = $('#createDefaultFreeInsuranceBtn');
            var $loadingIndicator = $('#loadingIndicator');
            
            // Show loading state
            $button.prop('disabled', true).addClass('medical-loading');
            $loadingIndicator.show();

            $.ajax({
                url: '@Url.Action("CreateDefaultFreeInsurance", "PatientInsurance")',
                type: 'POST',
                data: {
                    patientId: patientId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    var isSuccess = getResponseSuccess(response);
                    var message = getResponseMessage(response);
                    
                    if (isSuccess) {
                        showMedicalSuccessMessage('Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                        // Refresh the page to show the new insurance
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showMedicalErrorMessage(message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯:', error);
                    showMedicalErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¢Ø²Ø§Ø¯');
                },
                complete: function() {
                    $button.prop('disabled', false).removeClass('medical-loading');
                    $loadingIndicator.hide();
                }
            });
        }

        /**
         * ğŸš¨ CRITICAL FIX: Secure HTML escaping for XSS prevention
         */
        function escapeHtml(text) {
            if (!text) return '';
            return $('<div>').text(text).html();
        }

        /**
         * ğŸš¨ CRITICAL FIX: Debug logging control for production
         */
        var DEBUG_MODE = window.__DEBUG__ || false;
        
        function debugLog(message, data) {
            if (DEBUG_MODE) {
                console.log(message, data);
            }
        }

        /**
         * ğŸ¥ Show Medical Info Message (XSS Safe)
         */
        function showMedicalInfoMessage(message) {
            var safeMessage = escapeHtml(message || '');
            var $alert = $('<div class="alert alert-info alert-dismissible fade show" role="alert">');
            $('<i class="fas fa-info-circle"></i> ').appendTo($alert);
            $('<span>').text(safeMessage).appendTo($alert);
            $('<button type="button" class="close" data-dismiss="alert">&times;</button>').appendTo($alert);
            
            $('.patient-insurance-form').prepend($alert);
            
            setTimeout(function() {
                $('.alert-info').fadeOut();
            }, 5000);
        }

        /**
         * ğŸ¥ Show Medical Success Message (XSS Safe)
         */
        function showMedicalSuccessMessage(message) {
            var safeMessage = escapeHtml(message || '');
            var $alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">');
            $('<i class="fas fa-check-circle"></i> ').appendTo($alert);
            $('<span>').text(safeMessage).appendTo($alert);
            $('<button type="button" class="close" data-dismiss="alert">&times;</button>').appendTo($alert);
            
            $('.admin-form-body').prepend($alert);
            
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 5000);
        }

        /**
         * ğŸ¥ Show Medical Error Message (XSS Safe)
         */
        function showMedicalErrorMessage(message) {
            var safeMessage = escapeHtml(message || '');
            var $alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">');
            $('<i class="fas fa-exclamation-circle"></i> ').appendTo($alert);
            $('<span>').text(safeMessage).appendTo($alert);
            $('<button type="button" class="close" data-dismiss="alert">&times;</button>').appendTo($alert);
            
            $('.admin-form-body').prepend($alert);
            
            setTimeout(function() {
                $('.alert-danger').fadeOut();
            }, 5000);
        }
        
        /**
         * ğŸ¥ Show Success Message
         */
        function showSuccessMessage(message) {
            showMedicalSuccessMessage(message);
        }
        
        /**
         * ğŸ¥ Show Error Message
         */
        function showErrorMessage(message) {
            showMedicalErrorMessage(message);
        }
    </script>
}
