using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Web.Mvc;
using ClinicApp.Core;
using ClinicApp.Helpers;
using ClinicApp.Interfaces;
using ClinicApp.Interfaces.Insurance;
using ClinicApp.Models.Entities.Insurance;
using ClinicApp.Services;
using ClinicApp.Services.Insurance;
using ClinicApp.ViewModels.Insurance.InsuranceTariff;
using ClinicApp.ViewModels.Insurance.Supplementary;
using Serilog;

namespace ClinicApp.Areas.Admin.Controllers.Insurance
{
    /// <summary>
    /// Ú©Ù†ØªØ±Ù„Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
    /// Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø¯Ø±Ù…Ø§Ù†ÛŒ Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§
    /// 
    /// ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:
    /// 1. Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
    /// 2. Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (ØªØ§Ù…ÛŒÙ† + Ø¯Ø§Ù†Ø§)
    /// 3. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±
    /// 4. Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ CRUD operations
    /// </summary>
    public class SupplementaryTariffController : BaseController
    {
        private readonly SupplementaryTariffSeederService _seederService;
        private readonly IInsuranceTariffService _tariffService;
        private readonly IInsurancePlanService _planService;
        private readonly IInsuranceProviderService _providerService;
        private readonly ILogger _log;
        private readonly ICurrentUserService _currentUserService;

        public SupplementaryTariffController(
            SupplementaryTariffSeederService seederService,
            IInsuranceTariffService tariffService,
            IInsurancePlanService planService,
            IInsuranceProviderService providerService,
            ILogger logger,
            ICurrentUserService currentUserService,
            IMessageNotificationService messageNotificationService)
            : base(messageNotificationService)
        {
            _seederService = seederService ?? throw new ArgumentNullException(nameof(seederService));
            _tariffService = tariffService ?? throw new ArgumentNullException(nameof(tariffService));
            _planService = planService ?? throw new ArgumentNullException(nameof(planService));
            _providerService = providerService ?? throw new ArgumentNullException(nameof(providerService));
            _log = logger.ForContext<SupplementaryTariffController>();
            _currentUserService = currentUserService ?? throw new ArgumentNullException(nameof(currentUserService));
        }

        /// <summary>
        /// ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        /// </summary>
        [HttpGet]
        public async Task<ActionResult> Index()
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                var statsResult = await _seederService.GetSupplementaryTariffStatsAsync();
                if (statsResult.Success)
                {
                    ViewBag.Stats = statsResult.Data;
                }

                return View();
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                return View();
            }
        }

        /// <summary>
        /// Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> CreateAll()
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                var result = await _seederService.CreateSupplementaryTariffsAsync();
                
                if (result.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯. User: {UserName} (Id: {UserId})",
                        _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - {Error}. User: {UserName} (Id: {UserId})",
                        result.Message, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Øª Ø®Ø§Øµ
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> CreateForService(int serviceId)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Øª {ServiceId}. User: {UserName} (Id: {UserId})",
                    serviceId, _currentUserService.UserName, _currentUserService.UserId);

                var result = await _seederService.CreateSupplementaryTariffForServiceAsync(serviceId);
                
                if (result.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Øª {ServiceId} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯. User: {UserName} (Id: {UserId})",
                        serviceId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Øª {ServiceId} - {Error}. User: {UserName} (Id: {UserId})",
                        serviceId, result.Message, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Øª {ServiceId}. User: {UserName} (Id: {UserId})",
                    serviceId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        /// </summary>
        [HttpGet]
        public async Task<JsonResult> GetStats()
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                var result = await _seederService.GetSupplementaryTariffStatsAsync();
                
                if (result.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. User: {UserName} (Id: {UserId})",
                        _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, data = result.Data }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - {Error}. User: {UserName} (Id: {UserId})",
                        result.Message, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ùˆ ØªÚ©Ù…ÛŒÙ„ÛŒ (Ù…Ø«Ù„ ØªØ§Ù…ÛŒÙ† + Ø¯Ø§Ù†Ø§)
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> CreateInsuranceCombination(int primaryPlanId, int supplementaryPlanId, decimal coveragePercent, decimal maxPayment)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡ - PrimaryPlanId: {PrimaryPlanId}, SupplementaryPlanId: {SupplementaryPlanId}, CoveragePercent: {CoveragePercent}, MaxPayment: {MaxPayment}. User: {UserName} (Id: {UserId})",
                    primaryPlanId, supplementaryPlanId, coveragePercent, maxPayment, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                var primaryPlan = await _planService.GetPlanDetailsAsync(primaryPlanId);
                var supplementaryPlan = await _planService.GetPlanDetailsAsync(supplementaryPlanId);

                if (!primaryPlan.Success || !supplementaryPlan.Success)
                {
                    return Json(new { success = false, message = "Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                // Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ÛŒ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØ¯ Ù…ÙˆØ¬ÙˆØ¯
                var result = await _seederService.CreateSupplementaryTariffsAsync();
                
                if (result.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ - PrimaryPlan: {PrimaryPlanName}, SupplementaryPlan: {SupplementaryPlanName}. User: {UserName} (Id: {UserId})",
                        primaryPlan.Data.Name, supplementaryPlan.Data.Name, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡ - {Error}. User: {UserName} (Id: {UserId})",
                        result.Message, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹ÛŒÛŒÙ† Ø³Øª Ø¨ÛŒÙ…Ù‡" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ø³Øª
        /// </summary>
        [HttpGet]
        public async Task<JsonResult> GetInsurancePlans()
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                var result = await _planService.GetPlansAsync(null, "", 1, 1000);
                
                if (result.Success)
                {
                    var plans = result.Data.Items.Select(p => new
                    {
                        id = p.InsurancePlanId,
                        name = p.Name,
                        providerName = p.InsuranceProviderName,
                        coveragePercent = p.CoveragePercent,
                        isPrimary = p.CoveragePercent > 0 && p.CoveragePercent < 100
                    }).ToList();

                    _log.Information("ğŸ¥ MEDICAL: Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ - Count: {Count}. User: {UserName} (Id: {UserId})",
                        plans.Count, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, data = plans }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ - {Error}. User: {UserName} (Id: {UserId})",
                        result.Message, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = result.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> EditTariff(int tariffId, decimal coveragePercent, decimal maxPayment, string settings = null)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - TariffId: {TariffId}, CoveragePercent: {CoveragePercent}, MaxPayment: {MaxPayment}. User: {UserName} (Id: {UserId})",
                    tariffId, coveragePercent, maxPayment, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡ Ù…ÙˆØ¬ÙˆØ¯
                var tariffResult = await _tariffService.GetTariffByIdAsync(tariffId);
                if (!tariffResult.Success)
                {
                    return Json(new { success = false, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                var tariff = tariffResult.Data;
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ CreateEditViewModel Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                var editModel = new InsuranceTariffCreateEditViewModel
                {
                    InsuranceTariffId = tariff.InsuranceTariffId,
                    ServiceId = tariff.ServiceId,
                    InsurancePlanId = tariff.InsurancePlanId,
                    TariffPrice = tariff.TariffPrice,
                    PatientShare = tariff.PatientShare,
                    InsurerShare = tariff.InsurerShare,
                    IsActive = tariff.IsActive
                };

                // Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                var updateResult = await _tariffService.UpdateTariffAsync(editModel);
                if (updateResult.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - {Error}. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        updateResult.Message, tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = updateResult.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> DeleteTariff(int tariffId)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªØ¹Ø±ÙÙ‡
                var tariffResult = await _tariffService.GetTariffByIdAsync(tariffId);
                if (!tariffResult.Success)
                {
                    return Json(new { success = false, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                // Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡
                var deleteResult = await _tariffService.DeleteTariffAsync(tariffId);
                if (deleteResult.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - {Error}. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        deleteResult.Message, tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = deleteResult.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        /// </summary>
        [HttpGet]
        public async Task<JsonResult> GetTariffDetails(int tariffId)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                var tariffResult = await _tariffService.GetTariffByIdAsync(tariffId);
                if (!tariffResult.Success)
                {
                    return Json(new { success = false, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                var tariff = tariffResult.Data;
                
                // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ø³Ø®
                var tariffDetails = new
                {
                    tariffId = tariff.InsuranceTariffId,
                    serviceId = tariff.ServiceId,
                    serviceName = tariff.ServiceTitle ?? "Ù†Ø§Ù…Ø´Ø®Øµ",
                    planId = tariff.InsurancePlanId,
                    planName = tariff.InsurancePlanName ?? "Ù†Ø§Ù…Ø´Ø®Øµ",
                    tariffPrice = tariff.TariffPrice,
                    patientShare = tariff.PatientShare,
                    insurerShare = tariff.InsurerShare,
                    createdAt = tariff.CreatedAt.ToString("yyyy/MM/dd HH:mm"),
                    updatedAt = tariff.UpdatedAt?.ToString("yyyy/MM/dd HH:mm")
                };
                
                _log.Information("ğŸ¥ MEDICAL: Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = true, data = tariffDetails }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø±Ø­
        /// </summary>
        [HttpGet]
        public async Task<JsonResult> GetTariffsByPlan(int planId)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø±Ø­ - PlanId: {PlanId}. User: {UserName} (Id: {UserId})",
                    planId, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                var supplementaryTariffsResult = await _tariffService.GetSupplementaryTariffsAsync(planId);
                if (!supplementaryTariffsResult.Success)
                {
                    return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" }, JsonRequestBehavior.AllowGet);
                }

                var tariffs = supplementaryTariffsResult.Data.Select(t => new
                {
                    tariffId = t.InsuranceTariffId,
                    serviceId = t.ServiceId,
                    serviceName = t.Service?.Title ?? "Ù†Ø§Ù…Ø´Ø®Øµ",
                    serviceCode = t.Service?.ServiceCode ?? "Ù†Ø§Ù…Ø´Ø®Øµ",
                    patientShare = t.PatientShare,
                    insurerShare = t.InsurerShare,
                    supplementaryCoveragePercent = t.SupplementaryCoveragePercent,
                    supplementaryMaxPayment = t.SupplementaryMaxPayment,
                    priority = t.Priority,
                    startDate = t.StartDate?.ToString("yyyy/MM/dd"),
                    endDate = t.EndDate?.ToString("yyyy/MM/dd"),
                    isActive = t.IsActive,
                    createdAt = t.CreatedAt.ToString("yyyy/MM/dd HH:mm")
                }).ToList();

                _log.Information("ğŸ¥ MEDICAL: ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø±Ø­ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ - PlanId: {PlanId}, Count: {Count}. User: {UserName} (Id: {UserId})",
                    planId, tariffs.Count, _currentUserService.UserName, _currentUserService.UserId);

                return Json(new { success = true, data = tariffs }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø±Ø­. PlanId: {PlanId}. User: {UserName} (Id: {UserId})",
                    planId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø±Ø­" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> UpdateTariffSettings(int tariffId, string settings)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø±ÙÙ‡ Ù…ÙˆØ¬ÙˆØ¯
                var tariffResult = await _tariffService.GetTariffByIdAsync(tariffId);
                if (!tariffResult.Success)
                {
                    return Json(new { success = false, message = "ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                var tariff = tariffResult.Data;
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ CreateEditViewModel Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                var editModel = new InsuranceTariffCreateEditViewModel
                {
                    InsuranceTariffId = tariff.InsuranceTariffId,
                    ServiceId = tariff.ServiceId,
                    InsurancePlanId = tariff.InsurancePlanId,
                    TariffPrice = tariff.TariffPrice,
                    PatientShare = tariff.PatientShare,
                    InsurerShare = tariff.InsurerShare,
                    IsActive = tariff.IsActive
                };

                // Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                var updateResult = await _tariffService.UpdateTariffAsync(editModel);
                if (updateResult.Success)
                {
                    _log.Information("ğŸ¥ MEDICAL: ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ - TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = true, message = "ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    _log.Warning("ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡ - {Error}. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                        updateResult.Message, tariffId, _currentUserService.UserName, _currentUserService.UserId);
                    
                    return Json(new { success = false, message = updateResult.Message }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡. TariffId: {TariffId}. User: {UserName} (Id: {UserId})",
                    tariffId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ¹Ø±ÙÙ‡" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¨ÛŒÙ…Ù‡
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<JsonResult> ValidateTariffCombination(int primaryPlanId, int supplementaryPlanId)
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¨ÛŒÙ…Ù‡ - PrimaryPlanId: {PrimaryPlanId}, SupplementaryPlanId: {SupplementaryPlanId}. User: {UserName} (Id: {UserId})",
                    primaryPlanId, supplementaryPlanId, _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
                var primaryPlanResult = await _planService.GetPlanDetailsAsync(primaryPlanId);
                var supplementaryPlanResult = await _planService.GetPlanDetailsAsync(supplementaryPlanId);

                if (!primaryPlanResult.Success || !supplementaryPlanResult.Success)
                {
                    return Json(new { success = false, message = "ÛŒÚ©ÛŒ Ø§Ø² Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯" }, JsonRequestBehavior.AllowGet);
                }

                var primaryPlan = primaryPlanResult.Data;
                var supplementaryPlan = supplementaryPlanResult.Data;

                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨
                var validationResult = new
                {
                    isValid = true,
                    primaryPlanName = primaryPlan.Name,
                    supplementaryPlanName = supplementaryPlan.Name,
                    primaryCoveragePercent = primaryPlan.CoveragePercent,
                    supplementaryCoveragePercent = supplementaryPlan.CoveragePercent,
                    totalCoveragePercent = primaryPlan.CoveragePercent + supplementaryPlan.CoveragePercent,
                    warnings = new List<string>(),
                    recommendations = new List<string>()
                };

                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
                if (validationResult.totalCoveragePercent > 100)
                {
                    validationResult.warnings.Add("Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨ÛŒØ´ Ø§Ø² 100% Ø§Ø³Øª");
                }

                if (primaryPlan.CoveragePercent < 50)
                {
                    validationResult.recommendations.Add("Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ Ú©Ù…ØªØ± Ø§Ø² 50% Ø§Ø³Øª");
                }

                _log.Information("ğŸ¥ MEDICAL: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯ - PrimaryPlan: {PrimaryPlanName}, SupplementaryPlan: {SupplementaryPlanName}. User: {UserName} (Id: {UserId})",
                    primaryPlan.Name, supplementaryPlan.Name, _currentUserService.UserName, _currentUserService.UserId);

                return Json(new { success = true, data = validationResult }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¨ÛŒÙ…Ù‡. PrimaryPlanId: {PrimaryPlanId}, SupplementaryPlanId: {SupplementaryPlanId}. User: {UserName} (Id: {UserId})",
                    primaryPlanId, supplementaryPlanId, _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ±Ú©ÛŒØ¨ Ø¨ÛŒÙ…Ù‡" }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
        /// </summary>
        [HttpGet]
        public async Task<JsonResult> GetTariffStatistics()
        {
            try
            {
                _log.Information("ğŸ¥ MEDICAL: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³
                var statsResult = await _seederService.GetSupplementaryTariffStatsAsync();
                if (!statsResult.Success)
                {
                    return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§" }, JsonRequestBehavior.AllowGet);
                }

                var statistics = new
                {
                    totalServices = statsResult.Data.TotalServices,
                    totalSupplementaryTariffs = statsResult.Data.TotalSupplementaryTariffs,
                    activeSupplementaryTariffs = statsResult.Data.ActiveSupplementaryTariffs,
                    expiredSupplementaryTariffs = statsResult.Data.ExpiredSupplementaryTariffs,
                    lastUpdated = DateTime.Now.ToString("yyyy/MM/dd HH:mm")
                };

                _log.Information("ğŸ¥ MEDICAL: Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);

                return Json(new { success = true, data = statistics }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                _log.Error(ex, "ğŸ¥ MEDICAL: Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§. User: {UserName} (Id: {UserId})",
                    _currentUserService.UserName, _currentUserService.UserId);
                
                return Json(new { success = false, message = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§" }, JsonRequestBehavior.AllowGet);
            }
        }
    }
}