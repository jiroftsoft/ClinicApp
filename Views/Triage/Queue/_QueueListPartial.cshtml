@using ClinicApp.Models.Enums
@model List<ClinicApp.ViewModels.Triage.TriageQueueItemDto>
@{
    var queueItems = Model ?? new List<ClinicApp.ViewModels.Triage.TriageQueueItemDto>();
}

<div class="table-responsive">
    <table class="table table-striped table-hover" id="queue-table">
        <thead class="thead-dark">
            <tr>
                <th>اولویت</th>
                <th>نام بیمار</th>
                <th>سطح تریاژ</th>
                <th>شکایت اصلی</th>
                <th>زمان انتظار</th>
                <th>وضعیت</th>
                <th>پایش مجدد</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody>
            @if (queueItems.Any())
            {
                foreach (var item in queueItems)
                {
                    <tr class="queue-item @item.UrgencyClass @item.OverdueClass" data-queue-id="@item.QueueId" data-assessment-id="@item.TriageAssessmentId">
                        <td>
                            <span class="badge badge-@(item.Priority <= 2 ? "danger" : item.Priority <= 4 ? "warning" : "info")">
                                @item.Priority
                            </span>
                        </td>
                        <td>
                            <strong>@item.PatientFullName</strong>
                            <br>
                            <small class="text-muted">#@item.PatientId</small>
                        </td>
                        <td>
                            <span class="badge badge-@(item.Level == TriageLevel.ESI1 ? "danger" :
                                                      item.Level ==TriageLevel.ESI2 ? "warning" :
                                                      item.Level ==TriageLevel.ESI3 ? "info" :
                                                      item.Level ==TriageLevel.ESI4 ? "success" : "secondary")">
                                @item.LevelDisplayName
                            </span>
                        </td>
                        <td>
                            <span class="text-truncate" style="max-width: 200px;" title="@item.ChiefComplaint">
                                @item.ChiefComplaint
                            </span>
                        </td>
                        <td>
                            <span class="wait-time" data-queue-time="@item.QueueTimeUtc.ToString("yyyy-MM-ddTHH:mm:ss.fffZ")">
                                @item.WaitTimeDisplay
                            </span>
                            @if (item.IsOverdue)
                            {
                                <br>
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    تأخیر
                                </small>
                            }
                        </td>
                        <td>
                            <span class="badge badge-@(item.Status == "Waiting" ? "warning" :
                                                      item.Status == "Called" ? "info" :
                                                      item.Status == "Completed" ? "success" : "secondary")">
                                @item.StatusDisplayName
                            </span>
                        </td>
                        <td>
                            @if (item.NextReassessmentDueAtUtc.HasValue)
                            {
                                <span class="text-info">
                                    <i class="fas fa-clock"></i>
                                    @item.NextReassessmentDueAtUtc.Value.ToString("HH:mm")
                                </span>
                                <br>
                                <small class="text-muted">
                                    @item.ReassessmentCount بار
                                </small>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-info btn-sm" onclick="TriageQueue.viewDetails(@item.TriageAssessmentId)" title="مشاهده جزئیات">
                                    <i class="fas fa-eye"></i>
                                </button>
                                @if (item.Status == "Waiting")
                                {
                                    <button type="button" class="btn btn-primary btn-sm" onclick="TriageQueue.callPatient(@item.QueueId)" title="فراخوانی بیمار">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                }
                                @if (item.Status == "Called")
                                {
                                    <button type="button" class="btn btn-success btn-sm" onclick="TriageQueue.completeAssessment(@item.QueueId)" title="تکمیل ارزیابی">
                                        <i class="fas fa-check"></i>
                                    </button>
                                }
                                <button type="button" class="btn btn-warning btn-sm" onclick="TriageQueue.reassess(@item.TriageAssessmentId)" title="پایش مجدد">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <br>
                        هیچ بیمار در صف انتظار نیست
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (queueItems.Any())
{
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="TriageQueue.selectAll()">
                    <i class="fas fa-check-square"></i>
                    انتخاب همه
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="TriageQueue.deselectAll()">
                    <i class="fas fa-square"></i>
                    لغو انتخاب
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="TriageQueue.bulkCall()">
                    <i class="fas fa-bell"></i>
                    فراخوانی گروهی
                </button>
            </div>
        </div>
        <div class="col-md-6 text-right">
            <small class="text-muted">
                آخرین به‌روزرسانی: <span id="last-update">@DateTime.Now.ToString("HH:mm:ss")</span>
            </small>
        </div>
    </div>
}

<script>
    // به‌روزرسانی زمان انتظار در Real-time
    function updateWaitTimes() {
        $('.wait-time').each(function () {
            var queueTime = new Date($(this).data('queue-time'));
            var now = new Date();
            var diff = Math.floor((now - queueTime) / 1000 / 60); // دقیقه

            if (diff < 60) {
                $(this).text(diff + ' دقیقه');
            } else {
                var hours = Math.floor(diff / 60);
                var minutes = diff % 60;
                $(this).text(hours + ':' + minutes.toString().padStart(2, '0'));
            }
        });
    }

    // به‌روزرسانی هر دقیقه
    setInterval(updateWaitTimes, 60000);

    // به‌روزرسانی اولیه
    updateWaitTimes();
</script>
