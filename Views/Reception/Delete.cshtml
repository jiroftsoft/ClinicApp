@using ClinicApp.ViewModels
@model ClinicApp.ViewModels.ReceptionDetailsViewModel

@{
    ViewBag.Title = "حذف پذیرش";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- ✅ بخش ۱: ساختار کلی -->
            <h2 class="text-center mb-4">حذف پذیرش</h2>
            <p class="text-center text-muted mb-4">تأیید حذف پذیرش شماره @Model.ReceptionId</p>
            
            <!-- ✅ بخش ۲: طراحی بصری -->
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        تأیید حذف پذیرش
                    </h4>
                </div>
                <div class="card-body">
                    <!-- ✅ هشدار حذف -->
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            هشدار حذف
                        </h5>
                        <p class="mb-0">
                            آیا از حذف این پذیرش اطمینان دارید؟ این عمل قابل بازگشت نیست و تمام اطلاعات مربوط به این پذیرش حذف خواهد شد.
                        </p>
                    </div>

                    <!-- ✅ نمایش اطلاعات پذیرش -->
                    <div class="form-section mb-4">
                        <div class="form-section-header">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <h5 class="mb-0">اطلاعات پذیرش</h5>
                        </div>
                        <div class="form-section-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">شناسه پذیرش:</label>
                                    <p class="form-control-plaintext">@Model.ReceptionId</p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">تاریخ پذیرش:</label>
                                    <p class="form-control-plaintext">@Model.ReceptionDate</p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">نوع پذیرش:</label>
                                    <p class="form-control-plaintext">
                                        <span class="badge bg-@(Model.Type == "عادی" ? "primary" : Model.Type == "اورژانس" ? "danger" : "warning")">
                                            @Model.Type
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">وضعیت:</label>
                                    <p class="form-control-plaintext">
                                        <span class="badge bg-@(Model.Status == "تکمیل شده" ? "success" : Model.Status == "در انتظار" ? "warning" : Model.Status == "لغو شده" ? "danger" : "info")">
                                            @Model.Status
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ اطلاعات بیمار -->
                    <div class="form-section mb-4">
                        <div class="form-section-header">
                            <i class="fas fa-user text-primary me-2"></i>
                            <h5 class="mb-0">اطلاعات بیمار</h5>
                        </div>
                        <div class="form-section-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">نام بیمار:</label>
                                    <p class="form-control-plaintext">@Model.PatientFullName</p>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">کد ملی:</label>
                                    <p class="form-control-plaintext">@Model.PatientNationalCode</p>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">شماره تماس:</label>
                                    <p class="form-control-plaintext">@Model.PatientPhoneNumber</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ اطلاعات پزشک -->
                    <div class="form-section mb-4">
                        <div class="form-section-header">
                            <i class="fas fa-user-md text-primary me-2"></i>
                            <h5 class="mb-0">اطلاعات پزشک</h5>
                        </div>
                        <div class="form-section-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">نام پزشک:</label>
                                    <p class="form-control-plaintext">@Model.DoctorFullName</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">تخصص:</label>
                                    <p class="form-control-plaintext">@Model.DoctorSpecialization</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ اطلاعات مالی -->
                    <div class="form-section mb-4">
                        <div class="form-section-header">
                            <i class="fas fa-money-bill-wave text-primary me-2"></i>
                            <h5 class="mb-0">اطلاعات مالی</h5>
                        </div>
                        <div class="form-section-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">مبلغ کل:</label>
                                    <p class="form-control-plaintext">@Model.TotalAmount.ToString("N0") تومان</p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">مبلغ پرداخت شده:</label>
                                    <p class="form-control-plaintext">@Model.PaidAmount.ToString("N0") تومان</p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">مبلغ باقی‌مانده:</label>
                                    <p class="form-control-plaintext">@Model.RemainingAmount.ToString("N0") تومان</p>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">روش پرداخت:</label>
                                    <p class="form-control-plaintext">@Model.PaymentMethod</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ هشدار وابستگی‌ها -->
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>
                            توجه به وابستگی‌ها
                        </h6>
                        <p class="mb-0">
                            قبل از حذف این پذیرش، لطفاً مطمئن شوید که:
                        </p>
                        <ul class="mb-0 mt-2">
                            <li>هیچ تراکنش مالی مرتبط با این پذیرش وجود ندارد</li>
                            <li>هیچ گزارش یا سند رسمی به این پذیرش وابسته نیست</li>
                            <li>این پذیرش در هیچ فرآیند قانونی یا بیمه‌ای استفاده نشده است</li>
                        </ul>
                    </div>

                    <!-- ✅ فرم حذف -->
                    @using (Html.BeginForm("DeleteConfirmed", "Reception", new { id = Model.ReceptionId }, FormMethod.Post, new { id = "delete-form" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        <!-- ✅ دکمه‌های عملیات -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" id="delete-button" class="btn btn-danger me-2">
                                    <span id="delete-button-text">
                                        <i class="fas fa-trash me-1"></i> حذف پذیرش
                                    </span>
                                    <span id="delete-button-spinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                                </button>
                                <a href="@Url.Action("Details", new { id = Model.ReceptionId })" class="btn btn-info me-2">
                                    <i class="fas fa-eye me-1"></i> مشاهده جزئیات
                                </a>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fas fa-arrow-right me-1"></i> بازگشت
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="~/Content/css/reception-standards.css" rel="stylesheet" />
}

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            // ✅ تأیید حذف
            $('#delete-form').on('submit', function (e) {
                e.preventDefault();
                
                // نمایش پیام تأیید
                if (confirm('آیا از حذف این پذیرش اطمینان دارید؟ این عمل قابل بازگشت نیست.')) {
                    submitDelete();
                }
            });

            // ✅ ارسال درخواست حذف
            function submitDelete() {
                var formData = $('#delete-form').serialize();
                
                $.ajax({
                    url: '@Url.Action("DeleteConfirmed", "Reception", new { id = Model.ReceptionId })',
                    type: 'POST',
                    data: formData,
                    beforeSend: function () {
                        $('#delete-button').prop('disabled', true);
                        $('#delete-button-text').hide();
                        $('#delete-button-spinner').show();
                    },
                    success: function (response) {
                        if (response.success) {
                            showSuccess('پذیرش با موفقیت حذف شد');
                            setTimeout(function () {
                                window.location.href = '@Url.Action("Index")';
                            }, 2000);
                        } else {
                            showError('خطا در حذف پذیرش: ' + response.message);
                        }
                    },
                    error: function () {
                        showError('خطا در ارتباط با سرور');
                    },
                    complete: function () {
                        $('#delete-button').prop('disabled', false);
                        $('#delete-button-text').show();
                        $('#delete-button-spinner').hide();
                    }
                });
            }

            function showSuccess(message) {
                toastr.success(message);
            }

            function showError(message) {
                toastr.error(message);
            }
        });
    </script>
}
