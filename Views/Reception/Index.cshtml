@using ClinicApp.ViewModels
@model ClinicApp.ViewModels.ReceptionSearchViewModel

@{
    ViewBag.Title = "مدیریت پذیرش‌ها";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- ✅ بخش ۱: ساختار کلی -->
            <h2 class="text-center mb-4">مدیریت پذیرش‌ها</h2>
            <p class="text-center text-muted mb-4">جستجو، فیلتر و مدیریت پذیرش‌های بیماران کلینیک شفا</p>
            
            <!-- ✅ بخش ۲: طراحی بصری -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>
                        لیست پذیرش‌ها
                    </h4>
                </div>
                <div class="card-body">
                    <!-- ✅ بخش جستجو و فیلتر -->
                    <div class="form-section mb-4">
                        <div class="form-section-header">
                            <i class="fas fa-search text-primary me-2"></i>
                            <h5 class="mb-0">جستجو و فیلتر</h5>
                        </div>
                        <div class="form-section-body">
                            @using (Html.BeginForm("Index", "Reception", FormMethod.Get, new { id = "search-form", @class = "needs-validation", novalidate = "novalidate" }))
                            {
                                <div class="row g-3">
                                    <!-- کد ملی بیمار -->
                                    <div class="col-md-3">
                                        <label for="PatientNationalCode" class="form-label">کد ملی بیمار</label>
                                        @Html.TextBoxFor(model => model.PatientNationalCode, new { @class = "form-control", placeholder = "کد ملی ۱۰ رقمی" })
                                        @Html.ValidationMessageFor(model => model.PatientNationalCode, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- نام بیمار -->
                                    <div class="col-md-3">
                                        <label for="PatientName" class="form-label">نام بیمار</label>
                                        @Html.TextBoxFor(model => model.PatientName, new { @class = "form-control", placeholder = "نام و نام خانوادگی" })
                                        @Html.ValidationMessageFor(model => model.PatientName, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- نام پزشک -->
                                    <div class="col-md-3">
                                        <label for="DoctorName" class="form-label">نام پزشک</label>
                                        @Html.TextBoxFor(model => model.DoctorName, new { @class = "form-control", placeholder = "نام پزشک" })
                                        @Html.ValidationMessageFor(model => model.DoctorName, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- وضعیت پذیرش -->
                                    <div class="col-md-3">
                                        <label for="Status" class="form-label">وضعیت پذیرش</label>
                                        @Html.DropDownListFor(model => model.Status, Model.StatusList, "همه وضعیت‌ها", new { @class = "form-select" })
                                        @Html.ValidationMessageFor(model => model.Status, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- تاریخ شروع -->
                                    <div class="col-md-3">
                                        <label for="StartDate" class="form-label">تاریخ شروع</label>
                                        @Html.TextBoxFor(model => model.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                        @Html.ValidationMessageFor(model => model.StartDate, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- تاریخ پایان -->
                                    <div class="col-md-3">
                                        <label for="EndDate" class="form-label">تاریخ پایان</label>
                                        @Html.TextBoxFor(model => model.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                        @Html.ValidationMessageFor(model => model.EndDate, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- نوع پذیرش -->
                                    <div class="col-md-3">
                                        <label for="Type" class="form-label">نوع پذیرش</label>
                                        @Html.DropDownListFor(model => model.Type, Model.TypeList, "همه انواع", new { @class = "form-select" })
                                        @Html.ValidationMessageFor(model => model.Type, "", new { @class = "text-danger" })
                                    </div>

                                    <!-- دکمه‌های جستجو -->
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search me-1"></i> جستجو
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- ✅ بخش نتایج -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <i class="fas fa-list text-primary me-2"></i>
                            <h5 class="mb-0">نتایج جستجو</h5>
                            <div class="ms-auto">
                                <a href="@Url.Action("Create")" class="btn btn-success btn-sm">
                                    <i class="fas fa-plus me-1"></i> پذیرش جدید
                                </a>
                            </div>
                        </div>
                        <div class="form-section-body">
                            <!-- جدول نتایج -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped" id="receptions-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>شناسه</th>
                                            <th>نام بیمار</th>
                                            <th>نام پزشک</th>
                                            <th>تاریخ پذیرش</th>
                                            <th>نوع</th>
                                            <th>وضعیت</th>
                                            <th>مبلغ</th>
                                            <th>عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receptions-tbody">
                                        <!-- نتایج از طریق AJAX بارگذاری می‌شوند -->
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                در حال بارگذاری...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- صفحه‌بندی -->
                            <nav aria-label="صفحه‌بندی نتایج" class="mt-3">
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- صفحه‌بندی از طریق AJAX بارگذاری می‌شود -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    
    <script type="text/javascript">
        $(document).ready(function () {
            // ✅ بارگذاری اولیه نتایج
            loadReceptions();

            // ✅ جستجو با فرم
            $('#search-form').on('submit', function (e) {
                e.preventDefault();
                loadReceptions();
            });

            // ✅ تابع بارگذاری نتایج
            function loadReceptions() {
                var formData = $('#search-form').serialize();
                
                $.ajax({
                    url: '@Url.Action("GetReceptions", "Reception")',
                    type: 'GET',
                    data: formData,
                    beforeSend: function () {
                        $('#receptions-tbody').html('<tr><td colspan="8" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>در حال بارگذاری...</td></tr>');
                    },
                    success: function (response) {
                        if (response.success) {
                            displayReceptions(response.data);
                        } else {
                            showError('خطا در بارگذاری نتایج: ' + response.message);
                        }
                    },
                    error: function () {
                        showError('خطا در ارتباط با سرور');
                    }
                });
            }

            // ✅ نمایش نتایج
            function displayReceptions(data) {
                var tbody = $('#receptions-tbody');
                tbody.empty();

                if (data.items && data.items.length > 0) {
                    $.each(data.items, function (index, reception) {
                        var row = '<tr>' +
                            '<td>' + reception.receptionId + '</td>' +
                            '<td>' + reception.patientFullName + '</td>' +
                            '<td>' + reception.doctorFullName + '</td>' +
                            '<td>' + reception.receptionDate + '</td>' +
                            '<td>' + reception.type + '</td>' +
                            '<td><span class="badge bg-' + getStatusColor(reception.status) + '">' + reception.status + '</span></td>' +
                            '<td>' + formatCurrency(reception.totalAmount) + '</td>' +
                            '<td>' +
                                '<div class="btn-group btn-group-sm" role="group">' +
                                    '<a href="@Url.Action("Details")/' + reception.receptionId + '" class="btn btn-outline-info" title="مشاهده جزئیات">' +
                                        '<i class="fas fa-eye"></i>' +
                                    '</a>' +
                                    '<a href="@Url.Action("EditReception")/' + reception.receptionId + '" class="btn btn-outline-warning" title="ویرایش">' +
                                        '<i class="fas fa-edit"></i>' +
                                    '</a>' +
                                    '<button type="button" class="btn btn-outline-danger" onclick="deleteReception(' + reception.receptionId + ')" title="حذف">' +
                                        '<i class="fas fa-trash"></i>' +
                                    '</button>' +
                                '</div>' +
                            '</td>' +
                        '</tr>';
                        tbody.append(row);
                    });
                } else {
                    tbody.html('<tr><td colspan="8" class="text-center text-muted">هیچ پذیرشی یافت نشد</td></tr>');
                }

                // نمایش صفحه‌بندی
                displayPagination(data);
            }

            // ✅ نمایش صفحه‌بندی
            function displayPagination(data) {
                var pagination = $('#pagination');
                pagination.empty();

                if (data.totalPages > 1) {
                    // دکمه قبلی
                    if (data.pageNumber > 1) {
                        pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + (data.pageNumber - 1) + ')">قبلی</a></li>');
                    }

                    // صفحات
                    for (var i = 1; i <= data.totalPages; i++) {
                        var activeClass = i === data.pageNumber ? 'active' : '';
                        pagination.append('<li class="page-item ' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                    }

                    // دکمه بعدی
                    if (data.pageNumber < data.totalPages) {
                        pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + (data.pageNumber + 1) + ')">بعدی</a></li>');
                    }
                }
            }

            // ✅ تغییر صفحه
            window.changePage = function (pageNumber) {
                $('#PageNumber').val(pageNumber);
                loadReceptions();
            };

            // ✅ حذف پذیرش
            window.deleteReception = function (receptionId) {
                if (confirm('آیا از حذف این پذیرش اطمینان دارید؟')) {
                    $.ajax({
                        url: '@Url.Action("Delete", "Reception")/' + receptionId,
                        type: 'POST',
                        data: {
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                showSuccess('پذیرش با موفقیت حذف شد');
                                loadReceptions();
                            } else {
                                showError('خطا در حذف پذیرش: ' + response.message);
                            }
                        },
                        error: function () {
                            showError('خطا در ارتباط با سرور');
                        }
                    });
                }
            };

            // ✅ توابع کمکی
            function getStatusColor(status) {
                switch (status) {
                    case 'تکمیل شده': return 'success';
                    case 'در انتظار': return 'warning';
                    case 'لغو شده': return 'danger';
                    case 'در حال انجام': return 'info';
                    default: return 'secondary';
                }
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('fa-IR').format(amount) + ' تومان';
            }

            function showSuccess(message) {
                // نمایش پیام موفقیت
                toastr.success(message);
            }

            function showError(message) {
                // نمایش پیام خطا
                toastr.error(message);
            }
        });
    </script>
}
