@using ClinicApp.ViewModels.Reception
@using ClinicApp.Constants
@model InsuranceAccordionViewModel

<!-- بخش اطلاعات بیمه - آکاردئون -->
<div class="insurance-accordion-section" id="insuranceAccordionSection">
    
    <!-- Header بخش -->
    <div class="section-header">
        <div class="section-title">
            <h5 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>
                اطلاعات بیمه
            </h5>
            <p class="section-subtitle mb-0">بیمه پایه و تکمیلی بیمار</p>
        </div>
        <div class="section-actions">
            <button type="button" class="btn btn-outline-primary btn-sm" id="loadPatientInsuranceBtn">
                <i class="fas fa-sync me-1"></i>
                بارگذاری بیمه
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" id="saveInsuranceBtn">
                <i class="fas fa-save me-1"></i>
                ذخیره بیمه
            </button>
        </div>
    </div>

    <!-- محتوای بخش -->
    <div class="section-content">
        <div class="row">
            <!-- ستون چپ: بیمه پایه -->
            <div class="col-lg-6">
                <div class="insurance-card primary-insurance">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            بیمه پایه
                        </h6>
                        <span class="badge bg-primary">الزامی</span>
                    </div>
                    <div class="card-body">
                        <!-- بیمه‌گذار پایه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>
                                بیمه‌گذار پایه <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-insurance-provider" 
                                    id="primaryInsuranceProvider" 
                                    name="PrimaryInsurance.ProviderId"
                                    data-placeholder="انتخاب بیمه‌گذار پایه">
                                <option value="">انتخاب کنید</option>
                            </select>
                        </div>

                        <!-- طرح بیمه پایه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-medical me-1"></i>
                                طرح بیمه پایه <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-insurance-plan" 
                                    id="primaryInsurancePlan" 
                                    name="PrimaryInsurance.PlanId"
                                    data-placeholder="انتخاب طرح بیمه"
                                    disabled>
                                <option value="">ابتدا بیمه‌گذار را انتخاب کنید</option>
                            </select>
                        </div>

                        <!-- شماره بیمه‌نامه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i>
                                شماره بیمه‌نامه
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="primaryPolicyNumber" 
                                   name="PrimaryInsurance.PolicyNumber"
                                   placeholder="شماره بیمه‌نامه"
                                   value="@Model.PrimaryInsurance.PolicyNumber">
                        </div>

                        <!-- شماره کارت بیمه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-credit-card me-1"></i>
                                شماره کارت بیمه
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="primaryCardNumber" 
                                   name="PrimaryInsurance.CardNumber"
                                   placeholder="شماره کارت بیمه"
                                   value="@Model.PrimaryInsurance.CardNumber">
                        </div>

                        <!-- وضعیت بیمه پایه -->
                        <div class="insurance-status">
                            <div class="status-item">
                                <span class="status-icon">
                                    <i class="fas fa-check-circle @(Model.PrimaryInsurance.IsValid ? "text-success" : "text-muted")"></i>
                                </span>
                                <span class="status-text">
                                    @(Model.PrimaryInsurance.IsValid ? "بیمه پایه معتبر" : "بیمه پایه انتخاب نشده")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ستون راست: بیمه تکمیلی -->
            <div class="col-lg-6">
                <div class="insurance-card supplementary-insurance">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            بیمه تکمیلی
                        </h6>
                        <span class="badge bg-success">اختیاری</span>
                    </div>
                    <div class="card-body">
                        <!-- بیمه‌گذار تکمیلی -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>
                                بیمه‌گذار تکمیلی
                            </label>
                            <select class="form-select select2-insurance-provider" 
                                    id="supplementaryInsuranceProvider" 
                                    name="SupplementaryInsurance.ProviderId"
                                    data-placeholder="انتخاب بیمه‌گذار تکمیلی">
                                <option value="">انتخاب کنید</option>
                            </select>
                        </div>

                        <!-- طرح بیمه تکمیلی -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-medical me-1"></i>
                                طرح بیمه تکمیلی
                            </label>
                            <select class="form-select select2-insurance-plan" 
                                    id="supplementaryInsurancePlan" 
                                    name="SupplementaryInsurance.PlanId"
                                    data-placeholder="انتخاب طرح بیمه"
                                    disabled>
                                <option value="">ابتدا بیمه‌گذار را انتخاب کنید</option>
                            </select>
                        </div>

                        <!-- شماره بیمه‌نامه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i>
                                شماره بیمه‌نامه
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="supplementaryPolicyNumber" 
                                   name="SupplementaryInsurance.PolicyNumber"
                                   placeholder="شماره بیمه‌نامه"
                                   value="@Model.SupplementaryInsurance.PolicyNumber">
                        </div>

                        <!-- شماره کارت بیمه -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-credit-card me-1"></i>
                                شماره کارت بیمه
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="supplementaryCardNumber" 
                                   name="SupplementaryInsurance.CardNumber"
                                   placeholder="شماره کارت بیمه"
                                   value="@Model.SupplementaryInsurance.CardNumber">
                        </div>

                        <!-- وضعیت بیمه تکمیلی -->
                        <div class="insurance-status">
                            <div class="status-item">
                                <span class="status-icon">
                                    <i class="fas fa-check-circle @(Model.SupplementaryInsurance.IsValid ? "text-success" : "text-muted")"></i>
                                </span>
                                <span class="status-text">
                                    @(Model.SupplementaryInsurance.IsValid ? "بیمه تکمیلی معتبر" : "بیمه تکمیلی انتخاب نشده")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- خلاصه محاسبات بیمه -->
        <div class="insurance-summary">
            <div class="row">
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">درصد پوشش بیمه</div>
                            <div class="summary-value" id="insuranceCoveragePercentage">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">سهم بیمه</div>
                            <div class="summary-value" id="insuranceShareAmount">0 ریال</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">سهم بیمار</div>
                            <div class="summary-value" id="patientShareAmount">0 ریال</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS تخصصی بخش بیمه -->
<style>
    .insurance-accordion-section {
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
    }

    .section-header {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title h5 {
        color: #333;
        font-weight: 600;
    }

    .section-subtitle {
        color: #666;
        font-size: 0.9rem;
    }

    .section-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .section-content {
        padding: 2rem;
    }

    .insurance-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 100%;
        transition: all 0.3s ease;
    }

    .insurance-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .primary-insurance {
        border-left: 4px solid #007bff;
    }

    .supplementary-insurance {
        border-left: 4px solid #28a745;
    }

    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        color: #333;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .form-control,
    .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .insurance-status {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-icon i {
        font-size: 1.1rem;
    }

    .status-text {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .insurance-summary {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e9ecef;
    }

    .summary-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .summary-icon {
        font-size: 2rem;
        color: #007bff;
        margin-bottom: 1rem;
    }

    .summary-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .summary-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #333;
    }

    /* Select2 Customization */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 45px;
        border: 1px solid #ced4da;
        border-radius: 6px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 43px;
        padding-left: 12px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 43px;
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: stretch;
        }

        .section-actions {
            justify-content: center;
        }

        .section-content {
            padding: 1rem;
        }

        .insurance-summary .row {
            flex-direction: column;
        }

        .summary-card {
            margin-bottom: 1rem;
        }
    }
</style>

<!-- JavaScript تخصصی بخش بیمه -->
<script>
    $(document).ready(function() {
        initializeInsuranceSection();
    });

    function initializeInsuranceSection() {
        console.log('🛡️ Initializing Insurance Section...');
        
        // تنظیمات اولیه
        setupSelect2();
        setupInsuranceEvents();
        setupInsuranceValidation();
        setupInsuranceActions();
        
        // بارگذاری بیمه‌گذاران
        loadInsuranceProviders();
        
        console.log('✅ Insurance Section initialized successfully');
    }

    function setupSelect2() {
        // تنظیمات Select2 برای بیمه‌گذاران
        $('.select2-insurance-provider').select2({
            placeholder: 'انتخاب کنید...',
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return 'نتیجه‌ای یافت نشد';
                },
                searching: function() {
                    return 'در حال جستجو...';
                }
            }
        });

        // تنظیمات Select2 برای طرح‌های بیمه
        $('.select2-insurance-plan').select2({
            placeholder: 'انتخاب کنید...',
            allowClear: true,
            width: '100%',
            disabled: true,
            language: {
                noResults: function() {
                    return 'نتیجه‌ای یافت نشد';
                },
                searching: function() {
                    return 'در حال جستجو...';
                }
            }
        });
    }

    function setupInsuranceEvents() {
        // تغییر بیمه‌گذار پایه
        $('#primaryInsuranceProvider').on('change', function() {
            const providerId = $(this).val();
            if (providerId) {
                loadInsurancePlans(providerId, '#primaryInsurancePlan', 1); // 1 = Primary
            } else {
                $('#primaryInsurancePlan').empty().prop('disabled', true);
            }
            calculateInsuranceShare();
        });

        // تغییر طرح بیمه پایه
        $('#primaryInsurancePlan').on('change', function() {
            calculateInsuranceShare();
        });

        // تغییر بیمه‌گذار تکمیلی
        $('#supplementaryInsuranceProvider').on('change', function() {
            const providerId = $(this).val();
            if (providerId) {
                loadInsurancePlans(providerId, '#supplementaryInsurancePlan', 2); // 2 = Supplementary
            } else {
                $('#supplementaryInsurancePlan').empty().prop('disabled', true);
            }
            calculateInsuranceShare();
        });

        // تغییر طرح بیمه تکمیلی
        $('#supplementaryInsurancePlan').on('change', function() {
            calculateInsuranceShare();
        });

        // تغییر شماره بیمه‌نامه
        $('#primaryPolicyNumber, #supplementaryPolicyNumber').on('input', function() {
            calculateInsuranceShare();
        });

        // تغییر شماره کارت بیمه
        $('#primaryCardNumber, #supplementaryCardNumber').on('input', function() {
            calculateInsuranceShare();
        });
    }

    function setupInsuranceValidation() {
        // اعتبارسنجی Real-time
        $('#primaryInsuranceProvider, #primaryInsurancePlan').on('change', function() {
            validatePrimaryInsurance();
        });

        $('#supplementaryInsuranceProvider, #supplementaryInsurancePlan').on('change', function() {
            validateSupplementaryInsurance();
        });
    }

    function setupInsuranceActions() {
        // دکمه بارگذاری بیمه بیمار
        $('#loadPatientInsuranceBtn').on('click', function() {
            loadPatientInsurance();
        });

        // دکمه ذخیره بیمه
        $('#saveInsuranceBtn').on('click', function() {
            saveInsurance();
        });
    }

    function loadInsuranceProviders() {
        $.ajax({
            url: '@Url.Action("GetInsuranceProviders", "ReceptionInsuranceAuto")',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    populateInsuranceProviders(response.data);
                } else {
                    showNotification('خطا در بارگذاری بیمه‌گذاران', 'error');
                }
            },
            error: function() {
                showNotification('خطا در بارگذاری بیمه‌گذاران', 'error');
            }
        });
    }

    function populateInsuranceProviders(providers) {
        const primarySelect = $('#primaryInsuranceProvider');
        const supplementarySelect = $('#supplementaryInsuranceProvider');
        
        // پاک کردن گزینه‌های قبلی
        primarySelect.empty().append('<option value="">انتخاب کنید</option>');
        supplementarySelect.empty().append('<option value="">انتخاب کنید</option>');
        
        // اضافه کردن بیمه‌گذاران
        providers.forEach(function(provider) {
            const option = `<option value="${provider.id}">${provider.name}</option>`;
            primarySelect.append(option);
            supplementarySelect.append(option);
        });
        
        // به‌روزرسانی Select2
        primarySelect.trigger('change');
        supplementarySelect.trigger('change');
    }

    function loadInsurancePlans(providerId, selectId, insuranceType) {
        $(selectId).prop('disabled', true).empty().append('<option value="">در حال بارگذاری...</option>');
        
        $.ajax({
            url: '@Url.Action("GetInsurancePlans", "ReceptionInsuranceAuto")',
            type: 'GET',
            data: { 
                providerId: providerId
            },
            dataType: 'json',
            success: function(response) {
                const select = $(selectId);
                select.empty().append('<option value="">انتخاب کنید</option>');
                
                if (response.success && response.data) {
                    response.data.forEach(function(plan) {
                        select.append(`<option value="${plan.id}">${plan.name}</option>`);
                    });
                    select.prop('disabled', false);
                } else {
                    select.append('<option value="">هیچ طرحی یافت نشد</option>');
                }
                
                select.trigger('change');
            },
            error: function() {
                $(selectId).empty().append('<option value="">خطا در بارگذاری</option>');
            }
        });
    }

    function validatePrimaryInsurance() {
        const providerId = $('#primaryInsuranceProvider').val();
        const planId = $('#primaryInsurancePlan').val();
        const isValid = providerId && planId;
        
        updateInsuranceStatus('primary', isValid);
        return isValid;
    }

    function validateSupplementaryInsurance() {
        const providerId = $('#supplementaryInsuranceProvider').val();
        const planId = $('#supplementaryInsurancePlan').val();
        const isValid = providerId && planId;
        
        updateInsuranceStatus('supplementary', isValid);
        return isValid;
    }

    function updateInsuranceStatus(type, isValid) {
        const statusIcon = $(`.${type}-insurance .status-icon i`);
        const statusText = $(`.${type}-insurance .status-text`);
        
        if (isValid) {
            statusIcon.removeClass('text-muted').addClass('text-success');
            statusText.text(`${type === 'primary' ? 'بیمه پایه' : 'بیمه تکمیلی'} معتبر`);
        } else {
            statusIcon.removeClass('text-success').addClass('text-muted');
            statusText.text(`${type === 'primary' ? 'بیمه پایه' : 'بیمه تکمیلی'} انتخاب نشده`);
        }
    }

    function calculateInsuranceShare() {
        // محاسبه سهم بیمه و بیمار
        const primaryValid = validatePrimaryInsurance();
        const supplementaryValid = validateSupplementaryInsurance();
        
        if (!primaryValid) {
            updateInsuranceSummary(0, 0, 0);
            return;
        }
        
        // درخواست محاسبه از سرور
        const insuranceData = {
            primaryProviderId: $('#primaryInsuranceProvider').val(),
            primaryPlanId: $('#primaryInsurancePlan').val(),
            supplementaryProviderId: $('#supplementaryInsuranceProvider').val(),
            supplementaryPlanId: $('#supplementaryInsurancePlan').val()
        };
        
        $.ajax({
            url: '@Url.Action("CalculateInsuranceShare", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: insuranceData,
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    updateInsuranceSummary(
                        response.data.coveragePercentage,
                        response.data.insuranceShare,
                        response.data.patientShare
                    );
                } else {
                    updateInsuranceSummary(0, 0, 0);
                }
            },
            error: function() {
                updateInsuranceSummary(0, 0, 0);
            }
        });
    }

    function updateInsuranceSummary(percentage, insuranceShare, patientShare) {
        $('#insuranceCoveragePercentage').text(percentage + '%');
        $('#insuranceShareAmount').text(formatCurrency(insuranceShare));
        $('#patientShareAmount').text(formatCurrency(patientShare));
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('fa-IR').format(amount) + ' ریال';
    }

    function loadPatientInsurance() {
        const patientId = getCurrentPatientId();
        
        if (!patientId) {
            showNotification('ابتدا بیمار را انتخاب کنید', 'warning');
            return;
        }
        
        $.ajax({
            url: '@Url.Action("AutoBindPatientInsurance", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: { patientId: getCurrentPatientId() },
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    displayPatientInsurance(response.data);
                } else {
                    showNotification('بیمه‌ای برای این بیمار یافت نشد', 'info');
                }
            },
            error: function() {
                showNotification('خطا در بارگذاری بیمه بیمار', 'error');
            }
        });
    }

    function displayPatientInsurance(insuranceData) {
        // پر کردن بیمه پایه
        if (insuranceData.primary) {
            $('#primaryInsuranceProvider').val(insuranceData.primary.providerId).trigger('change');
            $('#primaryInsurancePlan').val(insuranceData.primary.planId).trigger('change');
            $('#primaryPolicyNumber').val(insuranceData.primary.policyNumber);
            $('#primaryCardNumber').val(insuranceData.primary.cardNumber);
        }
        
        // پر کردن بیمه تکمیلی
        if (insuranceData.supplementary) {
            $('#supplementaryInsuranceProvider').val(insuranceData.supplementary.providerId).trigger('change');
            $('#supplementaryInsurancePlan').val(insuranceData.supplementary.planId).trigger('change');
            $('#supplementaryPolicyNumber').val(insuranceData.supplementary.policyNumber);
            $('#supplementaryCardNumber').val(insuranceData.supplementary.cardNumber);
        }
        
        // محاسبه مجدد
        calculateInsuranceShare();
    }

    function saveInsurance() {
        const insuranceData = collectInsuranceData();
        
        $.ajax({
            url: '@Url.Action("SavePatientInsurance", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: insuranceData,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    showNotification('اطلاعات بیمه با موفقیت ذخیره شد', 'success');
                } else {
                    showNotification(response.message || 'خطا در ذخیره اطلاعات بیمه', 'error');
                }
            },
            error: function() {
                showNotification('خطا در ذخیره اطلاعات بیمه', 'error');
            }
        });
    }

    function collectInsuranceData() {
        return {
            nationalCode: $('#patientNationalCode').val(),
            primaryProviderId: $('#primaryInsuranceProvider').val(),
            primaryPlanId: $('#primaryInsurancePlan').val(),
            primaryPolicyNumber: $('#primaryPolicyNumber').val(),
            primaryCardNumber: $('#primaryCardNumber').val(),
            supplementaryProviderId: $('#supplementaryInsuranceProvider').val(),
            supplementaryPlanId: $('#supplementaryInsurancePlan').val(),
            supplementaryPolicyNumber: $('#supplementaryPolicyNumber').val(),
            supplementaryCardNumber: $('#supplementaryCardNumber').val()
        };
    }

    function getCurrentPatientId() {
        // دریافت شناسه بیمار از بخش اطلاعات بیمار
        return $('#patientId').val() || null;
    }

    function showNotification(message, type) {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('#insuranceAccordionSection').prepend(alert);
        
        setTimeout(function() {
            alert.alert('close');
        }, 5000);
    }
</script>
