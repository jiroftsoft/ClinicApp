@using ClinicApp.ViewModels.Reception
@using ClinicApp.Constants
@model InsuranceAccordionViewModel

<!-- Ø¨Ø®Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ - Ø¢Ú©Ø§Ø±Ø¯Ø¦ÙˆÙ† -->
<div class="insurance-accordion-section" id="insuranceAccordionSection">
    
    <!-- Header Ø¨Ø®Ø´ -->
    <div class="section-header">
        <div class="section-title">
            <h5 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>
                Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡
            </h5>
            <p class="section-subtitle mb-0">Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ùˆ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø¨ÛŒÙ…Ø§Ø±</p>
        </div>
        <div class="section-actions">
            <button type="button" class="btn btn-outline-primary btn-sm" id="loadPatientInsuranceBtn">
                <i class="fas fa-sync me-1"></i>
                Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" id="saveInsuranceBtn">
                <i class="fas fa-save me-1"></i>
                Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡
            </button>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø®Ø´ -->
    <div class="section-content">
        <div class="row">
            <!-- Ø³ØªÙˆÙ† Ú†Ù¾: Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ -->
            <div class="col-lg-6">
                <div class="insurance-card primary-insurance">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡
                        </h6>
                        <span class="badge bg-primary">Ø§Ù„Ø²Ø§Ù…ÛŒ</span>
                    </div>
                    <div class="card-body">
                        <!-- Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>
                                Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡ <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-insurance-provider" 
                                    id="primaryInsuranceProvider" 
                                    name="PrimaryInsurance.ProviderId"
                                    data-placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            </select>
                        </div>

                        <!-- Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-medical me-1"></i>
                                Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-insurance-plan" 
                                    id="primaryInsurancePlan" 
                                    name="PrimaryInsurance.PlanId"
                                    data-placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡"
                                    disabled>
                                <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            </select>
                        </div>

                        <!-- Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i>
                                Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="primaryPolicyNumber" 
                                   name="PrimaryInsurance.PolicyNumber"
                                   placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡"
                                   value="@Model.PrimaryInsurance.PolicyNumber">
                        </div>

                        <!-- Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-credit-card me-1"></i>
                                Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="primaryCardNumber" 
                                   name="PrimaryInsurance.CardNumber"
                                   placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡"
                                   value="@Model.PrimaryInsurance.CardNumber">
                        </div>

                        <!-- ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ -->
                        <div class="insurance-status">
                            <div class="status-item">
                                <span class="status-icon">
                                    <i class="fas fa-check-circle @(Model.PrimaryInsurance.IsValid ? "text-success" : "text-muted")"></i>
                                </span>
                                <span class="status-text">
                                    @(Model.PrimaryInsurance.IsValid ? "Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ù…Ø¹ØªØ¨Ø±" : "Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª: Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
            <div class="col-lg-6">
                <div class="insurance-card supplementary-insurance">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                        </h6>
                        <span class="badge bg-success">Ø§Ø®ØªÛŒØ§Ø±ÛŒ</span>
                    </div>
                    <div class="card-body">
                        <!-- Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-building me-1"></i>
                                Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ
                            </label>
                            <select class="form-select select2-insurance-provider" 
                                    id="supplementaryInsuranceProvider" 
                                    name="SupplementaryInsurance.ProviderId"
                                    data-placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            </select>
                        </div>

                        <!-- Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-medical me-1"></i>
                                Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
                            </label>
                            <select class="form-select select2-insurance-plan" 
                                    id="supplementaryInsurancePlan" 
                                    name="SupplementaryInsurance.PlanId"
                                    data-placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡"
                                    disabled>
                                <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            </select>
                        </div>

                        <!-- Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i>
                                Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="supplementaryPolicyNumber" 
                                   name="SupplementaryInsurance.PolicyNumber"
                                   placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡"
                                   value="@Model.SupplementaryInsurance.PolicyNumber">
                        </div>

                        <!-- Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡ -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="fas fa-credit-card me-1"></i>
                                Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="supplementaryCardNumber" 
                                   name="SupplementaryInsurance.CardNumber"
                                   placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡"
                                   value="@Model.SupplementaryInsurance.CardNumber">
                        </div>

                        <!-- ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
                        <div class="insurance-status">
                            <div class="status-item">
                                <span class="status-icon">
                                    <i class="fas fa-check-circle @(Model.SupplementaryInsurance.IsValid ? "text-success" : "text-muted")"></i>
                                </span>
                                <span class="status-text">
                                    @(Model.SupplementaryInsurance.IsValid ? "Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…Ø¹ØªØ¨Ø±" : "Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø®Ù„Ø§ØµÙ‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨ÛŒÙ…Ù‡ -->
        <div class="insurance-summary">
            <div class="row">
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡</div>
                            <div class="summary-value" id="insuranceCoveragePercentage">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡</div>
                            <div class="summary-value" id="insuranceShareAmount">0 Ø±ÛŒØ§Ù„</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±</div>
                            <div class="summary-value" id="patientShareAmount">0 Ø±ÛŒØ§Ù„</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS ØªØ®ØµØµÛŒ Ø¨Ø®Ø´ Ø¨ÛŒÙ…Ù‡ -->
<style>
    .insurance-accordion-section {
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
    }

    .section-header {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title h5 {
        color: #333;
        font-weight: 600;
    }

    .section-subtitle {
        color: #666;
        font-size: 0.9rem;
    }

    .section-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .section-content {
        padding: 2rem;
    }

    .insurance-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 100%;
        transition: all 0.3s ease;
    }

    .insurance-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .primary-insurance {
        border-left: 4px solid #007bff;
    }

    .supplementary-insurance {
        border-left: 4px solid #28a745;
    }

    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        color: #333;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .form-control,
    .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .insurance-status {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-icon i {
        font-size: 1.1rem;
    }

    .status-text {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .insurance-summary {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e9ecef;
    }

    .summary-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .summary-icon {
        font-size: 2rem;
        color: #007bff;
        margin-bottom: 1rem;
    }

    .summary-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .summary-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #333;
    }

    /* Select2 Customization */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 45px;
        border: 1px solid #ced4da;
        border-radius: 6px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 43px;
        padding-left: 12px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 43px;
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: stretch;
        }

        .section-actions {
            justify-content: center;
        }

        .section-content {
            padding: 1rem;
        }

        .insurance-summary .row {
            flex-direction: column;
        }

        .summary-card {
            margin-bottom: 1rem;
        }
    }
</style>

<!-- JavaScript ØªØ®ØµØµÛŒ Ø¨Ø®Ø´ Ø¨ÛŒÙ…Ù‡ -->
<script>
    $(document).ready(function() {
        initializeInsuranceSection();
    });

    function initializeInsuranceSection() {
        console.log('ğŸ›¡ï¸ Initializing Insurance Section...');
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
        setupSelect2();
        setupInsuranceEvents();
        setupInsuranceValidation();
        setupInsuranceActions();
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù†
        loadInsuranceProviders();
        
        console.log('âœ… Insurance Section initialized successfully');
    }

    function setupSelect2() {
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Select2 Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù†
        $('.select2-insurance-provider').select2({
            placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...',
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                },
                searching: function() {
                    return 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
                }
            }
        });

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Select2 Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ù‡
        $('.select2-insurance-plan').select2({
            placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...',
            allowClear: true,
            width: '100%',
            disabled: true,
            language: {
                noResults: function() {
                    return 'Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                },
                searching: function() {
                    return 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
                }
            }
        });
    }

    function setupInsuranceEvents() {
        // ØªØºÛŒÛŒØ± Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± Ù¾Ø§ÛŒÙ‡
        $('#primaryInsuranceProvider').on('change', function() {
            const providerId = $(this).val();
            if (providerId) {
                loadInsurancePlans(providerId, '#primaryInsurancePlan', 1); // 1 = Primary
            } else {
                $('#primaryInsurancePlan').empty().prop('disabled', true);
            }
            calculateInsuranceShare();
        });

        // ØªØºÛŒÛŒØ± Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡
        $('#primaryInsurancePlan').on('change', function() {
            calculateInsuranceShare();
        });

        // ØªØºÛŒÛŒØ± Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ
        $('#supplementaryInsuranceProvider').on('change', function() {
            const providerId = $(this).val();
            if (providerId) {
                loadInsurancePlans(providerId, '#supplementaryInsurancePlan', 2); // 2 = Supplementary
            } else {
                $('#supplementaryInsurancePlan').empty().prop('disabled', true);
            }
            calculateInsuranceShare();
        });

        // ØªØºÛŒÛŒØ± Ø·Ø±Ø­ Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        $('#supplementaryInsurancePlan').on('change', function() {
            calculateInsuranceShare();
        });

        // ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ†Ø§Ù…Ù‡
        $('#primaryPolicyNumber, #supplementaryPolicyNumber').on('input', function() {
            calculateInsuranceShare();
        });

        // ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨ÛŒÙ…Ù‡
        $('#primaryCardNumber, #supplementaryCardNumber').on('input', function() {
            calculateInsuranceShare();
        });
    }

    function setupInsuranceValidation() {
        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Real-time
        $('#primaryInsuranceProvider, #primaryInsurancePlan').on('change', function() {
            validatePrimaryInsurance();
        });

        $('#supplementaryInsuranceProvider, #supplementaryInsurancePlan').on('change', function() {
            validateSupplementaryInsurance();
        });
    }

    function setupInsuranceActions() {
        // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±
        $('#loadPatientInsuranceBtn').on('click', function() {
            loadPatientInsurance();
        });

        // Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒÙ…Ù‡
        $('#saveInsuranceBtn').on('click', function() {
            saveInsurance();
        });
    }

    function loadInsuranceProviders() {
        $.ajax({
            url: '@Url.Action("GetInsuranceProviders", "ReceptionInsuranceAuto")',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    populateInsuranceProviders(response.data);
                } else {
                    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù†', 'error');
                }
            },
            error: function() {
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù†', 'error');
            }
        });
    }

    function populateInsuranceProviders(providers) {
        const primarySelect = $('#primaryInsuranceProvider');
        const supplementarySelect = $('#supplementaryInsuranceProvider');
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        primarySelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
        supplementarySelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨ÛŒÙ…Ù‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù†
        providers.forEach(function(provider) {
            const option = `<option value="${provider.id}">${provider.name}</option>`;
            primarySelect.append(option);
            supplementarySelect.append(option);
        });
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Select2
        primarySelect.trigger('change');
        supplementarySelect.trigger('change');
    }

    function loadInsurancePlans(providerId, selectId, insuranceType) {
        $(selectId).prop('disabled', true).empty().append('<option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>');
        
        $.ajax({
            url: '@Url.Action("GetInsurancePlans", "ReceptionInsuranceAuto")',
            type: 'GET',
            data: { 
                providerId: providerId
            },
            dataType: 'json',
            success: function(response) {
                const select = $(selectId);
                select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
                
                if (response.success && response.data) {
                    response.data.forEach(function(plan) {
                        select.append(`<option value="${plan.id}">${plan.name}</option>`);
                    });
                    select.prop('disabled', false);
                } else {
                    select.append('<option value="">Ù‡ÛŒÚ† Ø·Ø±Ø­ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                }
                
                select.trigger('change');
            },
            error: function() {
                $(selectId).empty().append('<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>');
            }
        });
    }

    function validatePrimaryInsurance() {
        const providerId = $('#primaryInsuranceProvider').val();
        const planId = $('#primaryInsurancePlan').val();
        const isValid = providerId && planId;
        
        updateInsuranceStatus('primary', isValid);
        return isValid;
    }

    function validateSupplementaryInsurance() {
        const providerId = $('#supplementaryInsuranceProvider').val();
        const planId = $('#supplementaryInsurancePlan').val();
        const isValid = providerId && planId;
        
        updateInsuranceStatus('supplementary', isValid);
        return isValid;
    }

    function updateInsuranceStatus(type, isValid) {
        const statusIcon = $(`.${type}-insurance .status-icon i`);
        const statusText = $(`.${type}-insurance .status-text`);
        
        if (isValid) {
            statusIcon.removeClass('text-muted').addClass('text-success');
            statusText.text(`${type === 'primary' ? 'Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡' : 'Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ'} Ù…Ø¹ØªØ¨Ø±`);
        } else {
            statusIcon.removeClass('text-success').addClass('text-muted');
            statusText.text(`${type === 'primary' ? 'Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡' : 'Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ'} Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡`);
        }
    }

    function calculateInsuranceShare() {
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ Ùˆ Ø¨ÛŒÙ…Ø§Ø±
        const primaryValid = validatePrimaryInsurance();
        const supplementaryValid = validateSupplementaryInsurance();
        
        if (!primaryValid) {
            updateInsuranceSummary(0, 0, 0);
            return;
        }
        
        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±
        const insuranceData = {
            primaryProviderId: $('#primaryInsuranceProvider').val(),
            primaryPlanId: $('#primaryInsurancePlan').val(),
            supplementaryProviderId: $('#supplementaryInsuranceProvider').val(),
            supplementaryPlanId: $('#supplementaryInsurancePlan').val()
        };
        
        $.ajax({
            url: '@Url.Action("CalculateInsuranceShare", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: insuranceData,
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    updateInsuranceSummary(
                        response.data.coveragePercentage,
                        response.data.insuranceShare,
                        response.data.patientShare
                    );
                } else {
                    updateInsuranceSummary(0, 0, 0);
                }
            },
            error: function() {
                updateInsuranceSummary(0, 0, 0);
            }
        });
    }

    function updateInsuranceSummary(percentage, insuranceShare, patientShare) {
        $('#insuranceCoveragePercentage').text(percentage + '%');
        $('#insuranceShareAmount').text(formatCurrency(insuranceShare));
        $('#patientShareAmount').text(formatCurrency(patientShare));
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('fa-IR').format(amount) + ' Ø±ÛŒØ§Ù„';
    }

    function loadPatientInsurance() {
        const patientId = getCurrentPatientId();
        
        if (!patientId) {
            showNotification('Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
            return;
        }
        
        $.ajax({
            url: '@Url.Action("AutoBindPatientInsurance", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: { patientId: getCurrentPatientId() },
            dataType: 'json',
            success: function(response) {
                if (response.success && response.data) {
                    displayPatientInsurance(response.data);
                } else {
                    showNotification('Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'info');
                }
            },
            error: function() {
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒÙ…Ù‡ Ø¨ÛŒÙ…Ø§Ø±', 'error');
            }
        });
    }

    function displayPatientInsurance(insuranceData) {
        // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¨ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÙ‡
        if (insuranceData.primary) {
            $('#primaryInsuranceProvider').val(insuranceData.primary.providerId).trigger('change');
            $('#primaryInsurancePlan').val(insuranceData.primary.planId).trigger('change');
            $('#primaryPolicyNumber').val(insuranceData.primary.policyNumber);
            $('#primaryCardNumber').val(insuranceData.primary.cardNumber);
        }
        
        // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ
        if (insuranceData.supplementary) {
            $('#supplementaryInsuranceProvider').val(insuranceData.supplementary.providerId).trigger('change');
            $('#supplementaryInsurancePlan').val(insuranceData.supplementary.planId).trigger('change');
            $('#supplementaryPolicyNumber').val(insuranceData.supplementary.policyNumber);
            $('#supplementaryCardNumber').val(insuranceData.supplementary.cardNumber);
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯
        calculateInsuranceShare();
    }

    function saveInsurance() {
        const insuranceData = collectInsuranceData();
        
        $.ajax({
            url: '@Url.Action("SavePatientInsurance", "ReceptionInsuranceAuto")',
            type: 'POST',
            data: insuranceData,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    showNotification('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                } else {
                    showNotification(response.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡', 'error');
                }
            },
            error: function() {
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡', 'error');
            }
        });
    }

    function collectInsuranceData() {
        return {
            nationalCode: $('#patientNationalCode').val(),
            primaryProviderId: $('#primaryInsuranceProvider').val(),
            primaryPlanId: $('#primaryInsurancePlan').val(),
            primaryPolicyNumber: $('#primaryPolicyNumber').val(),
            primaryCardNumber: $('#primaryCardNumber').val(),
            supplementaryProviderId: $('#supplementaryInsuranceProvider').val(),
            supplementaryPlanId: $('#supplementaryInsurancePlan').val(),
            supplementaryPolicyNumber: $('#supplementaryPolicyNumber').val(),
            supplementaryCardNumber: $('#supplementaryCardNumber').val()
        };
    }

    function getCurrentPatientId() {
        // Ø¯Ø±ÛŒØ§ÙØª Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø§Ø² Ø¨Ø®Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
        return $('#patientId').val() || null;
    }

    function showNotification(message, type) {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('#insuranceAccordionSection').prepend(alert);
        
        setTimeout(function() {
            alert.alert('close');
        }, 5000);
    }
</script>
