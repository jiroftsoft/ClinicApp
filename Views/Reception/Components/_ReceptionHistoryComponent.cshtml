@using ClinicApp.ViewModels.Reception
@model ReceptionHistoryViewModel

<!-- Reception History Component - Professional Medical Environment -->
<div class="reception-history-component" id="receptionHistoryComponent">
    <div class="component-header">
        <h5 class="component-title">
            <i class="fas fa-history me-2"></i>
            Ø³ÙˆØ§Ø¨Ù‚ Ù¾Ø°ÛŒØ±Ø´ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†
        </h5>
        <div class="component-actions">
            <button type="button" class="btn btn-outline-primary btn-sm" id="refreshHistoryBtn">
                <i class="fas fa-sync-alt"></i>
                Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
        </div>
    </div>

    <div class="component-content">
        <!-- Advanced Search Filters -->
        <div class="search-filters">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
                        <input type="text" id="dateFrom" class="form-control persian-datepicker" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                        <input type="text" id="dateTo" class="form-control persian-datepicker" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ Ø¨ÛŒÙ…Ø§Ø±</label>
                        <input type="text" id="nationalCodeFilter" class="form-control" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ÙˆØ¶Ø¹ÛŒØª Ù¾Ø°ÛŒØ±Ø´</label>
                        <select id="statusFilter" class="form-control">
                            <option value="">Ù‡Ù…Ù‡</option>
                            <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="search-actions">
                <button type="button" class="btn btn-primary" id="searchHistoryBtn">
                    <i class="fas fa-search me-1"></i>
                    Ø¬Ø³ØªØ¬Ùˆ
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clearFiltersBtn">
                    <i class="fas fa-times me-1"></i>
                    Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                </button>
            </div>
        </div>

        <!-- History Results -->
        <div class="history-results" id="historyResults">
            <div class="results-header">
                <h6>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h6>
                <span class="results-count" id="resultsCount">0 Ù…ÙˆØ±Ø¯ ÛŒØ§ÙØª Ø´Ø¯</span>
            </div>
            <div class="results-list" id="resultsList">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Reception History Styles -->
<style>
    .reception-history-component {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .component-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px 8px 0 0;
    }

    .component-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .component-actions {
        display: flex;
        gap: 0.5rem;
    }

    .component-content {
        padding: 1rem;
    }

    .search-filters {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .search-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .history-results {
    background: #fff;
        border: 1px solid #e9ecef;
    border-radius: 6px;
        overflow: hidden;
}

    .results-header {
    display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .results-count {
        font-size: 0.9rem;
    color: #6c757d;
}

    .results-list {
        max-height: 400px;
        overflow-y: auto;
}

.history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s;
}

.history-item:hover {
        background-color: #f8f9fa;
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-info {
        flex: 1;
    }

    .history-patient {
    font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
}

    .history-details {
        font-size: 0.9rem;
    color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .history-date {
        font-size: 0.8rem;
        color: #95a5a6;
    }

    .history-actions {
    display: flex;
        gap: 0.5rem;
}

    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    border-radius: 4px;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
    font-weight: 500;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

    .no-results {
        text-align: center;
        padding: 2rem;
    color: #6c757d;
    }

    .no-results i {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
</style>

<!-- Reception History JavaScript -->
<script>
    // Wait for jQuery to be available
    function waitForJQueryReceptionHistory() {
        if (typeof jQuery !== 'undefined' && typeof $ !== 'undefined') {
            $(document).ready(function() {
                initializeReceptionHistoryComponent();
            });
        } else {
            setTimeout(waitForJQueryReceptionHistory, 50);
        }
    }
    
    // Start waiting for jQuery
    waitForJQueryReceptionHistory();

    function initializeReceptionHistoryComponent() {
        console.log('ğŸ¥ Reception History Component Initialized');
        
        // Setup event handlers
        setupHistorySearch();
        setupHistoryActions();
        
        // Load initial data
        loadReceptionHistory();
    }

    function setupHistorySearch() {
        $('#searchHistoryBtn').on('click', function() {
            searchReceptionHistory();
        });

        $('#clearFiltersBtn').on('click', function() {
            clearFilters();
        });

        // Enter key support
        $('#nationalCodeFilter').on('keypress', function(e) {
            if (e.which === 13) {
                searchReceptionHistory();
            }
        });
    }

    function setupHistoryActions() {
        $('#refreshHistoryBtn').on('click', function() {
            loadReceptionHistory();
        });
    }

    function searchReceptionHistory() {
        const filters = {
            dateFrom: $('#dateFrom').val(),
            dateTo: $('#dateTo').val(),
            nationalCode: $('#nationalCodeFilter').val(),
            status: $('#statusFilter').val()
        };

        console.log('ğŸ” Searching reception history with filters:', filters);

        $.ajax({
            url: '@Url.Action("SearchReceptionHistory", "ReceptionHistory")',
            type: 'POST',
            data: filters,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    displayHistoryResults(response.data);
                } else {
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÙˆØ§Ø¨Ù‚: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ Error searching reception history:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÙˆØ§Ø¨Ù‚ Ù¾Ø°ÛŒØ±Ø´');
            }
        });
    }

    function loadReceptionHistory() {
        console.log('ğŸ“‹ Loading reception history...');

        $.ajax({
            url: '@Url.Action("GetReceptionHistory", "ReceptionHistory")',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    displayHistoryResults(response.data);
                } else {
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ø¨Ù‚: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ Error loading reception history:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ø¨Ù‚ Ù¾Ø°ÛŒØ±Ø´');
            }
        });
    }

    function displayHistoryResults(data) {
        const resultsList = $('#resultsList');
        const resultsCount = $('#resultsCount');
        
        resultsCount.text(data.length + ' Ù…ÙˆØ±Ø¯ ÛŒØ§ÙØª Ø´Ø¯');
        
        if (data.length === 0) {
            resultsList.html(`
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <p>Ù‡ÛŒÚ† Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                </div>
            `);
            return;
        }

        let html = '';
        data.forEach(function(item) {
            html += `
                <div class="history-item">
                    <div class="history-info">
                        <div class="history-patient">${item.patientName}</div>
                        <div class="history-details">
                            Ú©Ø¯ Ù…Ù„ÛŒ: ${item.nationalCode} | 
                            Ø®Ø¯Ù…Øª: ${item.serviceName} | 
                            Ù¾Ø²Ø´Ú©: ${item.doctorName}
                        </div>
                        <div class="history-date">${item.receptionDate}</div>
                    </div>
                    <div class="history-actions">
                        <span class="status-badge status-${item.status}">${item.statusText}</span>
                        <button class="btn btn-outline-primary btn-action" onclick="viewReceptionDetails(${item.receptionId})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success btn-action" onclick="editReception(${item.receptionId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-action" onclick="printReceipt(${item.receptionId})">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        resultsList.html(html);
    }

    function clearFilters() {
        $('#dateFrom').val('');
        $('#dateTo').val('');
        $('#nationalCodeFilter').val('');
        $('#statusFilter').val('');
        loadReceptionHistory();
    }

    // Global functions for actions
    window.viewReceptionDetails = function(receptionId) {
        console.log('ğŸ‘ï¸ Viewing reception details:', receptionId);
        // Open reception details modal or navigate to details page
    };

    window.editReception = function(receptionId) {
        console.log('âœï¸ Editing reception:', receptionId);
        // Open reception edit form
    };

    window.printReceipt = function(receptionId) {
        console.log('ğŸ–¨ï¸ Printing receipt for reception:', receptionId);
        // Open print dialog for receipt
    };

    function showError(message) {
        console.error('âŒ Error:', message);
        // Show error notification to user
    }
</script>
