@using ClinicApp.ViewModels.Reception
@using ClinicApp.Models.Enums
@model ClinicApp.ViewModels.Reception.ReceptionCreateViewModel

@{
    ViewBag.Title = "Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯";
    ViewBag.RequireDataTables = true;
    ViewBag.RequireSelect2 = true;
    ViewBag.RequireDatePicker = true;
    ViewBag.RequireFormValidation = true;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- âœ… Ø¨Ø®Ø´ Û±: Ø³Ø§Ø®ØªØ§Ø± Ú©Ù„ÛŒ -->
            <h2 class="text-center mb-4">Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯</h2>
            <p class="text-center text-muted mb-4">Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§</p>
            
            <!-- âœ… Ø¨Ø®Ø´ Û²: Ø·Ø±Ø§Ø­ÛŒ Ø¨ØµØ±ÛŒ -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        ÙØ±Ù… Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯
                    </h4>
                    <button type="button" id="reset-form-header-btn" class="btn btn-light btn-sm" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù…">
                        <i class="fas fa-undo me-1"></i>
                        Ø±ÛŒØ³Øª ÙØ±Ù…
                    </button>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Create", "Reception", FormMethod.Post, new { id = "create-reception-form", @class = "needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                        
                        <!-- âœ… Progress Indicator -->
                        <div class="mb-4">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" id="form-progress" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block text-center">
                                <span id="progress-text">0% ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>
                            </small>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Û±: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± -->
                        <div class="form-section mb-4">
                            <div class="form-section-header">
                                <i class="fas fa-user text-primary me-2"></i>
                                <h5 class="mb-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±</h5>
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨ÛŒÙ…Ø§Ø± -->
                                    <div class="col-md-6">
                                        <label for="patient-search" class="form-label">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨ÛŒÙ…Ø§Ø± <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" id="patient-search" class="form-control" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±">
                                            <button type="button" class="btn btn-outline-primary" id="search-patient-btn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div id="patient-search-results" class="mt-2"></div>
                                    </div>

                                    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± -->
                                    <div class="col-md-6">
                                        <label class="form-label">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± <span class="text-danger">*</span></label>
                                        <div id="selected-patient-info" class="mt-2">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Ø§Ø¨ØªØ¯Ø§ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯
                                            </div>
                                        </div>
                                        @Html.HiddenFor(model => model.PatientId)
                                    </div>
                                </div>

                                <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± -->
                                <div class="row g-3 mt-3" id="patient-info-fields" style="display: none;">
                                    <div class="col-md-4">
                                        <label for="FirstName" class="form-label">Ù†Ø§Ù… <span class="text-danger">*</span></label>
                                        @Html.TextBoxFor(model => model.FirstName, new { @class = "form-control", placeholder = "Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±" })
                                        @Html.ValidationMessageFor(model => model.FirstName, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="LastName" class="form-label">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ <span class="text-danger">*</span></label>
                                        @Html.TextBoxFor(model => model.LastName, new { @class = "form-control", placeholder = "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¨ÛŒÙ…Ø§Ø±" })
                                        @Html.ValidationMessageFor(model => model.LastName, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="NationalCode" class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ <span class="text-danger">*</span></label>
                                        @Html.TextBoxFor(model => model.NationalCode, new { @class = "form-control", placeholder = "Ú©Ø¯ Ù…Ù„ÛŒ Û±Û° Ø±Ù‚Ù…ÛŒ" })
                                        @Html.ValidationMessageFor(model => model.NationalCode, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="PhoneNumber" class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label>
                                        @Html.TextBoxFor(model => model.PhoneNumber, new { @class = "form-control", placeholder = "Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†" })
                                        @Html.ValidationMessageFor(model => model.PhoneNumber, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="Gender" class="form-label">Ø¬Ù†Ø³ÛŒØª</label>
                                        @Html.DropDownListFor(model => model.Gender, new SelectList(new List<object> { new { Value = "", Text = "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯" }, new { Value = "1", Text = "Ù…Ø±Ø¯" }, new { Value = "2", Text = "Ø²Ù†" } }, "Value", "Text"), new { @class = "form-select" })
                                        @Html.ValidationMessageFor(model => model.Gender, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="BirthDateShamsi" class="form-label">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</label>
                                        @Html.TextBoxFor(model => model.BirthDateShamsi, new { @class = "form-control persian-datepicker", placeholder = "Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", id = "birthDateShamsi", value = "" })
                                        @Html.HiddenFor(model => model.BirthDate)
                                        @Html.ValidationMessageFor(model => model.BirthDateShamsi, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-2">
                                        <label for="Age" class="form-label">Ø³Ù†</label>
                                        <input type="text" id="Age" class="form-control" readonly placeholder="Ø³Ù†" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="Address" class="form-label">Ø¢Ø¯Ø±Ø³</label>
                                        @Html.TextAreaFor(model => model.Address, new { @class = "form-control", rows = "2", placeholder = "Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„" })
                                        @Html.ValidationMessageFor(model => model.Address, "", new { @class = "text-danger" })
                                    </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i>
                                                Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª
                                            </small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" id="edit-patient-btn" class="btn btn-outline-warning btn-sm" style="display: none;">
                                                <i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
                                            </button>
                                            <button type="button" id="reset-form-btn" class="btn btn-outline-danger btn-sm" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù…">
                                                <i class="fas fa-undo"></i> Ø±ÛŒØ³Øª ÙØ±Ù…
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                </div>

                                <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡ -->
                                <div class="row g-3 mt-3" id="insurance-info-fields" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="PrimaryInsuranceName" class="form-label">Ø¨ÛŒÙ…Ù‡ Ø§ÙˆÙ„ÛŒÙ‡</label>
                                        @Html.TextBoxFor(model => model.PrimaryInsuranceName, new { @class = "form-control", placeholder = "Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡ Ø§ÙˆÙ„ÛŒÙ‡" })
                                        @Html.ValidationMessageFor(model => model.PrimaryInsuranceName, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-6">
                                        <label for="SecondaryInsuranceName" class="form-label">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
                                        @Html.TextBoxFor(model => model.SecondaryInsuranceName, new { @class = "form-control", placeholder = "Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ" })
                                        @Html.ValidationMessageFor(model => model.SecondaryInsuranceName, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-6">
                                        <label for="InsuranceNumber" class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡</label>
                                        @Html.TextBoxFor(model => model.InsuranceNumber, new { @class = "form-control", placeholder = "Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡" })
                                        @Html.ValidationMessageFor(model => model.InsuranceNumber, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-6">
                                        <label for="InsuranceShare" class="form-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
                                        @Html.TextBoxFor(model => model.InsuranceShare, new { @class = "form-control", type = "number", step = "1000", placeholder = "Ù…Ø¨Ù„Øº Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡" })
                                        @Html.ValidationMessageFor(model => model.InsuranceShare, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <!-- Ø§Ø³ØªØ¹Ù„Ø§Ù… Ú©Ù…Ú©ÛŒ -->
                                <div class="row g-3 mt-3">
                                    <div class="col-md-4">
                                        <label for="NationalCodeForInquiry" class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ¹Ù„Ø§Ù…</label>
                                        @Html.TextBoxFor(model => model.NationalCodeForInquiry, new { @class = "form-control", placeholder = "Ú©Ø¯ Ù…Ù„ÛŒ Û±Û° Ø±Ù‚Ù…ÛŒ" })
                                        @Html.ValidationMessageFor(model => model.NationalCodeForInquiry, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="BirthDateShamsiForInquiry" class="form-label">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ¹Ù„Ø§Ù…</label>
                                        @Html.TextBoxFor(model => model.BirthDateShamsiForInquiry, new { @class = "form-control persian-datepicker", placeholder = "Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", id = "birthDateShamsiForInquiry", value = "" })
                                        @Html.HiddenFor(model => model.BirthDateForInquiry)
                                        @Html.ValidationMessageFor(model => model.BirthDateShamsiForInquiry, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid">
                                            <button type="button" class="btn btn-outline-info" id="inquiry-btn">
                                                <i class="fas fa-search me-1"></i> Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‡ÙˆÛŒØª
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ù†ØªØ§ÛŒØ¬ Ø§Ø³ØªØ¹Ù„Ø§Ù… -->
                                <div id="inquiry-results" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Û²: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø²Ø´Ú© -->
                        <div class="form-section mb-4">
                            <div class="form-section-header">
                                <i class="fas fa-user-md text-primary me-2"></i>
                                <h5 class="mb-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø²Ø´Ú©</h5>
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="DoctorId" class="form-label">Ù¾Ø²Ø´Ú© Ù…Ø¹Ø§Ù„Ø¬ <span class="text-danger">*</span></label>
                                        @Html.DropDownListFor(model => model.DoctorId, Model.DoctorList, "Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©", new { @class = "form-select", id = "doctorSelect" })
                                        @Html.ValidationMessageFor(model => model.DoctorId, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ReceptionDateShamsi" class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´ <span class="text-danger">*</span></label>
                                        @Html.TextBoxFor(model => model.ReceptionDateShamsi, new { @class = "form-control persian-datepicker", placeholder = "Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´", id = "receptionDateShamsi", value = "" })
                                        @Html.HiddenFor(model => model.ReceptionDate)
                                        @Html.ValidationMessageFor(model => model.ReceptionDateShamsi, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Û³: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Ø§Øª -->
                        <div class="form-section mb-4">
                            <div class="form-section-header">
                                <i class="fas fa-stethoscope text-primary me-2"></i>
                                <h5 class="mb-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Ø§Øª</h5>
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="service-category" class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Ø§Øª</label>
                                        <select id="service-category" class="form-select">
                                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="services" class="form-label">Ø®Ø¯Ù…Ø§Øª <span class="text-danger">*</span></label>
                                        <select id="services" class="form-select" multiple>
                                            <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                        </select>
                                        @Html.ValidationMessageFor(model => model.SelectedServiceIds, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="form-label">Ø®Ø¯Ù…Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</label>
                                    <div id="selected-services" class="border rounded p-2 min-height-50">
                                        <span class="text-muted">Ù‡ÛŒÚ† Ø®Ø¯Ù…ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Û´: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª -->
                        <div class="form-section mb-4">
                            <div class="form-section-header">
                                <i class="fas fa-money-bill-wave text-primary me-2"></i>
                                <h5 class="mb-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h5>
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="TotalAmount" class="form-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº <span class="text-danger">*</span></label>
                                        @Html.TextBoxFor(model => model.TotalAmount, new { @class = "form-control", type = "number", step = "1000", placeholder = "Ù…Ø¨Ù„Øº Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†" })
                                        @Html.ValidationMessageFor(model => model.TotalAmount, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="PaymentMethod" class="form-label">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª <span class="text-danger">*</span></label>
                                        @Html.DropDownListFor(model => model.PaymentMethod, Model.PaymentMethodList, "Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª", new { @class = "form-select", id = "paymentMethodSelect" })
                                        @Html.ValidationMessageFor(model => model.PaymentMethod, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="PosTransactionId" class="form-label">Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´ POS</label>
                                        @Html.TextBoxFor(model => model.PosTransactionId, new { @class = "form-control", placeholder = "Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´" })
                                        @Html.ValidationMessageFor(model => model.PosTransactionId, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label for="PaidAmount" class="form-label">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</label>
                                        @Html.TextBoxFor(model => model.PaidAmount, new { @class = "form-control", type = "number", step = "1000", placeholder = "Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡" })
                                        @Html.ValidationMessageFor(model => model.PaidAmount, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="InsuranceShare" class="form-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡</label>
                                        @Html.TextBoxFor(model => model.InsuranceShare, new { @class = "form-control", type = "number", step = "1000", placeholder = "Ø³Ù‡Ù… Ø¨ÛŒÙ…Ù‡" })
                                        @Html.ValidationMessageFor(model => model.InsuranceShare, "", new { @class = "text-danger" })
                                    </div>
                                    <div class="col-md-4">
                                        <label for="PatientShare" class="form-label">Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±</label>
                                        @Html.TextBoxFor(model => model.PatientShare, new { @class = "form-control", type = "number", step = "1000", placeholder = "Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±" })
                                        @Html.ValidationMessageFor(model => model.PatientShare, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Ûµ: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ -->
                        <div class="form-section mb-4">
                            <div class="form-section-header">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <h5 class="mb-0">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ</h5>
                            </div>
                            <div class="form-section-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            @Html.CheckBoxFor(model => model.IsEmergency, new { @class = "form-check-input" })
                                            <label class="form-check-label" for="IsEmergency">
                                                Ù¾Ø°ÛŒØ±Ø´ Ø§ÙˆØ±Ú˜Ø§Ù†Ø³
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            @Html.CheckBoxFor(model => model.IsOnlineReception, new { @class = "form-check-input" })
                                            <label class="form-check-label" for="IsOnlineReception">
                                                Ù¾Ø°ÛŒØ±Ø´ Ø¢Ù†Ù„Ø§ÛŒÙ†
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-12">
                                        <label for="Notes" class="form-label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</label>
                                        @Html.TextAreaFor(model => model.Notes, new { @class = "form-control", rows = 3, placeholder = "ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ..." })
                                        @Html.ValidationMessageFor(model => model.Notes, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… Ø¨Ø®Ø´ Û¶: Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" id="submit-button" class="btn btn-success me-2">
                                    <span id="submit-button-text">
                                        <i class="fa fa-save me-1"></i> Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´
                                    </span>
                                    <span id="submit-button-spinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                                </button>
                                <button type="button" id="reset-form-footer-btn" class="btn btn-outline-danger me-2" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù…">
                                    <i class="fas fa-undo me-1"></i> Ø±ÛŒØ³Øª ÙØ±Ù…
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fa fa-arrow-right me-1"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="~/Content/css/reception-standards.css" rel="stylesheet" />
    
    <style>
        /* âœ… Persian DatePicker Styles */
        .persian-datepicker {
            direction: rtl;
            text-align: right;
        }
        
        /* âœ… Select2 Persian Support */
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 34px;
            padding-right: 12px;
            padding-left: 20px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 8px;
        }
        
        .select2-dropdown {
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        /* âœ… Form Section Styles */
        .form-section {
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .form-section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .form-section-header h5 {
            color: #495057;
            font-weight: 600;
        }
        
        .form-section-body {
            padding: 10px 0;
        }
        
        /* âœ… Progress Bar Styles */
        .progress {
            border-radius: 10px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }
        
        /* âœ… Min Height for Selected Services */
        .min-height-50 {
            min-height: 50px;
        }
    </style>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    
    <script type="text/javascript">
        $(document).ready(function () {
            // âœ… Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Persian DatePicker
            initializePersianDatePickers();
            
            // âœ… Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Select2
            initializeSelect2();
            
            // âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            loadDoctors();
            // loadServiceCategories(); // Ø­Ø°Ù Ø´Ø¯ - Ø­Ø§Ù„Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø²Ø´Ú© Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯

            // âœ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨ÛŒÙ…Ø§Ø±
            $('#search-patient-btn').on('click', function () {
                var searchTerm = $('#patient-search').val().trim();
                if (searchTerm.length >= 2) {
                    searchPatients(searchTerm);
                } else {
                    showError('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ Û² Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                }
            });

            // âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ…Ø§Ø± - Ø­Ø°Ù Ø´Ø¯Ù‡ Ú†ÙˆÙ† Ø§Ø² populatePatientForm Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

            // âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú© - Cascade Loading
            $('#doctorSelect').on('change', function () {
                var doctorId = $(this).val();
                console.log('ğŸ‘¨â€âš•ï¸ Doctor selected:', doctorId);
                
                if (doctorId) {
                    // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø²Ø´Ú©
                    loadDoctorDepartments(doctorId);
                } else {
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ§Ø¨Ø³ØªÙ‡
                    clearServiceFields();
                }
            });

            // âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Ø§Øª
            $('#service-category').on('change', function () {
                var categoryId = $(this).val();
                console.log('ğŸ“‹ Service category selected:', categoryId);
                
                if (categoryId) {
                    loadServicesByCategory(categoryId);
                } else {
                    $('#services').empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
                }
            });

            // âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Ø§Øª
            $('#services').on('change', function () {
                updateSelectedServices();
            });

            // âœ… Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‡ÙˆÛŒØª
            $('#inquiry-btn').on('click', function () {
                var nationalCode = $('#NationalCodeForInquiry').val().trim();
                var birthDateShamsi = $('#BirthDateShamsiForInquiry').val();
                var birthDate = $('#BirthDateForInquiry').val();
                
                if (nationalCode && birthDateShamsi) {
                    inquiryPatientIdentity(nationalCode, birthDate);
                } else {
                    showError('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ùˆ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                }
            });

            // âœ… Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
            $('#create-reception-form').on('submit', function (e) {
                e.preventDefault();
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                if (!validateForm()) {
                    return;
                }

                // Ø§Ø±Ø³Ø§Ù„ AJAX
                submitForm();
            });

            // âœ… ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
            function searchPatients(searchTerm) {
                console.log('ğŸ” Starting search for:', searchTerm);
                
                $.ajax({
                    url: '@Url.Action("SearchPatientsByName", "Reception")',
                    type: 'GET',
                    data: { searchTerm: searchTerm, pageNumber: 1, pageSize: 10 },
                    beforeSend: function () {
                        $('#patient-search-results').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</div>');
                    },
                    success: function (response) {
                        console.log('âœ… Raw Response:', response);
                        console.log('âœ… Response Type:', typeof response);
                        
                        // Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('âœ… Parsed Response:', parsedResponse);
                            } catch (e) {
                                console.error('âŒ JSON Parse Error:', e);
                                showError('Ø®Ø·Ø§ Ø¯Ø± ØªØ¬Ø²ÛŒÙ‡ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±');
                                return;
                            }
                        }
                        
                        console.log('âœ… Response Success:', parsedResponse.success);
                        console.log('âœ… Response Data:', parsedResponse.data);
                        console.log('âœ… Response Items:', parsedResponse.data?.Items);
                        console.log('âœ… Items Length:', parsedResponse.data?.Items?.length);
                        
                        if (parsedResponse.success) {
                            try {
                                if (parsedResponse.data && parsedResponse.data.Items) {
                                    console.log('âœ… Valid response structure - calling displayPatientSearchResults');
                                    displayPatientSearchResults(parsedResponse.data);
                                    showSuccess('Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                        } else {
                                    console.error('âŒ Invalid response data structure:', parsedResponse.data);
                                    showError('Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                                }
                            } catch (error) {
                                console.error('âŒ Error in displayPatientSearchResults:', error);
                                console.error('âŒ Error Stack:', error.stack);
                                showError('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬: ' + error.message);
                            }
                        } else {
                            console.error('âŒ Response not successful:', parsedResponse);
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: ' + (parsedResponse.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
                        }
                    },
                    error: function () {
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    }
                });
            }

            function displayPatientSearchResults(data) {
                console.log('ğŸ¯ Display Data:', data);
                console.log('ğŸ¯ Data Items:', data.Items);
                console.log('ğŸ¯ Items Length:', data.Items?.length);
                
                var results = $('#patient-search-results');
                results.empty();

                if (data.Items && data.Items.length > 0) {
                    console.log('âœ… Found items, processing...');
                    
                    // Auto-select if only one result
                    if (data.Items.length === 1) {
                        var patient = data.Items[0];
                        console.log('ğŸ¯ Auto-selecting single patient:', patient);
                        console.log('ğŸ¯ Patient ID:', patient.PatientId);
                        console.log('ğŸ¯ Patient Name:', patient.FullName);
                        
                        try {
                            populatePatientForm(patient);
                            console.log('âœ… Auto-select completed successfully');
                        } catch (error) {
                            console.error('âŒ Error in auto-select:', error);
                            console.error('âŒ Error Stack:', error.stack);
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨ÛŒÙ…Ø§Ø±: ' + error.message);
                        }
                        return;
                    }
                    
                    var html = '<div class="list-group">';
                    $.each(data.Items, function (index, patient) {
                        console.log('Processing Patient:', patient); // Debug log
                        
                        // Safe handling of patient data
                        var patientId = patient.PatientId || 0;
                        var fullName = (patient.FullName && patient.FullName.trim()) || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                        var nationalCode = patient.NationalCode || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                        var phoneNumber = patient.PhoneNumber || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                        
                        // Create onclick with patient data
                        var patientData = JSON.stringify(patient).replace(/"/g, '&quot;');
                        
                        html += '<a href="#" class="list-group-item list-group-item-action" onclick="populatePatientForm(' + patientData + ')">';
                        html += '<div class="d-flex w-100 justify-content-between">';
                        html += '<h6 class="mb-1">' + fullName + '</h6>';
                        html += '<small>' + nationalCode + '</small>';
                        html += '</div>';
                        html += '<p class="mb-1">' + phoneNumber + '</p>';
                        html += '</a>';
                    });
                    html += '</div>';
                    results.html(html);
                    console.log('HTML Generated:', html); // Debug log
                } else {
                    // âœ… Ø³Ù†Ø§Ø±ÛŒÙˆ Ø¯ÙˆÙ…: Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
                    results.html(`
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯!</strong>
                            <p class="mb-2">Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ Ù…Ù„ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
                            <div class="d-flex gap-2">
                                <button type="button" id="create-new-patient-btn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-user-plus me-1"></i>
                                    Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
                                </button>
                                <button type="button" id="retry-search-btn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-redo me-1"></i>
                                    Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¬Ø¯Ø¯
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ "Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯"ØŒ ÙØ±Ù… Ø«Ø¨Øª Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
                            </small>
                        </div>
                    `);
                }
            }

            function selectPatient(patientId, patientName) {
                console.log('Selecting Patient:', patientId, patientName); // Debug log
                
                // Set the dropdown value
                $('#patient-select').val(patientId);
                
                // Update the selected patient info
                $('#selected-patient-info').html('<div class="alert alert-success"><i class="fas fa-check me-1"></i>Ø¨ÛŒÙ…Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: ' + patientName + '</div>');
                
                // Clear search results
                $('#patient-search-results').empty();
                
                // Update progress
                updateProgress();
                
                // Show success message
                showSuccess('Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: ' + patientName);
            }

            function populatePatientForm(patient) {
                console.log('ğŸ¥ Populating Patient Form:', patient);
                console.log('ğŸ¥ Patient ID:', patient.PatientId);
                console.log('ğŸ¥ Patient Name:', patient.FullName);
                console.log('ğŸ¥ Patient FirstName:', patient.FirstName);
                console.log('ğŸ¥ Patient LastName:', patient.LastName);
                console.log('ğŸ¥ Patient NationalCode:', patient.NationalCode);
                console.log('ğŸ¥ Patient PhoneNumber:', patient.PhoneNumber);
                console.log('ğŸ¥ Patient Gender:', patient.Gender);
                console.log('ğŸ¥ Patient BirthDate:', patient.BirthDate);
                console.log('ğŸ¥ Patient Address:', patient.Address);
                
                try {
                    // Show patient info fields
                    console.log('ğŸ¥ Showing patient info fields...');
                    $('#patient-info-fields').show();
                    
                    // Show insurance info fields
                    console.log('ğŸ¥ Showing insurance info fields...');
                    $('#insurance-info-fields').show();
                    
                    // Populate patient information fields directly
                    console.log('ğŸ¥ Populating form fields...');
                    $('#FirstName').val(patient.FirstName || '');
                    $('#LastName').val(patient.LastName || '');
                    $('#NationalCode').val(patient.NationalCode || '');
                    $('#PhoneNumber').val(patient.PhoneNumber || '');
                    $('#Address').val(patient.Address || '');
                    
                    // Set gender
                    if (patient.Gender) {
                        console.log('ğŸ¥ Setting gender:', patient.Gender);
                        $('#Gender').val(patient.Gender);
                    }
                    
                    // Set birth date (Persian DatePicker)
                    if (patient.BirthDate) {
                        console.log('ğŸ¥ Setting birth date:', patient.BirthDate);
                        console.log('ğŸ¥ Birth date type:', typeof patient.BirthDate);
                        try {
                            // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
                            var birthDate = new Date(parseInt(patient.BirthDate.substr(6)));
                            if (!isNaN(birthDate.getTime())) {
                                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
                                var persianDate = convertGregorianToPersian(birthDate);
                                console.log('ğŸ¥ Persian birth date:', persianDate);
                                
                                // ØªÙ†Ø¸ÛŒÙ… ÙÛŒÙ„Ø¯ Ø´Ù…Ø³ÛŒ
                                $('#birthDateShamsi').val(persianDate);
                                
                                // ØªÙ†Ø¸ÛŒÙ… ÙÛŒÙ„Ø¯ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù…Ø®ÙÛŒ
                                var isoDate = birthDate.getFullYear() + '-' + 
                                            String(birthDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                            String(birthDate.getDate()).padStart(2, '0');
                                $('#BirthDate').val(isoDate);
                                
                                console.log('âœ… Birth date set successfully:', { persian: persianDate, gregorian: isoDate });
                                
                                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø³Ù†
                                displayAge(patient.BirthDate);
                            } else {
                                console.warn('âš ï¸ Invalid birth date format:', patient.BirthDate);
                            }
                        } catch (error) {
                            console.error('âŒ Error setting birth date:', error);
                            console.error('âŒ Birth date value:', patient.BirthDate);
                        }
                    } else {
                        console.log('ğŸ¥ No birth date provided');
                        $('#Age').val(''); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³Ù†
                    }
                    
                    // Set patient ID for form submission
                    console.log('ğŸ¥ Setting patient ID:', patient.PatientId);
                    $('#PatientId').val(patient.PatientId);
                    
                    // Update selected patient info
                    console.log('ğŸ¥ Updating selected patient info...');
                    $('#selected-patient-info').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check me-1"></i>
                            <strong>Ø¨ÛŒÙ…Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:</strong> ${patient.FullName}
                            <br>
                            <small>Ú©Ø¯ Ù…Ù„ÛŒ: ${patient.NationalCode} | ØªÙ„ÙÙ†: ${patient.PhoneNumber}</small>
                        </div>
                    `);
                    
                    // Clear search results
                    console.log('ğŸ¥ Clearing search results...');
                    $('#patient-search-results').empty();
                    
                    // Update progress
                    console.log('ğŸ¥ Updating progress...');
                    updateProgress();
                    
                    // Show success message
                    console.log('ğŸ¥ Showing success message...');
                    showSuccess('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± ÙØ±Ù… Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª');
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
                    $('#edit-patient-btn').show();
                    
                    console.log('âœ… Patient form populated successfully');
                } catch (error) {
                    console.error('âŒ Error in populatePatientForm:', error);
                    console.error('âŒ Error Stack:', error.stack);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù…: ' + error.message);
                }
            }

            function loadPatientInfo(patientId) {
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
                updateProgress();
            }

            function loadServiceCategories() {
                console.log('ğŸ”„ Loading service categories...');
                
                $.ajax({
                    url: '@Url.Action("GetServiceCategories", "Reception")',
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        console.log('ğŸ“‹ Raw Service Categories Response:', response);
                        console.log('ğŸ“‹ Response Type:', typeof response);
                        
                        // Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('ğŸ“‹ Parsed Service Categories Response:', parsedResponse);
                            } catch (e) {
                                console.error('âŒ JSON Parse Error:', e);
                                console.error('âŒ Raw Response:', response);
                                return;
                            }
                        }
                        
                        console.log('ğŸ“‹ Response Success:', parsedResponse.success);
                        console.log('ğŸ“‹ Response Data:', parsedResponse.data);
                        console.log('ğŸ“‹ Data Type:', typeof parsedResponse.data);
                        console.log('ğŸ“‹ Data Length:', parsedResponse.data ? parsedResponse.data.length : 'undefined');
                        
                        if (parsedResponse.success) {
                            var select = $('#service-category');
                            console.log('ğŸ“‹ Select Element Found:', select.length > 0);
                            
                            select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>');
                            
                            if (parsedResponse.data && parsedResponse.data.length > 0) {
                                console.log('ğŸ“‹ Processing categories...');
                                $.each(parsedResponse.data, function (index, category) {
                                    console.log('ğŸ“‹ Category:', index, category);
                                    console.log('ğŸ“‹ Category ID:', category.ServiceCategoryId);
                                    console.log('ğŸ“‹ Category Title:', category.Title);
                                    
                                    select.append('<option value="' + category.ServiceCategoryId + '">' + category.Title + '</option>');
                                });
                                console.log('âœ… Service categories loaded successfully');
                            } else {
                                console.warn('âš ï¸ No service categories found in response');
                            }
                        } else {
                            console.error('âŒ Service categories request failed:', parsedResponse.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('âŒ Service categories AJAX error:', {
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                    }
                });
            }

            function loadServicesByCategory(categoryId) {
                console.log('ğŸ”„ Loading services for category:', categoryId);
                
                $.ajax({
                    url: '@Url.Action("GetServicesByCategory", "Reception")',
                    type: 'GET',
                    dataType: 'json',
                    data: { categoryId: categoryId },
                    success: function (response) {
                        console.log('ğŸ“‹ Raw Services Response:', response);
                        console.log('ğŸ“‹ Response Type:', typeof response);
                        
                        // Parse response if it's a string
                        var parsedResponse = response;
                        if (typeof response === 'string') {
                            try {
                                parsedResponse = JSON.parse(response);
                                console.log('ğŸ“‹ Parsed Services Response:', parsedResponse);
                            } catch (e) {
                                console.error('âŒ JSON Parse Error:', e);
                                console.error('âŒ Raw Response:', response);
                                return;
                            }
                        }
                        
                        console.log('ğŸ“‹ Response Success:', parsedResponse.success);
                        console.log('ğŸ“‹ Response Data:', parsedResponse.data);
                        console.log('ğŸ“‹ Data Type:', typeof parsedResponse.data);
                        console.log('ğŸ“‹ Data Length:', parsedResponse.data ? parsedResponse.data.length : 'undefined');
                        
                        if (parsedResponse.success) {
                            var select = $('#services');
                            console.log('ğŸ“‹ Services Select Element Found:', select.length > 0);
                            
                            select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø¯Ù…Øª</option>');
                            
                            if (parsedResponse.data && parsedResponse.data.length > 0) {
                                console.log('ğŸ“‹ Processing services...');
                                $.each(parsedResponse.data, function (index, service) {
                                    console.log('ğŸ“‹ Service:', index, service);
                                    console.log('ğŸ“‹ Service ID:', service.ServiceId);
                                    console.log('ğŸ“‹ Service Title:', service.Title);
                                    console.log('ğŸ“‹ Service Price:', service.BasePrice);
                                    
                                    select.append('<option value="' + service.ServiceId + '">' + service.Title + ' - ' + service.BasePrice + ' ØªÙˆÙ…Ø§Ù†</option>');
                                });
                                console.log('âœ… Services loaded successfully');
                            } else {
                                console.warn('âš ï¸ No services found for category:', categoryId);
                                select.append('<option value="">Ø®Ø¯Ù…ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                            }
                        } else {
                            console.error('âŒ Services request failed:', parsedResponse.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('âŒ Services AJAX error:', {
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                    }
                });
            }

            function updateSelectedServices() {
                var selected = $('#services').val();
                var selectedDiv = $('#selected-services');
                
                if (selected && selected.length > 0) {
                    var html = '';
                    $.each(selected, function (index, serviceId) {
                        var serviceText = $('#services option[value="' + serviceId + '"]').text();
                        html += '<span class="badge bg-primary me-1 mb-1">' + serviceText + '</span>';
                    });
                    selectedDiv.html(html);
                } else {
                    selectedDiv.html('<span class="text-muted">Ù‡ÛŒÚ† Ø®Ø¯Ù…ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>');
                }
                
                updateProgress();
            }

            function inquiryPatientIdentity(nationalCode, birthDate) {
                $.ajax({
                    url: '@Url.Action("InquiryPatientIdentity", "Reception")',
                    type: 'POST',
                    data: {
                        nationalCode: nationalCode,
                        birthDate: birthDate,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    beforeSend: function () {
                        $('#inquiry-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù…...');
                    },
                    success: function (response) {
                        console.log('Inquiry Response:', response); // Debug log
                        if (response.success) {
                            showSuccess('Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø§Ø³ØªØ¹Ù„Ø§Ù…
                            showInquiryResults(response.data);
                            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø´Ø¯Ù‡
                            populateFormFromInquiry(response.data);
                        } else {
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ¹Ù„Ø§Ù…: ' + (response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
                        }
                    },
                    error: function () {
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    },
                    complete: function () {
                        $('#inquiry-btn').prop('disabled', false).html('<i class="fas fa-search me-1"></i>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‡ÙˆÛŒØª');
                    }
                });
            }

            function showInquiryResults(inquiryData) {
                console.log('Showing Inquiry Results:', inquiryData); // Debug log
                
                if (!inquiryData || !inquiryData.IdentityData) {
                    showError('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    return;
                }

                var identityData = inquiryData.IdentityData;
                var insuranceData = inquiryData.InsuranceData;

                // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± ÛŒÚ© modal ÛŒØ§ panel
                var resultsHtml = '<div class="card mt-3">';
                resultsHtml += '<div class="card-header bg-warning text-dark">';
                resultsHtml += '<h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Ù†ØªØ§ÛŒØ¬ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‡ÙˆÛŒØª</h6>';
                resultsHtml += '</div>';
                resultsHtml += '<div class="card-body">';
                
                // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØª
                resultsHtml += '<div class="row">';
                resultsHtml += '<div class="col-md-6">';
                resultsHtml += '<h6 class="text-primary">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØª:</h6>';
                resultsHtml += '<p><strong>Ù†Ø§Ù…:</strong> ' + (identityData.FirstName || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> ' + (identityData.LastName || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>Ù†Ø§Ù… Ù¾Ø¯Ø±:</strong> ' + (identityData.FatherName || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>Ø¬Ù†Ø³ÛŒØª:</strong> ' + (identityData.Gender === 1 ? 'Ù…Ø±Ø¯' : 'Ø²Ù†') + '</p>';
                resultsHtml += '<p><strong>Ù…Ø­Ù„ ØªÙˆÙ„Ø¯:</strong> ' + (identityData.BirthPlace || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '</div>';
                
                // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡
                resultsHtml += '<div class="col-md-6">';
                resultsHtml += '<h6 class="text-primary">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡:</h6>';
                resultsHtml += '<p><strong>Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡:</strong> ' + (insuranceData.InsuranceName || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡:</strong> ' + (insuranceData.InsuranceNumber || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ' + (insuranceData.InsuranceStatus || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</p>';
                resultsHtml += '<p><strong>Ø¯Ø±ØµØ¯ Ù¾ÙˆØ´Ø´:</strong> ' + (insuranceData.CoveragePercentage || 0) + '%</p>';
                resultsHtml += '<p><strong>ÙØ±Ø§Ù†Ø´ÛŒØ²:</strong> ' + (insuranceData.Deductible || 0).toLocaleString() + ' Ø±ÛŒØ§Ù„</p>';
                resultsHtml += '</div>';
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ø¨Ø¹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                resultsHtml += '<div class="col-12 mt-2">';
                resultsHtml += '<div class="alert alert-info">';
                resultsHtml += '<i class="fas fa-info-circle me-2"></i>';
                resultsHtml += '<strong>Ù…Ù†Ø¨Ø¹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª:</strong> Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆÚ©Ø§Ù„ Ú©Ù„ÛŒÙ†ÛŒÚ© Ø´ÙØ§ (7 Ù‡Ø²Ø§Ø± Ø±Ú©ÙˆØ±Ø¯ Ø¨ÛŒÙ…Ø§Ø±)';
                resultsHtml += '</div>';
                resultsHtml += '</div>';
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
                if (inquiryData.Message && inquiryData.Message.includes('Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯')) {
                    resultsHtml += '<div class="col-12 mt-2">';
                    resultsHtml += '<div class="alert alert-warning">';
                    resultsHtml += '<i class="fas fa-exclamation-triangle me-2"></i>';
                    resultsHtml += '<strong>ØªÙˆØ¬Ù‡:</strong> Ø§ÛŒÙ† Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆÚ©Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
                    resultsHtml += '</div>';
                    resultsHtml += '</div>';
                }
                resultsHtml += '</div>';
                
                resultsHtml += '<div class="mt-3">';
                resultsHtml += '<button type="button" class="btn btn-primary" onclick="applyInquiryData()">';
                resultsHtml += '<i class="fas fa-check me-1"></i>Ø§Ø¹Ù…Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ ÙØ±Ù…';
                resultsHtml += '</button>';
                resultsHtml += '<button type="button" class="btn btn-secondary ms-2" onclick="clearInquiryResults()">';
                resultsHtml += '<i class="fas fa-times me-1"></i>Ø¨Ø³ØªÙ†';
                resultsHtml += '</button>';
                resultsHtml += '</div>';
                
                resultsHtml += '</div></div>';

                // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
                $('#inquiry-results').html(resultsHtml);
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø¹Ø¯ÛŒ
                window.currentInquiryData = inquiryData;
            }

            function populateFormFromInquiry(inquiryData) {
                if (!inquiryData || !inquiryData.IdentityData) {
                    return;
                }

                var identityData = inquiryData.IdentityData;
                var insuranceData = inquiryData.InsuranceData;

                // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù…
                $('#FirstName').val(identityData.FirstName || '');
                $('#LastName').val(identityData.LastName || '');
                $('#Gender').val(identityData.Gender || '');
                $('#BirthDate').val(identityData.BirthDate ? new Date(identityData.BirthDate).toISOString().split('T')[0] : '');
                $('#Address').val(identityData.Address || '');
                
                // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡
                if (insuranceData && insuranceData.InsuranceName) {
                    $('#InsuranceName').val(insuranceData.InsuranceName);
                    $('#InsuranceNumber').val(insuranceData.InsuranceNumber);
                }

                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨
                if (inquiryData.Message && inquiryData.Message.includes('Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯')) {
                    showWarning('Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯ - Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯');
                } else {
                    showSuccess('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ù‡ ÙØ±Ù… Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯');
                }
            }

            function applyInquiryData() {
                if (window.currentInquiryData) {
                    populateFormFromInquiry(window.currentInquiryData);
                    clearInquiryResults();
                }
            }

            function clearInquiryResults() {
                $('#inquiry-results').empty();
                window.currentInquiryData = null;
            }

            function loadDoctors() {
                console.log('ğŸ‘¨â€âš•ï¸ Loading doctors...');
                
                $.ajax({
                    url: '@Url.Action("GetDoctors", "Reception")',
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        console.log('ğŸ‘¨â€âš•ï¸ Doctors response:', response);
                        
                        if (response.success) {
                            var select = $('#doctorSelect');
                            select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©</option>');
                            
                            if (response.data && response.data.length > 0) {
                            $.each(response.data, function (index, doctor) {
                                    console.log('ğŸ‘¨â€âš•ï¸ Doctor:', doctor);
                                    select.append('<option value="' + doctor.DoctorId + '">' + doctor.FullName + '</option>');
                                });
                                console.log('âœ… Doctors loaded successfully');
                            } else {
                                console.warn('âš ï¸ No doctors found');
                            }
                        } else {
                            console.error('âŒ Failed to load doctors:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('âŒ Error loading doctors:', { status: status, error: error });
                    }
                });
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø²Ø´Ú©
            function loadDoctorDepartments(doctorId) {
                console.log('ğŸ¥ Loading departments for doctor:', doctorId);
                
                $.ajax({
                    url: '@Url.Action("GetDoctorDepartments", "Reception")',
                    type: 'GET',
                    dataType: 'json',
                    data: { doctorId: doctorId },
                    success: function (response) {
                        console.log('ğŸ¥ Doctor departments response:', response);
                        
                        if (response.success) {
                            // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§
                            loadServiceCategoriesByDepartments(response.data);
                        } else {
                            console.error('âŒ Failed to load doctor departments:', response.message);
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø²Ø´Ú©: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('âŒ Error loading doctor departments:', { status: status, error: error });
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§');
                    }
                });
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§
            function loadServiceCategoriesByDepartments(departments) {
                console.log('ğŸ“‹ Loading service categories for departments:', departments);
                
                if (!departments || departments.length === 0) {
                    console.warn('âš ï¸ No departments provided');
                    clearServiceFields();
                    return;
                }
                
                // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†â€ŒÙ‡Ø§
                var departmentIds = departments.map(function(dept) { return dept.DepartmentId; });
                console.log('ğŸ“‹ Department IDs:', departmentIds);
                
                $.ajax({
                    url: '@Url.Action("GetServiceCategoriesByDepartments", "Reception")',
                    type: 'GET',
                    dataType: 'json',
                    data: { departmentIds: departmentIds.join(',') },
                    success: function (response) {
                        console.log('ğŸ“‹ Service categories response:', response);
                        
                        if (response.success) {
                            populateServiceCategories(response.data);
                        } else {
                            console.error('âŒ Failed to load service categories:', response.message);
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('âŒ Error loading service categories:', { status: status, error: error });
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§');
                    }
                });
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª
            function populateServiceCategories(categories) {
                console.log('ğŸ“‹ Populating service categories:', categories);
                
                var select = $('#service-category');
                select.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>');
                
                if (categories && categories.length > 0) {
                    $.each(categories, function (index, category) {
                        console.log('ğŸ“‹ Category:', category);
                        select.append('<option value="' + category.ServiceCategoryId + '">' + category.Title + ' (' + category.DepartmentName + ')</option>');
                    });
                    console.log('âœ… Service categories populated successfully');
                } else {
                    console.warn('âš ï¸ No service categories found');
                    select.append('<option value="">Ø³Ø±ÙØµÙ„â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</option>');
                }
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø®Ø¯Ù…Ø§Øª
                $('#services').empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª
            function clearServiceFields() {
                console.log('ğŸ”„ Clearing service fields...');
                
                $('#service-category').empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ù¾Ø²Ø´Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
                $('#services').empty().append('<option value="">Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>');
            }

            function validateForm() {
                var isValid = true;
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨ÛŒÙ…Ø§Ø±
                if (!$('#PatientId').val()) {
                    showError('Ù„Ø·ÙØ§Ù‹ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    isValid = false;
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù¾Ø²Ø´Ú©
                if (!$('#DoctorId').val()) {
                    showError('Ù„Ø·ÙØ§Ù‹ Ù¾Ø²Ø´Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    isValid = false;
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´
                if (!$('#ReceptionDateShamsi').val()) {
                    showError('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    isValid = false;
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø®Ø¯Ù…Ø§Øª
                if (!$('#services').val() || $('#services').val().length === 0) {
                    showError('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø®Ø¯Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    isValid = false;
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Persian DatePicker
                if (!validatePersianDates()) {
                    isValid = false;
                }
                
                return isValid;
            }
            
            // âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ
            function validatePersianDates() {
                var isValid = true;
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´
                var receptionDate = $('#ReceptionDateShamsi').val();
                if (receptionDate && !isValidPersianDate(receptionDate)) {
                    showError('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                    isValid = false;
                }
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                var birthDate = $('#BirthDateShamsiForInquiry').val();
                if (birthDate && !isValidPersianDate(birthDate)) {
                    showError('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                    isValid = false;
                }
                
                return isValid;
            }
            
            // âœ… Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ÙØ§Ø±Ø³ÛŒ
            function isValidPersianDate(persianDate) {
                if (!persianDate || persianDate.trim() === '') {
                    return true; // ÙÛŒÙ„Ø¯ Ø®Ø§Ù„ÛŒ Ù…Ø¬Ø§Ø² Ø§Ø³Øª
                }
                
                var persianDatePattern = /^[Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°]+[/][Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°]+[/][Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°]+$/;
                return persianDatePattern.test(persianDate);
            }

            function submitForm() {
                var formData = $('#create-reception-form').serialize();
                
                $.ajax({
                    url: '@Url.Action("Create", "Reception")',
                    type: 'POST',
                    data: formData,
                    beforeSend: function () {
                        $('#submit-button').prop('disabled', true);
                        $('#submit-button-text').hide();
                        $('#submit-button-spinner').show();
                    },
                    success: function (response) {
                        if (response.success) {
                            showSuccess('Ù¾Ø°ÛŒØ±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
                            setTimeout(function () {
                                window.location.href = '@Url.Action("Index")';
                            }, 2000);
                        } else {
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´: ' + (response.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
                        }
                    },
                    error: function () {
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    },
                    complete: function () {
                        $('#submit-button').prop('disabled', false);
                        $('#submit-button-text').show();
                        $('#submit-button-spinner').hide();
                    }
                });
            }

            function updateProgress() {
                var progress = 0;
                var totalFields = 6; // ØªØ¹Ø¯Ø§Ø¯ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
                
                if ($('#PatientId').val()) progress += 1;
                if ($('#DoctorId').val()) progress += 1;
                if ($('#services').val() && $('#services').val().length > 0) progress += 1;
                if ($('#TotalAmount').val()) progress += 1;
                if ($('#PaymentMethod').val()) progress += 1;
                if ($('#ReceptionDateShamsi').val()) progress += 1;
                
                var percentage = Math.round((progress / totalFields) * 100);
                $('#form-progress').css('width', percentage + '%');
                $('#progress-text').text(percentage + '% ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡');
            }

            function showSuccess(message) {
                console.log('âœ… Success:', message);
                toastr.success(message);
            }

            function showError(message) {
                console.error('âŒ Error:', message);
                toastr.error(message);
            }

            function showWarning(message) {
                console.warn('âš ï¸ Warning:', message);
                toastr.warning(message);
            }
            
            // âœ… Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Persian DatePicker
            function initializePersianDatePickers() {
                $('.persian-datepicker').each(function() {
                    var $this = $(this);
                    var currentValue = $this.val();
                    
                    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø´Ú©Ù„â€ŒØ³Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
                    if (currentValue && currentValue.includes('Û·Û¸Û³')) {
                        $this.val('');
                    }
                    
                    $this.persianDatepicker({
                        format: 'YYYY/MM/DD',
                        initialValue: false,
                        autoClose: true,
                        calendar: {
                            persian: {
                                locale: 'fa',
                                showHint: true,
                                leapYearMode: 'algorithmic'
                            }
                        }
                    });
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ ØµØ­ÛŒØ­
                    setTimeout(function() {
                        if (!$this.val() || $this.val().includes('Û·Û¸Û³')) {
                            $this.val('');
                        }
                    }, 100);
                });
                
                // âœ… Event delegation Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØªØ§Ø±ÛŒØ® - ÙÙ‚Ø· Persian DatePicker
                $(document).on('change', '.persian-datepicker', function() {
                    console.log('ğŸ—“ï¸ Persian datepicker change event triggered');
                    convertPersianDateToGregorian($(this));
                });
                
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ input events - ÙÙ‚Ø· Persian DatePicker
                $(document).on('input blur', '.persian-datepicker', function() {
                console.log('ğŸ—“ï¸ Persian datepicker input/blur event triggered');
                var $element = $(this);
                    setTimeout(function() {
                    convertPersianDateToGregorian($element);
                    }, 100);
                });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù†)
            $(document).on('change', '#BirthDate', function() {
                console.log('ğŸ“… Birth date changed');
                var birthDate = $(this).val();
                console.log('ğŸ“… Birth date value:', birthDate);
                console.log('ğŸ“… Birth date type:', typeof birthDate);
                if (birthDate) {
                    displayAge(birthDate);
                } else {
                    $('#Age').val('');
                }
            });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„Ø¯ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯
            $(document).on('focus blur', '#BirthDate', function() {
                var currentValue = $(this).val();
                console.log('ğŸ“… BirthDate field value on focus/blur:', currentValue);
            });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
            $(document).on('click', '#edit-patient-btn', function() {
                var patientId = $('#PatientId').val();
                if (patientId) {
                    console.log('ğŸ¥ Opening patient edit page for ID:', patientId);
                    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯
                    window.open('@Url.Action("Edit", "Patient")/' + patientId, '_blank');
                } else {
                    showError('Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
            });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯
            $(document).on('click', '#create-new-patient-btn', function() {
                var nationalCode = $('#NationalCodeForInquiry').val();
                console.log('ğŸ¥ Creating new patient with national code:', nationalCode);
                
                if (nationalCode) {
                    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ú©Ø¯ Ù…Ù„ÛŒ
                    var createUrl = '@Url.Action("Create", "Patient")' + '?nationalCode=' + encodeURIComponent(nationalCode);
                    window.open(createUrl, '_blank');
                } else {
                    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ú©Ø¯ Ù…Ù„ÛŒ
                    window.open('@Url.Action("Create", "Patient")', '_blank');
                }
            });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¬Ø¯Ø¯
            $(document).on('click', '#retry-search-btn', function() {
                console.log('ğŸ”„ Retrying patient search...');
                $('#patient-search-results').empty();
                $('#NationalCodeForInquiry').focus();
                showInfo('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            });
            
            // âœ… Event delegation Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Reset Form
            $(document).on('click', '#reset-form-header-btn, #reset-form-footer-btn, #reset-form-btn', function() {
                console.log('ğŸ”„ Resetting form...');
                resetReceptionForm();
            });
            
            // âœ… Keyboard Shortcut Ø¨Ø±Ø§ÛŒ Reset Form (Ctrl+R)
            $(document).on('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² reload ØµÙØ­Ù‡
                    console.log('ğŸ”„ Reset form triggered by keyboard shortcut (Ctrl+R)');
                    resetReceptionForm();
                }
            });
            
            // âœ… ØªØ§Ø¨Ø¹ Reset Form
            function resetReceptionForm() {
                try {
                    console.log('ğŸ”„ Starting form reset...');
                    
                    // ØªØ§ÛŒÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±
                    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                        console.log('ğŸ”„ Form reset cancelled by user');
                        return;
                    }
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨ÛŒÙ…Ø§Ø±
                    console.log('ğŸ”„ Clearing patient search fields...');
                    $('#NationalCodeForInquiry').val('');
                    $('#patient-search-results').empty();
                    $('#selected-patient-info').empty();
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
                    console.log('ğŸ”„ Clearing patient info fields...');
                    $('#PatientId').val('');
                    $('#FirstName').val('');
                    $('#LastName').val('');
                    $('#NationalCode').val('');
                    $('#PhoneNumber').val('');
                    $('#Gender').val('');
                    $('#birthDateShamsi').val('');
                    $('#BirthDate').val('');
                    $('#Age').val('');
                    $('#Address').val('');
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ù‡
                    console.log('ğŸ”„ Clearing insurance info fields...');
                    $('#InsuranceType').val('');
                    $('#InsuranceNumber').val('');
                    $('#InsuranceExpiryDate').val('');
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´
                    console.log('ğŸ”„ Clearing reception fields...');
                    $('#ReceptionDate').val('');
                    $('#receptionDateShamsi').val('');
                    $('#ReceptionTime').val('');
                    $('#ReceptionType').val('');
                    $('#IsEmergency').prop('checked', false);
                    $('#IsOnlineReception').prop('checked', false);
                    $('#Notes').val('');
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø²Ø´Ú© Ùˆ Ø®Ø¯Ù…Øª
                    console.log('ğŸ”„ Clearing doctor and service fields...');
                    $('#doctorSelect').val('');
                    clearServiceFields();
                    
                    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
                    console.log('ğŸ”„ Hiding form sections...');
                    $('#patient-info-fields').hide();
                    $('#insurance-info-fields').hide();
                    $('#edit-patient-btn').hide();
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                    console.log('ğŸ”„ Clearing messages...');
                    $('.alert').remove();
                    
                    // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Progress Indicator
                    console.log('ğŸ”„ Resetting progress...');
                    updateProgress();
                    
                    // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ú©Ø¯ Ù…Ù„ÛŒ
                    console.log('ğŸ”„ Focusing on national code field...');
                    $('#NationalCodeForInquiry').focus();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                    console.log('ğŸ”„ Showing success message...');
                    showSuccess('ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±ÛŒØ³Øª Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯.');
                    
                    console.log('âœ… Form reset completed successfully');
                    
                } catch (error) {
                    console.error('âŒ Error resetting form:', error);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙØ±Ù…: ' + error.message);
                }
            }
                
                // âœ… Event delegation Ø¨Ø±Ø§ÛŒ HTML5 date fields - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ logging
                $(document).on('change', 'input[type="date"]', function() {
                    var $element = $(this);
                    var fieldId = $element.attr('id');
                    var dateValue = $element.val();
                    console.log('ğŸ“… HTML5 date field changed:', {
                        fieldId: fieldId,
                        dateValue: dateValue
                    });
                });
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®
            function convertPersianDateToGregorian($element) {
                try {
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ element
                    if (!$element || $element.length === 0) {
                        console.warn('âš ï¸ Element not found for date conversion');
                        return;
                    }
                    
                    var fieldId = $element.attr('id');
                    var fieldType = $element.attr('type');
                    var fieldClass = $element.attr('class');
                    
                    console.log('ğŸ—“ï¸ Converting date for field:', {
                        fieldId: fieldId,
                        fieldType: fieldType,
                        fieldClass: fieldClass
                    });
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ ÙÛŒÙ„Ø¯
                    if (fieldType === 'date') {
                        console.log('ğŸ“… HTML5 date field detected - skipping Persian conversion');
                        return;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ø§Ø³ persian-datepicker
                    if (!fieldClass || !fieldClass.includes('persian-datepicker')) {
                        console.log('ğŸ“… Not a Persian datepicker field - skipping conversion');
                        return;
                    }
                    
                    var persianDate = $element.val();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ù‚Ø¯Ø§Ø±
                    if (!persianDate || persianDate.trim() === '') {
                        console.log('ğŸ“… Empty date value - skipping conversion');
                        return;
                    }
                    
                    console.log('ğŸ“… Persian date value:', persianDate);
                    
                        // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ÙØ§Ø±Ø³ÛŒ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
                        var persianDatePattern = /^[Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°0-9]+[/][Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°0-9]+[/][Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹Û°0-9]+$/;
                        
                        console.log('ğŸ” Testing date pattern:', persianDate);
                        console.log('ğŸ” Pattern test result:', persianDatePattern.test(persianDate));
                        
                        if (persianDatePattern.test(persianDate)) {
                            // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
                        try {
                            var gregorianDate = convertPersianToGregorian(persianDate);
                            if (gregorianDate) {
                                var isoDate = gregorianDate.toISOString().split('T')[0];
                                
                                if (fieldId === 'receptionDateShamsi') {
                                    $('#ReceptionDate').val(isoDate);
                                    console.log('âœ… Reception date converted:', isoDate);
                                } else if (fieldId === 'birthDateShamsiForInquiry') {
                                    $('#BirthDateForInquiry').val(isoDate);
                                    console.log('âœ… Birth date for inquiry converted:', isoDate);
                                }
                                
                                console.log('âœ… ØªØ§Ø±ÛŒØ® ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯:', {
                                    fieldId: fieldId,
                                    persianDate: persianDate,
                                    gregorianDate: isoDate
                                });
                            } else {
                                console.warn('âš ï¸ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ù†ÛŒØ³Øª:', persianDate);
                            }
                        } catch (conversionError) {
                            console.error('âŒ Error in date conversion:', conversionError);
                            console.warn('âš ï¸ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ù†ÛŒØ³Øª:', persianDate);
                            }
                        } else {
                        console.warn('âš ï¸ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª:', persianDate);
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:', error);
                    console.error('âŒ Error details:', {
                        message: error.message,
                        stack: error.stack,
                        element: $element
                    });
                }
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù†
            function calculateAge(birthDate) {
                try {
                    console.log('ğŸ“… Calculating age for birth date:', birthDate);
                    
                    if (!birthDate) {
                        console.log('ğŸ“… No birth date provided');
                        return null;
                    }
                    
                    var birth;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª .NET Date
                    if (typeof birthDate === 'string' && birthDate.includes('/Date(')) {
                        console.log('ğŸ“… Processing .NET Date format');
                        birth = new Date(parseInt(birthDate.substr(6)));
                    } else if (typeof birthDate === 'string') {
                        console.log('ğŸ“… Processing string date format');
                        birth = new Date(birthDate);
                    } else {
                        console.log('ğŸ“… Processing other date format');
                        birth = new Date(birthDate);
                    }
                    
                    console.log('ğŸ“… Parsed birth date:', birth);
                    
                    if (isNaN(birth.getTime())) {
                        console.error('âŒ Invalid birth date after parsing:', birthDate);
                        return null;
                    }
                    
                    var today = new Date();
                    var age = today.getFullYear() - birth.getFullYear();
                    var monthDiff = today.getMonth() - birth.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                        age--;
                    }
                    
                    console.log('ğŸ“… Calculated age:', age);
                    return age;
                } catch (error) {
                    console.error('âŒ Error calculating age:', error);
                    return null;
                }
            }
            
            // âœ… ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø³Ù†
            function displayAge(birthDate) {
                var age = calculateAge(birthDate);
                if (age !== null) {
                    $('#Age').val(age + ' Ø³Ø§Ù„');
                    console.log('âœ… Age displayed:', age + ' Ø³Ø§Ù„');
                } else {
                    $('#Age').val('');
                    console.log('âš ï¸ Age could not be calculated');
                }
            }
            
            // âœ… ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø¨Ù‡ ÙØ±Ù…Øª Ù…Ù†Ø§Ø³Ø¨
            function formatBirthDateForDisplay(birthDate) {
                try {
                    console.log('ğŸ“… Formatting birth date for display:', birthDate);
                    
                    if (!birthDate) {
                        console.log('ğŸ“… No birth date provided');
                        return null;
                    }
                    
                    var date;
                    if (typeof birthDate === 'string' && birthDate.includes('/Date(')) {
                        // ÙØ±Ù…Øª .NET Date
                        console.log('ğŸ“… Processing .NET Date format for display');
                        date = new Date(parseInt(birthDate.substr(6)));
                    } else if (typeof birthDate === 'string') {
                        // ÙØ±Ù…Øª ISO string ÛŒØ§ Ø³Ø§ÛŒØ± ÙØ±Ù…Øªâ€ŒÙ‡Ø§
                        console.log('ğŸ“… Processing string date format for display');
                        date = new Date(birthDate);
                    } else {
                        // Date object
                        console.log('ğŸ“… Processing object date format for display');
                        date = new Date(birthDate);
                    }
                    
                    console.log('ğŸ“… Parsed date for display:', date);
                    
                    if (isNaN(date.getTime())) {
                        console.error('âŒ Invalid birth date format:', birthDate);
                        return null;
                    }
                    
                    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙØ±Ù…Øª ISO Ø¨Ø±Ø§ÛŒ HTML5 date input (YYYY-MM-DD)
                    var year = date.getFullYear();
                    var month = String(date.getMonth() + 1).padStart(2, '0');
                    var day = String(date.getDate()).padStart(2, '0');
                    var isoDate = year + '-' + month + '-' + day;
                    
                    console.log('âœ… Formatted birth date:', isoDate);
                    console.log('ğŸ“… Date components:', { year: year, month: month, day: day });
                    return isoDate;
                } catch (error) {
                    console.error('âŒ Error formatting birth date:', error);
                    return null;
                }
            }
            
            // âœ… ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
            function convertGregorianToPersian(gregorianDate) {
                try {
                    console.log('ğŸ—“ï¸ Converting Gregorian to Persian:', gregorianDate);
                    
                    if (!gregorianDate || isNaN(gregorianDate.getTime())) {
                        console.error('âŒ Invalid Gregorian date');
                        return null;
                    }
                    
                    var year = gregorianDate.getFullYear();
                    var month = gregorianDate.getMonth() + 1;
                    var day = gregorianDate.getDate();
                    
                    // ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
                    var persianYear = year - 621;
                    var persianMonth = month;
                    var persianDay = day;
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ù…Ø§Ù‡ Ùˆ Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ
                    if (month > 2) {
                        persianMonth = month - 2;
                    } else {
                        persianYear -= 1;
                        persianMonth = month + 10;
                    }
                    
                    // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ
                    var persianDate = persianYear + '/' + 
                                    String(persianMonth).padStart(2, '0') + '/' + 
                                    String(persianDay).padStart(2, '0');
                    
                    console.log('âœ… Persian date created:', persianDate);
                    return persianDate;
                } catch (error) {
                    console.error('âŒ Error converting to Persian:', error);
                    return null;
                }
            }
            
            // âœ… ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Ø¯Ø³ØªÛŒ)
            function convertPersianToGregorian(persianDate) {
                try {
                    console.log('ğŸ—“ï¸ Converting Persian date:', persianDate);
                    
                    // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
                    var englishDate = persianDate
                        .replace(/Û°/g, '0')
                        .replace(/Û±/g, '1')
                        .replace(/Û²/g, '2')
                        .replace(/Û³/g, '3')
                        .replace(/Û´/g, '4')
                        .replace(/Ûµ/g, '5')
                        .replace(/Û¶/g, '6')
                        .replace(/Û·/g, '7')
                        .replace(/Û¸/g, '8')
                        .replace(/Û¹/g, '9');
                    
                    console.log('ğŸ—“ï¸ English date:', englishDate);
                    
                    // ØªØ¬Ø²ÛŒÙ‡ ØªØ§Ø±ÛŒØ®
                    var parts = englishDate.split('/');
                    if (parts.length !== 3) {
                        console.error('âŒ Invalid date format:', persianDate);
                        return null;
                    }
                    
                    var year = parseInt(parts[0]);
                    var month = parseInt(parts[1]);
                    var day = parseInt(parts[2]);
                    
                    console.log('ğŸ—“ï¸ Parsed parts:', { year: year, month: month, day: day });
                    
                    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                    if (isNaN(year) || isNaN(month) || isNaN(day)) {
                        console.error('âŒ Invalid date numbers:', { year: year, month: month, day: day });
                        return null;
                    }
                    
                    if (year < 1300 || year > 1500) {
                        console.error('âŒ Invalid year range:', year);
                        return null;
                    }
                    
                    if (month < 1 || month > 12) {
                        console.error('âŒ Invalid month range:', month);
                        return null;
                    }
                    
                    if (day < 1 || day > 31) {
                        console.error('âŒ Invalid day range:', day);
                        return null;
                    }
                    
                    console.log('âœ… Date validation passed:', { year: year, month: month, day: day });
                    
                    // ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (ØªÙ‚Ø±ÛŒØ¨ÛŒ)
                    // Ø§ÛŒÙ† ÛŒÚ© ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª - Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² library Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
                    var gregorianYear = year + 621;
                    var gregorianMonth = month;
                    var gregorianDay = day;
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ù…Ø§Ù‡ Ùˆ Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… Ù…ÛŒÙ„Ø§Ø¯ÛŒ
                    if (month > 10) {
                        gregorianYear += 1;
                        gregorianMonth = month - 10;
                    } else {
                        gregorianMonth = month + 2;
                    }
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ
                    var gregorianDate = new Date(gregorianYear, gregorianMonth - 1, gregorianDay);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ®
                    if (isNaN(gregorianDate.getTime())) {
                        console.error('âŒ Invalid Gregorian date created');
                        return null;
                    }
                    
                    console.log('âœ… Gregorian date created:', gregorianDate);
                    return gregorianDate;
                    
                } catch (error) {
                    console.error('âŒ Error in convertPersianToGregorian:', error);
                    return null;
                }
            }
            
            // âœ… Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Select2
            function initializeSelect2() {
                $('#doctorSelect').select2({
                    placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©',
                    allowClear: true,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
                        },
                        searching: function() {
                            return "Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...";
                        }
                    }
                });
                
                $('#paymentMethodSelect').select2({
                    placeholder: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª',
                    allowClear: true,
                    width: '100%',
                    language: {
                        noResults: function() {
                            return "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
                        },
                        searching: function() {
                            return "Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...";
                        }
                    }
                });
            }

            // âœ… Ø§Ø¹Ù…Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            $('#create-reception-form').validate({
                rules: {
                    'PatientId': {
                        required: true
                    },
                    'DoctorId': {
                        required: true
                    },
                    'TotalAmount': {
                        required: true,
                        min: 0
                    },
                    'PaymentMethod': {
                        required: true
                    },
                    'ReceptionDateShamsi': {
                        required: true
                    },
                    'BirthDateShamsiForInquiry': {
                        required: false
                    }
                },
                messages: {
                    'PatientId': {
                        required: "Ù„Ø·ÙØ§Ù‹ Ø¨ÛŒÙ…Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
                    },
                    'DoctorId': {
                        required: "Ù„Ø·ÙØ§Ù‹ Ù¾Ø²Ø´Ú© Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
                    },
                    'TotalAmount': {
                        required: "Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
                        min: "Ù…Ø¨Ù„Øº Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯"
                    },
                    'PaymentMethod': {
                        required: "Ù„Ø·ÙØ§Ù‹ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
                    },
                    'ReceptionDateShamsi': {
                        required: "Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ù¾Ø°ÛŒØ±Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                    },
                    'BirthDateShamsiForInquiry': {
                        required: "Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                    }
                }
            });
        });
    </script>
}
