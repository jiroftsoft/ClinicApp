@using ClinicApp.Extensions
@using ClinicApp.Models.Entities
@model ClinicApp.Interfaces.PagedResult<ClinicApp.ViewModels.PatientIndexViewModel>

@if (Model != null && Model.Items != null && Model.Items.Any())
{
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead class="table-dark">
                <tr>
                    <th scope="col">
                        <i class="fa fa-user me-1"></i>
                        نام کامل
                    </th>
                    <th scope="col">
                        <i class="fa fa-id-card me-1"></i>
                        کد ملی
                    </th>
                    <th scope="col">
                        <i class="fa fa-venus-mars me-1"></i>
                        جنسیت
                    </th>
                    <th scope="col">
                        <i class="fa fa-phone me-1"></i>
                        شماره تلفن
                    </th>
                    <th scope="col">
                        <i class="fa fa-calendar me-1"></i>
                        تاریخ تولد
                    </th>
                    <th scope="col">
                        <i class="fa fa-cogs me-1"></i>
                        عملیات
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var patient in Model.Items)
                {
                    <tr class="patient-item">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div>
                                    <strong>@patient.FullName</strong>
                                    @if (!string.IsNullOrEmpty(patient.Email))
                                    {
                                        <br><small class="text-muted">@patient.Email</small>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>
                            <code class="bg-light px-2 py-1 rounded">@patient.NationalCode</code>
                        </td>
                        <td>
                            <span class="badge @(patient.Gender == Gender.Male ? "bg-primary" : "bg-danger")">
                                <i class="fa @(patient.Gender == Gender.Male ? "fa-male" : "fa-female") me-1"></i>
                                @patient.GenderDisplay
                            </span>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(patient.PhoneNumber))
                            {
                                <a href="tel:@patient.PhoneNumber" class="text-decoration-none">
                                    <i class="fa fa-phone me-1"></i>
                                    @patient.PhoneNumber
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (patient.BirthDate.HasValue)
                            {
                                <span title="@patient.BirthDate.Value.ToPersianDate()">
                                    @patient.BirthDate.Value.ToPersianDate()
                                </span>
                                <br>
                                <small class="text-muted">@patient.BirthDate.Value.ToString("yyyy/MM/dd")</small>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                @Html.ActionLink("مشاهده", "Details", new { id = patient.PatientId }, new { 
                                    @class = "btn btn-outline-info btn-sm",
                                    @title = "مشاهده جزئیات بیمار"
                                })
                                @Html.ActionLink("ویرایش", "Edit", new { id = patient.PatientId }, new { 
                                    @class = "btn btn-outline-warning btn-sm",
                                    @title = "ویرایش اطلاعات بیمار"
                                })
                                <button type="button" 
                                        class="btn btn-outline-danger btn-sm delete-btn" 
                                        data-id="@patient.PatientId" 
                                        data-name="@patient.FullName"
                                        title="حذف بیمار">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    if (Model.TotalPages > 1)
    {
        <nav aria-label="صفحه‌بندی بیماران" class="mt-4">
            <ul class="pagination justify-content-center">
                <!-- Previous Page -->
                @if (Model.PageNumber > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="@(Model.PageNumber - 1)" aria-label="صفحه قبلی">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                }
                else
                {
                    <li class="page-item disabled">
                        <span class="page-link" aria-label="صفحه قبلی">
                            <span aria-hidden="true">&laquo;</span>
                        </span>
                    </li>
                }

                <!-- Page Numbers -->
                @{
                    int startPage = Math.Max(1, Model.PageNumber - 2);
                    int endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                }

                @if (startPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="1">1</a>
                    </li>
                    if (startPage > 2)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }

                @for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" href="#" data-page="@i">@i</a>
                    </li>
                }

                @if (endPage < Model.TotalPages)
                {
                    if (endPage < Model.TotalPages - 1)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="@Model.TotalPages">@Model.TotalPages</a>
                    </li>
                }

                <!-- Next Page -->
                @if (Model.PageNumber < Model.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="@(Model.PageNumber + 1)" aria-label="صفحه بعدی">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                }
                else
                {
                    <li class="page-item disabled">
                        <span class="page-link" aria-label="صفحه بعدی">
                            <span aria-hidden="true">&raquo;</span>
                        </span>
                    </li>
                }
            </ul>
        </nav>

        <!-- Pagination Info -->
        <div class="text-center text-muted">
            <small>
                نمایش @((Model.PageNumber - 1) * Model.PageSize + 1) تا @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalItems)) 
                از @Model.TotalItems بیمار
            </small>
        </div>
    }
}
else
{
    <div class="text-center p-5">
        <i class="fa fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">هیچ بیماری یافت نشد</h5>
        <p class="text-muted">لطفاً معیارهای جستجو را تغییر دهید یا بیمار جدیدی اضافه کنید.</p>
        @Html.ActionLink("افزودن بیمار جدید", "Create", null, new { 
            @class = "btn btn-success",
            @title = "افزودن بیمار جدید"
        })
    </div>
}