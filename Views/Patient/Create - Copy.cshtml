@model ClinicApp.ViewModels.PatientCreateEditViewModel
@{
    ViewBag.Title = "ثبت بیمار جدید";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user-plus me-2"></i>@ViewBag.Title</h4>
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Create", "Patient", FormMethod.Post, new { id = "create-patient-form", role = "form" }))
                {
                    @Html.AntiForgeryToken()

                    @* نمایش خطاهای کلی مدل در اینجا *@
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                    <div class="row g-3">
                        <div class="col-md-6">
                            @Html.LabelFor(model => model.FirstName, new { @class = "form-label" })
                            @Html.EditorFor(model => model.FirstName, new { htmlAttributes = new { @class = "form-control", placeholder = "نام بیمار" } })
                            @Html.ValidationMessageFor(model => model.FirstName, "", new { @class = "text-danger" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(model => model.LastName, new { @class = "form-label" })
                            @Html.EditorFor(model => model.LastName, new { htmlAttributes = new { @class = "form-control", placeholder = "نام خانوادگی بیمار" } })
                            @Html.ValidationMessageFor(model => model.LastName, "", new { @class = "text-danger" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(model => model.NationalCode, new { @class = "form-label" })
                            @Html.EditorFor(model => model.NationalCode, new { htmlAttributes = new { @class = "form-control", placeholder = "کد ملی ۱۰ رقمی", autocomplete = "off" } })
                            @Html.ValidationMessageFor(model => model.NationalCode, "", new { @class = "text-danger" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(model => model.PhoneNumber, new { @class = "form-label" })
                            @Html.EditorFor(model => model.PhoneNumber, new { htmlAttributes = new { @class = "form-control", placeholder = "مثال: 09123456789" } })
                            @Html.ValidationMessageFor(model => model.PhoneNumber, "", new { @class = "text-danger" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(model => model.BirthDatePersian, new { @class = "form-label" })

                            <!-- فیلد شمسی (نمایش به کاربر) -->
                            @Html.TextBoxFor(model => model.BirthDatePersian, new
                            {
                                @class = "form-control",
                                id = "birthdate-picker",
                                autocomplete = "off",
                                @readonly = "readonly"
                            })
                            @Html.ValidationMessageFor(model => model.BirthDatePersian, "", new { @class = "text-danger" })

                            <!-- فیلد میلادی (مخفی) -->
                            @Html.HiddenFor(model => model.BirthDate)
                        </div>


                        <div class="col-12">
                            @Html.LabelFor(model => model.Address, new { @class = "form-label" })
                            @Html.TextAreaFor(model => model.Address, 4, 0, new { @class = "form-control", placeholder = "آدرس محل سکونت بیمار" })
                            @Html.ValidationMessageFor(model => model.Address, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-end">
                        @Html.ActionLink("بازگشت به لیست", "Index", null, new { @class = "btn btn-outline-secondary me-2" })
                        <button type="submit" id="submit-button" class="btn btn-success">
                            <span id="submit-button-text">
                                <i class="fas fa-check me-2"></i>ثبت بیمار
                            </span>
                            <span id="submit-button-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        $(document).ready(function () {

            var $picker = $("#birthdate-picker");
            if (!$picker.length) return;

            $picker.pDatepicker({
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: false,
                observer: true,
                altField: '[name="BirthDate"]', // فیلد Hidden میلادی
                altFormat: 'YYYY-MM-DD',
                calendarSettings: {
                    persian: {
                        locale: 'fa',
                        leapYearMode: 'astronomical'
                    }
                },
                theme: 'blue',
                digits: 'persian',
                textArray: {
                    'fa': {
                        'today': 'امروز',
                        'yesterday': 'دیروز',
                        'lastWeek': 'هفته گذشته',
                        'lastMonth': 'ماه گذشته',
                        'lastYear': 'سال گذشته',
                        'clear': 'پاک کن',
                        'close': 'بستن'
                    }
                },
                calendar: {
                    persian: {
                        monthNames: [
                            'فروردین', 'اردیبهشت', 'خرداد',
                            'تیر', 'مرداد', 'شهریور',
                            'مهر', 'آبان', 'آذر',
                            'دی', 'بهمن', 'اسفند'
                        ],
                        dayNames: [
                            'شنبه', 'یک‌شنبه', 'دوشنبه',
                            'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'
                        ],
                        dayNamesShort: ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج']
                    }
                },
                toolbox: {
                    todayBtn: { enabled: true, text: { fa: 'امروز' } },
                    clearBtn: { enabled: true, text: { fa: 'پاک کن' } },
                    calendarSwitch: { enabled: true, format: "YYYY" }
                }
            });


            // ۲. مدیریت وضعیت دکمه ثبت برای جلوگیری از ارسال تکراری
            $('#create-patient-form').on('submit', function () {
                if ($(this).valid()) {
                    var submitBtn = $('#submit-button');
                    submitBtn.prop('disabled', true); // غیرفعال کردن دکمه
                    $('#submit-button-text').hide();
                    $('#submit-button-spinner').show(); // نمایش اسپینر
                }
            });

            // ۳. (اختیاری) بهبود نمایش خطاهای اعتبارسنجی
            $.validator.setDefaults({
                highlight: function (element) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element) {
                    $(element).removeClass('is-invalid');
                }
            });
        });
    </script>
}